<!DOCTYPE html>
<html>
<head>
  <title>Supabase Database Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Supabase Database Test</h1>
  <button onclick="testDatabase()">Test Database Connection</button>
  <button onclick="createTable()">Create Table (if missing)</button>
  <button onclick="testSave()">Test Save</button>
  <button onclick="testLoad()">Test Load</button>
  <button onclick="directQuery()">Direct Query</button>
  <br><br>
  <pre id="output"></pre>

  <script>
    const SUPABASE_URL = 'https://yoxzlejphrhtuisnptor.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlveHpsZWpwaHJodHVpc25wdG9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NjIwNDIsImV4cCI6MjA3NDEzODA0Mn0.azXNn6AQQcB5iJzn7ebhAh5cSBESgKwEV2aSviX8yeY';

    let supabase;
    let currentUser = null;

    function log(msg) {
      console.log(msg);
      document.getElementById('output').innerHTML += msg + '\n';
    }

    async function init() {
      log('Initializing Supabase...');
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const { data: { session }, error } = await supabase.auth.getSession();
      if (session) {
        currentUser = session.user;
        log('Logged in as: ' + session.user.email);
        log('User ID: ' + session.user.id);
      } else {
        log('Not logged in');
      }
    }

    async function testDatabase() {
      log('\n=== Testing Database Connection ===');

      if (!currentUser) {
        log('ERROR: Not logged in!');
        return;
      }

      try {
        // Test if we can query the table
        log('Attempting to query hotlist_data table...');

        const { data, error, status, statusText } = await supabase
          .from('hotlist_data')
          .select('*')
          .eq('user_id', currentUser.id);

        log('Response status: ' + status);
        log('Response statusText: ' + statusText);

        if (error) {
          log('ERROR: ' + JSON.stringify(error));
          if (error.code === '42P01') {
            log('Table does not exist! Run Create Table first.');
          } else if (error.code === '42501') {
            log('Permission denied! Check RLS policies.');
          }
        } else {
          log('SUCCESS: Table exists and is accessible');
          log('Data found: ' + (data && data.length > 0 ? 'Yes' : 'No'));
          if (data && data.length > 0) {
            log('Data ID: ' + data[0].id);
            log('Data size: ' + (data[0].data ? data[0].data.length : 0) + ' chars');
          }
        }
      } catch (err) {
        log('EXCEPTION: ' + err.message);
      }
    }

    async function createTable() {
      log('\n=== Creating Table (Run in SQL Editor) ===');
      log('Copy and paste this SQL in Supabase SQL Editor:');
      log('');
      log(`-- Create the hotlist_data table
CREATE TABLE IF NOT EXISTS hotlist_data (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  data TEXT NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id)
);

-- Enable Row Level Security
ALTER TABLE hotlist_data ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Users can view their own data" ON hotlist_data
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own data" ON hotlist_data
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own data" ON hotlist_data
  FOR UPDATE USING (auth.uid() = user_id);`);
    }

    async function testSave() {
      log('\n=== Testing Save ===');

      if (!currentUser) {
        log('ERROR: Not logged in!');
        return;
      }

      const testData = {
        clients: [{id: 1, name: 'Test Client'}],
        timestamp: new Date().toISOString()
      };

      try {
        log('Saving test data...');
        const { error } = await supabase
          .from('hotlist_data')
          .upsert({
            user_id: currentUser.id,
            data: JSON.stringify(testData),
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'user_id'
          });

        if (error) {
          log('Save ERROR: ' + JSON.stringify(error));
        } else {
          log('Save SUCCESS!');
        }
      } catch (err) {
        log('Save EXCEPTION: ' + err.message);
      }
    }

    async function testLoad() {
      log('\n=== Testing Load ===');

      if (!currentUser) {
        log('ERROR: Not logged in!');
        return;
      }

      try {
        log('Loading data...');
        const { data, error } = await supabase
          .from('hotlist_data')
          .select('data')
          .eq('user_id', currentUser.id)
          .single();

        if (error) {
          log('Load ERROR: ' + JSON.stringify(error));
        } else {
          log('Load SUCCESS!');
          if (data && data.data) {
            const parsed = JSON.parse(data.data);
            log('Parsed data: ' + JSON.stringify(parsed));
          }
        }
      } catch (err) {
        log('Load EXCEPTION: ' + err.message);
      }
    }

    async function directQuery() {
      log('\n=== Direct SQL Query Test ===');

      if (!currentUser) {
        log('ERROR: Not logged in!');
        return;
      }

      try {
        // Try a simple count query
        log('Attempting count query...');
        const { data, error, count } = await supabase
          .from('hotlist_data')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (error) {
          log('Count ERROR: ' + JSON.stringify(error));
        } else {
          log('Count SUCCESS: ' + count + ' records');
        }
      } catch (err) {
        log('Count EXCEPTION: ' + err.message);
      }
    }

    // Initialize on load
    init();
  </script>
</body>
</html>