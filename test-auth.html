<!DOCTYPE html>
<html>
<head>
  <title>Auth Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Supabase Auth Test</h1>
  <div id="status">Loading...</div>
  <br>
  <button onclick="signIn()">Sign in with Google</button>
  <button onclick="signOut()">Sign Out</button>
  <button onclick="checkSession()">Check Session</button>
  <button onclick="clearStorage()">Clear Storage</button>
  <button onclick="window.location.reload()">Reload Page</button>
  <br><br>
  <pre id="output"></pre>

  <script>
    const SUPABASE_URL = 'https://yoxzlejphrhtuisnptor.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlveHpsZWpwaHJodHVpc25wdG9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NjIwNDIsImV4cCI6MjA3NDEzODA0Mn0.azXNn6AQQcB5iJzn7ebhAh5cSBESgKwEV2aSviX8yeY';

    let supabase;
    let currentUser = null;

    function log(msg) {
      console.log(msg);
      document.getElementById('output').innerHTML += msg + '\n';
    }

    async function init() {
      log('Initializing Supabase...');
      log('URL: ' + SUPABASE_URL);
      log('Key exists: ' + !!SUPABASE_KEY);

      // Check localStorage first
      log('Checking localStorage...');
      const keys = Object.keys(localStorage);
      const supabaseKeys = keys.filter(k => k.includes('supabase'));
      log('Supabase keys in storage: ' + supabaseKeys.join(', '));

      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      log('Supabase client created');

      // Add timeout to prevent hanging
      log('Checking session with timeout...');

      const timeout = new Promise((resolve) => {
        setTimeout(() => resolve({ timeout: true }), 5000);
      });

      const sessionPromise = supabase.auth.getSession();

      const result = await Promise.race([sessionPromise, timeout]);

      if (result.timeout) {
        log('ERROR: getSession() timed out after 5 seconds!');
        log('This suggests a Supabase configuration issue.');
        document.getElementById('status').innerHTML = 'Error: Session check timeout';
      } else if (result.error) {
        log('Error getting session: ' + result.error.message);
      } else if (result.data && result.data.session) {
        log('Session found: ' + result.data.session.user.email);
        currentUser = result.data.session.user;
        document.getElementById('status').innerHTML = 'Signed in as: ' + result.data.session.user.email;
      } else {
        log('No session found');
        document.getElementById('status').innerHTML = 'Not signed in';
      }

      // Listen for auth changes
      supabase.auth.onAuthStateChange((event, session) => {
        log('Auth event: ' + event);
        if (session) {
          currentUser = session.user;
          document.getElementById('status').innerHTML = 'Signed in as: ' + session.user.email;
        } else {
          currentUser = null;
          document.getElementById('status').innerHTML = 'Not signed in';
        }
      });
    }

    async function signIn() {
      log('Starting OAuth sign in...');
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.href
        }
      });

      if (error) {
        log('Sign in error: ' + error.message);
      } else {
        log('Redirecting to Google...');
      }
    }

    async function signOut() {
      log('Signing out...');
      const { error } = await supabase.auth.signOut();
      if (error) {
        log('Sign out error: ' + error.message);
      } else {
        log('Signed out successfully');
      }
    }

    async function checkSession() {
      log('Checking session...');
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) {
        log('Error: ' + error.message);
      } else if (session) {
        log('Session active: ' + session.user.email);
        log('Expires at: ' + new Date(session.expires_at * 1000));
      } else {
        log('No active session');
      }
    }

    function clearStorage() {
      log('Clearing all Supabase data from localStorage...');
      const keys = Object.keys(localStorage);
      const supabaseKeys = keys.filter(k => k.includes('supabase'));
      supabaseKeys.forEach(key => {
        log('Removing: ' + key);
        localStorage.removeItem(key);
      });
      log('Storage cleared. Please reload the page.');
    }

    // Initialize on load
    init();
  </script>
</body>
</html>