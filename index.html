<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<meta name="cache-buster" content="v37-20250119-nocache-<?php echo time(); ?>" />
<meta http-equiv="Last-Modified" content="0" />
<meta http-equiv="If-Modified-Since" content="0" />
<meta name="timestamp" content="1737166800" />
<title>Hotlist</title>
<link rel="manifest" href="/manifest.json?v=1.7.2">
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='28'%3E🔥%3C/text%3E%3C/svg%3E">
<meta name="theme-color" content="#ff5722">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Hotlist">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%23ff5722' rx='20'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='96' fill='white'%3E🔥%3C/text%3E%3C/svg%3E">
<style>
  :root{
  /* Brand & neutrals */
  --green:#0e7a5a; --green-600:#0a5e46; --green-50:#e9f5ee;
  --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e6e9f2;
  --shadow:0 10px 24px rgba(15,23,42,.06), 0 2px 6px rgba(15,23,42,.04);
  --orange:#f59e0b; --red:#dc2626; --blue:#4f79ff;
  --success:#10b981; --info:#60a5fa; --warning:#fbbf24;
  --radius:14px;

  /* Elevation tokens */
  --ring:0 0 0 2px rgba(99,102,241,.15);
  --ring-strong:0 0 0 3px rgba(99,102,241,.25);
}

/* Dark mode (automatic) */
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0f1220; --card:#16192a; --ink:#e6e9f5; --muted:#98a2b3; --line:#232846;
    --shadow:0 10px 24px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.25);
    --green:#22c38b; --green-600:#16a374; --green-50:#0f2a22;
  }
  .bar{background:#2b335e}
  .s-hot{background:#2b1d12;border-color:#8a4e21}
  .sbtn.s-hot{border:1px solid #8a4e21;background:#2b1d12}
  .sbtn.s-hot:hover{background:#3a2618;opacity:1}
  .sbtn.s-hot.active{background:#3a2618}
  .hot-row{
    border-left-color:#fb923c;
    background: linear-gradient(135deg,
      rgba(251, 146, 60, 0.18) 0%,
      rgba(249, 115, 22, 0.12) 30%,
      rgba(234, 88, 12, 0.08) 60%,
      rgba(220, 38, 38, 0.04) 100%
    );
    animation: hotPulse 2s ease-in-out infinite;
  }
  /* Today's block dark mode */
  #todayBlock {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(37, 99, 235, 0.08) 100%);
    border-color: rgba(59, 130, 246, 0.35);
  }
  #todayBlock h2 {
    color: #60a5fa;
  }
  #todayBlock .table-head {
    background: rgba(59, 130, 246, 0.15);
    border-color: rgba(59, 130, 246, 0.25);
    color: #93c5fd;
  }
  #todayBlock .row {
    background: rgba(22, 25, 42, 0.6);
    border-color: rgba(59, 130, 246, 0.2);
    cursor: pointer;
    position: relative;
    z-index: 1;
  }
  #todayBlock .row:hover {
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25), 0 2px 4px rgba(59, 130, 246, 0.15);
    transform: translateY(-1px);
    transition: all 0.2s ease;
  }
  #todayBlock .row.selected {
    outline: 2px solid var(--green);
    outline-offset: -1px;
  }
  .hot-badge {
    background: linear-gradient(135deg, #ff8a80, #ff6e40);
  }
  .lightning-bolt {
    filter: drop-shadow(0 0 15px #ffd54f);
  }
}

/* base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:linear-gradient(180deg, var(--bg), color-mix(in oklab, var(--bg) 85%, #fff));
  color:var(--ink);
  font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
  letter-spacing:.15px;
}

/* Layout shell */
.app{
  display:grid; grid-template-columns:1fr minmax(330px, 400px); grid-template-areas:"main side";
  gap:14px; padding:14px; max-width:1800px; margin:0 auto; min-height:100vh; position:relative;
}
.app > section.card{
  grid-area:main;
  position:relative;
  overflow-y:auto;
  max-height:calc(100vh - 28px);
}
.app > aside.card{grid-area:side}
.app > aside.card.left-sidebar{
  grid-area:left;
  overflow-x:hidden;
  overflow-y:auto;
  max-height:calc(100vh - 28px);
}

/* Dual sidebar layouts */
.app.dual-sidebar{
  grid-template-columns:minmax(300px, 380px) 1fr minmax(300px, 380px); 
  grid-template-areas:"left main side";
}
.app.leftbar{grid-template-columns:400px 1fr;grid-template-areas:"side main"}
.app.no-side{grid-template-columns:1fr; grid-template-areas:"main"}
.app.no-side > aside{display:none !important}

/* Card */
.card{
  background:var(--card);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
  padding:14px;
  border-radius:var(--radius);
  min-width:0;
}

/* Header */
header{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;margin-bottom:8px}
h1{
  text-transform:uppercase;
  letter-spacing:.6px;
  font-size:18pt;
  font-weight:800;
  margin:0;
}

/* Flame title styling */
.flame-title {
  background: linear-gradient(135deg, #ea580c, #fb923c, #f97316);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 15px rgba(255, 140, 0, 0.4))
          drop-shadow(0 0 30px rgba(255, 165, 0, 0.2));
  position: relative;
  display: inline-block;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

/* Hot flame animation when marking client hot */
@keyframes flameTravel {
  0% {
    transform: scale(0.5);
    opacity: 0;
  }
  20% {
    transform: scale(1.2);
    opacity: 1;
  }
  80% {
    transform: scale(0.8);
    opacity: 1;
  }
  100% {
    transform: scale(1.5);
    opacity: 0;
  }
}

.flame-burst {
  position: fixed;
  font-size: 96px;
  z-index: 10000;
  pointer-events: none;
  transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
.muted{color:var(--muted)} .small{font-size:12px}

/* Keyboard styles */
kbd {
  background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 2px 6px;
  font-family: monospace;
  font-size: 12px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  display: inline-block;
}
@media (prefers-color-scheme: dark) {
  kbd {
    background: linear-gradient(to bottom, #3a3f5c, #2b335e);
    border-color: #4a5568;
  }
}

/* Shortcuts section */
.shortcuts-section{
  position:static;
  margin-top:2px;
  margin-bottom:2px;
  padding:12px 16px;
  background:linear-gradient(135deg, #f8fafc, #f1f5f9);
  border:1px solid #e2e8f0;
  border-radius:8px;
  font-size:12px;
  color:#6b7390;
  line-height:1.6;
  z-index:10;
  box-shadow:0 -2px 8px rgba(0,0,0,0.05);
}
.error-banner{
  display:none;background:#fff3f3;color:#7f1d1d;border:1px solid #fecaca;
  padding:8px 10px;margin:8px 0;border-radius:10px
}

/* Inputs & buttons */
input,textarea,select,button{
  border:1px solid var(--line);
  border-radius:10px;
  font-size:14px;
  background:#fff;
  color:var(--ink);
  transition:.15s ease;
}
input[type=text],input[type=number]{padding:8px 10px}
select{padding:7px 10px;background:linear-gradient(#fff, #f8fafc)}
button{
  cursor:pointer;padding:8px 12px;background:linear-gradient(#fff, #f8fafc);
  box-shadow:0 1px 0 rgba(15,23,42,.04);
}
button:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(15,23,42,.08)}
button:focus-visible{outline:none; box-shadow:var(--ring)}
.btn-primary{
  background:linear-gradient(180deg, var(--green), color-mix(in oklab, var(--green) 85%, black));
  border-color:var(--green-600); color:#fff;
}
.btn-min{padding:5px 10px;font-size:12px}
.btn-min.gray{background:#f8fafc;border-color:#cbd5e1;color:#334155}

/* Ribbons & KPIs */
.ribbons{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
.ribbon{
  background:linear-gradient(180deg,#fffbe6,#fff4c2);
  border:1px solid #fde68a;
  font-size:11px;padding:4px 8px;border-radius:999px
}
.kpis-widget{display:grid;gap:8px;font-size:13px}
.kpis-widget .kpi-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f1f5f9}
.kpis-widget .kpi-row:last-child{border-bottom:none}
.kpis-widget .kpi-label{color:#6b7390}
.kpis-widget .kpi-value{font-weight:700;color:#1e293b}
.pill b{margin-right:6px}

/* Controls */
.controls{display:flex;gap:10px;align-items:center;width:100%}
.controls .stack{display:flex;gap:8px;align-items:center;flex-wrap:nowrap;width:100%}

/* Table head & rows */
.table-head{
  display:grid;grid-template-columns:1fr auto;gap:10px;padding:10px 12px;
  border-bottom:1px solid var(--line);font-size:12px;color:#4b5563;
  background:color-mix(in oklab, var(--card) 92%, #eef2ff); border-radius:12px
}
.row{
  display:grid; grid-template-columns:1fr auto; gap:10px;
  padding:12px 12px; border-bottom:1px dashed var(--line);
  align-items:center; border-radius:12px; position:relative;
}
.row:hover{
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.05);
  transition: box-shadow 0.2s ease;
  transform: translateY(-1px);
}
.row:last-child{border-bottom:none}
/* Selected row styling - more subtle and modern */
.row.selected {
  background: linear-gradient(90deg, #3b82f6 3px, rgba(59, 130, 246, 0.08) 3px);
  box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.15);
  border-radius: 12px;
}
.row.selected:hover {
  background: linear-gradient(90deg, #3b82f6 3px, rgba(59, 130, 246, 0.12) 3px);
}

/* Drag and drop styles */
.row.dragging { opacity: 0.5; transform: scale(0.98); cursor: move; }
.row.drag-over {
  background: linear-gradient(180deg, #3b82f6 2px, transparent 2px);
  background-position: top;
  padding-top: 14px;
}
.row.drag-over-bottom {
  background: linear-gradient(180deg, transparent calc(100% - 2px), #3b82f6 calc(100% - 2px));
  background-position: bottom;
  padding-bottom: 14px;
}

/* Font size adjustments for client rows */
body[data-font-size="xsmall"] .row { font-size: 12px; }
body[data-font-size="xsmall"] .row .name { font-size: 15px; } /* Keep name at standard size */
body[data-font-size="xsmall"] .row .qbtn { font-size: 18px; padding: 4px 8px; } /* Keep group icons at minimum 18px */
body[data-font-size="xsmall"] .row .sbtn { font-size: 11px; padding: 3px 6px; }
body[data-font-size="xsmall"] .row .sbtn .ico { font-size: 12px; }
body[data-font-size="xsmall"] .row .iconbtn { font-size: 18px; padding: 4px 7px; }
body[data-font-size="xsmall"] .row .badge { font-size: 9px; }
body[data-font-size="xsmall"] .row .notes-preview { font-size: 10px; }
body[data-font-size="xsmall"] .row .status-icon { font-size: 12px; }
body[data-font-size="xsmall"] .row .stage-icon { width: 32px; height: 32px; font-size: 12px; }
body[data-font-size="xsmall"] .row .stage-label { font-size: 8px; }

body[data-font-size="small"] .row { font-size: 13px; }
body[data-font-size="small"] .row .name { font-size: 15px; }
body[data-font-size="small"] .row .qbtn { font-size: 20px; padding: 5px 9px; }
body[data-font-size="small"] .row .sbtn { font-size: 12px; padding: 4px 7px; }
body[data-font-size="small"] .row .sbtn .ico { font-size: 14px; }
body[data-font-size="small"] .row .iconbtn { font-size: 20px; padding: 5px 8px; }
body[data-font-size="small"] .row .badge { font-size: 10px; }
body[data-font-size="small"] .row .notes-preview { font-size: 11px; }
body[data-font-size="small"] .row .status-icon { font-size: 14px; }
body[data-font-size="small"] .row .stage-icon { width: 36px; height: 36px; font-size: 14px; }
body[data-font-size="small"] .row .stage-label { font-size: 9px; }

body[data-font-size="medium"] .row { font-size: 14px; }
body[data-font-size="medium"] .row .name { font-size: 15px; }
body[data-font-size="medium"] .row .qbtn { font-size: 22px; padding: 0 9px 5px 9px; }
body[data-font-size="medium"] .row .sbtn { font-size: 13px; padding: 5px 8px; }
body[data-font-size="medium"] .row .sbtn .ico { font-size: 16px; }
body[data-font-size="medium"] .row .iconbtn { font-size: 22px; padding: 6px 9px; }
body[data-font-size="medium"] .row .badge { font-size: 11px; }
body[data-font-size="medium"] .row .notes-preview { font-size: 12px; }
body[data-font-size="medium"] .row .status-icon { font-size: 16px; }
body[data-font-size="medium"] .row .stage-icon { width: 44px; height: 44px; font-size: 18px; }
body[data-font-size="medium"] .row .stage-label { font-size: 10px; }

body[data-font-size="large"] .row { font-size: 15px; }
body[data-font-size="large"] .row .name { font-size: 16px; }
body[data-font-size="large"] .row .qbtn { font-size: 24px; padding: 6px 10px; }
body[data-font-size="large"] .row .sbtn { font-size: 14px; padding: 6px 9px; }
body[data-font-size="large"] .row .sbtn .ico { font-size: 18px; }
body[data-font-size="large"] .row .iconbtn { font-size: 24px; padding: 7px 10px; }
body[data-font-size="large"] .row .badge { font-size: 12px; }
body[data-font-size="large"] .row .notes-preview { font-size: 13px; }
body[data-font-size="large"] .row .status-icon { font-size: 18px; }
body[data-font-size="large"] .row .stage-icon { width: 50px; height: 50px; font-size: 20px; }
body[data-font-size="large"] .row .stage-label { font-size: 11px; }

body[data-font-size="xlarge"] .row { font-size: 16px; }
body[data-font-size="xlarge"] .row .name { font-size: 18px; }
body[data-font-size="xlarge"] .row .qbtn { font-size: 26px; padding: 7px 11px; }
body[data-font-size="xlarge"] .row .sbtn { font-size: 15px; padding: 7px 10px; }
body[data-font-size="xlarge"] .row .sbtn .ico { font-size: 20px; }
body[data-font-size="xlarge"] .row .iconbtn { font-size: 26px; padding: 8px 11px; }
body[data-font-size="xlarge"] .row .badge { font-size: 13px; }
body[data-font-size="xlarge"] .row .notes-preview { font-size: 14px; }
body[data-font-size="xlarge"] .row .status-icon { font-size: 20px; }
body[data-font-size="xlarge"] .row .stage-icon { width: 56px; height: 56px; font-size: 24px; }
body[data-font-size="xlarge"] .row .stage-label { font-size: 12px; }

/* Hot lead styling */
.row.hot-row{
  border-left:4px solid #f97316;
  background: linear-gradient(135deg,
    rgba(254, 215, 170, 0.35) 0%,
    rgba(251, 146, 60, 0.25) 20%,
    rgba(249, 115, 22, 0.18) 40%,
    rgba(234, 88, 12, 0.12) 60%,
    rgba(220, 38, 38, 0.08) 100%
  ) !important;
  position:relative;
}
.row.hot-row:hover{
  box-shadow: 0 6px 20px rgba(251, 146, 60, 0.25), 0 2px 8px rgba(249, 115, 22, 0.15);
  transform: translateY(-1px);
  transition: all 0.2s ease;
}

/* Hot icon sizing to match stage icons */
.sbtn.s-hot .ico {
  font-size: 18px; /* Default size to match stage icons */
}

/* Hot icon sizes for each font-size level */
body[data-font-size="xsmall"] .row .sbtn.s-hot .ico { font-size: 12px; }
body[data-font-size="small"] .row .sbtn.s-hot .ico { font-size: 14px; }
body[data-font-size="medium"] .row .sbtn.s-hot .ico { font-size: 18px; }
body[data-font-size="large"] .row .sbtn.s-hot .ico { font-size: 20px; }
body[data-font-size="xlarge"] .row .sbtn.s-hot .ico { font-size: 24px; }

/* Animate the fire icon when hot status is active */
.sbtn.s-hot.active .ico {
  display: inline-block;
  animation: fireFlicker 1.5s ease-in-out infinite;
  transform-origin: center bottom;
}

@keyframes fireFlicker {
  0%, 100% { 
    transform: scale(1) rotate(0deg);
    filter: brightness(1);
  }
  25% {
    transform: scale(1.1) rotate(-5deg);
    filter: brightness(1.2) hue-rotate(-10deg);
  }
  50% { 
    transform: scale(1.15) rotate(3deg);
    filter: brightness(1.4) hue-rotate(10deg);
  }
  75% {
    transform: scale(1.05) rotate(-3deg);
    filter: brightness(1.1) hue-rotate(-5deg);
  }
}

/* Left column */
.leftcol{display:flex;flex-direction:column;gap:2px;justify-content:center;min-width:0;overflow:hidden}
.stamp{font-variant-numeric:tabular-nums;color:#6b7390;font-size:12px}
.lastmeta{font-size:11px;color:#6b7390}

.name-line{display:flex;gap:10px;align-items:center;min-width:0;overflow:hidden}
.name{font-weight:850;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:none}
.touchCount{opacity:.55;font-size:11px;margin-left:4px;flex:0 0 auto}
.status-icons{display:flex;gap:6px;align-items:center;flex:0 0 auto}
.status-icon{font-size:22px;line-height:1}
.notes-preview{
  font-size:12px;color:#6b7390;margin-top:2px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  margin-left:11px;max-width:100%;
}

/* Action groups */
.actions-wrap{
  display:flex;align-items:center;justify-content:flex-start;flex-wrap:nowrap;overflow:visible;
  column-gap:24px; flex-shrink:0;
}
.group--quick{display:flex;gap:10px;align-items:center; margin-right:18px;}
.group--status{display:flex;gap:12px;align-items:center; margin-right:18px;}
.group--icons{display:flex;gap:0;align-items:center}

/* Quick counters */
.qbtn{
  position:relative;border:none;padding:8px 12px;border-radius:12px;
  background:transparent;font-size:16px;line-height:1;display:inline-flex;align-items:center;justify-content:center;min-width:46px
}
.qbtn:hover{
  transform:translateY(-1px);
}
.qbtn .badge{
  position:absolute;right:-6px;bottom:-8px;background:#fff;border:1px solid #cbd5e1;
  border-radius:10px;font-size:10px;line-height:1;padding:2px 5px;
}
.badge[data-zero="1"]{display:none}
.qbtn .last-contact{
  position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);
  font-size:9px;color:#6b7280;white-space:nowrap;background:transparent;
  padding:1px 3px;border-radius:4px;
}

/* Status buttons */
.sbtn{
  position:relative; border:none; padding:8px 10px; border-radius:12px;
  font-size:11px; background:transparent; white-space:nowrap; display:inline-flex; align-items:center; justify-content:center; opacity:.7;
  flex-direction:column; min-width:50px; transition:.15s ease;
}
.sbtn:hover{opacity:1; transform:translateY(-1px)}
.sbtn:focus-visible{outline:none; box-shadow:var(--ring)}
.sbtn .ico{font-size:18px;line-height:1}
.sbtn .label{display:none;font-size:10px;line-height:1;margin-top:3px;text-align:center}
.sbtn.active{outline:2px solid var(--green);opacity:1; background:transparent}
.sbtn.active .label{display:block}
.s-quote{background:#fffdf6;border-color:#fde68a}
.s-app{background:#f7fdf9;border-color:#ccebd9}
.s-sig{background:#fff7f8;border-color:#fecdd3}
.s-medq{background:#f6f5ff;border-color:#ddd6fe}
.s-pur{background:#f3fbf6;border-color:#cfe9dc}
.s-hot{background:#fff7ed;border-color:#fed7aa}
.sbtn.s-hot{
  border:1px solid #fed7aa;
  background:#fff7ed;
}
.sbtn.s-hot:hover{
  background:#fff1e6;
  opacity:1;
}
.sbtn.s-hot.active{
  outline:2px solid #fb923c;
  background:#fff1e6;
  opacity:1;
}

/* Tooltip (under icons) */
.has-tip{position:relative}
.has-tip::after{
  content:attr(data-tip);
  position:absolute; left:50%; transform:translateX(-50%);
  top:calc(100% + 6px); opacity:0; pointer-events:none;
  background:#111827; color:#fff; font-size:10px; line-height:1;
  padding:6px 8px; border-radius:6px; white-space:nowrap;
  box-shadow:0 6px 18px rgba(15,23,42,.18);
  transition:opacity .12s ease, transform .12s ease;
}
.has-tip:hover::after{opacity:.95; transform:translateX(-50%) translateY(2px)}

/* Schedule dropdown */
.sched-menu{
  position:absolute; z-index:1000; min-width:200px;
  background:var(--card); border:1px solid var(--line); box-shadow:var(--shadow);
  padding:6px; display:flex; flex-direction:column; border-radius:12px;
}
.sched-menu button{
  border:none; background:none; padding:10px 12px; text-align:left;
  font-size:14px; cursor:pointer; color:var(--ink); border-radius:10px;
}
.sched-menu button:hover{background:#f1f5ff; transform:none; box-shadow:none;}
.sched-menu button.selected{background:#f1f5ff;}

/* Status Progress Tracker - Domino's Style */
.status-tracker {
  display: flex;
  position: relative;
  padding: 15px 0;
  margin: 10px 0;
}

.status-tracker::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 25px;
  right: 25px;
  height: 1px;
  background: rgba(226, 232, 240, 0.5);
  z-index: 0;
}

.status-tracker::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 25px;
  height: 1px;
  background: rgba(16, 185, 129, 0.4);
  z-index: 0;
  transition: width 0.3s ease;
  width: 0;
}

.status-tracker[data-progress="0"]::after { width: calc(16.67% - 20px); }
.status-tracker[data-progress="1"]::after { width: calc(33.33% - 20px); }
.status-tracker[data-progress="2"]::after { width: calc(50% - 20px); }
.status-tracker[data-progress="3"]::after { width: calc(66.67% - 20px); }
.status-tracker[data-progress="4"]::after { width: calc(83.33% - 20px); }
.status-tracker[data-progress="5"]::after { width: calc(100% - 45px); }

/* No status selected */
.status-tracker[data-progress="-1"]::after { width: 0; }

.status-tracker .stage {
  flex: 1;
  text-align: center;
  position: relative;
  z-index: 1;
}

.status-tracker .stage-icon {
  width: 44px;
  height: 44px;
  margin: 0 auto 6px;
  border-radius: 50%;
  background: white;
  border: 3px solid var(--line);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.status-tracker .stage.completed .stage-icon {
  border-color: var(--line);
  background: #10b981;
  transform: scale(1.05);
}

.status-tracker .stage.active .stage-icon {
  border: 1px solid #059669;
  background: var(--orange);
  color: white;
}

.status-tracker .stage.active.purchased .stage-icon {
  border: 1px solid #059669;
  background: #10b981;
  color: white;
}


.status-tracker .stage-label {
  font-size: 10px;
  color: var(--muted);
  line-height: 1.2;
}

.status-tracker .stage.completed .stage-label,
.status-tracker .stage.active .stage-label {
  color: var(--ink);
  font-weight: 600;
}


/* Compact mode for status tracker */
.status-tracker.compact {
  padding: 0;
  margin: 0;
  min-width: 320px;
}

.status-tracker.compact::before {
  top: 22px;
  left: 20px;
  right: 20px;
  height: 1px;
}

.status-tracker.compact::after {
  top: 22px;
  transform: none;
}

.status-tracker.compact .stage-icon {
  width: 36px;
  height: 36px;
  font-size: 16px;
  cursor: pointer;
  transition: transform 0.2s;
}

.status-tracker.compact .stage-icon:hover {
  transform: scale(1.1);
}

.status-tracker.compact .stage-label {
  font-size: 9px;
  max-width: 50px;
  text-align: center;
  line-height: 1.1;
}

/* Notes area */
.notes{display:grid;margin-top:6px}
.notes textarea{
  min-height:64px;resize:vertical;padding:10px;border-radius:12px;background:#fff;
  box-shadow:inset 0 1px 0 rgba(15,23,42,.04)
}
.hidden{display:none}

/* Aging & touched badges */
.age-badge{
  display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;
  font-size:11px;font-weight:800;color:#fff;flex:0 0 auto; box-shadow:0 2px 6px rgba(15,23,42,.16)
}
.age-badge.orange{background:var(--orange)}
.age-badge.red{background:var(--red)}
.age-badge.sm{width:16px;height:16px;font-size:10px}
/* Green dot for touched today */
.touched-dot{
  display:inline-block;
  width:16px;
  height:16px;
  border-radius:50%;
  background:var(--success);
  margin-left:2px;
  vertical-align:middle;
}

/* Sidebar & widgets */
.sidebar{overflow-x:hidden;overflow-y:auto;max-height:calc(100vh - 28px)}
.sidebar h2{margin:0 0 8px;font-size:14px;font-weight:700}
.widget{margin-top:12px;padding-top:8px;border-top:1px dashed var(--line)}
.widget[draggable="true"]{cursor:grab}
.widget.dragging{opacity:.85}
.widget.drag-over{outline:2px dashed var(--info); border-radius:12px}
.widget-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
.widget-title{font-size:14px;margin:0}
.widget-actions{display:flex;gap:6px;align-items:center}
.collapse-btn{font-size:14px;line-height:1;padding:4px 8px;width:28px;text-align:center;border-radius:10px}
.collapse-btn::after{content:"–"}
.widget-body.hidden{display:none}

/* Drag zones for dual sidebar */
.sidebar-drag-zone{
  position:absolute; top:60px; bottom:20px; width:120px; z-index:999;
  background:linear-gradient(90deg, rgba(79,121,255,.15), rgba(79,121,255,.05));
  border:3px dashed var(--info); opacity:0; pointer-events:none;
  transition:opacity .2s ease; display:flex; align-items:center; justify-content:center; flex-direction:column;
  font-size:16px; color:var(--info); font-weight:bold;
}
.sidebar-drag-zone.left{left:20px; border-radius:12px}
.sidebar-drag-zone.right{right:20px; border-radius:12px}
.sidebar-drag-zone.active{opacity:1; pointer-events:auto; display:flex !important}
.sidebar-drag-zone::after{content:"📁 Drop Widget Here"}
.sidebar.drag-target{outline:3px dashed var(--info); background:rgba(79,121,255,.05)}

/* Progress Stats Bar */
.progress-stats{
  display:flex; align-items:center; justify-content:flex-start;
  padding:8px 20px; width:100%;
  background:linear-gradient(135deg, #f0f9ff, #ecfdf5);
  border:1px solid #bfdbfe; border-radius:8px; margin:6px 0;
  font-size:14px; color:#1f2937; flex-wrap:nowrap; gap:16px;
  min-height:36px; box-sizing:border-box;
}
.stat-group{
  display:flex; align-items:center; gap:6px; white-space:nowrap;
  flex-shrink:0;
}
.stat-group strong{
  color:#059669; font-weight:700;
}
.stat-separator{
  display:none;
}
.inline-progress{
  width:80px; height:6px; background:#e5e7eb; border-radius:3px;
  position:relative; margin-left:6px; box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);
  flex-shrink:0;
}
.progress-fill{
  height:100%; width:0%; background:linear-gradient(90deg, #10b981, #059669);
  border-radius:3px; transition:width 0.4s ease;
  box-shadow:0 1px 2px rgba(16,185,129,0.3);
}
.goal-input{
  width:60px; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px;
  font-size:14px; text-align:center; margin-left:6px;
  background:#ffffff; transition:border-color 0.2s; flex-shrink:0;
  min-width:40px;
}
.goal-input:focus{
  border-color:#3b82f6; outline:none; box-shadow:0 0 0 2px rgba(59,130,246,0.1);
}
.btn-save{
  padding:4px 12px; font-size:13px; border:1px solid #10b981; 
  border-radius:4px; background:#10b981; color:white; cursor:pointer;
  margin-left:6px; transition:background 0.2s; flex-shrink:0;
  white-space:nowrap;
}
.btn-save:hover{
  background:#059669;
}

/* Segmented progress for context goals */
.segmented-progress {
  display: flex;
  gap: 2px;
}
.segment {
  width: 6px;
  height: 14px;
  background: #dfdfdf;
  border-radius: 2px;
  transition: all 0.3s ease;
}
.segment.filled {
  background: #059669;
  box-shadow: 0 0 6px rgba(5,150,105,0.4);
  border: 1px solid rgba(16,185,129,0.3);
}


/* Trophy Icon Fill Progress for Life Apps */
.icon-progress {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.trophy-icon {
  position: relative;
  width: 20px;
  height: 20px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.trophy-base {
  position: absolute;
  font-size: 20px;
  opacity: 0.3;
}

.trophy-fill {
  position: absolute;
  font-size: 20px;
  background: linear-gradient(to top, #fbbf24 0%, #fbbf24 var(--fill), transparent var(--fill));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: saturate(1.5);
}

/* 7-Day Outreach History */
.outreach-history{
  display:flex; align-items:center; gap:8px;
  padding:6px 20px; font-size:12px; color:#6b7390;
  background:rgba(241,245,249,0.5); border-radius:6px; margin:0 0 6px;
}
.history-label{font-weight:600; color:#475569}
.history-days{display:flex; gap:6px}
.history-day{
  display:flex; flex-direction:column; align-items:center;
  padding:4px 6px; background:white; border:1px solid #e2e8f0; border-radius:4px;
  min-width:32px;
}
.history-day-name{font-size:10px; color:#94a3b8; margin-bottom:2px}
.history-day-count{font-weight:700; color:#1e293b}
.history-day.today{background:#dbeafe; border-color:#93c5fd}
.history-day.goal-met{background:#dcfce7; border-color:#86efac}

/* Goal Achievement Celebration */
.celebration{
  position:fixed; top:0; left:0; width:100%; height:100%; 
  pointer-events:none; z-index:9999; overflow:hidden;
}
.celebration.hidden{
  display:none;
}
.celebration-banner{
  position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
  background:linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
  background-size:400% 400%; animation:rainbow 1s ease-in-out infinite;
  padding:20px 40px; border-radius:15px; font-size:24px; font-weight:bold;
  color:white; text-shadow:2px 2px 4px rgba(0,0,0,0.3);
  box-shadow:0 10px 30px rgba(0,0,0,0.3); 
  animation:celebrationBounce 0.6s ease-out, rainbow 2s ease-in-out infinite;
}
.celebration-text{
  display:block; white-space:nowrap;
}
.confetti-container{
  position:absolute; top:0; left:0; width:100%; height:100%;
}
.confetti{
  position:absolute; width:10px; height:10px; background:#ff6b6b;
  animation:confettiFall 3s linear infinite;
}
.confetti:nth-child(2n){background:#feca57;}
.confetti:nth-child(3n){background:#48dbfb;}
.confetti:nth-child(4n){background:#ff9ff3;}
.confetti:nth-child(5n){background:#1dd1a1;}

@keyframes celebrationBounce{
  0%{transform:translate(-50%, -50%) scale(0) rotate(-180deg); opacity:0;}
  50%{transform:translate(-50%, -50%) scale(1.2) rotate(0deg); opacity:1;}
  100%{transform:translate(-50%, -50%) scale(1) rotate(0deg); opacity:1;}
}
@keyframes rainbow{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
@keyframes confettiFall{
  0%{transform:translateY(-100vh) rotate(0deg); opacity:1;}
  100%{transform:translateY(100vh) rotate(720deg); opacity:0;}
}

/* Purchase Celebration - Dollar Explosion */
.dollar-explosion{
  position:fixed;
  pointer-events:none;
  z-index:10000;
}
.dollar-particle{
  position:absolute;
  font-size:24px;
  font-weight:bold;
  color:#10b981;
  animation:explode 1.5s ease-out forwards;
  transform-origin:center;
}
@keyframes explode{
  0%{
    transform:translate(0, 0) scale(0) rotate(0deg);
    opacity:1;
  }
  50%{
    opacity:1;
  }
  100%{
    transform:translate(var(--dx), var(--dy)) scale(1) rotate(720deg);
    opacity:0;
  }
}

/* Context selector for adding in All view */
#addContextSelector {
  padding: 8px 12px;
  border: 1px solid #d1d5db;
  border-radius: 0 6px 6px 0;
  font-size: 14px;
  background: #f9fafb;
  cursor: pointer;
  margin-left: -1px;
  display: none;
  font-weight: 500;
  color: #374151;
  position: relative;
}

body[data-all-contexts="true"] #addContextSelector {
  display: inline-block;
}

body[data-all-contexts="true"] #globalSearch {
  border-radius: 6px 0 0 6px !important;
  border-right: none !important;
}

#addContextSelector:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

/* Context selector tooltip */
.context-tooltip {
  position: absolute;
  top: -35px;
  left: 50%;
  transform: translateX(-50%);
  background: #374151;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s;
  z-index: 1000;
}

.context-tooltip::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  border-top: 5px solid #374151;
}

.context-tooltip.show {
  opacity: 1;
}

/* Context Pills Switcher */
.context-pills {
  display: inline-flex;
  gap: 6px;
  background: #f1f5f9;
  padding: 4px;
  border-radius: 12px;
}

.context-pills button {
  padding: 7px 11px;
  border: none;
  background: transparent;
  border-radius: 8px;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
  color: #64748b;
  font-weight: 500;
  font-family: system-ui, -apple-system, sans-serif;
  line-height: 1.2;
}

.context-pills button:hover {
  background: rgba(255, 255, 255, 0.5);
}

.context-pills button.active {
  background: white;
  color: #1e293b;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.context-pills .pill-icon {
  font-size: 16px;
}

.context-pills .pill-label {
  font-size: 13px;
}

/* Context Group Headers */
.context-group {
  margin-bottom: 16px;
  position: relative;
}

/* Compact mode for All Contexts view */
body[data-all-contexts="true"] .row {
  padding: 6px 12px;
}

body[data-all-contexts="true"] .context-group {
  margin-bottom: 0;
}

body[data-all-contexts="true"] .context-group-header {
  padding: 6px 10px;
  font-size: 15px;
}

body[data-all-contexts="true"] .context-group > div:last-child {
  padding: 4px;
}

.context-group-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: linear-gradient(90deg, #10b981, #059669);
  border: 1px solid #10b981;
  border-radius: 12px 12px 0 0;
  margin-bottom: 0;
  font-weight: 700;
  font-size: 15px;
  color: white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  position: sticky;
  top: -1px;
  z-index: 100;
}

.context-group-title {
  display: flex;
  align-items: center;
  gap: 8px;
}

.context-group-title > span:first-child {
  font-size: 14px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.context-group-controls {
  display: flex;
  gap: 6px;
}

.context-group-controls button {
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 4px;
  padding: 2px 6px;
  cursor: pointer;
  font-size: 12px;
  line-height: 1;
  transition: all 0.2s;
  color: #1e293b;
  font-weight: 600;
}

.context-group-controls button:hover {
  background: white;
  border-color: white;
  transform: scale(1.05);
}

.context-group-controls button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
}

.context-group-count {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.8);
  font-weight: 500;
  margin-left: 4px;
  background: rgba(0, 0, 0, 0.2);
  padding: 2px 6px;
  border-radius: 10px;
}

.context-group > div:last-child {
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 12px 12px;
  padding: 8px;
  background: rgba(255, 255, 255, 0.5);
}

/* Delete Undo Notification */
.delete-undo-notification {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #1e293b;
  color: white;
  padding: 12px 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 10000;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    transform: translateX(-50%) translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
}

.delete-undo-notification button {
  background: #3b82f6;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

.delete-undo-notification button:hover {
  background: #2563eb;
}

.delete-undo-countdown {
  font-weight: 600;
  color: #fbbf24;
}

/* Activity */
.activity{max-height:30vh;overflow:auto}
.activity .item{
  display:grid;grid-template-columns:56px 1fr;gap:8px;padding:8px 0;border-bottom:1px dashed var(--line);position:relative
}
.activity .item:last-child{border-bottom:none}
.activity .undo{
  position:absolute;right:0;top:50%;transform:translateY(-50%);
  opacity:0;transition:opacity .12s;background:#e8f0ff;border:1px solid #cbd5e1;color:#0f172a;
  padding:5px 8px;font-size:11px;cursor:pointer;border-radius:10px
}
.activity .item:hover .undo{opacity:1}

/* Micro viz */
.chart{height:100px;display:flex;gap:6px;align-items:flex-end;margin-top:8px}
.bar{flex:1;background:#dbe6ff;border-radius:6px 6px 0 0}
.barlab{font-size:10px;color:#6b7390;text-align:center;margin-top:4px}
.heatmap{display:grid;grid-template-columns:repeat(13,10px);gap:4px}
.cell{width:10px;height:10px;background:#eef2ff;border:1px solid #e5e7eb;border-radius:2px}
.cell.l1{background:#dbeafe}.cell.l2{background:#bfdbfe}.cell.l3{background:#93c5fd}.cell.l4{background:#60a5fa}

/* Lists in sidebar */
.nextlist,.followups{display:grid;gap:8px}
.nextitem,.followitem{
  display:flex;justify-content:space-between;align-items:center;border:1px dashed var(--line);
  padding:6px 8px;background:#fff;border-radius:12px
}

/* Quote */
.quote{font-style:italic;color:#334155;font-size:15px;padding:8px;border-radius:12px;background:color-mix(in oklab, var(--card) 92%, #f0f4ff)}
.quote small{display:block;color:#6b7280;margin-top:4px}

/* Today queue */
.queue-block{margin:10px 0 12px;padding:8px;border:1px dashed var(--line);background:#fff;border-radius:12px}
.queue-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.queue-title{font-weight:800}

/* Today's section styling */
#todayBlock {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.03) 100%);
  border: 2px solid rgba(59, 130, 246, 0.25);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.08);
}

#todayBlock h2 {
  color: #2563eb;
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

#todayBlock h2::before {
  content: "📅";
  font-size: 20px;
}

#todayBlock .table-head {
  background: rgba(59, 130, 246, 0.08);
  border: 1px solid rgba(59, 130, 246, 0.15);
  color: #1e40af;
  font-weight: 600;
}

#todayBlock .row {
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(59, 130, 246, 0.12);
  margin-bottom: 4px;
  cursor: pointer;
  position: relative;
  z-index: 1;
}

#todayBlock .row:hover {
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15), 0 2px 4px rgba(59, 130, 246, 0.08);
  transform: translateY(-1px);
  transition: all 0.2s ease;
}

#todayBlock .row.selected {
  outline: 2px solid var(--green);
  outline-offset: -1px;
}

/* Icon buttons row (📝 📅 📂 🗑) */
.iconbtn{
  position:relative;border:none;background:transparent;
  cursor:pointer;font-size:16px;line-height:1;padding:8px 10px;
  display:inline-flex;align-items:center;justify-content:center;min-width:42px;border-radius:12px
}
.iconbtn:focus-visible{outline:none; box-shadow:var(--ring)}
.group--icons .iconbtn{border:none;background:transparent}

/* Chips */
.tag-chip{
  display:inline-block;border:1px solid #cbd5e1;background:#f8fafc;font-size:11px;
  padding:2px 6px;margin-left:4px;white-space:nowrap;flex-shrink:0;border-radius:999px;
  position:relative;
}
.tag-chip.scheduled{
  padding-right:8px;
}
.tag-chip.purchased-chip{
  background:#e9f5ee;
  color:#0e7a5a;
  border-color:#0e7a5a;
  font-weight:600;
}
.tag-chip.scheduled .unschedule-x{
  display:none;
  position:absolute;
  right:2px;
  top:-2px;
  background:#dc2626;
  color:white;
  border-radius:50%;
  width:14px;
  height:14px;
  line-height:14px;
  text-align:center;
  font-size:10px;
  cursor:pointer;
  font-weight:bold;
}
.tag-chip.scheduled:hover .unschedule-x{
  display:block;
}

/* Density switch */
body[data-density="comfortable"] .row{padding:8px 12px}
body[data-density="comfortable"] .name{font-size:16px}

body[data-density="compact"] .row{padding:2px 8px}
body[data-density="compact"] .name{font-size:14px}
body[data-density="compact"] .notes-preview{font-size:11px}
body[data-density="compact"] .group--quick{gap:6px; margin-right:6px}
body[data-density="compact"] .group--status{gap:6px; margin-right:6px}
body[data-density="compact"] .iconbtn{min-width:34px; padding:4px 6px; font-size:14px}
body[data-density="compact"] .qbtn{min-width:36px; padding:4px 6px; font-size:14px}
body[data-density="compact"] .sbtn{min-width:38px; padding:4px 6px}
body[data-density="compact"] .sbtn .ico{font-size:16px}
body[data-density="compact"] .sbtn .label{display:none} /* Hide labels in compact mode */
body[data-density="compact"] .status-tracker .stage-label{display:none} /* Hide status tracker labels in compact */

/* Titles-only density mode */
body[data-density="titles-only"] .row{padding:3px 8px}
body[data-density="titles-only"] .name{font-size:14px}
body[data-density="titles-only"] .notes-preview{display:none}
body[data-density="titles-only"] .lastmeta{display:none}
body[data-density="titles-only"] .stamp{display:none}
body[data-density="titles-only"] .group--quick{gap:6px; margin-right:10px}
body[data-density="titles-only"] .group--status{gap:6px; margin-right:10px}
body[data-density="titles-only"] .qbtn{min-width:32px; padding:3px 5px; font-size:14px}
body[data-density="titles-only"] .sbtn{min-width:34px; padding:3px 5px; font-size:10px}
body[data-density="titles-only"] .sbtn .ico{font-size:14px}
body[data-density="titles-only"] .iconbtn{min-width:30px; padding:3px 5px; font-size:12px}
body[data-density="titles-only"] .sbtn .label{display:none}
body[data-density="titles-only"] .qbtn .badge{font-size:8px; padding:1px 3px}
body[data-density="titles-only"] .qbtn .last-contact{display:none}
body[data-density="titles-only"] .touchCount{display:none}
body[data-density="titles-only"] .status-tracker{gap:10px}
body[data-density="titles-only"] .status-tracker::before{display:none} /* Hide background line */
body[data-density="titles-only"] .status-tracker::after{display:none} /* Hide progress line */
body[data-density="titles-only"] .status-tracker .stage-icon{display:none} /* Hide icons in titles-only */
body[data-density="titles-only"] .status-tracker .stage-label{
  font-size: 11px;
  font-weight: 600;
  display: inline-block;
  min-width: 60px;
  text-align: center;
  cursor: pointer;
}

/* Stage label styles for titles-only mode */
body[data-density="titles-only"] .stage-label {
  border-bottom: 2px solid #e5e7eb; /* Light gray underline for inactive */
  padding: 2px 4px 4px 4px;
  font-weight: 600;
  color: #6b7280;
  transition: all 0.2s ease;
}

/* Active/completed stage labels */
body[data-density="titles-only"] .stage.active .stage-label,
body[data-density="titles-only"] .stage.completed .stage-label {
  border-bottom: 2px solid #ffd93d; /* Yellow underline for active/completed */
  color: #1e293b;
  font-weight: 700;
}


/* Responsive */
/* Medium screens - better layout for 1400x900 */
@media (min-width:1151px) and (max-width:1450px){
  #sidebar-controls{
    flex:0 0 auto;
  }
}

/* Large screens - bigger status icons for screens 1680px and wider */
@media (min-width: 1680px) {
  /* Default comfortable mode gets larger icons on wide screens */
  body[data-density="comfortable"] .status-tracker .stage-icon,
  body[data-density="comfortable"] .status-tracker.compact .stage-icon {
    width: 53px;
    height: 53px;
    font-size: 22px;
  }

  body[data-density="comfortable"] .status-tracker .stage-label,
  body[data-density="comfortable"] .status-tracker.compact .stage-label {
    font-size: 11px;
  }

  /* More spacing between stages to clearly show green line */
  body[data-density="comfortable"] .status-tracker {
    gap: 12px;
  }

  /* Progress lines disabled */

  /* Scale up further with font size adjustments on large screens */
  body[data-density="comfortable"][data-font-size="xsmall"] .status-tracker .stage-icon { width: 44px; height: 44px; font-size: 16px; }
  body[data-density="comfortable"][data-font-size="small"] .status-tracker .stage-icon { width: 48px; height: 48px; font-size: 18px; }
  body[data-density="comfortable"][data-font-size="medium"] .status-tracker .stage-icon { width: 53px; height: 53px; font-size: 22px; }
  body[data-density="comfortable"][data-font-size="large"] .status-tracker .stage-icon { width: 58px; height: 58px; font-size: 25px; }
  body[data-density="comfortable"][data-font-size="xlarge"] .status-tracker .stage-icon { width: 64px; height: 64px; font-size: 28px; }

  /* Line position adjustments disabled */

  /* Hot icon sizes for large screens to match stage icons */
  body[data-density="comfortable"] .row .sbtn.s-hot .ico { font-size: 22px; }
  body[data-density="comfortable"][data-font-size="xsmall"] .row .sbtn.s-hot .ico { font-size: 16px; }
  body[data-density="comfortable"][data-font-size="small"] .row .sbtn.s-hot .ico { font-size: 18px; }
  body[data-density="comfortable"][data-font-size="medium"] .row .sbtn.s-hot .ico { font-size: 22px; }
  body[data-density="comfortable"][data-font-size="large"] .row .sbtn.s-hot .ico { font-size: 25px; }
  body[data-density="comfortable"][data-font-size="xlarge"] .row .sbtn.s-hot .ico { font-size: 28px; }
}

@media (max-width:1150px){
  .app{grid-template-columns:1fr;grid-template-areas:"main" "side";padding:10px}
  .table-head,.row{grid-template-columns:1fr}
  .actions-wrap{justify-content:flex-start}
  .sidebar{max-height:52vh}
}


</style>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-N5DXZ4MC');</script>
<!-- End Google Tag Manager -->
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N5DXZ4MC"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div class="app" id="appRoot">
  <!-- ===== DRAG ZONES ===== -->
  <div class="sidebar-drag-zone left" id="leftDragZone"></div>
  <div class="sidebar-drag-zone right" id="rightDragZone"></div>
  
  <!-- Goal Achievement Celebration -->
  <div id="celebration" class="celebration hidden">
    <div class="celebration-banner">
      <span class="celebration-text">🎉 DAILY GOAL ACHIEVED! 🎉</span>
    </div>
    <div class="confetti-container" id="confettiContainer"></div>
  </div>

  <!-- Purchase Celebration Audio -->
  <audio id="chachingSound" preload="auto">
    <source src="sounds/cash-register-kaching-376867.wav" type="audio/wav">
  </audio>
  
  <!-- ===== LEFT SIDEBAR (for drag and drop dual sidebar only) ===== -->
  <aside class="card sidebar left-sidebar" id="leftSidebar" style="display:none;">
    <!-- Widgets can be dragged here for dual sidebar layout -->
  </aside>
  
  <!-- ===== MAIN LIST ===== -->
  <section class="card">
    <header>
      <div style="display:flex;flex-direction:column;gap:8px;width:100%">
        <div style="display:flex; align-items:center; justify-content:center; gap:12px; position:relative;">
          <h1 id="hotlistTitle" class="flame-title" style="position:absolute; left:0;">
            <span id="contextName">Life</span> Hotlist 🔥
          </h1>
          <div id="authStatus" style="position:absolute; right:0; font-size:11px; color:var(--muted);"></div>
          <div id="contextPills" class="context-pills">
            <button data-context="all">
              <span class="pill-icon">📊</span>
              <span class="pill-label">All</span>
            </button>
            <button data-context="life" class="active">
              <span class="pill-icon">❤️</span>
              <span class="pill-label">Life</span>
            </button>
            <button data-context="home_auto">
              <span class="pill-icon">🏠</span>
              <span class="pill-label">H&A</span>
            </button>
            <button data-context="commercial">
              <span class="pill-icon">🏢</span>
              <span class="pill-label">Comm</span>
            </button>
            <button data-context="farm">
              <span class="pill-icon">🚜</span>
              <span class="pill-label">Farm</span>
            </button>
            <button data-context="networking">
              <span class="pill-icon">🤝</span>
              <span class="pill-label">Network</span>
            </button>
          </div>
        </div>
        <div id="errorBanner" class="error-banner"></div>

        <!-- Daily Outreach Progress Bar -->
        <div class="progress-stats">
          <div class="stat-group">
            <strong>Daily Outreach:</strong>
            <span id="dailyOutreachLabel">0 / 10</span>
            <div class="inline-progress" id="dailyOutreachBar">
              <div class="progress-fill" id="dailyOutreachFill"></div>
            </div>
          </div>
          <div class="stat-separator">|</div>
          <div class="stat-group">
            <strong>Calls:</strong>
            <span id="dailyCalls">0</span>
          </div>
          <div class="stat-separator">|</div>
          <div class="stat-group">
            <strong>Messages:</strong>
            <span id="dailyMessages">0</span>
          </div>
          <div class="stat-separator">|</div>
          <div class="stat-group">
            <strong>Goal:</strong>
            <input type="number" class="goal-input" id="dailyOutreachGoal" value="10" min="1" max="100" style="width:35px; padding:2px 4px; font-size:12px;">
            <button class="btn-save" id="saveDailyGoal" style="padding:2px 6px; margin-left:4px; font-size:11px;">Set</button>
          </div>
          <div class="stat-separator" id="contextGoalSeparator">|</div>
          <div class="stat-group" id="contextGoalGroup" style="background:#e9f5ee; padding:4px 8px; border-radius:6px; display:flex; align-items:center; gap:8px;">
            <strong style="color:#0e7a5a;" id="contextGoalLabel">Life Apps Goal:</strong>
            <span style="color:#0e7a5a; font-weight:700; margin-right:4px;" id="contextGoalCurrent">0</span>
            <div class="segmented-progress" id="contextGoalSegments" style="display:flex; gap:2px;">
              <!-- Segments will be dynamically generated -->
            </div>
            <span style="color:#0e7a5a; margin-left:4px;" id="contextGoalMax">5</span>
            <input type="number" class="goal-input" id="monthlyAppsGoal" value="5" min="1" max="20" style="width:35px; padding:2px 4px; font-size:12px; margin-left:8px;">
            <button class="btn-save" id="saveMonthlyGoal" style="padding:2px 6px; margin-left:4px; font-size:11px;">Set</button>
          </div>
        </div>

        <!-- All controls in single row below daily outreach -->
        <div class="controls" style="margin:0;padding:0;">
          <div class="stack" style="flex-wrap:nowrap;align-items:center;">
            <input id="globalSearch" type="text" placeholder="Search clients or add new (press Enter)" style="min-width:160px;flex:1;" />
            <select id="addContextSelector" title="Select context for new client">
              <option value="" disabled selected>Select context</option>
              <option value="life">❤️ Life</option>
              <option value="home_auto">🏠 Home & Auto</option>
              <option value="commercial">🏢 Commercial</option>
              <option value="farm">🚜 Farm</option>
              <option value="networking">🤝 Networking</option>
            </select>
            <label class="small">Sort
              <select id="sortBy">
                <option value="lastTouch">Last touched</option>
                <option value="createdAt">Date added</option>
                <option value="name">Name</option>
                <option value="none">No Sort</option>
              </select>
            </label>
            <label class="small">Density
              <select id="densitySelect">
                <option value="comfortable">Comfortable</option>
                <option value="compact">Compact</option>
                <option value="titles-only">Titles only</option>
              </select>
            </label>
            <div style="display:flex;gap:2px;align-items:center;">
              <button id="fontSizeDown" class="btn-min gray" title="Decrease font size" style="padding:4px 8px;font-weight:bold;">−</button>
              <span id="fontSizeLabel" style="font-size:11px;color:var(--muted);min-width:20px;text-align:center;">M</span>
              <button id="fontSizeUp" class="btn-min gray" title="Increase font size" style="padding:4px 8px;font-weight:bold;">+</button>
            </div>
            <button id="toggleSidebarBtn" class="btn-min gray" title="Toggle Sidebar" style="padding:4px 8px;">◧</button>
            <div id="sidebar-controls" style="display:flex; gap:2px;"></div>
            <button id="importBtn" class="btn-min gray" title="Import Clients" style="padding:4px 8px;">📥</button>
            <button id="exportBtn" class="btn-min gray" title="Export Clients" style="padding:4px 8px;">📤</button>
            <button id="essentialQuestionsBtn" class="btn-min gray" title="Essential Questions" style="padding:4px 8px;">💡</button>
          </div>
        </div>
      </div>
    </header>


    <div id="todayBlock" class="section hidden">
      <h2>Today</h2>
      <div id="todayList"></div>
    </div>

    <div id="emptyState" style="display:none;"></div>

    <div id="clearDemoSection" style="display:none; text-align:center; margin:20px 0;">
      <button id="clearDemoBtn" class="btn-min orange" onclick="clearDemoData()" style="padding:8px 16px;">
        🗑️ Clear Demo Data
      </button>
      <p style="margin:8px 0 0 0; font-size:0.9em; color:var(--muted);">
        Remove the 3 demo clients to start fresh
      </p>
    </div>

    <div class="table-head" id="mainTableHead">
      <div>Client • Notes</div>
      <div>Actions</div>
    </div>
    <div id="list"></div>

    <div id="scheduledBlock" class="section hidden">
      <h2>Scheduled</h2>
      <div class="table-head"><div>Client • Notes</div><div>Actions</div></div>
      <div id="scheduledList"></div>
    </div>

    <div id="archivedBlock" class="hidden section">
      <h2>Archived</h2>
      <div id="archivedList"></div>
    </div>

    <!-- Shortcuts section at bottom of main content -->
    <div class="shortcuts-section" id="shortcutsSection" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
      <div>
        <strong style="color:#475569">Shortcuts:</strong> ↑/↓ or J/K navigate • 1–5 status • <b>0</b> clear • N notes • A call • L message • <b>Shift+A/L</b> remove • <b>H</b> hot • <b>F</b> today • <b>D</b> tomorrow • <span style="opacity:0.7; font-weight:600">⌘/ for help</span>
      </div>
      <div style="display:flex; align-items:center; gap:16px; font-size:12px; color:#64748b;">
        <a href="#" onclick="showChangelogModal(); return false;" style="color:#3b82f6; text-decoration:none; hover:text-decoration:underline;">v<span id="versionNumber">1.0.0</span></a>
        <span style="color:#cbd5e1;">|</span>
        <!-- Cloud sync hidden for now -->
        <a href="#" onclick="showSignInDialog(); return false;" style="color:#3b82f6; text-decoration:none; hover:text-decoration:underline; display:none;" id="cloudSyncLink">Cloud sync</a>
        <span style="color:#cbd5e1; display:none;" id="cloudSyncSeparator">|</span>
        <a href="#" onclick="openSuggestEmail(); return false;" style="color:#3b82f6; text-decoration:none; hover:text-decoration:underline;">Suggest a change</a>
      </div>
    </div>
  </section>

  <!-- ===== SIDEBAR WIDGETS ===== -->
  <aside class="card sidebar" id="sidebarWidgets">
    <div class="widget" data-key="powerHour" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Power Hour</h2><div class="widget-actions"><button class="btn-min gray" id="hopReset">Reset</button></div></div>
      <div class="widget-body"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div><span id="hopClock" class="small muted">01:00:00</span></div><div class="small muted">Calls this session: <b id="hopCalls">0</b></div></div><div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center"><button class="btn-primary" id="hopStart">Start</button><button class="btn-min gray" id="hopPause">Pause</button></div></div>
    </div>

    <div class="widget" data-key="settings" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Settings</h2><div class="widget-actions"><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div style="display:grid;gap:6px">
        <label>Status filter
          <select id="statusFilter"><option value="">Any status</option><option>Sent Quote</option><option>Sent Application</option><option>Pending Application Signature</option><option>Pending Medical Questionnaire</option><option>Issued</option></select>
        </label>
        <label><input id="showArchived" type="checkbox" /> Show archived</label>
        <label class="small"><input id="groupToggle" type="checkbox" /> Group today's activity by client</label>
        <label class="small">Aging threshold (business days)
          <select id="ageDays"><option>2</option><option>4</option><option>6</option><option>8</option></select>
        </label>
        <label class="small">Calendar events
          <select id="calendarMethod">
            <option value="google">Google Calendar</option>
            <option value="outlook">Outlook Calendar</option>
            <option value="ics">Download ICS file</option>
          </select>
        </label>
      </div></div>
    </div>

    <div class="widget" data-key="scheduled" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Scheduled</h2><div class="widget-actions"><button class="btn-min gray" id="calendarViewBtn" title="Calendar View">📅</button><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="followList" class="followups"></div></div>
    </div>

    <div class="widget" data-key="summaryReport" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Activity Chart</h2><div class="widget-actions"><select id="chartRangeSel" style="font-size:12px; padding:2px 4px; margin-right:8px;"><option value="7" selected>7d</option><option value="14">14d</option><option value="30">30d</option><option value="60">60d</option><option value="90">90d</option></select><button class="btn-min gray" id="emailSummaryBtn">Email</button><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body">
        <div id="chart" style="display:flex; align-items:flex-end; height:120px; gap:4px; padding:10px 0;"></div>
      </div>
    </div>

    <!-- Activity Chart widget removed but data preserved -->

    <div class="widget" data-key="heatmap" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Heatmap (90d)</h2><div class="widget-actions"><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="heatmap" class="heatmap"></div></div>
    </div>

    <div class="widget" data-key="kpis" draggable="true">
      <div class="widget-head"><h2 class="widget-title">KPIs</h2><div class="widget-actions"><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="kpis" class="kpis-widget"></div></div>
    </div>

    <div class="widget" data-key="pipeline" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Pipeline</h2><div class="widget-actions"><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="pipeline" class="small"></div></div>
    </div>

    <div class="widget" data-key="nextTouch" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Next to Touch</h2><div class="widget-actions"><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="nextList" class="nextlist"></div></div>
    </div>


    <div class="widget" data-key="todayActivity" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Today's Activity</h2><div class="widget-actions"><button class="btn-min gray" id="emailTodayDetailBtn">Email Today</button><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div class="small muted" id="todayDate"></div><div class="activity" id="activity"></div></div>
    </div>

    <div class="widget" data-key="motivation" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Motivation</h2><div class="widget-actions"><button class="btn-min gray" id="quotesEditBtn">Edit quotes</button><button class="btn-min gray" id="quotesNextBtn">Next</button><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="quoteView" class="quote">Add quotes to get started.</div><div class="small muted" id="quoteMeta" style="margin-top:4px"></div><div id="quoteEditor" class="hidden" style="margin-top:8px"><div class="small muted" style="margin-bottom:8px; color:#4b5563;">📝 Enter one quote per line • Empty lines will be ignored • <span id="quoteCount" style="font-weight:600;">0 quotes</span></div><div style="position:relative;"><textarea id="quotesTextarea" style="width:100%; min-height:300px; max-height:500px; padding:12px 12px 12px 30px; border:2px solid #e5e7eb; border-radius:8px; font-size:13px; line-height:2.2; resize:vertical; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; white-space:pre-wrap; word-wrap:break-word;"></textarea><div id="quoteBullets" style="position:absolute; left:10px; top:12px; color:#9ca3af; font-size:13px; line-height:2.2; pointer-events:none;"></div></div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px"><div class="small muted">Rotate every <select id="quoteInterval" style="padding:2px 4px; border:1px solid #d1d5db; border-radius:4px;"><option value="5">5</option><option value="10">10</option><option value="15" selected>15</option><option value="30">30</option><option value="60">60</option></select> min • <label style="cursor:pointer;"><input type="checkbox" id="quoteRandom" checked> Shuffle</label> • <label style="cursor:pointer;"><input type="checkbox" id="quoteNoRepeat" checked> Avoid repeats</label></div><div><button class="btn-primary" id="quotesSaveBtn" style="padding:6px 16px;">Save Quotes</button><button class="btn-min gray" id="quotesCancelBtn" style="margin-left:8px;">Cancel</button></div></div></div></div>
    </div>
  </aside>
</div>

<!-- Part B goes right below -->
<!-- Part B — JS logic (save as part-b.js or inline under Part A) -->
<script>
// Apply density and font size immediately (before IIFE to ensure earliest possible execution)
(function() {
  function getCookieEarly(name) {
    var value = "; " + document.cookie;
    var parts = value.split("; " + name + "=");
    if (parts.length == 2) return parts.pop().split(";").shift();
    return null;
  }
  document.body.setAttribute('data-density', getCookieEarly('density') || 'comfortable');
  document.body.setAttribute('data-font-size', getCookieEarly('fontSize') || 'medium');
})();

(function(){
  /* =========================
   *  Version & Changelog
   * ========================= */
  var VERSION = '2.4.0';

  // Supabase Configuration (will be null until user provides credentials)
  var SUPABASE_URL = null;  // Will be set from localStorage or user input
  var SUPABASE_ANON_KEY = null;  // Will be set from localStorage or user input
  var supabase = null;  // Supabase client instance
  var currentUser = null;  // Current authenticated user
  var syncEnabled = false;  // Whether to sync to cloud

  // Initialize Supabase if credentials exist
  function initSupabase() {
    var storedUrl = localStorage.getItem('hotlistSupabaseUrl');
    var storedKey = localStorage.getItem('hotlistSupabaseAnonKey');

    if (storedUrl && storedKey && window.supabase) {
      SUPABASE_URL = storedUrl;
      SUPABASE_ANON_KEY = storedKey;
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      checkAuthStatus();
    }
  }

  // Check if user is signed in
  async function checkAuthStatus() {
    if (!supabase) return;

    try {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      if (user) {
        syncEnabled = true;
        updateAuthUI();

        // Check if this is first sync - if cloud is empty, migrate local data
        const cloudData = await loadFromCloud();
        if (!cloudData) {
          console.log('First sync - migrating local data to cloud');
          // Get existing local data
          var localData = localStorage.getItem(STABLE_KEY);
          if (localData) {
            try {
              var parsedData = JSON.parse(localData);
              await saveToCloud(parsedData);
              console.log('Local data migrated to cloud successfully');
            } catch (e) {
              console.error('Failed to migrate local data:', e);
            }
          }
        } else {
          // Cloud has data - ask user if they want to use cloud or keep local
          if (confirm('Cloud data found. Use cloud data? (Cancel to keep local data)')) {
            state = coerceState(cloudData);
            save(state);
            render();
          }
        }
      }
    } catch (error) {
      console.log('Auth check failed:', error);
    }
  }

  // Sign in with email (magic link)
  async function signInWithEmail(email) {
    if (!supabase) {
      alert('Please configure Supabase first');
      return;
    }

    try {
      const { error } = await supabase.auth.signInWithOtp({
        email: email,
        options: {
          emailRedirectTo: window.location.origin
        }
      });

      if (error) throw error;
      alert('Check your email for the login link!');
    } catch (error) {
      console.error('Sign in error:', error);
      alert('Sign in failed: ' + error.message);
    }
  }

  // Sign out
  async function signOut() {
    if (!supabase) return;

    try {
      await supabase.auth.signOut();
      currentUser = null;
      syncEnabled = false;
      updateAuthUI();
      // Continue using local storage
      console.log('Signed out - continuing with local storage');
    } catch (error) {
      console.error('Sign out error:', error);
    }
  }

  // Save to cloud (for signed-in users)
  async function saveToCloud(data) {
    if (!supabase || !currentUser || !syncEnabled) return;

    try {
      const { error } = await supabase
        .from('hotlist_data')
        .upsert({
          user_id: currentUser.id,
          data: JSON.stringify(data),
          updated_at: new Date().toISOString()
        }, {
          onConflict: 'user_id'
        });

      if (error) throw error;
    } catch (error) {
      console.error('Cloud save failed:', error);
    }
  }

  // Load from cloud
  async function loadFromCloud() {
    if (!supabase || !currentUser) return null;

    try {
      const { data, error } = await supabase
        .from('hotlist_data')
        .select('data')
        .eq('user_id', currentUser.id)
        .single();

      if (error) throw error;
      return data ? JSON.parse(data.data) : null;
    } catch (error) {
      console.error('Cloud load failed:', error);
      return null;
    }
  }

  // Update UI based on auth status
  function updateAuthUI() {
    // This will be called to update the UI when auth status changes
    var authStatus = document.getElementById('authStatus');
    var cloudSyncLink = document.getElementById('cloudSyncLink');

    if (currentUser) {
      // Update header status
      if (authStatus) {
        authStatus.innerHTML = '☁️ Synced • <a href="#" onclick="signOut(); return false;" style="color:var(--muted); text-decoration:underline;">Sign out</a>';
      }
      // Update footer link
      if (cloudSyncLink) {
        cloudSyncLink.innerHTML = '☁️ Synced';
        cloudSyncLink.onclick = function() {
          if (confirm('Sign out from cloud sync?')) {
            signOut();
          }
          return false;
        };
      }
    } else {
      // Clear header status
      if (authStatus) {
        authStatus.innerHTML = '';
      }
      // Reset footer link
      if (cloudSyncLink) {
        cloudSyncLink.innerHTML = 'Cloud sync';
        cloudSyncLink.onclick = function() {
          showSignInDialog();
          return false;
        };
      }
    }
  }

  // Recent commits from git log
  var CHANGELOG = [
    { version: '2.4.0', date: '2025-01-23', changes: 'Added context-specific monthly goals with segmented progress indicators, improved quotes editor with bullet points and better visual spacing, fixed aging threshold saving, added compact mode tooltips for all icons appearing below with high z-index, daily outreach now counts unique clients only, added titles-only density mode with underlined text labels' },
    { version: '2.3.1', date: '2025-01-21', changes: 'Improved All Contexts view layout by removing spacing between context groups for a more compact design' },
    { version: '2.3.0', date: '2025-01-21', changes: 'Enhanced scheduling with 30-minute calendar integration and direct Google Calendar support, improved status tracker with 1px borders and cleaner icon styling, distinctive Today\'s queue styling with blue theme, refined UI with shadow-based hover effects, fixed context switching and row selection, changed Commercial "Lead" to "Contact", default clients start with no status' },
    { version: '2.2.0', date: '2025-01-19', changes: 'Add optional cloud sync with Supabase (local storage remains default), add left/right arrow keys for stage navigation' },
    { version: '2.1.1', date: '2025-01-19', changes: 'Improve context selector styling to be more subtle (black/gray instead of orange), fix name preservation when forgetting to select context in All view' },
    { version: '2.1.0', date: '2025-01-19', changes: 'Replace dropdown with pill-style context switcher, add last contact dates, improve All Contexts view with reorderable groups, enable adding clients in All view, change "Issued" to "Issued" across all contexts' },
    { version: '2.0.0', date: '2025-01-18', changes: 'Add multi-context support for Life, Home & Auto, Commercial, Farm, and Networking with context-specific stages' },
    { version: '1.10.9', date: '2025-01-18', changes: 'Fix drag-and-drop in incognito/production by defaulting to no-sort when no cookie exists' },
    { version: '1.10.8', date: '2025-01-18', changes: 'Add Google Tag Manager integration (GTM-N5DXZ4MC) and standardize iconbtn sizes' },
    { version: '1.10.7', date: '2025-01-18', changes: 'Standardize group icon sizes with 18px minimum and 2px increments (18/20/22/24/26px)' },
    { version: '1.10.6', date: '2025-01-18', changes: 'Add extra small (XS) font size option while keeping client names and group icons readable' },
    { version: '1.10.5', date: '2025-01-18', changes: 'Match hot icon sizing with stage icons across all font sizes and screen sizes' },
    { version: '1.10.4', date: '2025-01-18', changes: 'Fix drag-and-drop, improve header layout, and enhance daily outreach bar' },
    { version: '1.10.3', date: '2025-01-18', changes: 'Add responsive status icons for large screens (1680px+) with progressive scaling' },
    { version: '1.10.2', date: '2025-01-18', changes: 'Fix drag-and-drop initialization and improve drag visual to show only client name' },
    { version: '1.10.1', date: '2025-01-18', changes: 'Remove drag cursor on hover - only show when actively dragging' },
    { version: '1.10.0', date: '2025-01-18', changes: 'Add drag-and-drop support for manual client reordering when "No Sort" is selected' },
    { version: '1.9.2', date: '2025-01-18', changes: 'Default sort option to "No Sort" to maintain client order' },
    { version: '1.9.1', date: '2025-01-18', changes: 'Fix font size adjustment to include all row icons, reset font size when changing density' },
    { version: '1.9.0', date: '2025-01-18', changes: 'Add font size adjustment buttons, cookie-based sort preference, and "No Sort" option to prevent client reordering' },
    { version: '1.8.8', date: '2025-01-18', changes: 'Fix keyboard navigation wrapping - stop at top when pressing k instead of jumping to bottom' },
    { version: '1.8.7', date: '2025-01-17', changes: 'Fix Windows PWA icon by reverting to emoji fire icon with rounded corners' },
    { version: '1.8.6', date: '2025-01-17', changes: 'Revert favicon to emoji fire while keeping PWA icon as custom SVG' },
    { version: '1.8.5', date: '2025-01-17', changes: 'Add custom fire icon for PWA installation replacing emoji icon' },
    { version: '1.8.4', date: '2025-01-17', changes: 'Adjust row padding for comfortable (8px 12px) and compact (2px 8px) modes' },
    { version: '1.8.3', date: '2025-01-17', changes: 'Remove ultra-compact mode, simplify to 2 density options, fix density select display' },
    { version: '1.8.2', date: '2025-01-17', changes: 'Switch to cookie-based density persistence for cache-resistant settings' },
    { version: '1.8.1', date: '2025-01-17', changes: 'Add demo data system with Load Demo button for first-time users' },
    { version: '1.8.0', date: '2025-01-16', changes: 'Implement IndexedDB persistent storage, fix celebration logic, add storage management tools' },
    { version: '1.7.2', date: '2025-01-16', changes: 'Redesign celebrations, fix header layout, and prevent duplicate goal celebrations' },
    { version: '1.7.1', date: '2025-01-16', changes: 'Fix service worker caching strategy and force cache refresh' },
    { version: '1.7.0', date: '2025-01-15', changes: 'Add epic purchase celebration with money rain and cha-ching sound' },
    { version: '1.6.0', date: '2025-01-15', changes: 'Fix purchase tracking with unique purchase dates and cancelable purchase chips' }
  ];

  /* =========================
   *  Constants & helpers
   * ========================= */
  var STABLE_KEY='hotlistStable';
  var UI_KEY='hotlistUI';

  // Context configurations
  var CONTEXTS = {
    life: {
      name: "Life",
      icon: "❤️",
      stages: ['Initial Contact', 'Sent Quote', 'Sent Application', 'Pending Application Signature', 'Pending Medical Questionnaire', 'Issued'],
      stageIcons: ['🤝', '💵', '📝', '✍️', '🧪', '✅'],
      stageAbbr: ['Contact', 'Quoted', 'App', 'SigPend', 'MedQ', 'Issued']
    },
    home_auto: {
      name: "Home & Auto",
      icon: "🏠",
      stages: ['Contact', 'Quoted', 'Applied', 'Issued'],
      stageIcons: ['📞', '💵', '📝', '✅'],
      stageAbbr: ['Contact', 'Quoted', 'Applied', 'Issued']
    },
    commercial: {
      name: "Commercial",
      icon: "🏢",
      stages: ['Contact', 'Quoted', 'Proposal', 'Underwriting', 'Issued'],
      stageIcons: ['👤', '💵', '📊', '🔍', '✅'],
      stageAbbr: ['Contact', 'Quoted', 'Proposal', 'U/W', 'Issued']
    },
    farm: {
      name: "Farm",
      icon: "🚜",
      stages: ['Lead', 'Quoted', 'Inspection', 'Underwriting', 'Issued'],
      stageIcons: ['👤', '💵', '🔎', '🔍', '✅'],
      stageAbbr: ['Lead', 'Quoted', 'Insp', 'U/W', 'Issued']
    },
    networking: {
      name: "Networking",
      icon: "🤝",
      stages: ['Connected', 'Engaged', 'Referred'],
      stageIcons: ['🔗', '💬', '🎯'],
      stageAbbr: ['Connect', 'Engaged', 'Referred']
    }
  };

  // Default to life insurance for backwards compatibility
  var currentContext = 'life';

  // Legacy mappings for migration
  var STATUS=['Initial Contact','Sent Quote','Sent Application','Pending Application Signature','Pending Medical Questionnaire','Issued'];
  var STATUS_ABBR={'Initial Contact':'Contact','Sent Quote':'Quoted','Sent Application':'App','Pending Application Signature':'SigPend','Pending Medical Questionnaire':'MedQ','Issued':'Issued'};
  var STATUS_ICON={'Initial Contact':'\uD83E\uDD1D','Sent Quote':'\uD83E\uDD7E','Sent Application':'\uD83D\uDCDD','Pending Application Signature':'\u270D\uFE0F','Pending Medical Questionnaire':'\uD83E\uDDEA','Issued':'\u2705'};
  var EMOJI_CALL='\uD83D\uDCDE';
  var EMOJI_MSG ='\uD83D\uDCAC';
  var CLAP      ='\uD83D\uDC4F';

  function $(sel,root){ return (root||document).querySelector(sel); }
  function $all(sel,root){ return [].slice.call((root||document).querySelectorAll(sel)); }
  function nowISO(){ return new Date().toISOString(); }
  function startOfDay(d){ var x=new Date(d); x.setHours(0,0,0,0); return x; }
  function addDays(d,n){ var x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function isWithin(ts,start,end){ var t=new Date(ts); return t>=start && t<end; }
  function isToday(ts){ return new Date(ts).toDateString()===new Date().toDateString(); }
  function fmtDay(ts){ var d=new Date(ts); return (d.getMonth()+1)+'/'+d.getDate(); }
  function fmtTime(ts){ return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
  function last(arr){ return arr && arr.length ? arr[arr.length-1] : null; }
  function uid(){ return 'h_'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function escapeHtml(s){ s=String(s==null?'':s); return s.replace(/[&<>"']/g,function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]; }); }
  function businessDaysSince(ts){ var start=startOfDay(new Date(ts)), end=startOfDay(new Date()), days=0, d=new Date(start); for(; d<end; d.setDate(d.getDate()+1)){ var wd=d.getDay(); if(wd!==0 && wd!==6) days++; } return days; }
  function toLocalInputValue(iso){ if(!iso) return ''; var d=new Date(iso); var pad=function(n){return String(n).padStart(2,'0');}; return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes()); }
  function fromLocalInputValue(val){ if(!val) return ''; var d=new Date(val); if(isNaN(+d)) return ''; return d.toISOString(); }

  /* Elements */
  var els={
    appRoot:$('#appRoot'),
    list:$('#list'), archivedList:$('#archivedList'), archivedBlock:$('#archivedBlock'),
    kpis:$('#kpis'),
    globalSearch:$('#globalSearch'), sortBy:$('#sortBy'), contextPills:$('#contextPills'),
    addContextSelector:$('#addContextSelector'),
    contextName:$('#contextName'), contextLabel:$('#contextLabel'),
    statusFilter:$('#statusFilter'), showArchived:$('#showArchived'),
    ageDays:$('#ageDays'), groupToggle:$('#groupToggle'),
    emailSummaryBtn:$('#emailSummaryBtn'),
    chart:$('#chart'), chartRangeSel:$('#chartRangeSel'), heatmap:$('#heatmap'),
    todayDate:$('#todayDate'), activity:$('#activity'), emailTodayDetailBtn:$('#emailTodayDetailBtn'),
    hopStart:$('#hopStart'), hopPause:$('#hopPause'), hopReset:$('#hopReset'), hopClock:$('#hopClock'), hopCalls:$('#hopCalls'),
    pipeline:$('#pipeline'), nextList:$('#nextList'), followList:$('#followList'),
    quoteView:$('#quoteView'), quoteMeta:$('#quoteMeta'), quotesEditBtn:$('#quotesEditBtn'),
    quotesNextBtn:$('#quotesNextBtn'), quoteEditor:$('#quoteEditor'), quotesTextarea:$('#quotesTextarea'),
    quoteInterval:$('#quoteInterval'), quoteRandom:$('#quoteRandom'), quoteNoRepeat:$('#quoteNoRepeat'),
    quotesSaveBtn:$('#quotesSaveBtn'), quotesCancelBtn:$('#quotesCancelBtn'),
    sidebar:$('#sidebarWidgets'), leftSidebar:$('#leftSidebar'),
    leftDragZone:$('#leftDragZone'), rightDragZone:$('#rightDragZone'),
    tomorrowList:$('#tomorrowList'),
    ribbonIssued:$('#ribbonIssued'), ribbonWeeklyCalls:$('#ribbonWeeklyCalls'), ribbonStreak:$('#ribbonStreak'),
    dailyOutreachGoal:$('#dailyOutreachGoal'), dailyOutreachBar:$('#dailyOutreachBar'),
    dailyOutreachFill:$('#dailyOutreachFill'), dailyOutreachLabel:$('#dailyOutreachLabel'),
    dailyCalls:$('#dailyCalls'), dailyMessages:$('#dailyMessages'), saveDailyGoal:$('#saveDailyGoal'),
    monthlyPurchases:$('#monthlyPurchases'), monthlyAppsGoal:$('#monthlyAppsGoal'),
    saveMonthlyGoal:$('#saveMonthlyGoal'),
    celebration:$('#celebration'), confettiContainer:$('#confettiContainer'),
    chachingSound:$('#chachingSound'),
    todayBlock:$('#todayBlock'), todayList:$('#todayList'),
    scheduledBlock:$('#scheduledBlock'), scheduledList:$('#scheduledList'),
    densitySelect:$('#densitySelect'),
    toggleSidebarBtn:$('#toggleSidebarBtn'),
    importBtn:$('#importBtn'), exportBtn:$('#exportBtn'), essentialQuestionsBtn:$('#essentialQuestionsBtn'),
    sidebarControls:$('#sidebar-controls'),
    emptyState:$('#emptyState'), mainTableHead:$('#mainTableHead'), clearDemoSection:$('#clearDemoSection'),
    calendarViewBtn:$('#calendarViewBtn'),
    calendarMethod:$('#calendarMethod')
  };

  /* IndexedDB Storage Module */
  var storageDB = null;
  var DB_NAME = 'HotlistDB';
  var DB_VERSION = 1;
  var STORE_NAME = 'appData';

  async function requestPersistentStorage() {
    if ('storage' in navigator && 'persist' in navigator.storage) {
      try {
        const persistent = await navigator.storage.persist();
        console.log('Persistent storage:', persistent ? 'granted' : 'denied');
        return persistent;
      } catch (e) {
        console.warn('Could not request persistent storage:', e);
        return false;
      }
    }
    return false;
  }

  async function getStorageInfo() {
    const info = {
      persistent: false,
      quota: 0,
      usage: 0
    };

    if ('storage' in navigator) {
      try {
        if ('persisted' in navigator.storage) {
          info.persistent = await navigator.storage.persisted();
        }
        if ('estimate' in navigator.storage) {
          const estimate = await navigator.storage.estimate();
          info.quota = estimate.quota || 0;
          info.usage = estimate.usage || 0;
        }
      } catch (e) {
        console.warn('Could not get storage info:', e);
      }
    }

    return info;
  }

  function initDB() {
    return new Promise(async function(resolve, reject) {
      if (!window.indexedDB) {
        console.log('IndexedDB not supported, falling back to localStorage');
        resolve(null);
        return;
      }

      // Request persistent storage to prevent data loss during cache clearing
      await requestPersistentStorage();

      var request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onerror = function() {
        console.error('Failed to open IndexedDB:', request.error);
        resolve(null);
      };

      request.onsuccess = function() {
        storageDB = request.result;
        console.log('IndexedDB initialized successfully');

        // Handle database closing unexpectedly
        storageDB.onclose = function() {
          console.warn('IndexedDB connection closed unexpectedly');
          storageDB = null;
        };

        storageDB.onerror = function(event) {
          console.error('IndexedDB error:', event);
        };

        storageDB.onabort = function(event) {
          console.error('IndexedDB transaction aborted:', event);
        };

        resolve(storageDB);
      };

      request.onupgradeneeded = function(event) {
        var db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME);
        }
      };
    });
  }

  function saveToIndexedDB(key, data) {
    return new Promise(function(resolve, reject) {
      // Re-open database if needed
      if (!storageDB) {
        initDB().then(function(db) {
          if (!db) {
            reject(new Error('IndexedDB not available'));
            return;
          }
          performSave();
        });
      } else {
        performSave();
      }

      function performSave() {
        try {
          var transaction = storageDB.transaction([STORE_NAME], 'readwrite');
          var store = transaction.objectStore(STORE_NAME);
          var request = store.put(data, key);

          request.onsuccess = function() {
            console.log('Data saved to IndexedDB successfully');
            resolve();
          };

          request.onerror = function() {
            console.error('Failed to save to IndexedDB:', request.error);
            reject(request.error);
          };

          transaction.oncomplete = function() {
            console.log('IndexedDB transaction completed');
          };

          transaction.onerror = function() {
            console.error('IndexedDB transaction error:', transaction.error);
            reject(transaction.error);
          };
        } catch (e) {
          console.error('Error during IndexedDB save:', e);
          reject(e);
        }
      }
    });
  }

  function loadFromIndexedDB(key) {
    return new Promise(function(resolve, reject) {
      // Re-open database if needed
      if (!storageDB) {
        initDB().then(function(db) {
          if (!db) {
            reject(new Error('IndexedDB not available'));
            return;
          }
          performLoad();
        });
      } else {
        performLoad();
      }

      function performLoad() {
        try {
          var transaction = storageDB.transaction([STORE_NAME], 'readonly');
          var store = transaction.objectStore(STORE_NAME);
          var request = store.get(key);

          request.onsuccess = function() {
            console.log('Data loaded from IndexedDB:', key, request.result ? 'found' : 'not found');
            resolve(request.result);
          };

          request.onerror = function() {
            console.error('Failed to load from IndexedDB:', request.error);
            reject(request.error);
          };
        } catch (e) {
          console.error('Error during IndexedDB load:', e);
          reject(e);
        }
      }
    });
  }

  /* UI state with IndexedDB support */
  function loadUI() {
    if (storageDB) {
      return loadFromIndexedDB(UI_KEY).then(function(data) {
        if (data) {
          try {
            return JSON.parse(data);
          } catch(e) {
            console.error('Failed to parse IndexedDB UI data:', e);
          }
        }
        return loadUIFromLocalStorage();
      }).catch(function(e) {
        console.error('IndexedDB UI load failed:', e);
        return loadUIFromLocalStorage();
      });
    }
    return loadUIFromLocalStorage();
  }

  function loadUIFromLocalStorage() {
    try {
      return JSON.parse(localStorage.getItem(UI_KEY) || '{}');
    } catch(e) {
      return {};
    }
  }

  function saveUI(u) {
    var dataStr = JSON.stringify(u);

    // Always save to localStorage first (synchronous, immediate)
    localStorage.setItem(UI_KEY, dataStr);

    // Then attempt to save to IndexedDB (asynchronous)
    saveToIndexedDB(UI_KEY, dataStr).then(function() {
      console.log('Successfully saved UI to IndexedDB');
    }).catch(function(e) {
      console.error('Failed to save UI to IndexedDB, but localStorage save succeeded:', e);
      // Try to reinitialize DB for next save
      storageDB = null;
    });
  }
  var ui = {};
  var uiReady = Promise.resolve().then(function() {
    var result = loadUI();
    if (result && result.then) {
      return result.then(function(loadedUI) {
        ui = loadedUI || {};
        // Initialize context group order if not present
        if(!ui.contextGroupOrder){
          ui.contextGroupOrder = ['life', 'home_auto', 'commercial', 'farm', 'networking'];
        }
        return ui;
      });
    }
    ui = result || {};
    // Initialize context group order if not present
    if(!ui.contextGroupOrder){
      ui.contextGroupOrder = ['life', 'home_auto', 'commercial', 'farm', 'networking'];
    }
    return ui;
  });

  /* Daily queue rotation */
  function rotateDailyQueues(){
    if(!state || !state.clients) return;

    var today = new Date().toDateString();
    var lastRotation = ui.lastQueueRotation || '';

    if(lastRotation !== today){
      // It's a new day, rotate queues
      var rotated = false;
      state.clients.forEach(function(c){
        if(c.queueTomorrow){
          c.queueToday = true;
          c.queueTomorrow = false;
          rotated = true;
        }
      });

      if(rotated){
        save(state);
      }

      // Save today's date as last rotation
      ui.lastQueueRotation = today;
      saveUI(ui);
    }
  }

  function getAgeThreshold(){
    var v = (ui.ageDays!=null) ? Number(ui.ageDays) : Number((els.ageDays && els.ageDays.value) || 4);
    return isFinite(v) ? v : 4;
  }

  /* Migrate existing localStorage data to IndexedDB */
  function migrateData() {
    if (!storageDB) return Promise.resolve();

    return new Promise(function(resolve) {
      var promises = [];

      var mainData = localStorage.getItem(STABLE_KEY);
      if (mainData) {
        promises.push(saveToIndexedDB(STABLE_KEY, mainData).catch(function(e) {
          console.error('Failed to migrate main data:', e);
        }));
      }

      var uiData = localStorage.getItem(UI_KEY);
      if (uiData) {
        promises.push(saveToIndexedDB(UI_KEY, uiData).catch(function(e) {
          console.error('Failed to migrate UI data:', e);
        }));
      }

      Promise.all(promises).then(function() {
        console.log('Data migration completed');
        resolve();
      });
    });
  }

  /* Stable state */
  function coerceState(x){ var out={clients:[], quotes:{raw:'', list:[]}, quotesSettings:{interval:15, random:true, norepeat:true, recent:[]} }; if(!x) return out; if(Array.isArray(x)){ out.clients=x; return normalize(out); } if(typeof x==='object'){ if(Array.isArray(x.clients)) out.clients=x.clients; if(x.quotes) out.quotes=x.quotes; if(x.quotesSettings) out.quotesSettings=x.quotesSettings; return normalize(out);} return out; }
  function normalize(state){
    state.clients=(state.clients||[]).map(function(c){
      return {
        id:c.id||uid(),
        name:c.name||'(Unnamed)',
        notes:(typeof c.notes==='string'?c.notes:''),
        context:c.context||'life',  // Preserve context field
        stage:(typeof c.stage==='number'?c.stage:0),  // Preserve stage field
        status:c.status||'',
        purchaseDate:(typeof c.purchaseDate==='string'?c.purchaseDate:''),
        lastTouch:c.lastTouch||nowISO(),
        createdAt:c.createdAt||c.lastTouch||nowISO(),
        archived:!!c.archived,
        followUp:(typeof c.followUp==='string'?c.followUp:''),
        callCount:(isFinite(c.callCount)?c.callCount:0),
        msgCount:(isFinite(c.msgCount)?c.msgCount:0),
        queueToday:!!c.queueToday,
        queueTomorrow:!!c.queueTomorrow,
        hot:!!c.hot,
        history:Array.isArray(c.history)?
          c.history.filter(Boolean).map(function(h){
            return {id:(h.id||uid()), ts:(h.ts||nowISO()), action:(h.action||'status'), to:(h.to!=null?h.to:''), kind:(h.kind!=null?h.kind:'')};
          }) : []
      };
    });
    state.quotes = state.quotes || {raw:'', list:[]};
    if(!Array.isArray(state.quotes.list)) state.quotes.list=[];
    state.quotesSettings = state.quotesSettings || {interval:15, random:true, norepeat:true, recent:[]};
    if(!Array.isArray(state.quotesSettings.recent)) state.quotesSettings.recent=[];
    return state;
  }

  /* Enhanced load/save with IndexedDB and localStorage fallback */
  function load() {
    if (storageDB) {
      return loadFromIndexedDB(STABLE_KEY).then(function(data) {
        if (data) {
          try {
            return coerceState(JSON.parse(data));
          } catch(e) {
            console.error('Failed to parse IndexedDB data:', e);
          }
        }
        return loadFromLocalStorage();
      }).catch(function(e) {
        console.error('IndexedDB load failed, using localStorage:', e);
        return loadFromLocalStorage();
      });
    }
    return loadFromLocalStorage();
  }

  function loadFromLocalStorage() {
    try {
      var cur = JSON.parse(localStorage.getItem(STABLE_KEY) || 'null');
      if (cur) return coerceState(cur);
    } catch(e) {
      console.error('Failed to load from localStorage:', e);
    }
    var fresh = {clients:[], quotes:{raw:'', list:[]}, quotesSettings:{interval:15, random:true, norepeat:true, recent:[]}};
    localStorage.setItem(STABLE_KEY, JSON.stringify(fresh));
    return fresh;
  }

  function save(data) {
    var dataStr = JSON.stringify(data);

    // Always save to localStorage first (synchronous, immediate)
    localStorage.setItem(STABLE_KEY, dataStr);

    // Then attempt to save to IndexedDB (asynchronous)
    saveToIndexedDB(STABLE_KEY, dataStr).then(function() {
      console.log('Successfully saved to IndexedDB');
    }).catch(function(e) {
      console.error('Failed to save to IndexedDB, but localStorage save succeeded:', e);
      // Try to reinitialize DB for next save
      storageDB = null;
    });

    // Also save to cloud if user is signed in
    if (currentUser && syncEnabled) {
      saveToCloud(data);
    }
  }
  /* Initialize storage and load state */
  var state = {clients:[], quotes:{raw:'', list:[]}, quotesSettings:{interval:15, random:true, norepeat:true, recent:[]}}; // Default state to prevent null errors
  var storageReady = initDB().then(function() {
    return migrateData();
  }).then(function() {
    var result = load();
    if (result && result.then) {
      return result.then(function(loadedState) {
        state = loadedState || state;
        return state;
      });
    }
    state = result || state;
    return state;
  }).catch(function(e) {
    console.error('Storage initialization failed:', e);
    state = loadFromLocalStorage() || state;
    return state;
  });

  /* Error banner */
  window.addEventListener('error', function(e){ var b=$('#errorBanner'); if(!b) return; b.style.display='block'; var msg=(e && e.error && e.error.message) ? e.error.message : (e && e.message ? e.message : 'unknown error'); b.textContent='Script error: '+msg; });

  /* Undo (simple) */
  var undoStack=[]; function withUndo(mut){ var snap=JSON.stringify(state); mut(); undoStack.push(snap); if(undoStack.length>50) undoStack.shift(); }

  /* UI-preserving render */
  function preserveUIAndRender(mutator){
    var prevDocY=window.scrollY, prevActY=els.activity?els.activity.scrollTop:0;
    var sel=getSelectedClient(); var selId=sel?sel.id:null;
    if(mutator) withUndo(mutator);
    save(state); render();
    if(selId) setSelectedRowById(selId);
    window.scrollTo(0,prevDocY); if(els.activity) els.activity.scrollTop=prevActY;
  }

  /* Show context selector tooltip */
  function showContextTooltip(){
    var contextSelector = document.getElementById('addContextSelector');
    if(!contextSelector) return;

    // Remove any existing tooltip
    var existingTooltip = contextSelector.querySelector('.context-tooltip');
    if(existingTooltip) existingTooltip.remove();

    // Create tooltip
    var tooltip = document.createElement('div');
    tooltip.className = 'context-tooltip';
    tooltip.textContent = '👆 Please select a context first';
    contextSelector.appendChild(tooltip);

    // Show with animation
    setTimeout(function() {
      tooltip.classList.add('show');
    }, 10);

    // Hide after 3 seconds
    setTimeout(function() {
      tooltip.classList.remove('show');
      setTimeout(function() {
        tooltip.remove();
      }, 300);
    }, 3000);
  }

  /* Helper function to get last call or message date */
  function getLastContactDate(client, type){
    if(!client.history) return null;
    // Sort history by date, newest first
    var sorted = client.history.filter(function(h){
      return h.action === 'status' && h.to === type;
    }).sort(function(a,b){
      return new Date(b.ts) - new Date(a.ts);
    });
    if(sorted.length > 0){
      var date = new Date(sorted[0].ts);
      return (date.getMonth() + 1) + '/' + date.getDate();
    }
    return null;
  }

  /* CRUD / actions */
  function addClient(name){
    // Handle adding clients in "all" context view
    if(currentContext === 'all'){
      var contextSelector = document.getElementById('addContextSelector');
      var selectedContext = contextSelector ? contextSelector.value : '';

      if(!selectedContext){
        // Show tooltip instead of alert
        showContextTooltip();
        contextSelector.focus();

        // Pulse the selector to draw attention
        contextSelector.style.animation = 'pulse 0.5s ease-in-out 2';
        setTimeout(function() {
          contextSelector.style.animation = '';
        }, 1000);

        return false;  // Return false to indicate client wasn't added
      }

      // Add client to the selected context
      preserveUIAndRender(function(){
        var newClient = {
          id:uid(),
          name:name,
          notes:'',
          context: selectedContext,  // Use selected context
          stage: -1,  // No status activated by default
          status:'',
          lastTouch:nowISO(),
          createdAt:nowISO(),
          archived:false,
          followUp:'',
          callCount:0,
          msgCount:0,
          queueToday:false,
          queueTomorrow:false,
          hot:false,
          history:[]
        };

        // Check sort preference
        var sortBy = getCookie('sortBy');
        if(!sortBy || sortBy === 'none'){
          state.clients.unshift(newClient);
        } else {
          state.clients.push(newClient);
        }

        // Reset the context selector
        contextSelector.value = '';
      });
      return;
    }
    preserveUIAndRender(function(){
      var newClient = {
        id:uid(),
        name:name,
        notes:'',
        context: currentContext,  // Set context for new clients
        stage: -1,  // No status activated by default
        status:'',  // Keep for backwards compatibility
        lastTouch:nowISO(),
        createdAt:nowISO(),
        archived:false,
        followUp:'',
        callCount:0,
        msgCount:0,
        queueToday:false,
        queueTomorrow:false,
        hot:false,
        history:[]
      };

      // If "No Sort" is selected, add to beginning, otherwise add to end
      var sortBy = getCookie('sortBy');
      if(!sortBy || sortBy === 'none'){
        state.clients.unshift(newClient);  // Add to beginning
      } else {
        state.clients.push(newClient);  // Add to end
      }
    });
  }
  function setStatus(c,newStatus,buttonElement){
    var wasIssued = c.status === 'Issued';
    var oldStatus = c.status;

    // Only update if status is actually changing
    if(oldStatus === newStatus) {
      // Check if we already have this status recorded today
      var today = new Date().toDateString();
      var alreadyRecordedToday = (c.history || []).some(function(h) {
        if(h.action === 'status' && h.to === newStatus) {
          var histDate = new Date(h.ts).toDateString();
          return histDate === today;
        }
        return false;
      });

      if(alreadyRecordedToday) {
        console.log('Status already recorded today, skipping duplicate entry');
        return;
      }
    }

    preserveUIAndRender(function(){
      var when=nowISO();
      c.status=newStatus;
      c.lastTouch=when;
      c.history.push({id:uid(), ts:when, action:'status', to:newStatus});
      if(c.queueToday) c.queueToday=false;
      // Set purchase date when status becomes Issued
      if(newStatus === 'Issued' && !c.purchaseDate){
        c.purchaseDate = when;
      }
    });
    // Trigger epic purchase celebration!
    if(newStatus === 'Issued' && !wasIssued){
      setTimeout(function(){
        startPurchaseCelebration(buttonElement);
      }, 100);
    }
  }

  // New function for setting stage in context-aware system
  function setClientStage(c, newStage){
    var clientContext = c.context || currentContext;
    var contextConfig = CONTEXTS[clientContext] || CONTEXTS.life;
    var stages = contextConfig.stages;

    // Validate stage index (allow -1 for no stage)
    if(newStage < -1 || newStage >= stages.length) return;

    var oldStage = c.stage;
    var wasFinalStage = oldStage === stages.length - 1;

    preserveUIAndRender(function(){
      var when = nowISO();
      c.stage = newStage;
      c.context = clientContext; // Ensure context is set
      c.lastTouch = when;

      // Add history entry
      if(!c.history) c.history = [];
      c.history.push({
        id: uid(),
        ts: when,
        action: 'stage',
        to: stages[newStage],
        stageIndex: newStage
      });

      if(c.queueToday) c.queueToday = false;

      // Set purchase/issue date when reaching final stage
      if(newStage === stages.length - 1 && !c.purchaseDate){
        c.purchaseDate = when;
      }
    });

    // Trigger celebration for final stage
    if(newStage === stages.length - 1 && !wasFinalStage){
      setTimeout(function(){
        startPurchaseCelebration();
      }, 100);
    }
  }

  function clearStatus(c){ preserveUIAndRender(function(){ c.status=''; if(c.purchaseDate) delete c.purchaseDate; }); }
  function clearPurchase(c){ preserveUIAndRender(function(){ if(c.status === 'Issued') c.status=''; if(c.purchaseDate) delete c.purchaseDate; }); }
  function incrementCall(c){
    preserveUIAndRender(function(){
      // Check if already contacted today for daily outreach purposes
      var today = new Date().toDateString();
      var alreadyContactedToday = false;

      if(c.history && c.history.length > 0){
        for(var i = c.history.length - 1; i >= 0; i--){
          var h = c.history[i];
          if(h.action === 'status' && (h.to === 'Called' || h.to === 'Emailed')){
            var histDate = new Date(h.ts).toDateString();
            if(histDate === today){
              alreadyContactedToday = true;
              break;
            }
          }
        }
      }

      // Always increment the call count and add to history
      c.callCount=(c.callCount||0)+1;
      c.lastTouch=nowISO();
      c.history.push({id:uid(), ts:nowISO(), action:'status', to:'Called'});
      if(c.queueToday) c.queueToday=false;

      // Mark if this is the first contact today (for daily outreach tracking)
      if(!alreadyContactedToday){
        c._firstContactToday = true;
      }
    });
    // Update Power Hour call counter if timer is running
    if(hopRunning){
      hopCallCount++;
      updateHopCalls(hopCallCount);
    }
  }
  function decrementCall(c){
    preserveUIAndRender(function(){
      c.callCount=Math.max(0,(c.callCount||0)-1);
      // Also remove the most recent call from history
      if(c.history && c.history.length > 0){
        var callIndex = -1;
        for(var i = c.history.length - 1; i >= 0; i--){
          if(c.history[i].action === 'status' && c.history[i].to === 'Called'){
            callIndex = i;
            break;
          }
        }
        if(callIndex !== -1){
          c.history.splice(callIndex, 1);
        }
      }
    });
    // Update Power Hour call counter if timer is running
    if(hopRunning && hopCallCount > 0){
      hopCallCount--;
      updateHopCalls(hopCallCount);
    }
  }
  function incrementMsg(c){
    preserveUIAndRender(function(){
      // Check if already contacted today for daily outreach purposes
      var today = new Date().toDateString();
      var alreadyContactedToday = false;

      if(c.history && c.history.length > 0){
        for(var i = c.history.length - 1; i >= 0; i--){
          var h = c.history[i];
          if(h.action === 'status' && (h.to === 'Called' || h.to === 'Emailed')){
            var histDate = new Date(h.ts).toDateString();
            if(histDate === today){
              alreadyContactedToday = true;
              break;
            }
          }
        }
      }

      // Always increment the message count and add to history
      c.msgCount=(c.msgCount||0)+1;
      c.lastTouch=nowISO();
      c.history.push({id:uid(), ts:nowISO(), action:'status', to:'Emailed'});
      if(c.queueToday) c.queueToday=false;

      // Mark if this is the first contact today (for daily outreach tracking)
      if(!alreadyContactedToday){
        c._firstContactToday = true;
      }
    });
  }
  function decrementMsg(c){
    preserveUIAndRender(function(){
      c.msgCount=Math.max(0,(c.msgCount||0)-1);
      // Also remove the most recent message from history
      if(c.history && c.history.length > 0){
        var msgIndex = -1;
        for(var i = c.history.length - 1; i >= 0; i--){
          if(c.history[i].action === 'status' && c.history[i].to === 'Emailed'){
            msgIndex = i;
            break;
          }
        }
        if(msgIndex !== -1){
          c.history.splice(msgIndex, 1);
        }
      }
    });
  }
  function updateNotes(c,notes){ c.notes=notes; save(state); }
  function archiveClient(c,flag){ preserveUIAndRender(function(){ c.archived=!!flag; }); }
  var deleteUndoTimeout = null;
  var deletedClient = null;

  function deleteClient(c){
    // Store the client and its index for potential undo
    var clientIndex = state.clients.findIndex(function(x){return x.id===c.id;});
    deletedClient = JSON.parse(JSON.stringify(c));

    // Remove the client immediately
    preserveUIAndRender(function(){
      state.clients=state.clients.filter(function(x){return x.id!==c.id;});
    });

    // Clear any existing timeout
    if(deleteUndoTimeout){
      clearTimeout(deleteUndoTimeout);
      var existingNotif = document.querySelector('.delete-undo-notification');
      if(existingNotif) existingNotif.remove();
    }

    // Create undo notification
    var notif = document.createElement('div');
    notif.className = 'delete-undo-notification';

    var message = document.createElement('span');
    message.textContent = 'Deleted "' + c.name + '" - ';

    var countdown = document.createElement('span');
    countdown.className = 'delete-undo-countdown';
    var secondsLeft = 5;
    countdown.textContent = secondsLeft + 's';

    var undoBtn = document.createElement('button');
    undoBtn.textContent = 'Undo';
    undoBtn.onclick = function(){
      clearTimeout(deleteUndoTimeout);
      clearInterval(countdownInterval);

      // Restore the client at its original position
      preserveUIAndRender(function(){
        if(clientIndex >= 0 && clientIndex <= state.clients.length){
          state.clients.splice(clientIndex, 0, deletedClient);
        } else {
          state.clients.push(deletedClient);
        }
      });

      notif.remove();
      deletedClient = null;
    };

    notif.appendChild(message);
    notif.appendChild(countdown);
    notif.appendChild(undoBtn);
    document.body.appendChild(notif);

    // Update countdown
    var countdownInterval = setInterval(function(){
      secondsLeft--;
      if(secondsLeft > 0){
        countdown.textContent = secondsLeft + 's';
      } else {
        clearInterval(countdownInterval);
      }
    }, 1000);

    // Remove notification and clear deleted client after 5 seconds
    deleteUndoTimeout = setTimeout(function(){
      notif.remove();
      deletedClient = null;
      clearInterval(countdownInterval);
    }, 5000);
  }
  function toggleQueueToday(c,val){ preserveUIAndRender(function(){ c.queueToday = (typeof val==='boolean') ? val : !c.queueToday; if(c.queueToday) c.queueTomorrow=false; }); }
  function toggleQueueTomorrow(c,val){ preserveUIAndRender(function(){ c.queueTomorrow = (typeof val==='boolean') ? val : !c.queueTomorrow; if(c.queueTomorrow) c.queueToday=false; }); }

  /* Enhanced Follow-up picker with Calendar */
  var hiddenFollowPicker=document.createElement('input'); hiddenFollowPicker.type='datetime-local'; hiddenFollowPicker.className='hidden'; document.body.appendChild(hiddenFollowPicker); var followTargetClient=null;

  function createCalendarModal(client, initialDate) {
    var modal = document.createElement('div');
    modal.className = 'calendar-modal';
    modal.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--card); border-radius:12px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,0.3); z-index:10001; width:400px;';

    var backdrop = document.createElement('div');
    backdrop.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000;';

    var selectedDate = initialDate || new Date();
    selectedDate.setHours(9, 0, 0, 0);

    function updateModal() {
      modal.innerHTML = `
        <h3 style="margin:0 0 20px 0; color:var(--ink);">Schedule Follow-up for ${client.name}</h3>
        <div style="display:grid; gap:16px;">
          <div>
            <label style="display:block; margin-bottom:8px; color:var(--muted); font-size:12px; font-weight:600;">DATE</label>
            <input type="date" id="calendarDate" value="${selectedDate.toISOString().split('T')[0]}" style="width:100%; padding:8px 12px; border:1px solid var(--line); border-radius:8px; background:var(--bg); color:var(--ink); font-size:14px;">
          </div>
          <div>
            <label style="display:block; margin-bottom:8px; color:var(--muted); font-size:12px; font-weight:600;">TIME (30-minute intervals)</label>
            <select id="calendarTime" style="width:100%; padding:8px 12px; border:1px solid var(--line); border-radius:8px; background:var(--bg); color:var(--ink); font-size:14px;">
              ${generateTimeOptions(selectedDate)}
            </select>
          </div>
          <div style="display:grid; gap:8px; margin-top:16px;">
            <button id="confirmSchedule" style="padding:12px 16px; background:var(--green); color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Set Follow-up Only</button>
            <button id="addToCalendar" style="padding:12px 16px; background:var(--blue); color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
              <span style="font-size:16px;">📅</span> Set Follow-up + Add to Calendar
            </button>
            <button id="cancelSchedule" style="padding:10px 16px; background:transparent; color:var(--muted); border:1px solid var(--line); border-radius:8px; cursor:pointer;">Cancel</button>
          </div>
        </div>
      `;

      modal.querySelector('#calendarDate').addEventListener('change', function(e) {
        selectedDate = new Date(e.target.value + 'T' + modal.querySelector('#calendarTime').value);
      });

      modal.querySelector('#calendarTime').addEventListener('change', function(e) {
        var timeStr = e.target.value;
        selectedDate.setHours(parseInt(timeStr.split(':')[0]), parseInt(timeStr.split(':')[1]), 0, 0);
      });

      modal.querySelector('#confirmSchedule').addEventListener('click', function() {
        client.followUp = selectedDate.toISOString();
        save(state);
        render();
        cleanup();
      });

      modal.querySelector('#addToCalendar').addEventListener('click', function() {
        client.followUp = selectedDate.toISOString();
        save(state);
        createCalendarEvent(client, selectedDate);
        render();
        cleanup();
      });

      modal.querySelector('#cancelSchedule').addEventListener('click', cleanup);
    }

    function generateTimeOptions(date) {
      var options = [];
      var currentHour = date.getHours();
      var currentMin = Math.floor(date.getMinutes() / 30) * 30;

      for(var h = 0; h < 24; h++) {
        for(var m = 0; m < 60; m += 30) {
          var hour12 = h === 0 ? 12 : (h > 12 ? h - 12 : h);
          var ampm = h < 12 ? 'AM' : 'PM';
          var timeStr = hour12 + ':' + (m < 10 ? '0' : '') + m + ' ' + ampm;
          var value = (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
          var selected = (h === currentHour && m === currentMin) ? 'selected' : '';
          options.push(`<option value="${value}" ${selected}>${timeStr}</option>`);
        }
      }
      return options.join('');
    }

    function cleanup() {
      modal.remove();
      backdrop.remove();
    }

    backdrop.addEventListener('click', cleanup);
    document.body.appendChild(backdrop);
    document.body.appendChild(modal);
    updateModal();
  }

  function createCalendarEvent(client, date) {
    // Get the client's context for the title
    var clientContext = client.context || 'life';
    var contextName = CONTEXTS[clientContext] ? CONTEXTS[clientContext].name : 'Life';
    var title = contextName + ' Follow-up: ' + client.name;
    var details = 'Follow-up appointment with ' + client.name;
    if(client.notes) {
      details += '\n\nNotes: ' + client.notes.substring(0, 200);
    }

    // Format date for calendar URL
    var startDate = new Date(date);
    var endDate = new Date(date);
    endDate.setMinutes(endDate.getMinutes() + 30); // 30-minute appointment

    // Get user's preferred calendar method
    var method = ui.calendarMethod || (els.calendarMethod ? els.calendarMethod.value : 'outlook');

    if(method === 'google') {
      // Google Calendar URL
      var startStr = startDate.toISOString().replace(/-|:|\.\d\d\d/g, '');
      var endStr = endDate.toISOString().replace(/-|:|\.\d\d\d/g, '');

      var googleCalUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE' +
        '&text=' + encodeURIComponent(title) +
        '&dates=' + startStr + '/' + endStr +
        '&details=' + encodeURIComponent(details);

      window.open(googleCalUrl, '_blank');
    }
    else if(method === 'outlook') {
      // Outlook Web Calendar URL
      var startStr = startDate.toISOString();
      var endStr = endDate.toISOString();

      var outlookUrl = 'https://outlook.live.com/calendar/0/deeplink/compose?' +
        'subject=' + encodeURIComponent(title) +
        '&startdt=' + encodeURIComponent(startStr) +
        '&enddt=' + encodeURIComponent(endStr) +
        '&body=' + encodeURIComponent(details) +
        '&allday=false';

      window.open(outlookUrl, '_blank');
    }
    else {
      // ICS file download (default fallback)
      var formatDate = function(d) {
        return d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      };

      var icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Hotlist//EN',
        'BEGIN:VEVENT',
        'UID:' + client.id + '-' + Date.now() + '@hotlist',
        'DTSTAMP:' + formatDate(new Date()),
        'DTSTART:' + formatDate(startDate),
        'DTEND:' + formatDate(endDate),
        'SUMMARY:' + title,
        'DESCRIPTION:' + details.replace(/\n/g, '\\n'),
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');

      var blob = new Blob([icsContent], { type: 'text/calendar' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'followup-' + client.name.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '.ics';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showNotification('Calendar Event', 'ICS file downloaded - check your downloads folder');
    }
  }

  function setFollowUpViaPicker(c) {
    var initialDate = c.followUp ? new Date(c.followUp) : null;
    createCalendarModal(c, initialDate);
  }

  hiddenFollowPicker.addEventListener('change', function(){ if(!followTargetClient) return; var iso=fromLocalInputValue(hiddenFollowPicker.value); followTargetClient.followUp=iso; save(state); render(); followTargetClient=null; });

  /* KPIs / ribbons / pipeline / goals */
  function computeKPIs(){ if(!state || !state.clients) return {total:0, touchedToday:0, purchased:0, contacted:0, convRate:0, avgCalls:'—'}; var active=state.clients.filter(function(c){return !c.archived;}); var touchedToday=active.filter(function(c){return isToday(c.lastTouch);}); var purchased=state.clients.filter(function(c){return c.status==='Issued';}); var contacted=state.clients.filter(function(c){return (c.history||[]).length>0 && c.status!=='Issued';}); var perClient=state.clients.map(function(c){ var fp=(c.history||[]).find(function(h){return h.action==='status' && h.to==='Issued';}); var firstPur = fp ? fp.ts : null; if(!firstPur) return null; var calls=(c.history||[]).filter(function(h){ return h.action==='status' && h.to==='Called' && new Date(h.ts)<=new Date(firstPur); }).length; return calls; }).filter(function(v){return v!==null;}); var avgCalls = perClient.length ? (perClient.reduce(function(a,b){return a+b;},0)/perClient.length).toFixed(1) : '—'; return {total:active.length, touchedToday:touchedToday.length, purchased:purchased.length, contacted:contacted.length, convRate:(contacted.length? Math.round((purchased.length/Math.max(contacted.length,1))*100) : 0), avgCalls:avgCalls}; }
  function renderKPIs(){ 
    var k=computeKPIs(); 
    if(!els.kpis) return;
    els.kpis.innerHTML=''; 
    [['Active Leads',k.total],['Touched Today',k.touchedToday],['Issued',k.purchased],['Contacted (not purchased)',k.contacted],['Conv. Rate',(k.convRate||0)+'%'],['Avg Calls→Purchase',k.avgCalls]].forEach(function(pair){ 
      var row=document.createElement('div'); 
      row.className='kpi-row'; 
      row.innerHTML='<span class="kpi-label">'+pair[0]+'</span><span class="kpi-value">'+pair[1]+'</span>'; 
      els.kpis.appendChild(row); 
    }); 
  }
  function pipelineStats(){ var counts={Calls:0,Emails:0,Quotes:0,Apps:0,Issued:0}; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action!=='status') return; if(h.to==='Called') counts.Calls++; else if(h.to==='Emailed') counts.Emails++; else if(h.to==='Sent Quote') counts.Quotes++; else if(h.to==='Sent Application') counts.Apps++; else if(h.to==='Issued') counts.Issued++; }); }); function conv(a,b){ return a? Math.round((b/a)*100) : 0; } return {counts:counts, convCE:conv(counts.Calls,counts.Emails), convEQ:conv(counts.Emails,counts.Quotes), convQA:conv(counts.Quotes,counts.Apps), convAP:conv(counts.Apps,counts.Issued)}; }
  function renderPipeline(){ var p=pipelineStats(); els.pipeline.innerHTML = '' +'<div>Calls: <b>'+p.counts.Calls+'</b> → Emails: <b>'+p.counts.Emails+'</b> (<b>'+p.convCE+'%</b>)</div>' +'<div>Emails: <b>'+p.counts.Emails+'</b> → Quotes: <b>'+p.counts.Quotes+'</b> (<b>'+p.convEQ+'%</b>)</div>' +'<div>Quotes: <b>'+p.counts.Quotes+'</b> → Apps: <b>'+p.counts.Apps+'</b> (<b>'+p.convQA+'%</b>)</div>' +'<div>Apps: <b>'+p.counts.Apps+'</b> → Issued: <b>'+p.counts.Issued+'</b> (<b>'+p.convAP+'%</b>)</div>'; }
  function weekRange(){ var end=startOfDay(new Date()), start=addDays(end,-6); return {start:start, end:addDays(end,1)}; }
  function weeklyCalls(){ var r=weekRange(), cnt=0; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action==='status' && h.to==='Called' && isWithin(h.ts,r.start,r.end)) cnt++; }); }); return cnt; }
  /* Goals widget removed - functionality now in daily outreach bar */
  function touchesOnDay(day){ var start=startOfDay(day), end=addDays(start,1), cnt=0; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action==='status'){ var t=new Date(h.ts); if(t>=start && t<end) cnt++; }}); }); return cnt; }
  function calcStreak(minPerDay){ var min=(typeof minPerDay==='number'?minPerDay:1), streak=0; for(var i=0;i<365;i++){ var day=addDays(new Date(), -i); if(touchesOnDay(day) >= min) streak++; else break; } return streak; }
  // Keep collecting KPI data for email summaries
  function getKPIData(){
    return {
      purchased: (state && state.clients) ? state.clients.filter(function(c){return c.status==='Issued';}).length : 0,
      weeklyCalls: weeklyCalls(),
      streak: calcStreak(1)
    };
  }
  function renderTrendRibbons(){
    // Data collection continues but no UI update needed
    getKPIData();
  }
  
  /* Goal Achievement Celebration */
  var celebrationActive = false;
  var lastGoalState = false; // Track if goal was achieved in last render
  
  function createConfetti(){
    if(!els.confettiContainer) return;
    for(var i = 0; i < 50; i++){
      var confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.animationDelay = Math.random() * 3 + 's';
      confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
      els.confettiContainer.appendChild(confetti);
    }
  }
  
  function startCelebration(){
    if(celebrationActive || !els.celebration) return;
    celebrationActive = true;
    
    // Show celebration
    els.celebration.classList.remove('hidden');
    
    // Create confetti
    createConfetti();
    
    // Auto-hide after 4 seconds
    setTimeout(function(){
      stopCelebration();
    }, 4000);
  }
  
  function stopCelebration(){
    if(!celebrationActive || !els.celebration) return;
    celebrationActive = false;

    // Hide celebration
    els.celebration.classList.add('hidden');

    // Clean up confetti
    if(els.confettiContainer) els.confettiContainer.innerHTML = '';
  }

  /* Purchase Celebration - Dollar Explosion */
  function startPurchaseCelebration(buttonElement){
    // Play cash register sound
    if(els.chachingSound) {
      try {
        els.chachingSound.play();
      } catch(e) {
        console.log('Audio playback failed:', e);
      }
    }

    // Create dollar explosion from button
    if(!buttonElement) return;

    var rect = buttonElement.getBoundingClientRect();
    var centerX = rect.left + rect.width / 2;
    var centerY = rect.top + rect.height / 2;

    // Create container for particles
    var container = document.createElement('div');
    container.className = 'dollar-explosion';
    container.style.left = centerX + 'px';
    container.style.top = centerY + 'px';
    document.body.appendChild(container);

    // Create dollar particles
    var dollarSymbols = ['$', '💵', '💰', '💸', '💲'];
    for(var i = 0; i < 12; i++){
      var particle = document.createElement('div');
      particle.className = 'dollar-particle';
      particle.textContent = dollarSymbols[Math.floor(Math.random() * dollarSymbols.length)];

      // Random explosion direction
      var angle = (Math.PI * 2 * i) / 12 + (Math.random() - 0.5) * 0.5;
      var distance = 80 + Math.random() * 120;
      var dx = Math.cos(angle) * distance;
      var dy = Math.sin(angle) * distance - 50; // Bias upward

      particle.style.setProperty('--dx', dx + 'px');
      particle.style.setProperty('--dy', dy + 'px');
      particle.style.animationDelay = Math.random() * 0.2 + 's';

      container.appendChild(particle);
    }

    // Clean up after animation
    setTimeout(function(){
      container.remove();
    }, 2000);
  }
  
  /* Daily Outreach Goal */
  function getDailyOutreachCounts(){
    // Use local date, not UTC
    var todayStart = new Date();
    todayStart.setHours(0,0,0,0);
    var todayEnd = new Date();
    todayEnd.setHours(23,59,59,999);

    var totalCalls = 0, totalMessages = 0;
    var uniqueClientsContacted = {}; // Track unique clients contacted today

    if(state && state.clients) state.clients.forEach(function(c){
      if(!c.id) return; // Skip clients without ID

      var clientContactedToday = false;
      var clientCalls = 0;
      var clientMessages = 0;

      if(c.history){
        c.history.forEach(function(h){
          if(!h.ts) return;
          var hTime = new Date(h.ts);
          // Check if the history entry is from today (in local time)
          if(hTime >= todayStart && hTime <= todayEnd){
            if(h.to === 'Called' || h.action === 'call'){
              clientCalls++;
              clientContactedToday = true;
            } else if(h.to === 'Emailed' || h.action === 'message'){
              clientMessages++;
              clientContactedToday = true;
            }
          }
        });
      }

      // Track unique client if contacted today
      if(clientContactedToday && c.id){
        uniqueClientsContacted[c.id] = true;
      }

      // Add to total calls/messages
      totalCalls += clientCalls;
      totalMessages += clientMessages;
    });

    var uniqueOutreach = Object.keys(uniqueClientsContacted).length;

    // Return unique client count as total for daily outreach
    return {calls: totalCalls, messages: totalMessages, total: uniqueOutreach};
  }
  
  function getOutreachCountForDate(date){
    var start = new Date(date);
    start.setHours(0,0,0,0);
    var end = new Date(date);
    end.setHours(23,59,59,999);
    
    var count = 0;
    state.clients.forEach(function(c){
      (c.history||[]).forEach(function(h){
        if(h.action === 'status'){
          var hDate = new Date(h.ts);
          if(hDate >= start && hDate <= end){
            if(h.to === 'Called' || h.to === 'Messaged' || h.to === 'Emailed') count++;
          }
        }
      });
    });
    return count;
  }

  function getMonthlyPurchases(){
    var now = new Date();
    var startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    var endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    var count = 0;

    if(state && state.clients) state.clients.forEach(function(c){
      // Check if client is in current context
      var clientContext = c.context || 'life';
      if(clientContext !== currentContext) return;

      // Check if client has reached final stage (purchased/issued)
      var contextConfig = CONTEXTS[clientContext];
      var finalStage = contextConfig.stages.length - 1;

      if((c.stage === finalStage || c.status === 'Issued') && c.purchaseDate){
        var purchaseDate = new Date(c.purchaseDate);
        if(purchaseDate >= startOfMonth && purchaseDate < endOfMonth){
          count++;
        }
      }
    });
    return count;
  }

  function renderDailyOutreach(){
    if(!els.dailyOutreachGoal || !els.dailyOutreachBar) return;
    var goal = Number(ui.dailyOutreachGoal || 10);
    var counts = getDailyOutreachCounts();
    var progress = Math.min(100, (counts.total / goal) * 100);
    var goalAchieved = counts.total >= goal && goal > 0;
    var today = new Date().toDateString();

    if(els.dailyOutreachFill) els.dailyOutreachFill.style.width = progress + '%';
    if(els.dailyOutreachLabel) els.dailyOutreachLabel.textContent = counts.total + ' / ' + goal;
    if(els.dailyCalls) els.dailyCalls.textContent = String(counts.calls);
    if(els.dailyMessages) els.dailyMessages.textContent = String(counts.messages);

    // Update monthly purchases/goal based on current context
    var monthlyAchievements = getMonthlyPurchases();

    // Get the goal for current context (stored per context)
    if(!ui.contextGoals) ui.contextGoals = {};
    var contextGoalKey = currentContext + 'Goal';
    var monthlyGoal = ui.contextGoals[contextGoalKey] || 5;

    // Update the current and max display
    var contextGoalCurrent = document.getElementById('contextGoalCurrent');
    var contextGoalMax = document.getElementById('contextGoalMax');
    if(contextGoalCurrent) contextGoalCurrent.textContent = String(monthlyAchievements);
    if(contextGoalMax) contextGoalMax.textContent = String(monthlyGoal);

    // Update monthly goal input if it exists
    if(els.monthlyAppsGoal && document.activeElement !== els.monthlyAppsGoal) {
      els.monthlyAppsGoal.value = String(monthlyGoal);
    }

    // Update segmented progress
    var contextGoalSegments = document.getElementById('contextGoalSegments');
    if(contextGoalSegments) {
      // Clear existing segments
      contextGoalSegments.innerHTML = '';

      // Generate segments up to the goal
      for(var i = 0; i < monthlyGoal; i++) {
        var segment = document.createElement('div');
        segment.className = 'segment';

        if(i < monthlyAchievements) {
          segment.classList.add('filled');
        }

        contextGoalSegments.appendChild(segment);
      }
    }

    // Update goal input if it exists
    if(els.dailyOutreachGoal && document.activeElement !== els.dailyOutreachGoal) {
      els.dailyOutreachGoal.value = String(goal);
    }

    // Check if it's a new day - reset celebration tracking
    var isNewDay = ui.lastCelebrationDate !== today;
    if(isNewDay){
      ui.lastCelebrationGoal = 0; // Reset the celebrated goal level
      ui.lastCelebrationDate = today;
      // For a new day, reset the count to 0 to track fresh
      ui.lastOutreachCount = 0;
      // If there are already activities today (from before page load), update the count
      if(counts.total > 0){
        // If goal is already achieved on first load of the day, mark as celebrated
        if(goalAchieved){
          ui.lastCelebrationGoal = goal;
        }
        // Update count after checking celebration status
        ui.lastOutreachCount = counts.total;
      }
      saveUI(ui);
    }

    // Check if goal has been increased since last celebration
    var lastCelebratedGoal = ui.lastCelebrationGoal || 0;
    var goalIncreased = goal > lastCelebratedGoal;

    // Only trigger celebration when:
    // 1. Goal is achieved
    // 2. Either:
    //    a) Haven't celebrated at this goal level yet (goal was increased), OR
    //    b) Count dropped below goal and came back up (undo scenario)
    // 3. Count has actually changed (not just page refresh)
    // 4. We just crossed the threshold
    var previousCount = ui.lastOutreachCount || 0;
    var countChanged = counts.total !== previousCount;
    var justCrossedThreshold = previousCount < goal && counts.total >= goal;
    var shouldCelebrate = false;

    if(goalAchieved && countChanged){
      // Celebrate if we crossed the threshold (either from below or goal was raised)
      if(justCrossedThreshold){
        shouldCelebrate = true;
      }
      // Also celebrate if goal was increased and we're already past the new goal
      else if(goalIncreased && counts.total >= goal){
        shouldCelebrate = true;
      }
    }

    if(shouldCelebrate){
      startCelebration();
      ui.lastCelebrationGoal = goal; // Remember the goal level we celebrated at
      saveUI(ui);
    }

    // Update stored count
    if(counts.total !== previousCount){
      ui.lastOutreachCount = counts.total;
      saveUI(ui);
    }

    lastGoalState = goalAchieved;
  }
  
  if(els.saveDailyGoal){
    els.saveDailyGoal.addEventListener('click', function(){
      var oldGoal = ui.dailyOutreachGoal || 10;
      var newGoal = Number(els.dailyOutreachGoal.value || 10);
      ui.dailyOutreachGoal = newGoal;

      // If goal was decreased below the celebration level, reset celebration tracker
      if(newGoal < oldGoal && ui.lastCelebrationGoal > newGoal){
        ui.lastCelebrationGoal = Math.min(ui.lastCelebrationGoal, newGoal);
      }

      saveUI(ui);
      renderDailyOutreach();
    });
  }

  if(els.saveMonthlyGoal){
    els.saveMonthlyGoal.addEventListener('click', function(){
      var newGoal = Number(els.monthlyAppsGoal.value || 5);
      // Save goal for current context
      if(!ui.contextGoals) ui.contextGoals = {};
      var contextGoalKey = currentContext + 'Goal';
      ui.contextGoals[contextGoalKey] = newGoal;
      saveUI(ui);
      renderDailyOutreach();
    });
  }

  // Quotes edit functionality
  if(els.quotesEditBtn){
    els.quotesEditBtn.addEventListener('click', function(){
      if(els.quoteEditor && els.quoteView){
        els.quoteEditor.classList.remove('hidden');
        els.quoteView.classList.add('hidden');
        if(els.quoteMeta) els.quoteMeta.classList.add('hidden');
        // Load current quotes
        if(els.quotesTextarea){
          els.quotesTextarea.value = (state.quotes && state.quotes.raw) || '';
          updateQuoteCount();
        }
        // Load settings
        var settings = state.quotesSettings || {interval:15, random:true, norepeat:true};
        if(els.quoteInterval) els.quoteInterval.value = settings.interval || 15;
        if(els.quoteRandom) els.quoteRandom.checked = settings.random !== false;
        if(els.quoteNoRepeat) els.quoteNoRepeat.checked = settings.norepeat !== false;
      }
    });
  }

  // Update quote count as user types and add bullet points
  function updateQuoteCount(){
    if(!els.quotesTextarea) return;
    var lines = els.quotesTextarea.value.split('\n').filter(function(line){
      return line.trim().length > 0;
    });
    var quoteCountEl = document.getElementById('quoteCount');
    if(quoteCountEl){
      var count = lines.length;
      quoteCountEl.textContent = count + (count === 1 ? ' quote' : ' quotes');
    }

    // Update bullet points
    var bulletContainer = document.getElementById('quoteBullets');
    if(bulletContainer){
      var allLines = els.quotesTextarea.value.split('\n');
      var bullets = '';
      for(var i = 0; i < allLines.length; i++){
        if(allLines[i].trim().length > 0){
          bullets += '• ';
        }
        if(i < allLines.length - 1){
          bullets += '<br>';
        }
      }
      bulletContainer.innerHTML = bullets;

      // Make sure bullet container has enough height
      bulletContainer.style.height = els.quotesTextarea.scrollHeight + 'px';
    }
  }

  if(els.quotesTextarea){
    els.quotesTextarea.addEventListener('input', updateQuoteCount);
    els.quotesTextarea.addEventListener('scroll', function(){
      var bulletContainer = document.getElementById('quoteBullets');
      if(bulletContainer){
        bulletContainer.style.top = (12 - els.quotesTextarea.scrollTop) + 'px';
      }
    });
  }

  if(els.quotesNextBtn){
    els.quotesNextBtn.addEventListener('click', function(){
      renderQuote(true);
    });
  }

  if(els.quotesSaveBtn){
    els.quotesSaveBtn.addEventListener('click', function(){
      if(!els.quotesTextarea) return;
      var raw = els.quotesTextarea.value || '';
      var lines = raw.split('\n').map(function(x){return x.trim();}).filter(function(x){return x;});
      state.quotes = {raw:raw, list:lines};

      // Save settings
      state.quotesSettings = {
        interval: els.quoteInterval ? Number(els.quoteInterval.value || 15) : 15,
        random: els.quoteRandom ? els.quoteRandom.checked : true,
        norepeat: els.quoteNoRepeat ? els.quoteNoRepeat.checked : true,
        recent: state.quotesSettings ? state.quotesSettings.recent : []
      };

      save(state);
      scheduleQuoteTimer();
      renderQuote(true);

      // Hide editor
      if(els.quoteEditor) els.quoteEditor.classList.add('hidden');
      if(els.quoteView) els.quoteView.classList.remove('hidden');
      if(els.quoteMeta) els.quoteMeta.classList.remove('hidden');
    });
  }

  if(els.quotesCancelBtn){
    els.quotesCancelBtn.addEventListener('click', function(){
      // Hide editor without saving
      if(els.quoteEditor) els.quoteEditor.classList.add('hidden');
      if(els.quoteView) els.quoteView.classList.remove('hidden');
      if(els.quoteMeta) els.quoteMeta.classList.remove('hidden');
    });
  }

  function colorClass(st){ return st==='Initial Contact'?'s-contact' : st==='Sent Quote'?'s-quote' : st==='Sent Application'?'s-app' : st==='Pending Application Signature'?'s-sig' : st==='Pending Medical Questionnaire'?'s-medq' : 's-pur'; }

  /* Render Status Progress Tracker */
  // Get stages for current context (or client's context)
  function getContextStages(clientContext) {
    var ctx = clientContext || currentContext;
    return CONTEXTS[ctx] || CONTEXTS.life;
  }

  function renderStatusTracker(clientOrStatus, clientObj){
    var tracker = document.createElement('div');
    tracker.className = 'status-tracker compact';

    // Handle both client object and status string, with null checks
    var currentStage = null;
    var client = null;

    if(typeof clientOrStatus === 'string'){
      currentStage = clientOrStatus;
      client = clientObj;
    } else if(clientOrStatus){
      // For existing clients, use their stage or migrate from old status
      if(clientOrStatus.stage !== undefined) {
        currentStage = clientOrStatus.stage;
      } else if(clientOrStatus.status) {
        // Migrate old status to stage index
        currentStage = STATUS.indexOf(clientOrStatus.status);
      }
      client = clientOrStatus;
    } else {
      currentStage = null;
      client = clientObj;
    }

    // Get the context configuration
    var clientContext = (client && client.context) || currentContext;
    var contextConfig = CONTEXTS[clientContext] || CONTEXTS.life;
    var stages = contextConfig.stages;
    var stageIcons = contextConfig.stageIcons;

    // Convert stage to number if it's a string (for backwards compatibility)
    if(typeof currentStage === 'string') {
      var idx = stages.indexOf(currentStage);
      if(idx === -1) {
        // Try to find in old STATUS array for migration
        idx = STATUS.indexOf(currentStage);
        if(idx !== -1 && clientContext === 'life') {
          currentStage = Math.min(idx, stages.length - 1);
        } else {
          currentStage = -1;
        }
      } else {
        currentStage = idx;
      }
    }

    // Set progress level for the green line
    if(currentStage >= 0){
      tracker.setAttribute('data-progress', currentStage);
    } else {
      tracker.setAttribute('data-progress', '-1');
    }

    stages.forEach(function(stageName, index){
      var stage = document.createElement('div');
      stage.className = 'stage';

      // Set completed/active state
      if(currentStage >= 0){
        if(index < currentStage){
          stage.classList.add('completed');
        } else if(index === currentStage){
          stage.classList.add('active');
          // Add purchased class if this is the final stage
          if(index === stages.length - 1){
            stage.classList.add('purchased');
          }
        }
      }

      var icon = document.createElement('div');
      icon.className = 'stage-icon';
      icon.textContent = stageIcons[index] || '•';
      icon.title = stageName; // Tooltip for non-compact mode
      icon.style.position = 'relative';

      // Store stage name for tooltip
      icon.setAttribute('data-stage-name', stageName);

      // Make clickable to set stage (only if we have a client object)
      if(client && client.id){
        icon.addEventListener('click', function(e){
          e.stopPropagation();
          setClientStage(client, index);
        });

        // Add 'x' button to remove status for the first active stage (only shows on hover)
        if(index === 0 && currentStage === 0){
          var removeBtn = document.createElement('span');
          removeBtn.className = 'stage-remove-x';
          removeBtn.textContent = '×';
          removeBtn.style.cssText = 'position:absolute; top:-4px; right:-4px; width:14px; height:14px; background:#dc2626; color:white; border-radius:50%; font-size:10px; line-height:14px; text-align:center; cursor:pointer; display:none; z-index:10;';
          removeBtn.addEventListener('click', function(e){
            e.stopPropagation();
            client.stage = -1;
            client.status = '';
            save(state);
            render();
          });
          icon.appendChild(removeBtn);

          // Show/hide on hover
          icon.addEventListener('mouseenter', function(){
            removeBtn.style.display = 'block';
          });
          icon.addEventListener('mouseleave', function(){
            removeBtn.style.display = 'none';
          });
        }
      }

      var label = document.createElement('div');
      label.className = 'stage-label';
      // Use abbreviated names if available
      var shortName = (contextConfig.stageAbbr && contextConfig.stageAbbr[index]) || stageName;
      label.textContent = shortName;

      // Make label clickable in titles-only mode (same as icon)
      if(client && client.id){
        label.style.cursor = 'pointer';
        label.addEventListener('click', function(e){
          e.stopPropagation();
          setClientStage(client, index);
        });
      }

      stage.appendChild(icon);
      stage.appendChild(label);
      tracker.appendChild(stage);
    });

    return tracker;
  }
  function agingBadge(businessDays, thr){ var span=document.createElement('span'); var clr= businessDays > thr*2 ? 'red' : (businessDays > thr ? 'orange' : ''); span.className='age-badge'+(clr?(' '+clr):''); if(!clr){ span.style.display='none'; } span.textContent=String(businessDays); return span; }
  function contactedToday(c){ var start=startOfDay(new Date()), end=addDays(start,1); return (c.history||[]).some(function(h){ return h.action==='status' && isWithin(h.ts,start,end); }); }

  /* Tooltips */
  function setTip(el, text){ el.classList.add('has-tip'); el.setAttribute('data-tip', text); }

  /* Action icon group */
  function buildIconBar(c, notesWrap, ta){
    var bar=document.createElement('div'); bar.className='group--icons';
    function icon(label,key,tip){ var b=document.createElement('button'); b.className='iconbtn'; b.dataset.act=key; b.textContent=label; setTip(b, tip); return b; }
    var bNotes=icon('📝','notes','Notes'), bSched=icon('📅','schedule','Schedule'), bArch=icon('📂','archive','Archive'), bDel=icon('🗑','delete','Delete');
    bar.appendChild(bNotes); bar.appendChild(bSched); bar.appendChild(bArch); bar.appendChild(bDel);
    bNotes.addEventListener('click', function(){ notesWrap.classList.toggle('hidden'); if(!notesWrap.classList.contains('hidden')) ta.focus(); });
    bArch.addEventListener('click', function(){ archiveClient(c,!c.archived); });
    bDel.addEventListener('click', function(){ deleteClient(c); });
    bSched.addEventListener('click', function(e){ openScheduleMenu(e.currentTarget, c); });
    return bar;
  }

  function openScheduleMenu(anchorBtn, c){
    closeMenus();
    var menu=document.createElement('div'); menu.className='sched-menu';
    var rect=anchorBtn.getBoundingClientRect(); menu.style.top=(rect.bottom+window.scrollY)+'px'; menu.style.left=(rect.left+window.scrollX)+'px';
    menu.innerHTML=['<button data-m="today">Today</button>','<button data-m="tomorrow">Tomorrow</button>','<button data-m="pick">Pick Date/Time…</button>','<div style="border-top:1px solid var(--line);margin:4px 0"></div>','<button data-m="clear-fu">Clear Follow-Up</button>','<button data-m="clear-queues">Clear Today/Tomorrow</button>'].join('');
    document.body.appendChild(menu);
    menu.addEventListener('click', function(e){ var m=e.target.closest('button') && e.target.closest('button').dataset.m; if(m==='today'){ toggleQueueToday(c,true); } if(m==='tomorrow'){ toggleQueueTomorrow(c,true); } if(m==='pick'){ setFollowUpViaPicker(c); } if(m==='clear-fu'){ c.followUp=''; save(state); render(); } if(m==='clear-queues'){ c.queueToday=false; c.queueTomorrow=false; save(state); render(); } closeMenus(); });
    setTimeout(function(){ var kill=function(ev){ if(!menu.contains(ev.target)){ closeMenus(); document.removeEventListener('mousedown',kill,true);} }; document.addEventListener('mousedown',kill,true); },0);
  }
  function closeMenus(){ $all('.sched-menu').forEach(function(n){ n.parentNode.removeChild(n); }); }

  /* Build row */
  function buildRow(c, opts){
    opts=opts||{};
    var thr=getAgeThreshold();

    var row=document.createElement('div'); row.className='row '+(c.status==='Issued'?'purchased':''); row.dataset.id=c.id;
    /* Untouched class no longer needed - using green dot instead */
    row.addEventListener('click', function(){ setSelectedRowById(c.id); });

    var lastStatusEvt = last((c.history||[]).filter(function(h){return h.action==='status' && STATUS.indexOf(h.to)!==-1;}).sort(function(a,b){return new Date(a.ts)-new Date(b.ts);}));

    /* Build layout */
    if(false) { // Removed ultra-compact logic
      // Ultra-compact: name-section | actions-section | tags-section
      var nameSection=document.createElement('div'); nameSection.className='name-section';
      
      // Status icons + name + count + notes preview all in one line
      var icons=document.createElement('div'); icons.className='status-icons';
      var bd=businessDaysSince(c.lastTouch||nowISO());
      var badge=agingBadge(bd, thr); icons.appendChild(badge);
      /* Status icon removed - replaced by progress tracker */
      
      var name=document.createElement('div'); name.className='name'; 
      name.textContent=c.name;
      var tcount=document.createElement('span'); tcount.className='touchCount'; tcount.textContent='('+( (c.history||[]).length )+')';
      
      var firstLine=(c.notes||'').split('\n')[0] ? (c.notes||'').split('\n')[0].trim() : '';
      var preview=null; 
      if(firstLine){ 
        preview=document.createElement('div'); 
        preview.className='notes-preview'; 
        preview.textContent='"'+firstLine.slice(0,80)+'..."'; 
      }
      
      nameSection.appendChild(icons); nameSection.appendChild(name); nameSection.appendChild(tcount);
      if(contactedToday(c)){ 
        var touchedDot=document.createElement('span'); 
        touchedDot.className='touched-dot'; 
        touchedDot.title='Touched today';
        nameSection.appendChild(touchedDot); 
      }
      if(preview) nameSection.appendChild(preview);
      
      var mid = nameSection; // For ultra-compact, nameSection IS the mid
      
    } else {
      // Standard layout (comfortable/compact)
      var mid=document.createElement('div');
      mid.className='leftcol';
      var head=document.createElement('div'); head.className='name-line';

      var icons=document.createElement('div'); icons.className='status-icons';
      var bd=businessDaysSince(c.lastTouch||nowISO());
      var badge=agingBadge(bd, thr); badge.style.marginRight='4px'; icons.appendChild(badge);
      /* Status icon removed - replaced by progress tracker below */

      var name=document.createElement('div'); name.className='name'; 
      name.textContent=c.name;

      head.appendChild(icons); head.appendChild(name);
      var tcount=document.createElement('span'); tcount.className='touchCount'; tcount.textContent='('+( (c.history||[]).length )+')'; head.appendChild(tcount);
      if(contactedToday(c)){ 
        var touchedDot=document.createElement('span'); 
        touchedDot.className='touched-dot'; 
        touchedDot.title='Touched today';
        head.appendChild(touchedDot); 
      }
      if(opts.whenLabel){
        var whenChip=document.createElement('span');
        whenChip.className='tag-chip scheduled';
        whenChip.innerHTML = opts.whenLabel +
          '<button class="add-to-cal-btn" data-client-id="' + c.id + '" data-follow-up="' + c.followUp + '" style="margin-left:6px; padding:2px 6px; background:transparent; border:none; cursor:pointer; color:var(--blue); font-size:14px;" title="Add to Calendar">📅</button>' +
          '<span class="unschedule-x" data-client-id="' + c.id + '">×</span>';
        head.appendChild(whenChip);
      }
      if(c.purchaseDate){
        var purchaseChip=document.createElement('span');
        purchaseChip.className='tag-chip scheduled purchased-chip';
        var purchaseLabel = 'Issued: ' + new Date(c.purchaseDate).toLocaleDateString('en-US', {month:'numeric', day:'numeric', year:'2-digit'});
        purchaseChip.innerHTML = purchaseLabel + '<span class="unschedule-x clear-purchase" data-client-id="' + c.id + '">×</span>';
        head.appendChild(purchaseChip);
      }
      if(c.queueToday){ var chip1=document.createElement('span'); chip1.className='tag-chip'; chip1.textContent='Today'; head.appendChild(chip1); }
      if(c.queueTomorrow){ var chip2=document.createElement('span'); chip2.className='tag-chip'; chip2.textContent='Tomorrow'; head.appendChild(chip2); }
      mid.appendChild(head);

      var firstLine=(c.notes||'').split('\n')[0] ? (c.notes||'').split('\n')[0].trim() : '';
      var preview=null; if(firstLine){ preview=document.createElement('div'); preview.className='notes-preview'; preview.textContent=firstLine.slice(0,120); mid.appendChild(preview); }
    }
    
    // Notes textarea (shared by both layouts)
    var notesWrap=document.createElement('div'); notesWrap.className='notes hidden';
    var ta=document.createElement('textarea'); ta.placeholder='Notes…'; ta.value=c.notes||'';
    ta.addEventListener('input', function(){ updateNotes(c,ta.value); });
    ta.addEventListener('keydown', function(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); updateNotes(c, ta.value); var first=(ta.value||'').split('\n')[0] ? (ta.value||'').split('\n')[0].trim() : ''; if(first){ var existingPreview = mid.querySelector('.notes-preview'); if(!existingPreview){ var newPreview=document.createElement('div'); newPreview.className='notes-preview'; newPreview.textContent=first.slice(0,120); mid.insertBefore(newPreview, notesWrap); } else if(existingPreview) { existingPreview.textContent = first.slice(0,120); } } else { var existingPreview = mid.querySelector('.notes-preview'); if(existingPreview){ existingPreview.parentNode.removeChild(existingPreview); } } notesWrap.classList.add('hidden'); ta.blur(); }});
    notesWrap.appendChild(ta); mid.appendChild(notesWrap);

    if(false) { // Removed ultra-compact logic
      // Ultra-compact: actions-section | tags-section
      var actionsSection=document.createElement('div'); actionsSection.className='actions-section';
      
      // Combine all actions into one compact group
      var callBtn=document.createElement('button'); callBtn.className='qbtn has-tip'; setTip(callBtn,'Call'); callBtn.textContent=EMOJI_CALL;
      var callBadge=document.createElement('span'); callBadge.className='badge'; callBadge.textContent=String(c.callCount||0); callBadge.setAttribute('data-zero', (c.callCount||0)===0 ? '1':'0'); callBtn.appendChild(callBadge);
      var lastCallDate = getLastContactDate(c, 'Called');
      if(lastCallDate){
        var callDateSpan = document.createElement('span');
        callDateSpan.className = 'last-contact';
        callDateSpan.textContent = lastCallDate;
        callBtn.appendChild(callDateSpan);
      }
      callBtn.addEventListener('click', function(){ incrementCall(c); });

      var msgBtn=document.createElement('button'); msgBtn.className='qbtn has-tip'; setTip(msgBtn,'Message'); msgBtn.textContent=EMOJI_MSG;
      var msgBadge=document.createElement('span'); msgBadge.className='badge'; msgBadge.textContent=String(c.msgCount||0); msgBadge.setAttribute('data-zero', (c.msgCount||0)===0 ? '1':'0'); msgBtn.appendChild(msgBadge);
      var lastMsgDate = getLastContactDate(c, 'Emailed');
      if(lastMsgDate){
        var msgDateSpan = document.createElement('span');
        msgDateSpan.className = 'last-contact';
        msgDateSpan.textContent = lastMsgDate;
        msgBtn.appendChild(msgDateSpan);
      }
      msgBtn.addEventListener('click', function(){ incrementMsg(c); });

      actionsSection.appendChild(callBtn); actionsSection.appendChild(msgBtn);
      
      // Status buttons (icon only)
      STATUS.forEach(function(st){
        var btn=document.createElement('button'); btn.className='sbtn has-tip '+colorClass(st); setTip(btn, st);
        if(c.status===st) btn.classList.add('active');
        var ico=document.createElement('span'); ico.className='ico status-icon'; ico.textContent=STATUS_ICON[st] || '•';
        btn.appendChild(ico); // No label in ultra-compact
        btn.addEventListener('click', function(){ setStatus(c,st,btn); });
        actionsSection.appendChild(btn);
      });
      
      // Hot button
      var hotBtn=document.createElement('button'); hotBtn.className='sbtn has-tip s-hot'; setTip(hotBtn, 'Hot lead');
      if(c.hot) hotBtn.classList.add('active');
      var hotIco=document.createElement('span'); hotIco.className='ico'; hotIco.textContent='🔥';
      hotBtn.appendChild(hotIco);
      hotBtn.addEventListener('click', function(e){
        var wasHot = c.hot;
        preserveUIAndRender(function(){ c.hot = !c.hot; });
        if(!wasHot && c.hot){
          showFlameAnimation(e);
        }
      });
      actionsSection.appendChild(hotBtn);
      
      // Action icons
      var iconbar = buildIconBar(c, notesWrap, ta);
      iconbar.childNodes.forEach(function(btn){ actionsSection.appendChild(btn); });
      
      // Tags section
      var tagsSection=document.createElement('div'); tagsSection.className='tags-section';
      if(opts.whenLabel){
        var whenChip=document.createElement('span');
        whenChip.className='tag-chip scheduled';
        whenChip.innerHTML = opts.whenLabel + '<span class="unschedule-x" data-client-id="' + c.id + '">×</span>';
        tagsSection.appendChild(whenChip);
      }
      if(c.purchaseDate){
        var purchaseChip=document.createElement('span');
        purchaseChip.className='tag-chip scheduled purchased-chip';
        var purchaseLabel = 'Issued: ' + new Date(c.purchaseDate).toLocaleDateString('en-US', {month:'numeric', day:'numeric', year:'2-digit'});
        purchaseChip.innerHTML = purchaseLabel + '<span class="unschedule-x clear-purchase" data-client-id="' + c.id + '">×</span>';
        tagsSection.appendChild(purchaseChip);
      }
      if(c.queueToday){ var chip1=document.createElement('span'); chip1.className='tag-chip'; chip1.textContent='Today'; tagsSection.appendChild(chip1); }
      if(c.queueTomorrow){ var chip2=document.createElement('span'); chip2.className='tag-chip'; chip2.textContent='Tomorrow'; tagsSection.appendChild(chip2); }
      
      row.appendChild(mid); row.appendChild(actionsSection); row.appendChild(tagsSection);
      
    } else {
      // Standard layout
      var right=document.createElement('div'); right.className='actions-wrap';

      // Quick counters (more spacing from statuses via group class)
      var quick=document.createElement('div'); quick.className='group--quick';
      var callBtn=document.createElement('button'); callBtn.className='qbtn has-tip'; callBtn.title='Log a Call'; setTip(callBtn,'Call'); callBtn.textContent=EMOJI_CALL;
      var callBadge=document.createElement('span'); callBadge.className='badge'; callBadge.textContent=String(c.callCount||0); callBadge.setAttribute('data-zero', (c.callCount||0)===0 ? '1':'0'); callBtn.appendChild(callBadge);
      var lastCallDate = getLastContactDate(c, 'Called');
      if(lastCallDate){
        var callDateSpan = document.createElement('span');
        callDateSpan.className = 'last-contact';
        callDateSpan.textContent = lastCallDate;
        callBtn.appendChild(callDateSpan);
      }
      callBtn.addEventListener('click', function(){ incrementCall(c); });

      var msgBtn=document.createElement('button'); msgBtn.className='qbtn has-tip'; msgBtn.title='Log a Message'; setTip(msgBtn,'Message'); msgBtn.textContent=EMOJI_MSG;
      var msgBadge=document.createElement('span'); msgBadge.className='badge'; msgBadge.textContent=String(c.msgCount||0); msgBadge.setAttribute('data-zero', (c.msgCount||0)===0 ? '1':'0'); msgBtn.appendChild(msgBadge);
      var lastMsgDate = getLastContactDate(c, 'Emailed');
      if(lastMsgDate){
        var msgDateSpan = document.createElement('span');
        msgDateSpan.className = 'last-contact';
        msgDateSpan.textContent = lastMsgDate;
        msgBtn.appendChild(msgDateSpan);
      }
      msgBtn.addEventListener('click', function(){ incrementMsg(c); });
      quick.appendChild(callBtn); quick.appendChild(msgBtn);

      // Replace status buttons with progress tracker
      var statusTracker = renderStatusTracker(c);

      // Create a wrapper for status tracker and hot button
      var bar = document.createElement('div');
      bar.className = 'group--status';
      bar.style.display = 'flex';
      bar.style.alignItems = 'center';
      bar.style.gap = '12px';

      if(statusTracker){
        statusTracker.style.margin = '0';
        statusTracker.style.padding = '0';
        bar.appendChild(statusTracker);
      }

      // Hot Lead toggle button
      var hotBtn=document.createElement('button');
      hotBtn.className='sbtn has-tip s-hot';
      hotBtn.style.marginLeft = '8px';
      setTip(hotBtn, 'Hot lead (pin to top)');
      if(c.hot) hotBtn.classList.add('active');
      var hotIco=document.createElement('span'); hotIco.className='ico'; hotIco.textContent='🔥';
      var hotCap=document.createElement('span'); hotCap.className='label'; hotCap.textContent='Hot';
      hotBtn.appendChild(hotIco); hotBtn.appendChild(hotCap);
      hotBtn.addEventListener('click', function(e){
        var wasHot = c.hot;
        preserveUIAndRender(function(){ c.hot = !c.hot; });
        if(!wasHot && c.hot){
          showFlameAnimation(e);
        }
      });
      bar.appendChild(hotBtn);

      // Notes/Schedule/Archive/Delete (icon bar)
      var iconbar = buildIconBar(c, notesWrap, ta);

      right.appendChild(quick); right.appendChild(bar); right.appendChild(iconbar);
      row.appendChild(mid); row.appendChild(right);
    }
    
    // Hot lead row styling
    if(c.hot) {
      row.classList.add('hot-row');
    }
    
    return row;
  }

  /* Selection */
  function allRows(){ return $all('#todayList .row, #list .row, #scheduledList .row'); }
  var selectionIndex=0;
  function setSelectedRowById(id){ var rows=allRows(); var idx=rows.findIndex(function(r){return r.dataset.id===id;}); if(idx>=0){ selectionIndex=idx; restoreSelection(); } }
  function restoreSelection(){ var rows=allRows(); rows.forEach(function(r){ r.classList.remove('selected'); }); if(!rows.length) return; if(selectionIndex<0) selectionIndex=0; if(selectionIndex>=rows.length) selectionIndex=0; rows[selectionIndex].classList.add('selected'); rows[selectionIndex].scrollIntoView({block:'nearest'}); }
  function getSelectedClient(){ var rows=allRows(); if(!rows.length) return null; var id=rows[selectionIndex] && rows[selectionIndex].dataset.id; return (state && state.clients) ? state.clients.find(function(c){return c.id===id;}) : null; }

  /* Activity / chart / heatmap */
  function todaysItems(){ var start=startOfDay(new Date()), end=addDays(start,1), items=[]; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action!=='status') return; if(isWithin(h.ts,start,end)) items.push({ts:h.ts,name:c.name,label:(STATUS_ABBR[h.to]||h.to),clientId:c.id,histId:h.id}); }); }); return items.sort(function(a,b){return new Date(b.ts)-new Date(a.ts);}); }
  function todaysGrouped(){ var start=startOfDay(new Date()), end=addDays(start,1), map={}; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action!=='status') return; if(!isWithin(h.ts,start,end)) return; var label=(STATUS_ABBR[h.to]||h.to); var g=map[c.id] || {id:c.id,name:c.name,items:[]}; g.items.push({ts:h.ts,label:label,histId:h.id}); map[c.id]=g; }); }); var groups=Object.keys(map).map(function(k){ var g=map[k]; g.items=g.items.sort(function(a,b){return new Date(a.ts)-new Date(b.ts);}); g.latest=Math.max.apply(null, g.items.map(function(i){return +new Date(i.ts);})); return g; }).sort(function(a,b){return b.latest-a.latest;}); return groups; }
  function renderActivity(){ if(els.todayDate) els.todayDate.textContent=new Date().toLocaleDateString([], {weekday:'long',month:'long',day:'numeric',year:'numeric'}); var grouped= !!ui.groupTodayByClient; els.groupToggle && (els.groupToggle.checked = grouped); if(!els.activity) return; els.activity.innerHTML=''; if(!grouped){ var items=todaysItems(); if(!items.length){ els.activity.innerHTML='<div class="muted small">No activity yet today.</div>'; return; } items.forEach(function(it){ var div=document.createElement('div'); div.className='item'; div.innerHTML='<div class="small muted">'+fmtTime(it.ts)+'</div><div><b>'+escapeHtml(it.name)+'</b> — '+escapeHtml(it.label)+'</div>'+'<button class="undo" data-undo data-client="'+it.clientId+'" data-hist="'+it.histId+'">Undo</button>'; els.activity.appendChild(div); }); } else { var groups=todaysGrouped(); if(!groups.length){ els.activity.innerHTML='<div class="muted small">No activity yet today.</div>'; return; } groups.forEach(function(g){ var who=document.createElement('div'); who.style.fontWeight='700'; who.textContent=g.name; who.style.margin='6px 0 4px'; els.activity.appendChild(who); g.items.forEach(function(it){ var div=document.createElement('div'); div.className='item'; div.innerHTML='<div class="small muted">'+fmtTime(it.ts)+'</div><div>— '+escapeHtml(it.label)+'</div>'+'<button class="undo" data-undo data-client="'+g.id+'" data-hist="'+it.histId+'">Undo</button>'; els.activity.appendChild(div); }); }); } }
  if(els.activity) els.activity.addEventListener('click', function(e){ var btn=e.target.closest('[data-undo]'); if(!btn) return; var cid=btn.getAttribute('data-client'), hid=btn.getAttribute('data-hist'); var c=(state && state.clients) ? state.clients.find(function(x){return String(x.id)===String(cid);}) : null; if(!c) return; var i=c.history.findIndex(function(h){ return String(h.id)===String(hid); }); if(i!==-1){ preserveUIAndRender(function(){ c.history.splice(i,1); var onlyStatus=c.history.filter(function(h){return h.action==='status' && STATUS.indexOf(h.to)!==-1;}).sort(function(a,b){return new Date(a.ts)-new Date(b.ts);}); var lastStatus=last(onlyStatus); c.status = lastStatus ? (lastStatus.to||'') : ''; var anyLast=last(c.history.sort(function(a,b){return new Date(a.ts)-new Date(b.ts);})); if(anyLast) c.lastTouch=anyLast.ts; }); } });

  function lastNDays(n){ var out=[], i, day, next, count; for(i=n-1;i>=0;i--){ day=startOfDay(addDays(new Date(), -i)); next=addDays(day,1); count=0; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action==='status'){ var t=new Date(h.ts); if(t>=day && t<next) count++; }}); }); out.push({label:(day.getMonth()+1)+'/'+day.getDate(), count:count}); } return out; }
  function renderChart(){ if(!els.chart) return; var days=parseInt((els.chartRangeSel && els.chartRangeSel.value) || '7',10); var data=lastNDays(days), max=1, i; for(i=0;i<data.length;i++){ if(data[i].count>max) max=data[i].count; } els.chart.innerHTML=''; data.forEach(function(d){ var wrap=document.createElement('div'); wrap.style.flex='1'; wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.alignItems='stretch'; var bar=document.createElement('div'); bar.className='bar'; bar.style.height=(Math.max(6, (d.count/max*100)))+'%'; var lab=document.createElement('div'); lab.className='barlab'; lab.textContent=d.label; wrap.appendChild(bar); wrap.appendChild(lab); els.chart.appendChild(wrap); }); }
  function renderHeatmap(){ if(!els.heatmap) return; var days=90, data=lastNDays(days); function lvl(c){ return c===0?'': c<=1?'l1': c<=3?'l2': c<=6?'l3':'l4'; } els.heatmap.innerHTML=''; data.forEach(function(d){ var cell=document.createElement('div'); cell.className='cell '+lvl(d.count); cell.title=d.label+': '+d.count; els.heatmap.appendChild(cell); }); }

  /* Followups & Next to Touch */
  function renderFollowUps(){
    if(!els.followList) return;
    if(!state || !state.clients) return;
    var now = new Date();
    var items = state.clients.filter(function(c){
      // Exclude archived and tomorrow-queued clients
      return !c.archived && c.followUp && !c.queueTomorrow;
    }).map(function(c){
      var when = new Date(c.followUp);
      var daysUntil = Math.ceil((when - now) / (1000 * 60 * 60 * 24));
      return {c:c, when:when, daysUntil:daysUntil};
    }).sort(function(a,b){return +a.when - +b.when;});

    els.followList.innerHTML='';
    if(!items.length){
      els.followList.innerHTML='<div class="small muted">No scheduled follow ups.</div>';
      return;
    }

    // Add a button to add all follow-ups to calendar at once
    if(items.length > 1){
      var bulkBtn = document.createElement('button');
      bulkBtn.className = 'btn-min gray';
      bulkBtn.style.cssText = 'width: 100%; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 6px;';
      bulkBtn.innerHTML = '📅 Add All to Calendar (' + items.length + ')';
      bulkBtn.addEventListener('click', function(){
        items.forEach(function(item, index){
          setTimeout(function(){
            createCalendarEvent(item.c, item.when);
          }, index * 500); // Stagger to avoid overwhelming the browser
        });
      });
      els.followList.appendChild(bulkBtn);
    }

    items.forEach(function(rec){
      var div=document.createElement('div');
      div.className='followitem';
      div.style.cursor = 'pointer';

      var left=document.createElement('div');
      left.style.display = 'flex';
      left.style.alignItems = 'center';
      left.style.gap = '6px';

      var nameSpan = document.createElement('span');
      nameSpan.textContent=rec.c.name;
      left.appendChild(nameSpan);

      // Add small calendar button for individual items
      var calBtn = document.createElement('button');
      calBtn.style.cssText = 'padding: 2px 4px; background: transparent; border: none; cursor: pointer; color: var(--blue); font-size: 12px;';
      calBtn.textContent = '📅';
      calBtn.title = 'Add to Calendar';
      calBtn.addEventListener('click', function(e){
        e.stopPropagation();
        createCalendarEvent(rec.c, rec.when);
      });
      left.appendChild(calBtn);

      var right=document.createElement('div');
      right.className='small muted';

      // Show countdown and turn red if overdue
      if(rec.daysUntil < 0){
        right.style.color = '#dc2626';
        right.style.fontWeight = '600';
        right.textContent = Math.abs(rec.daysUntil) + ' days overdue';
      } else if(rec.daysUntil === 0){
        right.style.color = '#f59e0b';
        right.style.fontWeight = '600';
        right.textContent = 'Due today';
      } else if(rec.daysUntil === 1){
        right.textContent = 'Tomorrow';
      } else {
        right.textContent = 'In ' + rec.daysUntil + ' days';
      }

      div.appendChild(left);
      div.appendChild(right);
      els.followList.appendChild(div);
    });
  }
  function renderNextToTouch(){ if(!els.nextList) return; var thr=getAgeThreshold(); var list=state.clients.filter(function(c){return !c.archived;}).map(function(c){return {c:c, bd:businessDaysSince(c.lastTouch)};}).filter(function(x){return x.bd>thr;}).sort(function(a,b){return b.bd-a.bd;}).slice(0,25); els.nextList.innerHTML=''; if(!list.length){ els.nextList.innerHTML='<div class="small muted">All caught up '+CLAP+'</div>'; return; } list.forEach(function(it){ var div=document.createElement('div'); div.className='nextitem'; var left=document.createElement('div'); var b=agingBadge(it.bd, thr); b.classList.add('sm'); b.style.marginRight='6px'; b.style.display='inline-flex'; var nameSpan=document.createElement('span'); nameSpan.textContent=it.c.name; left.appendChild(b); left.appendChild(nameSpan); var right=document.createElement('div'); right.className='small muted'; right.textContent='Last: '+fmtDay(it.c.lastTouch)+' ('+it.bd+'bd)'; div.appendChild(left); div.appendChild(right); els.nextList.appendChild(div); }); }

  /* Tomorrow + Scheduled */
  function renderTomorrowList(){ if(!els.tomorrowList) return; var list = state.clients.filter(function(c){ return !c.archived && c.queueTomorrow; }); els.tomorrowList.innerHTML=''; if(!list.length){ els.tomorrowList.innerHTML='<div class="small muted">Nothing queued.</div>'; return; } sortClients(list).forEach(function(c){ var div=document.createElement('div'); div.className='nextitem'; div.innerHTML='<div>'+escapeHtml(c.name)+'</div><div class="small muted">last '+fmtDay(c.lastTouch)+'</div>'; els.tomorrowList.appendChild(div); }); }
  function isFutureFollowUp(c){ if(!c.followUp) return false; var t=new Date(c.followUp); return !isNaN(+t) && t>new Date(); }

  /* Root render */
  function sortClients(arr){
    var key = getCookie('sortBy');
    // Default to 'none' if no cookie is set
    if(!key) key = 'none';

    // If no sort is selected, return the array as-is
    if(key === 'none') {
      return arr.slice();
    }

    return arr.slice().sort(function(a,b){
      // Prioritize hot leads first
      if(a.hot !== b.hot) return a.hot ? -1 : 1;

      // Then apply the current sort key
      if(key==='name'){
        return a.name.localeCompare(b.name);
      }
      return new Date(b[key]||0)-new Date(a[key]||0);
    });
  }
  function renderList(container, clients, opts){
    opts=opts||{};
    if(!container) return;
    container.innerHTML='';
    var q=(els.globalSearch && els.globalSearch.value ? els.globalSearch.value : '').toLowerCase().trim();
    var filtered = clients.filter(function(c){
      // Note: Context filtering already done in render() function
      // Don't double-filter here
      if(els.showArchived && els.showArchived.checked ? !c.archived : c.archived) return false;
      if(els.statusFilter && els.statusFilter.value && c.status!==els.statusFilter.value) return false;
      if(q && !(c.name.toLowerCase().includes(q) || (c.notes||'').toLowerCase().includes(q) || (c.status||'').toLowerCase().includes(q))) return false;
      return true;
    });

    // Show empty state message if no clients (but not in renderList - handle this at higher level)
    if(filtered.length === 0 && clients.length === 0 && !q){
      // Don't show empty state in list container - this will be handled by main render function
      return;
    }

    sortClients(filtered).forEach(function(c){
      var row=buildRow(c, opts.rowOpts||{});
      container.appendChild(row);
    });
    restoreSelection();
  }

  function renderGroupedList(container){
    if(!container) return;
    container.innerHTML='';

    var q=(els.globalSearch && els.globalSearch.value ? els.globalSearch.value : '').toLowerCase().trim();

    // Render each context group in order
    ui.contextGroupOrder.forEach(function(contextKey, groupIndex){
      if(!CONTEXTS[contextKey]) return;

      var groupClients = state.clients.filter(function(c){
        var clientContext = c.context || 'life';
        if(clientContext !== contextKey) return false;
        if(els.showArchived && els.showArchived.checked ? !c.archived : c.archived) return false;
        if(els.statusFilter && els.statusFilter.value && c.status!==els.statusFilter.value) return false;
        if(q && !(c.name.toLowerCase().includes(q) || (c.notes||'').toLowerCase().includes(q) || (c.status||'').toLowerCase().includes(q))) return false;
        return true;
      });

      if(groupClients.length === 0 && !q) return; // Skip empty groups when not searching

      // Create group container
      var groupDiv = document.createElement('div');
      groupDiv.className = 'context-group';
      groupDiv.dataset.context = contextKey;

      // Create group header
      var header = document.createElement('div');
      header.className = 'context-group-header';

      var titleDiv = document.createElement('div');
      titleDiv.className = 'context-group-title';

      var titleSpan = document.createElement('span');
      titleSpan.textContent = CONTEXTS[contextKey].icon + ' ' + CONTEXTS[contextKey].name;
      titleDiv.appendChild(titleSpan);

      var countSpan = document.createElement('span');
      countSpan.className = 'context-group-count';
      countSpan.textContent = '(' + groupClients.length + ')';
      titleDiv.appendChild(countSpan);

      header.appendChild(titleDiv);

      // Add reorder controls
      var controls = document.createElement('div');
      controls.className = 'context-group-controls';

      var upBtn = document.createElement('button');
      upBtn.textContent = '↑';
      upBtn.title = 'Move group up';
      upBtn.disabled = groupIndex === 0;
      upBtn.onclick = function(){
        if(groupIndex > 0){
          var temp = ui.contextGroupOrder[groupIndex];
          ui.contextGroupOrder[groupIndex] = ui.contextGroupOrder[groupIndex - 1];
          ui.contextGroupOrder[groupIndex - 1] = temp;
          saveUI(ui);
          render();
        }
      };

      var downBtn = document.createElement('button');
      downBtn.textContent = '↓';
      downBtn.title = 'Move group down';
      downBtn.disabled = groupIndex === ui.contextGroupOrder.length - 1;
      downBtn.onclick = function(){
        if(groupIndex < ui.contextGroupOrder.length - 1){
          var temp = ui.contextGroupOrder[groupIndex];
          ui.contextGroupOrder[groupIndex] = ui.contextGroupOrder[groupIndex + 1];
          ui.contextGroupOrder[groupIndex + 1] = temp;
          saveUI(ui);
          render();
        }
      };

      controls.appendChild(upBtn);
      controls.appendChild(downBtn);
      header.appendChild(controls);

      groupDiv.appendChild(header);

      // Add clients
      var clientsContainer = document.createElement('div');
      sortClients(groupClients).forEach(function(c){
        var row = buildRow(c, {});
        clientsContainer.appendChild(row);
      });
      groupDiv.appendChild(clientsContainer);

      container.appendChild(groupDiv);
    });

    restoreSelection();
  }

  // Global tooltip for icons in compact mode
  var globalIconTooltip = null;

  function initializeCompactTooltips(){
    // Create global tooltip if it doesn't exist
    if(!globalIconTooltip){
      globalIconTooltip = document.createElement('div');
      globalIconTooltip.style.cssText = 'position:fixed;padding:4px 8px;background:rgba(0,0,0,0.9);color:white;font-size:11px;font-weight:600;white-space:nowrap;border-radius:4px;pointer-events:none;opacity:0;transition:opacity 0.2s;z-index:999999;box-shadow:0 2px 8px rgba(0,0,0,0.3);';
      document.body.appendChild(globalIconTooltip);
    }

    // Add event delegation for all tooltippable icons
    document.addEventListener('mouseover', function(e){
      if(document.body.getAttribute('data-density') !== 'compact') return;

      var target = e.target;
      var tooltipText = null;

      // Check for stage icons
      if(target.classList.contains('stage-icon') && target.getAttribute('data-stage-name')){
        tooltipText = target.getAttribute('data-stage-name');
      }
      // Check for group icons (iconbtn class)
      else if(target.classList.contains('iconbtn') && target.getAttribute('data-tip')){
        tooltipText = target.getAttribute('data-tip');
      }
      // Check for hot icon
      else if(target.classList.contains('sbtn') && target.classList.contains('s-hot')){
        tooltipText = 'Hot';
      }
      // Check for hot icon's inner span
      else if(target.parentElement && target.parentElement.classList.contains('s-hot')){
        tooltipText = 'Hot';
        target = target.parentElement; // Use parent for positioning
      }

      if(tooltipText){
        var rect = target.getBoundingClientRect();

        globalIconTooltip.textContent = tooltipText;
        globalIconTooltip.style.opacity = '1';

        // Position below the icon
        var tooltipRect = globalIconTooltip.getBoundingClientRect();
        var left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
        var top = rect.bottom + 8;

        // Keep tooltip on screen
        if(left < 5) left = 5;
        if(left + tooltipRect.width > window.innerWidth - 5){
          left = window.innerWidth - tooltipRect.width - 5;
        }
        // If no room below, show above
        if(top + tooltipRect.height > window.innerHeight - 5){
          top = rect.top - tooltipRect.height - 8;
        }

        globalIconTooltip.style.left = left + 'px';
        globalIconTooltip.style.top = top + 'px';
      }
    });

    document.addEventListener('mouseout', function(e){
      var target = e.target;
      if(target.classList.contains('stage-icon') ||
         target.classList.contains('iconbtn') ||
         target.classList.contains('sbtn') ||
         (target.parentElement && target.parentElement.classList.contains('s-hot'))){
        if(globalIconTooltip) globalIconTooltip.style.opacity = '0';
      }
    });
  }

  function render(){
    if(!state || !state.clients) return;

    // Set body attribute for All Contexts view
    if(currentContext === 'all'){
      document.body.setAttribute('data-all-contexts', 'true');
    } else {
      document.body.removeAttribute('data-all-contexts');
    }

    // Show/hide context goal and update label based on context
    var contextGoalGroup = document.getElementById('contextGoalGroup');
    var contextGoalSeparator = document.getElementById('contextGoalSeparator');
    var contextGoalLabel = document.getElementById('contextGoalLabel');

    if(contextGoalGroup && contextGoalSeparator && contextGoalLabel){
      if(currentContext !== 'all'){
        // Show goal for all contexts except 'all'
        contextGoalGroup.style.display = '';
        contextGoalSeparator.style.display = 'block';

        // Update label based on context
        var contextLabels = {
          'life': 'Life Apps Goal:',
          'home_auto': 'Home & Auto Goal:',
          'commercial': 'Commercial Goal:',
          'farm': 'Farm Goal:',
          'networking': 'Networking Goal:'
        };
        contextGoalLabel.textContent = contextLabels[currentContext] || 'Monthly Goal:';
      } else {
        // Hide for 'all' context
        contextGoalGroup.style.display = 'none';
        contextGoalSeparator.style.display = 'none';
      }
    }

    // Handle "all" context separately
    if(currentContext === 'all'){
      var activeAll = state.clients.filter(function(c){return !c.archived;});
      var scheduled = activeAll.filter(isFutureFollowUp);

      renderKPIs(); renderPipeline(); renderTrendRibbons(); renderDailyOutreach(); updateDemoButtons();

      // Hide empty state for "all" view
      hideEmptyState();

      // Render grouped list
      renderGroupedList(els.list);

      // Hide Today's block in "all" context view - clients are shown grouped by context instead
      if(els.todayBlock){
        els.todayBlock.classList.add('hidden');
      }
      if(els.todayList){
        els.todayList.innerHTML='';
      }

      // Hide Scheduled block in "all" context view as well
      if(els.scheduledBlock){
        els.scheduledBlock.classList.add('hidden');
      }
      if(els.scheduledList){
        els.scheduledList.innerHTML='';
      }

      // Handle scheduled items in sidebar
      renderList(els.followList, scheduled.sort(function(a, b) {
        var dateA = new Date(a.followUp);
        var dateB = new Date(b.followUp);
        return dateA - dateB;
      }));
      renderNextToTouch();
      renderFollowUps();
      renderActivity();
      renderHeatmap();
      renderChart();
      return;
    }

    // Filter clients by current context
    var contextClients = state.clients.filter(function(c){
      return (c.context || 'life') === currentContext;
    });

    var activeAll=contextClients.filter(function(c){return !c.archived;});
    var todayClients = activeAll.filter(function(c){ return c.queueToday; });
    var scheduled = activeAll.filter(isFutureFollowUp);
    var mainActive = activeAll.filter(function(c){ return !isFutureFollowUp(c) && !c.queueToday; });
    var archived=contextClients.filter(function(c){return c.archived;});

    renderKPIs(); renderPipeline(); renderTrendRibbons(); renderDailyOutreach(); updateDemoButtons();

    // Handle empty state for main list
    var totalActiveClients = mainActive.length + todayClients.length + scheduled.length;
    if(totalActiveClients === 0){
      showEmptyState();
    } else {
      hideEmptyState();
      renderList(els.list, mainActive);
    }

    // Today section
    if(els.todayBlock && els.todayList){
      if(todayClients.length){
        els.todayBlock.classList.remove('hidden');
        els.todayList.innerHTML='';
        sortClients(todayClients).forEach(function(c){
          var row=buildRow(c, {});
          els.todayList.appendChild(row);
        });
      } else {
        els.todayBlock.classList.add('hidden');
        els.todayList.innerHTML='';
      }
    }

    // Scheduled section
    if(els.scheduledBlock && els.scheduledList){
      if(scheduled.length){
        els.scheduledBlock.classList.remove('hidden');
        els.scheduledList.innerHTML='';
        sortClients(scheduled).forEach(function(c){
          var whenLabel=(new Date(c.followUp)).toLocaleString([], {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'});
          var row=buildRow(c, {whenLabel: whenLabel});
          els.scheduledList.appendChild(row);
        });
      } else {
        els.scheduledBlock.classList.add('hidden');
        els.scheduledList.innerHTML='';
      }
    }

    if(els.showArchived && els.showArchived.checked){
      els.archivedBlock.classList.remove('hidden');
      renderList(els.archivedList, archived);
    } else {
      els.archivedBlock.classList.add('hidden');
      els.archivedList && (els.archivedList.innerHTML='');
    }

    els.todayDate && (els.todayDate.textContent=new Date().toLocaleDateString([], {weekday:'long',month:'long',day:'numeric',year:'numeric'}));
    renderActivity(); renderChart(); renderHeatmap(); renderNextToTouch(); renderFollowUps(); renderQuote(false);

    // Enable drag and drop after rendering if "No Sort" is selected
    setTimeout(enableDragAndDrop, 100);
  }

  /* Quotes (light) */
  var quoteTimer=null; function pickQuote(){ var list=(state.quotes && state.quotes.list)||[]; if(!list.length) return ''; var qs=state.quotesSettings||{interval:15, random:true, norepeat:true, recent:[]}; if(!qs.random){ var idx=Number(qs.lastIndex||0); idx=(idx+1)%list.length; qs.lastIndex=idx; return list[idx]; } var recent=Array.isArray(qs.recent)?qs.recent:[]; var tries=0, idx2=0; do{ idx2=Math.floor(Math.random()*list.length); tries++; } while(qs.norepeat && recent.indexOf(idx2)!==-1 && tries<25); recent.push(idx2); while(recent.length>Math.min(20, Math.ceil(list.length/3))) recent.shift(); qs.recent=recent; qs.lastIndex=idx2; state.quotesSettings=qs; save(state); return list[idx2]; }
  function renderQuote(showNew){ if(showNew){ var q=pickQuote(); if(q) state.quotes._current=q; } if(!els.quoteView) return; var cur=(state.quotes && state.quotes._current) ? state.quotes._current : (((state.quotes||{}).list||[])[0]||''); els.quoteView.textContent = cur || 'Add quotes to get started.'; var count=((state.quotes||{}).list||[]).length; els.quoteMeta && (els.quoteMeta.textContent = count ? (count+' quotes • rotates every '+(state.quotesSettings&&state.quotesSettings.interval||15)+' min') : ''); }
  function scheduleQuoteTimer(){ if(quoteTimer) clearInterval(quoteTimer); var mins=(state.quotesSettings && state.quotesSettings.interval) ? Number(state.quotesSettings.interval) : 15; if(mins>0){ quoteTimer=setInterval(function(){ renderQuote(true); }, mins*60*1000); } }

  /* Filters & UI wiring */
  ['change','input'].forEach(function(ev){
    if(els.statusFilter) els.statusFilter.addEventListener(ev, render);
    if(els.showArchived) els.showArchived.addEventListener(ev, render);
    if(els.globalSearch) els.globalSearch.addEventListener(ev, render);
    if(els.sortBy) els.sortBy.addEventListener(ev, function(){
      setSortCookie(els.sortBy.value);
      render();
      setTimeout(enableDragAndDrop, 100);
      els.sortBy.blur(); // Remove focus to enable keyboard navigation
    });
    // Context pills click handlers
    if(els.contextPills) {
      els.contextPills.querySelectorAll('button').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var newContext = this.getAttribute('data-context');
          if(newContext === currentContext) return; // Already selected

          // Update active state
          els.contextPills.querySelectorAll('button').forEach(function(b) {
            b.classList.remove('active');
          });
          this.classList.add('active');

          // Update context
          currentContext = newContext;
          setContextCookie(currentContext);

          // Update the title and label
          if(els.contextName) {
            if(currentContext === 'all') {
              els.contextName.textContent = 'All';
            } else {
              els.contextName.textContent = CONTEXTS[currentContext].name;
            }
          }
          if(els.contextLabel) {
            if(currentContext === 'all') {
              els.contextLabel.textContent = 'All Contexts';
            } else {
              els.contextLabel.textContent = CONTEXTS[currentContext].name;
            }
          }
          // Re-render to update stage displays
          render();
          this.blur(); // Remove focus to enable keyboard navigation
        });
      });
    }
    if(els.chartRangeSel) els.chartRangeSel.addEventListener(ev, function(){ renderChart(); });
  });

  if(els.ageDays){
    els.ageDays.addEventListener('change', function(){
      ui.ageDays = Number(els.ageDays.value||4);
      saveUI(ui);
      render();
    });
  }

  if(els.calendarMethod){
    els.calendarMethod.addEventListener('change', function(){
      ui.calendarMethod = els.calendarMethod.value;
      saveUI(ui);
    });
  }

  // Event listener only, initialization moved to Promise.all
  if(els.groupToggle) els.groupToggle.addEventListener('change', function(){ ui.groupTodayByClient = !!els.groupToggle.checked; saveUI(ui); renderActivity(); });

  if(els.globalSearch) els.globalSearch.addEventListener('keydown', function(e){
    if(e.key==='Enter'){
      var q=els.globalSearch.value.trim(); if(!q) return;
      // Check for duplicates only within the current context
      var exists=state.clients.some(function(c){
        return (c.context || 'life') === currentContext && c.name.toLowerCase()===q.toLowerCase();
      });
      if(!exists){
        var added = addClient(q);
        // Only clear if client was actually added (not false)
        if(added !== false){
          els.globalSearch.value = '';
          state.searchTerm = '';
          // Reset context selector if in All view
          if(currentContext === 'all' && els.addContextSelector){
            els.addContextSelector.value = '';
          }
        }
        render();
      }
    }
  });

  /* Density - Cookie-based approach */
  function getCookie(name) {
    var value = "; " + document.cookie;
    var parts = value.split("; " + name + "=");
    if (parts.length == 2) return parts.pop().split(";").shift();
    return null;
  }

  function setDensityCookie(density) {
    document.cookie = "density=" + density + "; path=/; max-age=31536000"; // 1 year
  }

  function setSortCookie(sortBy) {
    document.cookie = "sortBy=" + sortBy + "; path=/; max-age=31536000"; // 1 year
  }

  function setFontSizeCookie(fontSize) {
    document.cookie = "fontSize=" + fontSize + "; path=/; max-age=31536000"; // 1 year
  }

  function setContextCookie(context) {
    document.cookie = "context=" + context + "; path=/; max-age=31536000"; // 1 year
  }


  function applyFontSize() {
    var size = getCookie('fontSize') || 'medium';
    document.body.setAttribute('data-font-size', size);
    if($('#fontSizeLabel')) {
      var labels = {xsmall: 'XS', small: 'S', medium: 'M', large: 'L', xlarge: 'XL'};
      $('#fontSizeLabel').textContent = labels[size] || 'M';
    }
  }

  function applyDensity() {
    var mode = getCookie('density') || 'comfortable';
    document.body.setAttribute('data-density', mode);
    if(els.densitySelect) els.densitySelect.value = mode;
  }

  /* Drag and Drop functionality for manual sorting */
  var draggedElement = null;
  var draggedClientId = null;

  function enableDragAndDrop() {
    var sortBy = getCookie('sortBy');
    // Default to 'none' if no cookie is set (for incognito/new browsers)
    var isNoSort = (!sortBy || sortBy === 'none');
    var rows = $all('.row');

    rows.forEach(function(row) {
      if(isNoSort) {
        row.draggable = true;

        // Remove old listeners to avoid duplicates
        row.removeEventListener('dragstart', handleDragStart);
        row.removeEventListener('dragend', handleDragEnd);
        row.removeEventListener('dragover', handleDragOver);
        row.removeEventListener('drop', handleDrop);
        row.removeEventListener('dragenter', handleDragEnter);
        row.removeEventListener('dragleave', handleDragLeave);

        // Add new listeners
        row.addEventListener('dragstart', handleDragStart);
        row.addEventListener('dragend', handleDragEnd);
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('drop', handleDrop);
        row.addEventListener('dragenter', handleDragEnter);
        row.addEventListener('dragleave', handleDragLeave);
      } else {
        row.draggable = false;
      }
    });
  }

  function handleDragStart(e) {
    // Don't drag if clicking on actual interactive elements
    var target = e.target;
    if(target.tagName === 'BUTTON' || target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT') {
      e.preventDefault();
      return false;
    }

    // Also prevent drag if clicking on clickable buttons/icons within the row
    if(target.closest('.qbtn') || target.closest('.sbtn') || target.closest('.iconbtn')) {
      e.preventDefault();
      return false;
    }

    draggedElement = this;
    draggedClientId = this.dataset.id;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';

    // Create a simple drag image instead of showing the whole row
    var dragImage = document.createElement('div');
    dragImage.style.cssText = 'position:absolute;left:-9999px;padding:8px 16px;background:#3b82f6;color:white;border-radius:4px;font-size:14px;';
    var clientName = this.querySelector('.name').textContent || 'Moving...';
    dragImage.textContent = clientName;
    document.body.appendChild(dragImage);
    e.dataTransfer.setDragImage(dragImage, 0, 0);

    // Clean up the drag image after a moment
    setTimeout(function() {
      if(dragImage.parentNode) dragImage.parentNode.removeChild(dragImage);
    }, 0);
  }

  function handleDragEnd(e) {
    this.classList.remove('dragging');
    $all('.row').forEach(function(row) {
      row.classList.remove('drag-over', 'drag-over-bottom');
    });
    draggedElement = null;
    draggedClientId = null;
  }

  function handleDragOver(e) {
    if(e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';

    var rect = this.getBoundingClientRect();
    var midpoint = rect.top + rect.height / 2;

    this.classList.remove('drag-over', 'drag-over-bottom');
    if(e.clientY < midpoint) {
      this.classList.add('drag-over');
    } else {
      this.classList.add('drag-over-bottom');
    }

    return false;
  }

  function handleDragEnter(e) {
    // Handled in dragover
  }

  function handleDragLeave(e) {
    this.classList.remove('drag-over', 'drag-over-bottom');
  }

  function handleDrop(e) {
    if(e.stopPropagation) e.stopPropagation();
    if(e.preventDefault) e.preventDefault();

    if(draggedElement !== this && draggedClientId) {
      var targetId = this.dataset.id;
      var rect = this.getBoundingClientRect();
      var midpoint = rect.top + rect.height / 2;
      var insertBefore = e.clientY < midpoint;

      // Update the manual order in state
      if(state && state.clients) {
        var draggedIndex = state.clients.findIndex(function(c) { return c.id === draggedClientId; });
        var targetIndex = state.clients.findIndex(function(c) { return c.id === targetId; });

        if(draggedIndex !== -1 && targetIndex !== -1) {
          var draggedClient = state.clients.splice(draggedIndex, 1)[0];

          // Adjust target index after removal if necessary
          if(draggedIndex < targetIndex) targetIndex--;

          // Insert at the appropriate position
          if(!insertBefore) targetIndex++;

          state.clients.splice(targetIndex, 0, draggedClient);

          // Save the new order
          save(state);

          // Re-render to apply the new order
          render();
        }
      }
    }

    this.classList.remove('drag-over', 'drag-over-bottom');
    return false;
  }

  /* Sidebar position + show/hide */
  ;(function(){
    var appRoot=els.appRoot;
    // Removed applySidebarPos - now handled in move button logic
    function applySidebarVisibility(){
      if(ui.sidebarHidden){ appRoot.classList.add('no-side'); if(els.toggleSidebarBtn) els.toggleSidebarBtn.textContent='◨'; }
      else { appRoot.classList.remove('no-side'); if(els.toggleSidebarBtn) els.toggleSidebarBtn.textContent='◧'; }
    }
    if(typeof ui.sidebarLeft==='undefined'){ ui.sidebarLeft=false; }
    if(typeof ui.sidebarHidden==='undefined'){ ui.sidebarHidden=false; }

    // Apply saved sidebar position
    if(ui.sidebarLeft){
      appRoot.classList.add('leftbar');
    }

    applySidebarVisibility();
    // Add the move-left/right helper in the sidebar-controls container
    var controls=els.sidebarControls;
    if(controls){
      var moveBtn=document.createElement('button');
      moveBtn.className='btn-min gray';
      moveBtn.style.padding='4px 8px';
      moveBtn.title = 'Move sidebar to the other side';
      function label(){
        moveBtn.textContent = ui.sidebarLeft ? '→' : '←';
      }
      label();
      moveBtn.addEventListener('click', function(){
        // Toggle sidebar position
        ui.sidebarLeft = !ui.sidebarLeft;

        // Simply toggle the leftbar class - CSS handles the rest
        if(ui.sidebarLeft){
          appRoot.classList.add('leftbar');
        } else {
          appRoot.classList.remove('leftbar');
        }

        // Save state and update button
        saveUI(ui);
        label();
      });
      controls.appendChild(moveBtn);
    }
    if(els.toggleSidebarBtn){
      els.toggleSidebarBtn.addEventListener('click', function(){
        ui.sidebarHidden = !ui.sidebarHidden; saveUI(ui); applySidebarVisibility();
      });
    }
  })();

  /* Import/Export functionality */
  if(els.importBtn){
    els.importBtn.addEventListener('click', function(){
      showImportDialog();
    });
  }

  function showImportDialog(){
    // Create modal background
    var modal = document.createElement('div');
    modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;';

    // Create modal content
    var content = document.createElement('div');
    content.style.cssText = 'background:white; border-radius:12px; padding:24px; max-width:500px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.2);';

    var html = '<h2 style="margin-top:0;">Import Data</h2>';
    html += '<p style="color:#666; margin-bottom:20px;">Import JSON backup or a list of client names.</p>';

    html += '<div style="margin-bottom:15px;">';
    html += '<label style="display:flex; align-items:center; margin-bottom:10px; cursor:pointer;">';
    html += '<input type="radio" name="importType" value="json" checked style="margin-right:8px;">';
    html += '<span><strong>JSON Export</strong> - Full backup with all client details, quotes, and settings</span>';
    html += '</label>';
    html += '<label style="display:flex; align-items:center; cursor:pointer;">';
    html += '<input type="radio" name="importType" value="names" style="margin-right:8px;">';
    html += '<span><strong>Client Names</strong> - Simple list (one name per line)</span>';
    html += '</label>';
    html += '</div>';

    html += '<textarea id="importData" style="width:100%; height:200px; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-family:monospace; font-size:12px; box-sizing:border-box;" placeholder="Paste your JSON export here..."></textarea>';

    html += '<div id="importOptions" style="margin-top:15px; padding:15px; background:#f3f4f6; border-radius:6px;">';
    html += '<strong style="display:block; margin-bottom:10px;">Import Mode:</strong>';
    html += '<label style="display:flex; align-items:center; margin-bottom:8px; cursor:pointer;">';
    html += '<input type="radio" name="mergeMode" value="replace" checked style="margin-right:8px;">';
    html += '<span><strong>Replace All</strong> - Clear existing data and import fresh</span>';
    html += '</label>';
    html += '<label style="display:flex; align-items:center; cursor:pointer;">';
    html += '<input type="radio" name="mergeMode" value="merge" style="margin-right:8px;">';
    html += '<span><strong>Merge</strong> - Add to existing data (avoids duplicate names)</span>';
    html += '</label>';
    html += '</div>';

    html += '<div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">';
    html += '<button id="confirmImport" style="padding:8px 20px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Import</button>';
    html += '<button id="cancelImport" style="padding:8px 20px; background:#6b7280; color:white; border:none; border-radius:6px; cursor:pointer;">Cancel</button>';
    html += '</div>';

    content.innerHTML = html;
    modal.appendChild(content);
    document.body.appendChild(modal);

    // Handle import type change
    var importTypeRadios = modal.querySelectorAll('input[name="importType"]');
    var importOptions = modal.querySelector('#importOptions');
    var importData = modal.querySelector('#importData');

    importTypeRadios.forEach(function(radio){
      radio.addEventListener('change', function(){
        if(this.value === 'json'){
          importOptions.style.display = 'block';
          importData.placeholder = 'Paste your JSON export here...';
        } else {
          importOptions.style.display = 'none';
          importData.placeholder = 'Paste client names here, one per line.\nExample:\nJohn Smith\nJane Doe\nBob Johnson';
        }
      });
    });

    // Confirm button
    modal.querySelector('#confirmImport').addEventListener('click', function(){
      var importType = modal.querySelector('input[name="importType"]:checked').value;
      var data = importData.value.trim();

      if(!data){
        alert('Please paste some data to import');
        return;
      }

      if(importType === 'json'){
        try {
          var importedData = JSON.parse(data);
          var mergeMode = modal.querySelector('input[name="mergeMode"]:checked').value;

          if(mergeMode === 'replace'){
            // Replace all data
            if(confirm('This will replace ALL your current data. Are you sure?')){
              if(importedData.clients) state.clients = importedData.clients;
              if(importedData.quotes) state.quotes = importedData.quotes;
              if(importedData.quotesSettings) state.quotesSettings = importedData.quotesSettings;

              save(state);
              render();
              scheduleQuoteTimer(); // Reset quote timer with new settings
              showNotification('Import Complete', 'All data has been replaced successfully');
              document.body.removeChild(modal);
            }
          } else {
            // Merge with existing
            var importCount = 0;
            if(importedData.clients){
              // Add imported clients, avoiding duplicates by name
              var existingNames = {};
              state.clients.forEach(function(c){
                existingNames[c.name.toLowerCase()] = true;
              });

              importedData.clients.forEach(function(client){
                if(!existingNames[client.name.toLowerCase()]){
                  // Ensure client has required fields
                  if(!client.id) client.id = uid();
                  if(!client.context) client.context = currentContext;
                  state.clients.push(client);
                  importCount++;
                }
              });
            }

            // Merge quotes if empty
            if(importedData.quotes && (!state.quotes || !state.quotes.list || state.quotes.list.length === 0)){
              state.quotes = importedData.quotes;
            }

            save(state);
            render();
            showNotification('Import Complete', importCount + ' new clients added (duplicates skipped)');
            document.body.removeChild(modal);
          }
        } catch(e){
          alert('Invalid JSON format. Please check your data and try again.\n\nError: ' + e.message);
        }
      } else {
        // Import names only
        var names = data.split('\n').map(function(n){return n.trim();}).filter(function(n){return n;});
        if(names.length > 0){
          names.forEach(function(name){
            addClient(name);
          });
          showNotification('Import Complete', names.length + ' clients imported successfully');
          document.body.removeChild(modal);
        }
      }
    });

    // Cancel button
    modal.querySelector('#cancelImport').addEventListener('click', function(){
      document.body.removeChild(modal);
    });

    // Close on background click
    modal.addEventListener('click', function(e){
      if(e.target === modal){
        document.body.removeChild(modal);
      }
    });

    // Focus textarea
    importData.focus();
  }

  if(els.exportBtn){
    els.exportBtn.addEventListener('click', function(){
      var data = {
        clients: state.clients,
        quotes: state.quotes,
        quotesSettings: state.quotesSettings
      };
      var json = JSON.stringify(data, null, 2);
      var blob = new Blob([json], {type: 'application/json'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'hotlist-export-' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification('Export Complete', 'Your data has been exported successfully');
    });
  }

  /* Context Essential Questions Button */
  if(els.essentialQuestionsBtn){
    els.essentialQuestionsBtn.addEventListener('click', function(){
      showEssentialQuestions();
    });
  }

  // Default essential questions for each context
  var defaultEssentialQuestions = {
    life: [
      {icon: '💵', text: 'How much life insurance coverage are you requesting?'},
      {icon: '🔢', text: 'What is your Social Security Number?'},
      {icon: '🎂', text: 'What is your date of birth?'},
      {icon: '🗺️', text: 'In which state were you born?'},
      {icon: '🪪', text: 'What is your driver\'s license number?'},
      {icon: '💼', text: 'What is your current occupation and Company Name?'},
      {icon: '💰', text: 'What is your annual income?'},
      {icon: '👫', text: 'What is your spouse\'s income?'},
      {icon: '📊', text: 'What is your estimated net worth?'},
      {icon: '❤️', text: 'Does your spouse currently have life insurance?'},
      {icon: '📄', text: 'Do you have any current personal life insurance policies?'},
      {icon: '🏥', text: 'Any medical issues or diagnoses in the past 12 months?'},
      {icon: '📆', text: 'Would you prefer monthly or annual premium payments?'},
      {icon: '✅', text: 'Are you ready to bind coverage today?'},
      {icon: '👨‍⚕️', text: 'Who is your primary care physician? (Optional — or use County Health Department instead.)'}
    ],
    home_auto: [
      {icon: '🏠', text: 'What is your property address?'},
      {icon: '🚗', text: 'Vehicle year, make, and model?'},
      {icon: '📅', text: 'Current policy expiration date?'},
      {icon: '💰', text: 'Current premium amount?'},
      {icon: '📄', text: 'Any claims in the past 5 years?'}
    ],
    commercial: [
      {icon: '🏢', text: 'Business name and type?'},
      {icon: '📍', text: 'Business location(s)?'},
      {icon: '💰', text: 'Annual revenue?'},
      {icon: '👥', text: 'Number of employees?'},
      {icon: '📄', text: 'Current coverage types?'}
    ],
    farm: [
      {icon: '🚜', text: 'Total acreage?'},
      {icon: '🌾', text: 'Types of crops/livestock?'},
      {icon: '🏗️', text: 'Buildings and equipment value?'},
      {icon: '💰', text: 'Annual farm income?'},
      {icon: '📄', text: 'Current farm policy details?'}
    ],
    networking: [
      {icon: '👤', text: 'Contact name and company?'},
      {icon: '📧', text: 'Email address?'},
      {icon: '📱', text: 'Phone number?'},
      {icon: '🤝', text: 'How can we help each other?'},
      {icon: '📅', text: 'Best time to follow up?'}
    ]
  };

  function showEssentialQuestions(){
    var modal = document.createElement('div');
    modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; display:flex; align-items:center; justify-content:center;';

    var content = document.createElement('div');
    content.style.cssText = 'background:white; border-radius:12px; padding:24px; max-width:700px; width:90%; max-height:85vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.2);';

    // Load saved questions or use defaults
    if(!state.essentialQuestions) state.essentialQuestions = {};
    var currentQuestions = state.essentialQuestions[currentContext] || defaultEssentialQuestions[currentContext] || [];

    // Context titles
    var contextTitles = {
      life: 'Life Application',
      home_auto: 'Home & Auto',
      commercial: 'Commercial',
      farm: 'Farm',
      networking: 'Networking'
    };

    var title = contextTitles[currentContext] || 'Context';

    var html = '<h2 style="margin-top:0; color:#333; font-size:20px;">' + title + ' Essential Questions</h2>';
    html += '<p style="color:#666; margin-bottom:20px; font-size:14px;">💡 Essential questions to remember for ' + title.toLowerCase() + ':</p>';

    // Editable area
    html += '<div id="questionsDisplay" style="line-height:1.8; margin-bottom:20px;">';
    currentQuestions.forEach(function(q, index){
      html += '<div style="margin-bottom:12px; display:flex; align-items:start; gap:10px;">';
      html += '<span style="font-size:20px; flex-shrink:0;">' + (q.icon || '•') + '</span>';
      html += '<span style="color:#444; flex:1; padding-top:2px;">' + q.text + '</span>';
      html += '</div>';
    });
    html += '</div>';

    // Edit mode (initially hidden)
    html += '<div id="questionsEditor" style="display:none; margin-bottom:20px;">';
    html += '<textarea id="questionsTextarea" style="width:100%; min-height:300px; padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:13px; line-height:1.8; font-family:-apple-system, BlinkMacSystemFont, sans-serif;" placeholder="Enter one question per line\nOptionally start with an emoji followed by space">';
    html += '</textarea>';
    html += '<p style="color:#9ca3af; font-size:12px; margin-top:8px;">💡 Format: [emoji] Question text (one per line)</p>';
    html += '</div>';

    // Buttons
    html += '<div style="display:flex; gap:8px; justify-content:space-between;">';
    html += '<div>';
    html += '<button id="editQuestionsBtn" style="padding:8px 16px; background:#f3f4f6; color:#374151; border:1px solid #e5e7eb; border-radius:6px; cursor:pointer; font-size:13px;">Edit</button>';
    html += '<button id="saveQuestionsBtn" style="display:none; padding:8px 16px; background:#f3f4f6; color:#059669; border:1px solid #d1fae5; border-radius:6px; cursor:pointer; font-size:13px; margin-left:8px;">Save</button>';
    html += '<button id="cancelEditBtn" style="display:none; padding:8px 16px; background:#fff; color:#6b7280; border:1px solid #e5e7eb; border-radius:6px; cursor:pointer; font-size:13px; margin-left:8px;">Cancel</button>';
    html += '</div>';
    html += '<button id="closeEssentialQuestions" style="padding:8px 20px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px;">Close</button>';
    html += '</div>';

    content.innerHTML = html;
    modal.appendChild(content);
    document.body.appendChild(modal);

    // Load current questions into textarea
    var textarea = document.getElementById('questionsTextarea');
    if(textarea){
      var textContent = currentQuestions.map(function(q){
        return (q.icon ? q.icon + ' ' : '') + q.text;
      }).join('\n');
      textarea.value = textContent;
    }

    // Edit button handler
    document.getElementById('editQuestionsBtn').addEventListener('click', function(){
      document.getElementById('questionsDisplay').style.display = 'none';
      document.getElementById('questionsEditor').style.display = 'block';
      document.getElementById('editQuestionsBtn').style.display = 'none';
      document.getElementById('saveQuestionsBtn').style.display = 'inline-block';
      document.getElementById('cancelEditBtn').style.display = 'inline-block';
      textarea.focus();
    });

    // Cancel edit handler
    document.getElementById('cancelEditBtn').addEventListener('click', function(){
      document.getElementById('questionsDisplay').style.display = 'block';
      document.getElementById('questionsEditor').style.display = 'none';
      document.getElementById('editQuestionsBtn').style.display = 'inline-block';
      document.getElementById('saveQuestionsBtn').style.display = 'none';
      document.getElementById('cancelEditBtn').style.display = 'none';
    });

    // Save handler
    document.getElementById('saveQuestionsBtn').addEventListener('click', function(){
      var lines = textarea.value.split('\n').filter(function(line){
        return line.trim().length > 0;
      });

      var newQuestions = lines.map(function(line){
        var trimmed = line.trim();
        // Check if line starts with an emoji
        var emojiMatch = trimmed.match(/^(\p{Emoji})\s+(.+)$/u);
        if(emojiMatch){
          return {icon: emojiMatch[1], text: emojiMatch[2]};
        }
        // No emoji, just text
        return {icon: '•', text: trimmed};
      });

      // Save to state
      if(!state.essentialQuestions) state.essentialQuestions = {};
      state.essentialQuestions[currentContext] = newQuestions;
      save(state);

      // Update display
      var displayHtml = '';
      newQuestions.forEach(function(q){
        displayHtml += '<div style="margin-bottom:12px; display:flex; align-items:start; gap:10px;">';
        displayHtml += '<span style="font-size:20px; flex-shrink:0;">' + (q.icon || '•') + '</span>';
        displayHtml += '<span style="color:#444; flex:1; padding-top:2px;">' + q.text + '</span>';
        displayHtml += '</div>';
      });
      document.getElementById('questionsDisplay').innerHTML = displayHtml;

      // Switch back to display mode
      document.getElementById('questionsDisplay').style.display = 'block';
      document.getElementById('questionsEditor').style.display = 'none';
      document.getElementById('editQuestionsBtn').style.display = 'inline-block';
      document.getElementById('saveQuestionsBtn').style.display = 'none';
      document.getElementById('cancelEditBtn').style.display = 'none';
    });

    // Close button handler
    document.getElementById('closeEssentialQuestions').addEventListener('click', function(){
      document.body.removeChild(modal);
    });

    // Close on background click
    modal.addEventListener('click', function(e){
      if(e.target === modal){
        document.body.removeChild(modal);
      }
    });
  }


  /* Show/hide demo buttons based on presence of demo data */
  function updateDemoButtons(){
    // Only show demo buttons for Life context
    var isLifeContext = currentContext === 'life';

    // Check if there are any demo clients
    var hasDemoClients = state.clients && state.clients.some(function(client){
      return client.id && client.id.startsWith('demo-');
    });

    // Life Essential Questions button is always visible
    // (removed old demo button logic)

    // Show/hide clear demo section (only for Life context when demo clients exist)
    if(els.clearDemoSection){
      els.clearDemoSection.style.display = (isLifeContext && hasDemoClients) ? 'block' : 'none';
    }
  }

  /* Empty State Management */
  function showEmptyState(){
    if(!els.emptyState || !els.mainTableHead) return;

    els.emptyState.style.display = 'block';
    els.mainTableHead.style.display = 'none';
    els.list.innerHTML = '';

    // Only show demo button for Life context
    var demoButton = currentContext === 'life' ?
      '<button onclick="loadDemoData()" style="background:var(--info); color:white; border:none; padding:12px 24px; border-radius:8px; font-size:14px; cursor:pointer; margin-top:10px; margin-bottom:20px;">📋 Load Demo Data</button>' :
      '';

    // Sign-in option (subtle)
    var signInOption = '';
    if (!currentUser) {
      signInOption = '<div style="margin-top:20px; padding-top:20px; border-top:1px solid rgba(0,0,0,0.05);">' +
        '<div style="font-size:12px; color:var(--muted); margin-bottom:10px;">' +
        'Want to sync across devices? ' +
        '<a href="#" onclick="showSignInDialog(); return false;" style="color:var(--green); text-decoration:underline;">Enable cloud sync</a> ' +
        '(optional)' +
        '</div>' +
        '</div>';
    } else {
      signInOption = '<div style="margin-top:20px; padding-top:20px; border-top:1px solid rgba(0,0,0,0.05);">' +
        '<div style="font-size:12px; color:var(--muted);">' +
        '☁️ Cloud sync enabled • ' +
        '<a href="#" onclick="signOut(); return false;" style="color:var(--muted); text-decoration:underline;">Sign out</a>' +
        '</div>' +
        '</div>';
    }

    els.emptyState.innerHTML = '<div style="padding:40px 20px; text-align:center; color:var(--muted);">' +
      '<div style="font-size:16px; margin-bottom:10px;">No clients yet</div>' +
      '<div style="font-size:14px; margin-bottom:20px;">Use the search bar above to add your first client.<br/>Just type a name and press Enter!<br/><br/>Or use the Import Client button (📥) in the top right to import from a file.</div>' +
      demoButton +
      '<div style="font-size:12px; color:var(--muted); max-width:750px; margin:0 auto; line-height:1.4; background:rgba(0,0,0,0.02); padding:15px; border-radius:8px;">' +
      '<strong>🔒 Privacy Notice:</strong> All data is stored locally in your browser by default. ' +
      'Nothing is sent to any server unless you enable cloud sync. ' +
      'Please avoid entering personally identifiable information (PII) like social security numbers, full addresses, or sensitive personal details.' +
      signInOption +
      '</div>' +
      '</div>';
  }

  function hideEmptyState(){
    if(!els.emptyState || !els.mainTableHead) return;

    els.emptyState.style.display = 'none';
    els.mainTableHead.style.display = 'flex';
  }

  /* Notification helper */
  function showNotification(title, body){
    if(!('Notification' in window)) return;
    if(Notification.permission === 'granted'){
      new Notification(title, { body: body, icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"%3E%3Crect width="192" height="192" fill="%23ff8c00"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-size="96" fill="white"%3E🔥%3C/text%3E%3C/svg%3E' });
    }
  }

  function requestNotificationPermission(){
    if('Notification' in window && Notification.permission === 'default'){
      Notification.requestPermission();
    }
  }

  /* Check for scheduled follow-ups */
  var notifiedFollowUps = {}; // Track which followups we've notified about
  function checkScheduledNotifications(){
    var now = new Date();
    var scheduled = state.clients.filter(function(c){
      if(c.archived || !c.followUp) return false;
      var followUpTime = new Date(c.followUp);
      if(isNaN(+followUpTime)) return false;

      // Check if this follow-up is due (within 5 minutes)
      var timeDiff = followUpTime - now;
      var isDue = timeDiff <= 5 * 60 * 1000 && timeDiff > -60 * 1000; // 5 min before to 1 min after

      // Only notify once per follow-up
      var notifKey = c.id + ':' + c.followUp;
      if(isDue && !notifiedFollowUps[notifKey]){
        notifiedFollowUps[notifKey] = true;
        return true;
      }
      return false;
    });

    scheduled.forEach(function(c){
      var followUpTime = new Date(c.followUp);
      var timeStr = followUpTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      showNotification('Follow-up Due: ' + c.name, 'Scheduled for ' + timeStr);
    });

    // Clean up old notifications older than 1 hour
    var oneHourAgo = now.getTime() - 60 * 60 * 1000;
    Object.keys(notifiedFollowUps).forEach(function(key){
      var parts = key.split(':');
      if(parts[1]){
        var notifTime = new Date(parts[1]).getTime();
        if(notifTime < oneHourAgo){
          delete notifiedFollowUps[key];
        }
      }
    });
  }

  // Check for scheduled notifications every minute
  setInterval(checkScheduledNotifications, 60 * 1000);

  /* Power Hour */
  var hopTimer=null, hopRemaining=60*60, hopRunning=false, hopCallCount=0, originalTitle = document.title;

  function renderHOP(){
    if(!els.hopClock) return;
    var h=Math.floor(hopRemaining/3600), m=Math.floor((hopRemaining%3600)/60), s=hopRemaining%60;
    var timeStr = [h,m,s].map(function(v){return String(v).padStart(2,'0');}).join(':');
    els.hopClock.textContent=timeStr;

    // Update tab title when timer is running
    if(hopRunning){
      document.title = timeStr + ' | ' + hopCallCount + ' calls | ' + originalTitle;
    }

    // Show notification when timer completes
    if(hopRemaining === 0 && hopRunning){
      showNotification('Power Hour Complete!', 'Great job! You completed ' + hopCallCount + ' calls in this session.');
    }
  }

  function updateHopCalls(count){
    hopCallCount = count;
    if(els.hopCalls) els.hopCalls.textContent = count;
    if(hopRunning) renderHOP(); // Update tab title
  }

  if(els.hopStart) els.hopStart.addEventListener('click', function(){
    if(hopRunning) return;
    hopRunning=true;
    requestNotificationPermission(); // Request permission when starting timer
    hopTimer=setInterval(function(){
      hopRemaining=Math.max(0, hopRemaining-1);
      renderHOP();
      if(hopRemaining===0){
        clearInterval(hopTimer);
        hopRunning=false;
        document.title = originalTitle; // Reset title
      }
    },1000);
  });

  if(els.hopPause) els.hopPause.addEventListener('click', function(){
    hopRunning=false;
    clearInterval(hopTimer);
    document.title = originalTitle; // Reset title
  });

  if(els.hopReset) els.hopReset.addEventListener('click', function(){
    hopRunning=false;
    clearInterval(hopTimer);
    hopRemaining=60*60;
    hopCallCount = 0;
    updateHopCalls(0);
    renderHOP();
    document.title = originalTitle; // Reset title
  });

  /* Modal functions */
  function showShortcutsModal(){
    // Update the shortcuts modal with current context stages
    var modal = document.getElementById('shortcutsModal');
    if(!modal) return;

    // Find all h3 elements and locate Status Management section
    var h3Elements = modal.querySelectorAll('h3');
    for(var i = 0; i < h3Elements.length; i++){
      if(h3Elements[i].textContent.includes('Status Management')){
        var statusContainer = h3Elements[i].nextElementSibling;
        if(statusContainer){
          // Clear existing content
          statusContainer.innerHTML = '';

          // Add current context stages
          var contextConfig = CONTEXTS[currentContext] || CONTEXTS.life;
          contextConfig.stages.forEach(function(stage, index){
            var div = document.createElement('div');
            div.innerHTML = '<kbd>' + (index + 1) + '</kbd> - ' + stage;
            statusContainer.appendChild(div);
          });

          // Add clear option
          var clearDiv = document.createElement('div');
          clearDiv.innerHTML = '<kbd>0</kbd> - Clear all status';
          statusContainer.appendChild(clearDiv);
        }
        break;
      }
    }

    modal.style.display = 'block';
  }
  function closeShortcutsModal(){
    document.getElementById('shortcutsModal').style.display = 'none';
  }
  function showChangelogModal(){
    // Populate changelog content when modal is shown
    var changelogEl = document.getElementById('changelogContent');
    if(changelogEl) {
      changelogEl.innerHTML = '';
      CHANGELOG.forEach(function(entry) {
        var item = document.createElement('div');
        item.style.cssText = 'border-left:3px solid #3b82f6; padding-left:12px; margin-bottom:12px;';
        item.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:4px;">' +
          '<strong style="color:#1e293b; font-size:14px;">v' + entry.version + '</strong>' +
          '<span style="color:#94a3b8; font-size:12px;">' + entry.date + '</span>' +
          '</div>' +
          '<div style="color:#475569; font-size:13px;">' + entry.changes + '</div>';
        changelogEl.appendChild(item);
      });
    }
    document.getElementById('changelogModal').style.display = 'block';
  }
  function closeChangelogModal(){
    document.getElementById('changelogModal').style.display = 'none';
  }
  function openSuggestEmail(){
    var email = 'leland' + '.' + 'smith' + '@' + 'country' + 'financial' + '.com';
    var subject = encodeURIComponent('Hotlist Suggestion');
    var body = encodeURIComponent('I have a suggestion for the Hotlist app:\n\n');
    window.location.href = 'mailto:' + email + '?subject=' + subject + '&body=' + body;
  }
  // Sign-in dialog function
  function showSignInDialog() {
    var dialog = document.createElement('div');
    dialog.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;';

    var content = document.createElement('div');
    content.style.cssText = 'background:white; border-radius:12px; padding:30px; max-width:400px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.2);';

    content.innerHTML =
      '<h2 style="margin:0 0 10px; color:var(--ink);">Enable Cloud Sync</h2>' +
      '<p style="color:var(--muted); font-size:14px; margin-bottom:20px;">Sync your data across devices. Your data remains private and encrypted.</p>' +

      '<div style="margin-bottom:20px;">' +
      '<label style="display:block; margin-bottom:5px; font-size:12px; color:var(--muted);">Email</label>' +
      '<input type="email" id="signInEmail" placeholder="your@email.com" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">' +
      '</div>' +

      '<div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:20px; font-size:12px; color:var(--muted);">' +
      '<strong>First time?</strong> Create a free Supabase account at ' +
      '<a href="https://supabase.com" target="_blank" style="color:var(--green); text-decoration:underline;">supabase.com</a> ' +
      'and create a new project. Then add your project URL and anon key below.' +
      '</div>' +

      '<details style="margin-bottom:20px;">' +
      '<summary style="cursor:pointer; color:var(--muted); font-size:12px; margin-bottom:10px;">Advanced: Configure Supabase (optional)</summary>' +
      '<div style="margin-top:10px;">' +
      '<input type="text" id="supabaseUrl" placeholder="Project URL (optional)" style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #e2e8f0; border-radius:6px; font-size:12px;">' +
      '<input type="text" id="supabaseKey" placeholder="Anon Key (optional)" style="width:100%; padding:8px; border:1px solid #e2e8f0; border-radius:6px; font-size:12px;">' +
      '</div>' +
      '</details>' +

      '<div style="display:flex; gap:10px; justify-content:flex-end;">' +
      '<button id="cancelSignIn" style="padding:8px 16px; border:1px solid #e2e8f0; background:white; border-radius:6px; cursor:pointer;">Cancel</button>' +
      '<button id="signInButton" style="padding:8px 16px; background:var(--green); color:white; border:none; border-radius:6px; cursor:pointer;">Send Login Link</button>' +
      '</div>';

    dialog.appendChild(content);
    document.body.appendChild(dialog);

    // Handle cancel button
    document.getElementById('cancelSignIn').addEventListener('click', function() {
      dialog.remove();
    });

    // Handle sign in
    document.getElementById('signInButton').addEventListener('click', function() {
      var email = document.getElementById('signInEmail').value;
      var url = document.getElementById('supabaseUrl').value;
      var key = document.getElementById('supabaseKey').value;

      // Save Supabase config if provided
      if (url && key) {
        localStorage.setItem('hotlistSupabaseUrl', url);
        localStorage.setItem('hotlistSupabaseAnonKey', key);
        initSupabase();
      }

      if (email) {
        signInWithEmail(email);
        dialog.remove();
      } else {
        alert('Please enter your email address');
      }
    });

    // Handle ESC key to close
    function handleEscape(e) {
      if (e.key === 'Escape') {
        dialog.remove();
        document.removeEventListener('keydown', handleEscape);
      }
    }
    document.addEventListener('keydown', handleEscape);

    // Focus email field
    setTimeout(function() {
      document.getElementById('signInEmail').focus();
    }, 100);
  }

  window.showShortcutsModal = showShortcutsModal;
  window.closeShortcutsModal = closeShortcutsModal;
  window.showChangelogModal = showChangelogModal;
  window.closeChangelogModal = closeChangelogModal;
  window.openSuggestEmail = openSuggestEmail;
  window.showSignInDialog = showSignInDialog;
  window.signOut = signOut;

  /* Flame animation when marking hot */
  function showFlameAnimation(event){
    var flame = document.createElement('div');
    flame.className = 'flame-burst';
    flame.innerHTML = '🔥';

    // Find the selected row or use click position
    var selectedRow = document.querySelector('.row.selected');

    if(selectedRow){
      var rect = selectedRow.getBoundingClientRect();
      flame.style.left = (rect.left + rect.width / 2 - 48) + 'px';
      flame.style.top = (rect.top + rect.height / 2 - 48) + 'px';
    } else if(event && event.clientX){
      flame.style.left = (event.clientX - 48) + 'px';
      flame.style.top = (event.clientY - 48) + 'px';
    } else {
      flame.style.left = (window.innerWidth / 2 - 48) + 'px';
      flame.style.top = (window.innerHeight / 2 - 48) + 'px';
    }

    document.body.appendChild(flame);

    // Apply animation
    flame.style.animation = 'flameTravel 0.6s ease-out';

    // Remove after animation completes
    setTimeout(function(){
      flame.remove();
    }, 600);

    // Make the title pulse briefly - only if title exists
    var titleElement = document.getElementById('hotlistTitle');
    if(titleElement){
      titleElement.style.animation = 'pulse 0.3s ease-out';
      setTimeout(function(){
        titleElement.style.animation = '';
      }, 300);
    }
  }

  // Make showFlameAnimation available globally for keyboard shortcuts
  window.showFlameAnimation = showFlameAnimation;

  /* Demo Data Functions */
  function createDemoClients(){

    var now = new Date().toISOString();
    var yesterday = new Date(Date.now() - 24*60*60*1000).toISOString();
    var twoDaysAgo = new Date(Date.now() - 2*24*60*60*1000).toISOString();

    var demoClients = [
      {
        id: 'demo-' + Date.now() + '-1',
        name: 'Sarah Johnson',
        context: 'life',
        status: 'Sent Quote',
        stage: 1,  // Quoted stage
        notes: 'Interested in term life insurance for $500K coverage.\nHas 2 young children, budget around $150/month.\nPrefers to meet on weekends due to work schedule.',
        callCount: 2,
        msgCount: 1,
        lastTouch: yesterday,
        created: twoDaysAgo,
        createdAt: twoDaysAgo,
        hot: false,
        archived: false,
        queueToday: false,
        queueTomorrow: false,
        history: [
          { ts: twoDaysAgo, action: 'created' }
        ]
      },
      {
        id: 'demo-' + Date.now() + '-2',
        name: 'Michael Chen',
        context: 'life',
        stage: 0,  // Initial Contact stage
        notes: 'Self-employed business owner looking for disability insurance.\nRuns a successful consulting firm, needs income protection.\nVery detail-oriented, asks lots of questions.',
        callCount: 0,
        msgCount: 0,
        lastTouch: new Date(Date.now() - 5*24*60*60*1000).toISOString(),
        created: new Date(Date.now() - 5*24*60*60*1000).toISOString(),
        createdAt: new Date(Date.now() - 5*24*60*60*1000).toISOString(),
        hot: false,
        archived: false,
        queueToday: false,
        queueTomorrow: false,
        history: [
          { ts: new Date(Date.now() - 5*24*60*60*1000).toISOString(), action: 'created' }
        ]
      },
      {
        id: 'demo-' + Date.now() + '-3',
        name: 'Jennifer Martinez',
        context: 'life',
        status: 'Issued',
        stage: 5,  // Issued/Issued stage
        notes: 'Issued whole life policy for $250K.\nEasy client, referred by existing customer.\nInterested in additional coverage for spouse.',
        callCount: 1,
        msgCount: 0,
        lastTouch: yesterday,
        created: new Date(Date.now() - 7*24*60*60*1000).toISOString(),
        createdAt: new Date(Date.now() - 7*24*60*60*1000).toISOString(),
        purchaseDate: yesterday,
        hot: false,
        archived: false,
        queueToday: false,
        queueTomorrow: false,
        history: [
          { ts: new Date(Date.now() - 7*24*60*60*1000).toISOString(), action: 'created' }
        ]
      }
    ];

    return demoClients;
  }

  function loadDemoData(){
    if(!confirm('This will add 3 demo clients to your list. Continue?')) return;

    var demoClients = createDemoClients();

    // Add demo clients to state
    state.clients = state.clients.concat(demoClients);

    // Mark that user has demo data
    localStorage.setItem('hotlist_ever_had_data', 'demo');
    save(state);
    render();

    // Show success message
    setTimeout(function(){
      alert('Demo data loaded! 📋\n\n• Sarah Johnson (Sent Quote)\n• Michael Chen (No status - try setting one!)\n• Jennifer Martinez (Issued)\n\nExplore the features and use keyboard shortcuts 1-6!');
    }, 100);
  }

  function clearDemoData(){
    if(!confirm('This will remove all demo clients (names starting with demo-). Your real clients will remain. Continue?')) return;

    // Remove all clients with demo IDs
    state.clients = state.clients.filter(function(client){
      return !client.id.startsWith('demo-');
    });

    save(state);
    render();

    // Mark that user has cleared demo data
    localStorage.setItem('hotlist_ever_had_data', 'cleared');

    // Show success message
    setTimeout(function(){
      alert('Demo data cleared! 🗑️\n\nYou can now add your real clients.');
    }, 100);
  }

  function initializeFirstTimeUser(){
    console.log('=== initializeFirstTimeUser Debug ===');
    console.log('state.clients:', state.clients);
    console.log('clients length:', state.clients ? state.clients.length : 'undefined');

    // Check if we should auto-load demo data
    var hasEverHadData = localStorage.getItem('hotlist_ever_had_data');
    console.log('hasEverHadData localStorage value:', hasEverHadData);

    // Check if this is a first-time user (no clients and no previous data)
    if(!state.clients || state.clients.length === 0){
      if(!hasEverHadData){
        console.log('Loading demo data for first-time user...');
        // First-time user - load demo data automatically
        var demoClients = createDemoClients();
        state.clients = demoClients;

        // Mark that user has seen demo data
        localStorage.setItem('hotlist_ever_had_data', 'demo');
        save(state);

        console.log('Demo data loaded! Client count:', state.clients.length);
        console.log('Demo clients:', state.clients.map(function(c){ return c.name; }));
      } else {
        console.log('User has had data before (flag:', hasEverHadData, '), not loading demo data');
      }
    } else {
      console.log('User already has', state.clients.length, 'clients');

      // Check if user has demo data mixed with real data
      var hasDemoClients = state.clients.some(function(client){
        return client.id && client.id.startsWith('demo-');
      });

      if(hasDemoClients && !hasEverHadData){
        console.log('Found demo clients, setting demo flag');
        localStorage.setItem('hotlist_ever_had_data', 'demo');
      }
    }
  }

  /* Debug/Reset Functions */
  function resetForTesting(){
    localStorage.removeItem('hotlist_ever_had_data');
    state.clients = [];
    save(state);
    render();
    console.log('App reset for testing - refresh page to see first-time user experience');
  }

  function forceLoadDemo(){
    var demoClients = createDemoClients();
    state.clients = demoClients;
    localStorage.setItem('hotlist_ever_had_data', 'demo');
    save(state);
    render();
    console.log('Demo data force loaded, client count:', state.clients.length);
  }

  function debugCurrentState(){
    console.log('=== Current App State ===');
    console.log('state.clients:', state.clients);
    console.log('clients count:', state.clients ? state.clients.length : 'undefined');
    console.log('localStorage flag:', localStorage.getItem('hotlist_ever_had_data'));
    console.log('clearDemoBtn element:', els.clearDemoBtn);
    console.log('clearDemoBtn display:', els.clearDemoBtn ? els.clearDemoBtn.style.display : 'element not found');

    if(state.clients && state.clients.length > 0){
      console.log('Client IDs:', state.clients.map(function(c){ return c.id; }));
      console.log('Demo clients:', state.clients.filter(function(c){ return c.id.startsWith('demo-'); }));
    }
  }

  // Make functions available globally for testing
  window.loadDemoData = loadDemoData;
  window.clearDemoData = clearDemoData;
  window.resetForTesting = resetForTesting;
  window.forceLoadDemo = forceLoadDemo;
  window.debugCurrentState = debugCurrentState;

  /* Click handler for unscheduling and clearing purchases */
  document.addEventListener('click', function(e){
    if(e.target.classList.contains('unschedule-x')){
      e.stopPropagation();
      var clientId = e.target.getAttribute('data-client-id');
      var client = state.clients.find(function(c){ return c.id === clientId; });
      if(client){
        if(e.target.classList.contains('clear-purchase')){
          // Clear purchase date and status
          clearPurchase(client);
        } else {
          // Clear follow-up date
          client.followUp = '';
          save(state);
          render();
        }
      }
    }
  });

  /* Schedule Dropdown */
  var activeDropdown = null;
  var dropdownSelectedIndex = 0;

  function showScheduleDropdown(client, event){
    // Close any existing dropdown
    if(activeDropdown){
      activeDropdown.remove();
      activeDropdown = null;
    }

    // Create dropdown menu
    var menu = document.createElement('div');
    menu.className = 'sched-menu';
    menu.style.position = 'fixed';

    // Get the selected row element to position the dropdown
    var rows = allRows();
    var selectedRow = rows[selectionIndex];
    if(!selectedRow) return;

    var rect = selectedRow.getBoundingClientRect();
    menu.style.left = rect.left + 100 + 'px';
    menu.style.top = rect.bottom + 'px';

    // Create menu options
    var options = [
      { label: '🔥 Mark Hot', action: function(){ preserveUIAndRender(function(){ client.hot = !client.hot; }); } },
      { label: '📅 Today', action: function(){ toggleQueueToday(client); } },
      { label: '➡️ Tomorrow', action: function(){ toggleQueueTomorrow(client); } },
      { label: '⏰ Follow-up...', action: function(){ setFollowUpViaPicker(client); } },
      { label: '📝 Archive', action: function(){ archiveClient(client, true); } },
      { label: '❌ Clear Status', action: function(){ clearStatus(client); } }
    ];

    options.forEach(function(opt, index){
      var btn = document.createElement('button');
      btn.textContent = opt.label;
      btn.onclick = function(){
        opt.action();
        closeDropdown();
      };
      if(index === 0) btn.className = 'selected';
      menu.appendChild(btn);
    });

    document.body.appendChild(menu);
    activeDropdown = menu;
    dropdownSelectedIndex = 0;

    // Handle dropdown navigation
    function handleDropdownKey(e){
      if(!activeDropdown) return;

      var buttons = activeDropdown.querySelectorAll('button');

      if(e.key === 'ArrowDown' || e.key === 'j' || e.key === 'J'){
        buttons[dropdownSelectedIndex].classList.remove('selected');
        dropdownSelectedIndex = (dropdownSelectedIndex + 1) % buttons.length;
        buttons[dropdownSelectedIndex].classList.add('selected');
        e.preventDefault();
        e.stopPropagation();
      }
      else if(e.key === 'ArrowUp' || e.key === 'k' || e.key === 'K'){
        buttons[dropdownSelectedIndex].classList.remove('selected');
        dropdownSelectedIndex = (dropdownSelectedIndex - 1 + buttons.length) % buttons.length;
        buttons[dropdownSelectedIndex].classList.add('selected');
        e.preventDefault();
        e.stopPropagation();
      }
      else if(e.key === 'Enter'){
        buttons[dropdownSelectedIndex].click();
        e.preventDefault();
        e.stopPropagation();
      }
      else if(e.key === 'Escape'){
        closeDropdown();
        e.preventDefault();
        e.stopPropagation();
      }
    }

    function closeDropdown(){
      if(activeDropdown){
        activeDropdown.remove();
        activeDropdown = null;
        document.removeEventListener('keydown', handleDropdownKey, true);
        document.removeEventListener('click', outsideClickHandler);
      }
    }

    function outsideClickHandler(e){
      if(activeDropdown && !activeDropdown.contains(e.target)){
        closeDropdown();
      }
    }

    // Add event listeners with capture to intercept before main handler
    document.addEventListener('keydown', handleDropdownKey, true);
    document.addEventListener('click', outsideClickHandler);
  }

  /* Keyboard shortcuts */
  document.addEventListener('keydown', function(e){
    // Skip if dropdown is active (dropdown handler will process)
    if(activeDropdown) return;

    var tag=(document.activeElement && document.activeElement.tagName)||'';

    // Handle Cmd+/ or Ctrl+/ for shortcuts modal
    if((e.metaKey || e.ctrlKey) && e.key === '/'){
      showShortcutsModal();
      e.preventDefault();
      return;
    }

    // Handle Escape to close modals
    if(e.key === 'Escape'){
      if(document.getElementById('shortcutsModal').style.display === 'block'){
        closeShortcutsModal();
        e.preventDefault();
        return;
      }
      if(document.getElementById('changelogModal') && document.getElementById('changelogModal').style.display === 'block'){
        closeChangelogModal();
        e.preventDefault();
        return;
      }
    }

    // Handle "/" to focus search (but not if already in an input)
    if(e.key === '/' && tag !== 'INPUT' && tag !== 'TEXTAREA' && tag !== 'SELECT'){
      if(els.globalSearch){
        els.globalSearch.focus();
        e.preventDefault();
        return;
      }
    }

    if(e.ctrlKey || e.metaKey) return;            // <-- Let browser handle other Ctrl/Cmd shortcuts
    if(tag==='INPUT' || tag==='TEXTAREA' || tag==='SELECT') return;

    var key=e.key;
    var rows=allRows(); if(!rows.length && !['F','f','d','D'].includes(key)) return;

    if(key==='ArrowDown' || key==='j' || key==='J'){ selectionIndex++; restoreSelection(); e.preventDefault(); }
    if(key==='ArrowUp' || key==='k' || key==='K'){ selectionIndex--; restoreSelection(); e.preventDefault(); }

    // Handle left/right arrow keys for stage navigation
    if(key==='ArrowLeft' || key==='ArrowRight'){
      var selectedClient = getSelectedClient();
      if(selectedClient){
        var clientContext = selectedClient.context || 'life';
        if(currentContext === 'all'){
          // In All Contexts view, use the client's own context
          clientContext = selectedClient.context || 'life';
        } else {
          // In specific context view, use current context
          clientContext = currentContext;
        }
        var contextConfig = CONTEXTS[clientContext] || CONTEXTS.life;
        var currentStage = selectedClient.stage || 0;

        if(key==='ArrowLeft' && currentStage > 0){
          // Move to previous stage
          setClientStage(selectedClient, currentStage - 1);
          e.preventDefault();
        } else if(key==='ArrowRight' && currentStage < contextConfig.stages.length - 1){
          // Move to next stage
          setClientStage(selectedClient, currentStage + 1);
          e.preventDefault();
        }
      }
    }

    // Handle number keys for stage selection based on current context
    if(key >= '1' && key <= '9'){
      var stageIndex = parseInt(key) - 1;
      var contextConfig = CONTEXTS[currentContext] || CONTEXTS.life;
      if(stageIndex < contextConfig.stages.length){
        var c1=getSelectedClient();
        if(c1){
          setClientStage(c1, stageIndex);
          e.preventDefault();
        }
      }
    }

    if(key==='0'){
      var c0=getSelectedClient();
      if(c0){
        // Clear all status (set to no stage)
        c0.stage = -1;
        c0.status = '';
        save(state);
        render();
        e.preventDefault();
      }
    }

    if(key==='a' || key==='A'){ 
      var c2=getSelectedClient(); 
      if(c2){ 
        if(e.shiftKey){ decrementCall(c2); } else { incrementCall(c2); }
        e.preventDefault(); 
      } 
    }
    if(key==='l' || key==='L'){ 
      var c3=getSelectedClient(); 
      if(c3){ 
        if(e.shiftKey){ decrementMsg(c3); } else { incrementMsg(c3); }
        e.preventDefault(); 
      } 
    }
    if(key==='n' || key==='N'){ var rows2=allRows(); var row=rows2[selectionIndex]; if(!row) return; var ta=row.querySelector('textarea'); var wrap=row.querySelector('.notes'); if(wrap){ wrap.classList.toggle('hidden'); if(!wrap.classList.contains('hidden') && ta) ta.focus(); } e.preventDefault(); }
    if(key==='h' || key==='H'){
      var cHot=getSelectedClient();
      if(cHot){
        var wasHot = cHot.hot;
        preserveUIAndRender(function(){ cHot.hot = !cHot.hot; });
        // Show flame animation if marking as hot
        if(!wasHot && cHot.hot){
          showFlameAnimation(e);
        }
        e.preventDefault();
      }
    }

    if(key==='F' || key==='f'){ 
      var c4=getSelectedClient() || state.clients.find(function(c){return !c.archived && !isFutureFollowUp(c) && !c.queueToday && !c.queueTomorrow;}); 
      if(c4){ 
        // Preserve position instead of client ID for F key
        var currentIndex = selectionIndex;
        var prevDocY=window.scrollY, prevActY=els.activity?els.activity.scrollTop:0;
        withUndo(function(){ c4.queueToday = !c4.queueToday; if(c4.queueToday && c4.queueTomorrow) c4.queueTomorrow=false; });
        save(state); render();
        // Restore position, not client
        selectionIndex = currentIndex;
        var rows = allRows();
        if(selectionIndex >= rows.length) selectionIndex = Math.max(0, rows.length - 1);
        restoreSelection();
        window.scrollTo(0,prevDocY); if(els.activity) els.activity.scrollTop=prevActY;
        e.preventDefault(); 
      } 
    }
    if(key==='d' || key==='D'){
      var c5=getSelectedClient() || state.clients.find(function(c){return !c.archived && !isFutureFollowUp(c) && !c.queueToday && !c.queueTomorrow;});
      if(c5){
        toggleQueueTomorrow(c5);
        // Client stays in main list but gets Tomorrow label, so selection stays the same
        e.preventDefault();
      }
    }

    // Schedule dropdown (S)
    if(key==='s' || key==='S'){
      var c6=getSelectedClient();
      if(c6){
        showScheduleDropdown(c6, e);
        e.preventDefault();
      }
    }

    // Undo (U) / placeholder Redo (R)
    if(key==='u' || key==='U'){ var prev=undoStack.pop(); if(prev){ state=coerceState(JSON.parse(prev)); save(state); render(); } }
    if(key==='r' || key==='R'){ /* Hook a redo stack here if needed */ }
  });

  /* Widgets drag & collapse */
  function loadWidgetOrder(){
    if(Array.isArray(ui.widgetOrder) && ui.widgetOrder.length > 0) {
      return ui.widgetOrder;
    }
    // Default order: Today's Activity, Power Hour, Motivation, Heatmap, then others
    var defaultOrder = ['todayActivity', 'powerHour', 'motivation', 'heatmap'];
    var allWidgets = $all('#sidebarWidgets .widget').map(function(w){return w.dataset.key;});
    var otherWidgets = allWidgets.filter(function(key){ return !defaultOrder.includes(key); });
    return defaultOrder.concat(otherWidgets);
  }
  function saveWidgetOrder(keys){ ui.widgetOrder=keys; saveUI(ui); }
  function applyWidgetOrder(){
    var keys=loadWidgetOrder(), map={};
    $all('#sidebarWidgets .widget[draggable="true"]').forEach(function(w){ map[w.dataset.key]=w; });
    keys.forEach(function(k){ if(map[k]) els.sidebar.appendChild(map[k]); });
  }
  
  function loadLeftWidgets(){ return Array.isArray(ui.leftWidgets) ? ui.leftWidgets : []; }
  function saveLeftWidgets(keys){ ui.leftWidgets=keys; saveUI(ui); }
  function saveWidgetLayout(){ 
    var rightKeys = $all('#sidebarWidgets .widget').map(function(w){return w.dataset.key;});
    var leftKeys = $all('#leftSidebar .widget').map(function(w){return w.dataset.key;});
    ui.widgetOrder = rightKeys; ui.leftWidgets = leftKeys; saveUI(ui); 
  }
  
  function applyDualSidebarLayout(){
    var leftWidgets = els.leftSidebar ? els.leftSidebar.querySelectorAll('.widget') : [];
    var hasLeft = leftWidgets.length > 0;
    if(hasLeft){
      els.appRoot.classList.add('dual-sidebar');
      els.leftSidebar.style.display = 'block';
    } else {
      els.appRoot.classList.remove('dual-sidebar');
      els.leftSidebar.style.display = 'none';
    }
  }
  
  function showDragZones(){ 
    if(els.leftDragZone) {
      els.leftDragZone.style.display = 'flex';
      els.leftDragZone.classList.add('active');
    }
    if(els.rightDragZone) {
      els.rightDragZone.style.display = 'flex';
      els.rightDragZone.classList.add('active');
    }
  }
  function hideDragZones(){ 
    if(els.leftDragZone) {
      els.leftDragZone.style.display = 'none';
      els.leftDragZone.classList.remove('active');
    }
    if(els.rightDragZone) {
      els.rightDragZone.style.display = 'none';
      els.rightDragZone.classList.remove('active');
    }
  }
  
  function enableDrag(){ 
    var dragging=null; 
    
    // Universal drag start for any widget
    document.addEventListener('dragstart', function(e){ 
      var w=e.target.closest('.widget'); 
      if(!w) return; 
      dragging=w; 
      e.dataTransfer.effectAllowed='move'; 
      e.dataTransfer.setData('text/plain', w.dataset.key || 'widget'); 
      w.classList.add('dragging'); 
      showDragZones();
    }); 
    
    // Drag over handlers for both sidebars and drag zones
    [els.sidebar, els.leftSidebar, els.leftDragZone, els.rightDragZone].forEach(function(container){
      if(!container) return;
      container.addEventListener('dragover', function(e){ 
        if(!dragging) return; 
        e.preventDefault(); 
        e.dataTransfer.dropEffect = 'move';
        var w=e.target.closest('.widget'); 
        if(w && w!==dragging) { 
          w.classList.add('drag-over'); 
        }
        // Highlight the container itself if dragging over empty space
        if(container === els.leftDragZone || container === els.rightDragZone || (!w && (container === els.sidebar || container === els.leftSidebar))) {
          container.classList.add('drag-target');
        }
      }); 
      container.addEventListener('dragleave', function(e){ 
        var w=e.target.closest('.widget'); 
        if(w) w.classList.remove('drag-over'); 
        container.classList.remove('drag-target');
      }); 
    });
    
    // Drop handlers
    els.sidebar.addEventListener('drop', function(e){ 
      if(!dragging) return; 
      e.preventDefault(); 
      var target=e.target.closest('.widget'); 
      if(target && target!==dragging){ 
        target.classList.remove('drag-over'); 
        var rect=target.getBoundingClientRect(); 
        var before=(e.clientY-rect.top) < rect.height/2; 
        els.sidebar.insertBefore(dragging, before? target : target.nextSibling); 
      } else {
        els.sidebar.appendChild(dragging);
      }
      dragging.classList.remove('dragging'); 
      els.sidebar.classList.remove('drag-target');
      hideDragZones(); 
      applyDualSidebarLayout();
      saveWidgetLayout();
      dragging=null;
    }); 
    
    if(els.leftSidebar){
      els.leftSidebar.addEventListener('drop', function(e){ 
        if(!dragging) return; 
        e.preventDefault(); 
        var target=e.target.closest('.widget'); 
        if(target && target!==dragging){ 
          target.classList.remove('drag-over'); 
          var rect=target.getBoundingClientRect(); 
          var before=(e.clientY-rect.top) < rect.height/2; 
          els.leftSidebar.insertBefore(dragging, before? target : target.nextSibling); 
        } else {
          els.leftSidebar.appendChild(dragging);
        }
        dragging.classList.remove('dragging'); 
        els.leftSidebar.classList.remove('drag-target');
        hideDragZones(); 
        applyDualSidebarLayout();
        saveWidgetLayout();
        dragging=null;
      }); 
    }
    
    if(els.leftDragZone){
      els.leftDragZone.addEventListener('drop', function(e){ 
        if(!dragging) return; 
        e.preventDefault(); 
        els.leftSidebar.appendChild(dragging);
        dragging.classList.remove('dragging'); 
        els.leftDragZone.classList.remove('drag-target');
        hideDragZones(); 
        applyDualSidebarLayout();
        saveWidgetLayout();
        dragging=null;
      }); 
    }
    
    if(els.rightDragZone){
      els.rightDragZone.addEventListener('drop', function(e){ 
        if(!dragging) return; 
        e.preventDefault(); 
        els.sidebar.appendChild(dragging);
        dragging.classList.remove('dragging'); 
        els.rightDragZone.classList.remove('drag-target');
        hideDragZones(); 
        applyDualSidebarLayout();
        saveWidgetLayout();
        dragging=null;
      }); 
    }
    
    // Drag end cleanup
    document.addEventListener('dragend', function(){ 
      var d=document.querySelector('.dragging'); 
      if(d) d.classList.remove('dragging'); 
      hideDragZones();
      dragging=null; 
    }); 
  }
  function enableCollapse(){ 
    // Handle collapse for both sidebars
    function setupCollapse(container){
      if(!container) return;
      container.addEventListener('click', function(e){ 
        var btn=e.target.closest('.collapse-btn'); 
        if(!btn) return; 
        var w=btn.closest('.widget'); 
        if(!w) return; 
        var body=w.querySelector('.widget-body'); 
        if(!body) return; 
        body.classList.toggle('hidden'); 
        ui.widgetCollapsed = ui.widgetCollapsed || {}; 
        ui.widgetCollapsed[w.dataset.key] = body.classList.contains('hidden'); 
        saveUI(ui); 
      }); 
    }
    setupCollapse(els.sidebar);
    setupCollapse(els.leftSidebar);
    
    ui.widgetCollapsed = ui.widgetCollapsed || {}; 
    $all('.widget').forEach(function(w){ 
      var body=w.querySelector('.widget-body'); 
      if(!body) return; 
      if(ui.widgetCollapsed[w.dataset.key]) body.classList.add('hidden'); 
      else body.classList.remove('hidden'); 
    }); 
  }

  /* Boot */
  // Context is handled by cookies
  var savedContext = getCookie('context');
  if(savedContext && (savedContext === 'all' || CONTEXTS[savedContext])) {
    currentContext = savedContext;
  }

  // Set body attribute for All Contexts view on initial load
  if(currentContext === 'all'){
    document.body.setAttribute('data-all-contexts', 'true');
  }

  // Set active context pill
  if(els.contextPills) {
    els.contextPills.querySelectorAll('button').forEach(function(btn) {
      btn.classList.remove('active');
      if(btn.getAttribute('data-context') === currentContext) {
        btn.classList.add('active');
      }
    });
  }
  if(els.contextName) {
    if(currentContext === 'all') {
      els.contextName.textContent = 'All';
    } else {
      els.contextName.textContent = CONTEXTS[currentContext].name;
    }
  }
  if(els.contextLabel) {
    if(currentContext === 'all') {
      els.contextLabel.textContent = 'All Contexts';
    } else {
      els.contextLabel.textContent = CONTEXTS[currentContext].name;
    }
  }

  // Sort is now handled by cookies
  if($('#sortBy')) {
    var currentSort = getCookie('sortBy');
    // Default to 'none' if no cookie exists
    $('#sortBy').value = currentSort || 'none';
  }

  // Remove duplicate initialization - handled above with Promise

  // ensure widgets are draggable
  $all('#sidebarWidgets .widget').forEach(function(w){ if(!w.getAttribute('draggable')) w.setAttribute('draggable','true'); });

  // Initialize dual sidebar system
  if(typeof ui.leftWidgets === 'undefined') ui.leftWidgets = [];
  if(typeof ui.dailyOutreachGoal === 'undefined') ui.dailyOutreachGoal = 10;
  // Initialize context goals
  if(typeof ui.contextGoals === 'undefined') {
    ui.contextGoals = {
      lifeGoal: 5,
      home_autoGoal: 5,
      commercialGoal: 5,
      farmGoal: 5,
      networkingGoal: 5
    };
  }
  
  // Apply saved left widget positions
  var leftKeys = loadLeftWidgets();
  var hasLeftWidgets = leftKeys.length > 0;

  leftKeys.forEach(function(key){
    var widget = $('#' + key) || $('[data-key="' + key + '"]');
    if(widget && els.leftSidebar) els.leftSidebar.appendChild(widget);
  });

  // Apply widget order for right sidebar
  applyWidgetOrder();

  // Apply dual sidebar layout if widgets are split between sidebars
  applyDualSidebarLayout();

  enableDrag(); enableCollapse();

  // Check for daily queue rotation on load (will be done after storage is ready)

  // Check for queue rotation every minute (in case app stays open overnight)
  setInterval(function(){
    var today = new Date().toDateString();
    if(ui.lastQueueRotation !== today){
      rotateDailyQueues();
      render();
    }
  }, 60000);

  /* Email functionality with KPI data */
  if(els.emailTodayDetailBtn){
    els.emailTodayDetailBtn.addEventListener('click', function(){
      var kpis = getKPIData();
      var today = new Date().toLocaleDateString();
      var dailyStats = getDailyStats();

      var subject = 'Life Hotlist - Today\'s Activity (' + today + ')';
      var body = 'Today\'s Activity Report\n\n';
      body += '=== KPIs ===\n';
      body += 'Issued: ' + kpis.purchased + '\n';
      body += 'Weekly Calls: ' + kpis.weeklyCalls + '\n';
      body += 'Streak: ' + kpis.streak + ' day(s)\n\n';
      body += '=== Daily Activity ===\n';
      body += 'Calls: ' + dailyStats.calls + '\n';
      body += 'Messages: ' + dailyStats.messages + '\n\n';

      // Add today's activity details
      var todayActivities = getTodayActivities();
      if(todayActivities.length > 0){
        body += '=== Activity Details ===\n';
        todayActivities.forEach(function(a){
          body += a.time + ' - ' + a.client + ': ' + a.action + '\n';
        });
      }

      window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    });
  }

  if(els.emailSummaryBtn){
    els.emailSummaryBtn.addEventListener('click', function(){
      var kpis = getKPIData();
      var range = els.chartRangeSel ? els.chartRangeSel.value : '7';
      var rangeDays = parseInt(range);

      var subject = 'Life Hotlist - ' + rangeDays + ' Day Summary Report';
      var body = rangeDays + ' Day Summary Report\n\n';
      body += '=== KPIs ===\n';
      body += 'Total Issued: ' + kpis.purchased + '\n';
      body += 'Weekly Calls: ' + kpis.weeklyCalls + '\n';
      body += 'Current Streak: ' + kpis.streak + ' day(s)\n\n';

      // Add pipeline summary
      var pipeline = getPipelineData();
      body += '=== Pipeline ===\n';
      Object.keys(pipeline).forEach(function(status){
        body += status + ': ' + pipeline[status] + '\n';
      });

      window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    });
  }

  // Helper function to get today's activities
  function getTodayActivities(){
    var activities = [];
    var today = startOfDay(new Date());
    var tomorrow = addDays(today, 1);

    state.clients.forEach(function(c){
      (c.history || []).forEach(function(h){
        var ts = new Date(h.ts);
        if(ts >= today && ts < tomorrow){
          activities.push({
            time: ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            client: c.name,
            action: h.action === 'status' ? 'Status: ' + h.to : h.action
          });
        }
      });
    });

    return activities.sort(function(a, b){ return b.time.localeCompare(a.time); });
  }

  // Helper to get pipeline data
  function getPipelineData(){
    var pipeline = {};
    if(state && state.clients) state.clients.forEach(function(c){
      if(!c.archived && c.status){
        pipeline[c.status] = (pipeline[c.status] || 0) + 1;
      }
    });
    return pipeline;
  }

  // Initialize version
  var versionEl = document.getElementById('versionNumber');
  if(versionEl) versionEl.textContent = VERSION;

  // Initialize compact mode tooltips
  initializeCompactTooltips();

  /* Wait for storage initialization then render */
  Promise.all([storageReady, uiReady]).then(function() {
    // Now that storage is ready, perform initial setup

    // Initialize ageDays dropdown with saved value
    if(els.ageDays) {
      els.ageDays.value = String(ui.ageDays || 4);
    }

    // Initialize calendarMethod dropdown with saved value
    if(els.calendarMethod && ui.calendarMethod) {
      els.calendarMethod.value = ui.calendarMethod;
    }

    // Initialize groupTodayByClient if not set
    if(typeof ui.groupTodayByClient === 'undefined'){
      ui.groupTodayByClient = true;
      saveUI(ui);
    }
    if(els.groupToggle && ui.groupTodayByClient) {
      els.groupToggle.checked = ui.groupTodayByClient;
    }

    // Initialize default quotes if none exist
    if(!state.quotes || !state.quotes.list || state.quotes.list.length === 0) {
      var defaultQuotes = [
        "Intentional means, I've got a list in front of me, and I am going to improve this list somehow today.",
        "You have to have a conviction about the product.",
        "I hate walking away from a family without life insurance.",
        "If it doesn't bug you, why doesn't it bug you?",
        "If you're just winging it, you're not gonna sell life insurance.",
        "You have to have a system and it has to be dialed in.",
        "You have to be bold.",
        "You need to protect your family.",
        "Right now, you don't have a safety net.",
        "How much is Spotify now? How much is Netflix? You can do all that, but not provide protection for your family.",
        "On the worst day of their lives, when our clients may have lost someone dear, imagine the impact you've made—because of your help, you completely changed the future for that family and their children.",
        "What if we flip the script on GoFundMe and we call life insurance, I funded me.",
        "Life insurance is simply the stacking of paychecks.",
        "When is the last time you've had someone review your household for total asset protection?",
        "Protect today so those you love can breathe tomorrow",
        "Love isn't just words—it's the protection you leave behind",
        "A policy is a promise that hardship won't steal their future",
        "Plan now so grief doesn't also bring financial strain",
        "Invest in certainty when life hands out uncertainty",
        "A small premium buys a lasting safety net",
        "Insurance turns worry into a manageable cost",
        "Leave more than memories—leave a stable tomorrow"
      ];

      state.quotes = {
        raw: defaultQuotes.join('\n'),
        list: defaultQuotes
      };

      // Only save if this is truly the first time
      if(!ui.quotesHaveBeenInitialized) {
        ui.quotesHaveBeenInitialized = true;
        save(state);
        saveUI(ui);
      }
    }

    // Density is now handled by cookies and applied immediately on page load

    // Setup density change listener and set initial value
    if(els.densitySelect){
      var currentDensity = getCookie('density') || 'comfortable';
      els.densitySelect.value = currentDensity;

      els.densitySelect.addEventListener('change', function(){
        setDensityCookie(this.value);
        applyDensity();
        // Reset font size to medium when changing density
        setFontSizeCookie('medium');
        applyFontSize();
        this.blur(); // Remove focus to enable keyboard navigation
      });
    }

    // Setup font size controls
    var fontSizes = ['xsmall', 'small', 'medium', 'large', 'xlarge'];
    var currentFontSize = getCookie('fontSize') || 'medium';
    applyFontSize();

    if($('#fontSizeDown')){
      $('#fontSizeDown').addEventListener('click', function(){
        var current = getCookie('fontSize') || 'medium';
        var index = fontSizes.indexOf(current);
        if(index > 0){
          setFontSizeCookie(fontSizes[index - 1]);
          applyFontSize();
        }
      });
    }

    if($('#fontSizeUp')){
      $('#fontSizeUp').addEventListener('click', function(){
        var current = getCookie('fontSize') || 'medium';
        var index = fontSizes.indexOf(current);
        if(index < fontSizes.length - 1){
          setFontSizeCookie(fontSizes[index + 1]);
          applyFontSize();
        }
      });
    }

    rotateDailyQueues();
    initializeFirstTimeUser(); // Check for first-time user and load demo data
    renderQuote(false);
    scheduleQuoteTimer();
    renderDailyOutreach();

    // Calendar View Button handler
    if(els.calendarViewBtn){
      els.calendarViewBtn.addEventListener('click', function(){
        // Show calendar view modal
        var modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--card); border-radius:12px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,0.3); z-index:10001; width:500px; max-height:600px; overflow-y:auto;';

        var backdrop = document.createElement('div');
        backdrop.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000;';

        modal.innerHTML = '<h3 style="margin:0 0 20px 0; color:var(--ink);">Scheduled Follow-ups Calendar</h3>';

        // Get all scheduled items
        var items = state.clients.filter(function(c){
          return !c.archived && c.followUp && !c.queueTomorrow;
        }).map(function(c){
          var when = new Date(c.followUp);
          var clientContext = c.context || 'life';
          var contextName = CONTEXTS[clientContext] ? CONTEXTS[clientContext].name : 'Life';
          return {c:c, when:when, context:contextName};
        }).sort(function(a,b){return +a.when - +b.when;});

        if(items.length === 0){
          modal.innerHTML += '<p style="color:var(--muted);">No scheduled follow-ups</p>';
        } else {
          var listDiv = document.createElement('div');
          listDiv.style.cssText = 'display:grid; gap:12px;';

          items.forEach(function(item){
            var itemDiv = document.createElement('div');
            itemDiv.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:var(--bg); border-radius:8px; border:1px solid var(--line);';

            var leftDiv = document.createElement('div');
            leftDiv.innerHTML = '<div style="font-weight:600; color:var(--ink);">' + item.context + ' Follow-up: ' + item.c.name + '</div>' +
                               '<div style="font-size:12px; color:var(--muted); margin-top:4px;">' + item.when.toLocaleString([], {month:'numeric',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'}) + '</div>';

            var calBtn = document.createElement('button');
            calBtn.style.cssText = 'padding:6px 10px; background:var(--blue); color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px;';
            calBtn.textContent = '📅 Add to Calendar';
            calBtn.addEventListener('click', function(){
              createCalendarEvent(item.c, item.when);
            });

            itemDiv.appendChild(leftDiv);
            itemDiv.appendChild(calBtn);
            listDiv.appendChild(itemDiv);
          });

          modal.appendChild(listDiv);
        }

        var closeBtn = document.createElement('button');
        closeBtn.style.cssText = 'margin-top:20px; padding:8px 16px; background:transparent; color:var(--muted); border:1px solid var(--line); border-radius:8px; cursor:pointer; width:100%;';
        closeBtn.textContent = 'Close';
        closeBtn.addEventListener('click', function(){
          modal.remove();
          backdrop.remove();
        });
        modal.appendChild(closeBtn);

        backdrop.addEventListener('click', function(){
          modal.remove();
          backdrop.remove();
        });

        document.body.appendChild(backdrop);
        document.body.appendChild(modal);
      });
    }

    // Event delegation for dynamically created elements
    document.addEventListener('click', function(e){
      // Handle unschedule-x buttons
      if(e.target.classList.contains('unschedule-x')){
        e.stopPropagation();
        var clientId = e.target.getAttribute('data-client-id');
        var client = state.clients.find(function(c){ return c.id === clientId; });
        if(client){
          if(e.target.classList.contains('clear-purchase')){
            client.purchaseDate = '';
          } else {
            client.followUp = '';
          }
          save(state);
          render();
        }
      }

      // Handle add-to-cal buttons
      if(e.target.classList.contains('add-to-cal-btn')){
        e.stopPropagation();
        var clientId = e.target.getAttribute('data-client-id');
        var client = state.clients.find(function(c){ return c.id === clientId; });
        if(client && client.followUp){
          createCalendarEvent(client, new Date(client.followUp));
        }
      }
    });

    // Initialize Supabase if configured
    initSupabase();
    render();
    setTimeout(enableDragAndDrop, 100);
  }).catch(function(e) {
    console.error('Failed to initialize storage:', e);
    if (!state) {
      state = {clients:[], quotes:{raw:'', list:[]}, quotesSettings:{interval:15, random:true, norepeat:true, recent:[]}};
    }
    if (!ui) {
      ui = {};
    }
    // Initialize Supabase even on storage failure
    initSupabase();
    renderQuote(false);
    scheduleQuoteTimer();
    renderDailyOutreach();
    render();
  });
})();
</script>

<!-- Shortcuts Modal -->
<div id="shortcutsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--card); border-radius:var(--radius); padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:var(--shadow);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0; color:var(--ink);">Keyboard Shortcuts</h2>
      <button onclick="closeShortcutsModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--muted);">×</button>
    </div>
    <div style="display:grid; gap:16px;">
      <div>
        <h3 style="color:var(--green); margin-bottom:8px; font-size:14px;">Navigation</h3>
        <div style="display:grid; gap:4px; font-size:13px;">
          <div><kbd>↑/↓</kbd> or <kbd>J/K</kbd> - Navigate between clients</div>
          <div><kbd>←/→</kbd> - Move to previous/next stage</div>
          <div><kbd>Click</kbd> - Focus on a client row</div>
        </div>
      </div>
      <div>
        <h3 style="color:var(--green); margin-bottom:8px; font-size:14px;">Status Management</h3>
        <div style="display:grid; gap:4px; font-size:13px;">
          <div><kbd>1</kbd> - Initial Contact</div>
          <div><kbd>2</kbd> - Sent Quote</div>
          <div><kbd>3</kbd> - Sent Application</div>
          <div><kbd>4</kbd> - Pending Application Signature</div>
          <div><kbd>5</kbd> - Pending Medical Questionnaire</div>
          <div><kbd>6</kbd> - Issued</div>
          <div><kbd>0</kbd> - Clear status</div>
        </div>
      </div>
      <div>
        <h3 style="color:var(--green); margin-bottom:8px; font-size:14px;">Actions</h3>
        <div style="display:grid; gap:4px; font-size:13px;">
          <div><kbd>A</kbd> - Log a call</div>
          <div><kbd>L</kbd> - Log a message/email</div>
          <div><kbd>Shift+A</kbd> - Remove a call</div>
          <div><kbd>Shift+L</kbd> - Remove a message</div>
          <div><kbd>N</kbd> - Toggle notes</div>
          <div><kbd>H</kbd> - Mark as hot lead</div>
        </div>
      </div>
      <div>
        <h3 style="color:var(--green); margin-bottom:8px; font-size:14px;">Scheduling</h3>
        <div style="display:grid; gap:4px; font-size:13px;">
          <div><kbd>S</kbd> - Open schedule menu (navigate with arrows)</div>
          <div><kbd>F</kbd> - Queue for today</div>
          <div><kbd>D</kbd> - Queue for tomorrow</div>
          <div><kbd>U</kbd> - Undo last action</div>
        </div>
      </div>
      <div>
        <h3 style="color:var(--green); margin-bottom:8px; font-size:14px;">Help</h3>
        <div style="display:grid; gap:4px; font-size:13px;">
          <div><kbd>⌘/</kbd> or <kbd>Ctrl+/</kbd> - Show this help</div>
          <div><kbd>Esc</kbd> - Close this dialog</div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Changelog Modal -->
<div id="changelogModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--card); border-radius:var(--radius); padding:24px; max-width:500px; width:90%; max-height:70vh; overflow-y:auto; box-shadow:var(--shadow);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0; color:var(--ink);">Changelog</h2>
      <button onclick="closeChangelogModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--muted);">×</button>
    </div>
    <div id="changelogContent" style="display:flex; flex-direction:column; gap:16px;">
      <!-- Changelog items will be inserted here by JavaScript -->
    </div>
  </div>
</div>

<script>
// Register service worker for PWA functionality
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      console.log('ServiceWorker registration successful:', registration.scope);
    }, function(err) {
      console.log('ServiceWorker registration failed:', err);
    });

    // Request notification permission if we have scheduled items
    // Check if state exists (it's defined in the main app IIFE)
    if(typeof state !== 'undefined' && state.clients){
      var hasScheduled = state.clients.some(function(c){
        return !c.archived && c.followUp;
      });
      if(hasScheduled && typeof requestNotificationPermission === 'function'){
        requestNotificationPermission();
      }
    }
  });
}

// PWA install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  // Could show install button here if desired
});
</script>

</body>
</html>
