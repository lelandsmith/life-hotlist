<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="cache-buster" content="v22-20250117" />
<title>Life Hotlist</title>
<link rel="manifest" href="/manifest.json?v=1.7.2">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='28'%3E🔥%3C/text%3E%3C/svg%3E">
<meta name="theme-color" content="#ff5722">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Hotlist">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%23ff5722'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='96' fill='white'%3E🔥%3C/text%3E%3C/svg%3E">
<style>
  :root{
  /* Brand & neutrals */
  --green:#0e7a5a; --green-600:#0a5e46; --green-50:#e9f5ee;
  --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e6e9f2;
  --shadow:0 10px 24px rgba(15,23,42,.06), 0 2px 6px rgba(15,23,42,.04);
  --orange:#f59e0b; --red:#dc2626; --blue:#4f79ff;
  --success:#10b981; --info:#60a5fa; --warning:#fbbf24;
  --radius:14px;

  /* Elevation tokens */
  --ring:0 0 0 2px rgba(99,102,241,.15);
  --ring-strong:0 0 0 3px rgba(99,102,241,.25);
}

/* Dark mode (automatic) */
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0f1220; --card:#16192a; --ink:#e6e9f5; --muted:#98a2b3; --line:#232846;
    --shadow:0 10px 24px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.25);
    --green:#22c38b; --green-600:#16a374; --green-50:#0f2a22;
  }
  .bar{background:#2b335e}
  .s-hot{background:#2b1d12;border-color:#8a4e21}
  .sbtn.s-hot.active{background:#3a2618}
  .hot-row{
    border-left-color:#fb923c;
    background: linear-gradient(135deg, 
      rgba(251, 146, 60, 0.18) 0%,
      rgba(249, 115, 22, 0.12) 30%,
      rgba(234, 88, 12, 0.08) 60%,
      rgba(220, 38, 38, 0.04) 100%
    );
    animation: hotPulse 2s ease-in-out infinite;
  }
  .hot-badge {
    background: linear-gradient(135deg, #ff8a80, #ff6e40);
  }
  .lightning-bolt {
    filter: drop-shadow(0 0 15px #ffd54f);
  }
}

/* base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:linear-gradient(180deg, var(--bg), color-mix(in oklab, var(--bg) 85%, #fff));
  color:var(--ink);
  font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
  letter-spacing:.15px;
}

/* Layout shell */
.app{
  display:grid; grid-template-columns:1fr minmax(330px, 400px); grid-template-areas:"main side";
  gap:14px; padding:14px; max-width:1800px; margin:0 auto; min-height:100vh; position:relative;
}
.app > section.card{
  grid-area:main;
  position:relative;
  overflow-y:auto;
  max-height:calc(100vh - 28px);
}
.app > aside.card{grid-area:side}
.app > aside.card.left-sidebar{
  grid-area:left;
  overflow-x:hidden;
  overflow-y:auto;
  max-height:calc(100vh - 28px);
}

/* Dual sidebar layouts */
.app.dual-sidebar{
  grid-template-columns:minmax(300px, 380px) 1fr minmax(300px, 380px); 
  grid-template-areas:"left main side";
}
.app.leftbar{grid-template-columns:400px 1fr;grid-template-areas:"side main"}
.app.no-side{grid-template-columns:1fr; grid-template-areas:"main"}
.app.no-side > aside{display:none !important}

/* Card */
.card{
  background:var(--card);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
  padding:14px;
  border-radius:var(--radius);
  min-width:0;
}

/* Header */
header{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;margin-bottom:8px}
h1{
  text-transform:uppercase;
  letter-spacing:.6px;
  font-size:18pt;
  font-weight:800;
  margin:0;
}

/* Flame title styling */
.flame-title {
  background: linear-gradient(135deg, #ff6b35, #ff8c00, #ffa500);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 15px rgba(255, 140, 0, 0.4))
          drop-shadow(0 0 30px rgba(255, 165, 0, 0.2));
  position: relative;
  display: inline-block;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

/* Hot flame animation when marking client hot */
@keyframes flameTravel {
  0% {
    transform: scale(0.5);
    opacity: 0;
  }
  20% {
    transform: scale(1.2);
    opacity: 1;
  }
  80% {
    transform: scale(0.8);
    opacity: 1;
  }
  100% {
    transform: scale(1.5);
    opacity: 0;
  }
}

.flame-burst {
  position: fixed;
  font-size: 96px;
  z-index: 10000;
  pointer-events: none;
  transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
.muted{color:var(--muted)} .small{font-size:12px}

/* Keyboard styles */
kbd {
  background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 2px 6px;
  font-family: monospace;
  font-size: 12px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  display: inline-block;
}
@media (prefers-color-scheme: dark) {
  kbd {
    background: linear-gradient(to bottom, #3a3f5c, #2b335e);
    border-color: #4a5568;
  }
}

/* Shortcuts section */
.shortcuts-section{
  position:static;
  margin-top:2px;
  margin-bottom:2px;
  padding:12px 16px;
  background:linear-gradient(135deg, #f8fafc, #f1f5f9);
  border:1px solid #e2e8f0;
  border-radius:8px;
  font-size:12px;
  color:#6b7390;
  line-height:1.6;
  z-index:10;
  box-shadow:0 -2px 8px rgba(0,0,0,0.05);
}
.error-banner{
  display:none;background:#fff3f3;color:#7f1d1d;border:1px solid #fecaca;
  padding:8px 10px;margin:8px 0;border-radius:10px
}

/* Inputs & buttons */
input,textarea,select,button{
  border:1px solid var(--line);
  border-radius:10px;
  font-size:14px;
  background:#fff;
  color:var(--ink);
  transition:.15s ease;
}
input[type=text],input[type=number]{padding:8px 10px}
select{padding:7px 10px;background:linear-gradient(#fff, #f8fafc)}
button{
  cursor:pointer;padding:8px 12px;background:linear-gradient(#fff, #f8fafc);
  box-shadow:0 1px 0 rgba(15,23,42,.04);
}
button:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(15,23,42,.08)}
button:focus-visible{outline:none; box-shadow:var(--ring)}
.btn-primary{
  background:linear-gradient(180deg, var(--green), color-mix(in oklab, var(--green) 85%, black));
  border-color:var(--green-600); color:#fff;
}
.btn-min{padding:5px 10px;font-size:12px}
.btn-min.gray{background:#f8fafc;border-color:#cbd5e1;color:#334155}

/* Ribbons & KPIs */
.ribbons{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
.ribbon{
  background:linear-gradient(180deg,#fffbe6,#fff4c2);
  border:1px solid #fde68a;
  font-size:11px;padding:4px 8px;border-radius:999px
}
.kpis-widget{display:grid;gap:8px;font-size:13px}
.kpis-widget .kpi-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f1f5f9}
.kpis-widget .kpi-row:last-child{border-bottom:none}
.kpis-widget .kpi-label{color:#6b7390}
.kpis-widget .kpi-value{font-weight:700;color:#1e293b}
.pill b{margin-right:6px}

/* Controls */
.controls{display:flex;gap:10px;align-items:center;width:100%}
.controls .stack{display:flex;gap:8px;align-items:center;flex-wrap:nowrap;width:100%}

/* Table head & rows */
.table-head{
  display:grid;grid-template-columns:1fr auto;gap:10px;padding:10px 12px;
  border-bottom:1px solid var(--line);font-size:12px;color:#4b5563;
  background:color-mix(in oklab, var(--card) 92%, #eef2ff); border-radius:12px
}
.row{
  display:grid; grid-template-columns:1fr auto; gap:10px;
  padding:12px 12px; border-bottom:1px dashed var(--line);
  align-items:center; border-radius:12px; position:relative;
}
.row:hover{background:color-mix(in oklab, var(--card) 92%, #eef2ff)}
.row:last-child{border-bottom:none}
/* Remove untouched background - we'll use green dot instead */
.row.selected{outline:2px solid var(--info); box-shadow:var(--ring-strong)}

/* Hot lead styling */
.row.hot-row{
  border-left:4px solid #f97316;
  background: linear-gradient(135deg, 
    rgba(254, 215, 170, 0.35) 0%,
    rgba(251, 146, 60, 0.25) 20%,
    rgba(249, 115, 22, 0.18) 40%,
    rgba(234, 88, 12, 0.12) 60%,
    rgba(220, 38, 38, 0.08) 100%
  ) !important;
  position:relative;
}

/* Animate the fire icon when hot status is active */
.sbtn.s-hot.active .ico {
  display: inline-block;
  animation: fireFlicker 1.5s ease-in-out infinite;
  transform-origin: center bottom;
}

@keyframes fireFlicker {
  0%, 100% { 
    transform: scale(1) rotate(0deg);
    filter: brightness(1);
  }
  25% {
    transform: scale(1.1) rotate(-5deg);
    filter: brightness(1.2) hue-rotate(-10deg);
  }
  50% { 
    transform: scale(1.15) rotate(3deg);
    filter: brightness(1.4) hue-rotate(10deg);
  }
  75% {
    transform: scale(1.05) rotate(-3deg);
    filter: brightness(1.1) hue-rotate(-5deg);
  }
}

/* Left column */
.leftcol{display:flex;flex-direction:column;gap:2px;justify-content:center;min-width:0;overflow:hidden}
.stamp{font-variant-numeric:tabular-nums;color:#6b7390;font-size:12px}
.lastmeta{font-size:11px;color:#6b7390}

.name-line{display:flex;gap:10px;align-items:center;min-width:0;overflow:hidden}
.name{font-weight:850;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:none}
.touchCount{opacity:.55;font-size:11px;margin-left:4px;flex:0 0 auto}
.status-icons{display:flex;gap:6px;align-items:center;flex:0 0 auto}
.status-icon{font-size:22px;line-height:1}
.notes-preview{
  font-size:12px;color:#6b7390;margin-top:2px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  margin-left:11px;max-width:100%;
}

/* Action groups */
.actions-wrap{
  display:flex;align-items:center;justify-content:flex-start;flex-wrap:nowrap;overflow:visible;
  column-gap:24px; flex-shrink:0;
}
.group--quick{display:flex;gap:10px;align-items:center; margin-right:18px;}
.group--status{display:flex;gap:12px;align-items:center; margin-right:18px;}
.group--icons{display:flex;gap:10px;align-items:center}

/* Quick counters */
.qbtn{
  position:relative;border:1px solid var(--line);padding:8px 12px;border-radius:12px;
  background:#fff;font-size:16px;line-height:1;display:inline-flex;align-items:center;justify-content:center;min-width:46px
}
.qbtn .badge{
  position:absolute;right:-6px;bottom:-8px;background:#fff;border:1px solid #cbd5e1;
  border-radius:10px;font-size:10px;line-height:1;padding:2px 5px; box-shadow:0 2px 6px rgba(15,23,42,.08)
}
.badge[data-zero="1"]{display:none}

/* Status buttons */
.sbtn{
  position:relative; border:1px solid var(--line); padding:8px 10px; border-radius:12px;
  font-size:11px; background:#fff; white-space:nowrap; display:inline-flex; align-items:center; justify-content:center; opacity:.7;
  flex-direction:column; min-width:50px; transition:.15s ease;
}
.sbtn:hover{opacity:1; transform:translateY(-1px)}
.sbtn:focus-visible{outline:none; box-shadow:var(--ring)}
.sbtn .ico{font-size:18px;line-height:1}
.sbtn .label{display:none;font-size:10px;line-height:1;margin-top:3px;text-align:center}
.sbtn.active{outline:2px solid var(--green);opacity:1; background:color-mix(in oklab, var(--green-50) 50%, #fff)}
.sbtn.active .label{display:block}
.s-quote{background:#fffdf6;border-color:#fde68a}
.s-app{background:#f7fdf9;border-color:#ccebd9}
.s-sig{background:#fff7f8;border-color:#fecdd3}
.s-medq{background:#f6f5ff;border-color:#ddd6fe}
.s-pur{background:#f3fbf6;border-color:#cfe9dc}
.s-hot{background:#fff7ed;border-color:#fed7aa}
.sbtn.s-hot.active{
  outline:2px solid #fb923c;
  background:#fff1e6;
  opacity:1;
}

/* Tooltip (under icons) */
.has-tip{position:relative}
.has-tip::after{
  content:attr(data-tip);
  position:absolute; left:50%; transform:translateX(-50%);
  top:calc(100% + 6px); opacity:0; pointer-events:none;
  background:#111827; color:#fff; font-size:10px; line-height:1;
  padding:6px 8px; border-radius:6px; white-space:nowrap;
  box-shadow:0 6px 18px rgba(15,23,42,.18);
  transition:opacity .12s ease, transform .12s ease;
}
.has-tip:hover::after{opacity:.95; transform:translateX(-50%) translateY(2px)}

/* Schedule dropdown */
.sched-menu{
  position:absolute; z-index:1000; min-width:200px;
  background:var(--card); border:1px solid var(--line); box-shadow:var(--shadow);
  padding:6px; display:flex; flex-direction:column; border-radius:12px;
}
.sched-menu button{
  border:none; background:none; padding:10px 12px; text-align:left;
  font-size:14px; cursor:pointer; color:var(--ink); border-radius:10px;
}
.sched-menu button:hover{background:#f1f5ff; transform:none; box-shadow:none;}
.sched-menu button.selected{background:#f1f5ff;}

/* Status Progress Tracker - Domino's Style */
.status-tracker {
  display: flex;
  position: relative;
  padding: 15px 0;
  margin: 10px 0;
}

.status-tracker::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 25px;
  right: 25px;
  height: 3px;
  background: var(--line);
  z-index: 0;
}

.status-tracker::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 25px;
  height: 3px;
  background: var(--green);
  z-index: 0;
  transition: width 0.3s ease;
  width: 0;
}

.status-tracker[data-progress="0"]::after { width: calc(16.67% - 20px); }
.status-tracker[data-progress="1"]::after { width: calc(33.33% - 20px); }
.status-tracker[data-progress="2"]::after { width: calc(50% - 20px); }
.status-tracker[data-progress="3"]::after { width: calc(66.67% - 20px); }
.status-tracker[data-progress="4"]::after { width: calc(83.33% - 20px); }
.status-tracker[data-progress="5"]::after { width: calc(100% - 45px); }

/* No status selected */
.status-tracker[data-progress="-1"]::after { width: 0; }

.status-tracker .stage {
  flex: 1;
  text-align: center;
  position: relative;
  z-index: 1;
}

.status-tracker .stage-icon {
  width: 44px;
  height: 44px;
  margin: 0 auto 6px;
  border-radius: 50%;
  background: white;
  border: 3px solid var(--line);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.status-tracker .stage.completed .stage-icon {
  border-color: var(--line);
  background: #10b981;
  transform: scale(1.05);
}

.status-tracker .stage.active .stage-icon {
  border: 3px solid #059669;
  background: var(--orange);
  color: white;
}

.status-tracker .stage.active.purchased .stage-icon {
  border: 3px solid #059669;
  background: #10b981;
  color: white;
}


.status-tracker .stage-label {
  font-size: 10px;
  color: var(--muted);
  line-height: 1.2;
}

.status-tracker .stage.completed .stage-label,
.status-tracker .stage.active .stage-label {
  color: var(--ink);
  font-weight: 600;
}


/* Compact mode for status tracker */
.status-tracker.compact {
  padding: 0;
  margin: 0;
  min-width: 320px;
}

.status-tracker.compact::before {
  top: 22px;
  left: 20px;
  right: 20px;
  height: 2px;
}

.status-tracker.compact::after {
  top: 22px;
  transform: none;
}

.status-tracker.compact .stage-icon {
  width: 36px;
  height: 36px;
  font-size: 16px;
  cursor: pointer;
  transition: transform 0.2s;
}

.status-tracker.compact .stage-icon:hover {
  transform: scale(1.1);
}

.status-tracker.compact .stage-label {
  font-size: 9px;
  max-width: 50px;
  text-align: center;
  line-height: 1.1;
}

/* Notes area */
.notes{display:grid;margin-top:6px}
.notes textarea{
  min-height:64px;resize:vertical;padding:10px;border-radius:12px;background:#fff;
  box-shadow:inset 0 1px 0 rgba(15,23,42,.04)
}
.hidden{display:none}

/* Aging & touched badges */
.age-badge{
  display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;
  font-size:11px;font-weight:800;color:#fff;flex:0 0 auto; box-shadow:0 2px 6px rgba(15,23,42,.16)
}
.age-badge.orange{background:var(--orange)}
.age-badge.red{background:var(--red)}
.age-badge.sm{width:16px;height:16px;font-size:10px}
/* Green dot for touched today */
.touched-dot{
  display:inline-block;
  width:16px;
  height:16px;
  border-radius:50%;
  background:var(--success);
  margin-left:2px;
  vertical-align:middle;
}

/* Sidebar & widgets */
.sidebar{overflow-x:hidden;overflow-y:auto;max-height:calc(100vh - 28px)}
.sidebar h2{margin:0 0 8px;font-size:14px;font-weight:700}
.widget{margin-top:12px;padding-top:8px;border-top:1px dashed var(--line)}
.widget[draggable="true"]{cursor:grab}
.widget.dragging{opacity:.85}
.widget.drag-over{outline:2px dashed var(--info); border-radius:12px}
.widget-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
.widget-title{font-size:14px;margin:0}
.widget-actions{display:flex;gap:6px;align-items:center}
.collapse-btn{font-size:14px;line-height:1;padding:4px 8px;width:28px;text-align:center;border-radius:10px}
.collapse-btn::after{content:"–"}
.widget-body.hidden{display:none}

/* Drag zones for dual sidebar */
.sidebar-drag-zone{
  position:absolute; top:60px; bottom:20px; width:120px; z-index:999;
  background:linear-gradient(90deg, rgba(79,121,255,.15), rgba(79,121,255,.05));
  border:3px dashed var(--info); opacity:0; pointer-events:none;
  transition:opacity .2s ease; display:flex; align-items:center; justify-content:center; flex-direction:column;
  font-size:16px; color:var(--info); font-weight:bold;
}
.sidebar-drag-zone.left{left:20px; border-radius:12px}
.sidebar-drag-zone.right{right:20px; border-radius:12px}
.sidebar-drag-zone.active{opacity:1; pointer-events:auto; display:flex !important}
.sidebar-drag-zone::after{content:"📁 Drop Widget Here"}
.sidebar.drag-target{outline:3px dashed var(--info); background:rgba(79,121,255,.05)}

/* Progress Stats Bar */
.progress-stats{
  display:flex; align-items:center; justify-content:space-between; 
  padding:8px 20px; width:100%;
  background:linear-gradient(135deg, #f0f9ff, #ecfdf5);
  border:1px solid #bfdbfe; border-radius:8px; margin:6px 0;
  font-size:14px; color:#1f2937; flex-wrap:nowrap;
  min-height:36px; box-sizing:border-box;
}
.stat-group{
  display:flex; align-items:center; gap:6px; white-space:nowrap;
  flex-shrink:0;
}
.stat-group strong{
  color:#059669; font-weight:700;
}
.stat-separator{
  color:#6b7280; font-weight:bold; margin:0 8px; flex-shrink:0;
}
.inline-progress{
  width:80px; height:6px; background:#e5e7eb; border-radius:3px;
  position:relative; margin-left:6px; box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);
  flex-shrink:0;
}
.progress-fill{
  height:100%; width:0%; background:linear-gradient(90deg, #10b981, #059669);
  border-radius:3px; transition:width 0.4s ease;
  box-shadow:0 1px 2px rgba(16,185,129,0.3);
}
.goal-input{
  width:60px; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px;
  font-size:14px; text-align:center; margin-left:6px;
  background:#ffffff; transition:border-color 0.2s; flex-shrink:0;
  min-width:60px;
}
.goal-input:focus{
  border-color:#3b82f6; outline:none; box-shadow:0 0 0 2px rgba(59,130,246,0.1);
}
.btn-save{
  padding:4px 12px; font-size:13px; border:1px solid #10b981; 
  border-radius:4px; background:#10b981; color:white; cursor:pointer;
  margin-left:6px; transition:background 0.2s; flex-shrink:0;
  white-space:nowrap;
}
.btn-save:hover{
  background:#059669;
}

/* 7-Day Outreach History */
.outreach-history{
  display:flex; align-items:center; gap:8px;
  padding:6px 20px; font-size:12px; color:#6b7390;
  background:rgba(241,245,249,0.5); border-radius:6px; margin:0 0 6px;
}
.history-label{font-weight:600; color:#475569}
.history-days{display:flex; gap:6px}
.history-day{
  display:flex; flex-direction:column; align-items:center;
  padding:4px 6px; background:white; border:1px solid #e2e8f0; border-radius:4px;
  min-width:32px;
}
.history-day-name{font-size:10px; color:#94a3b8; margin-bottom:2px}
.history-day-count{font-weight:700; color:#1e293b}
.history-day.today{background:#dbeafe; border-color:#93c5fd}
.history-day.goal-met{background:#dcfce7; border-color:#86efac}

/* Goal Achievement Celebration */
.celebration{
  position:fixed; top:0; left:0; width:100%; height:100%; 
  pointer-events:none; z-index:9999; overflow:hidden;
}
.celebration.hidden{
  display:none;
}
.celebration-banner{
  position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
  background:linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
  background-size:400% 400%; animation:rainbow 1s ease-in-out infinite;
  padding:20px 40px; border-radius:15px; font-size:24px; font-weight:bold;
  color:white; text-shadow:2px 2px 4px rgba(0,0,0,0.3);
  box-shadow:0 10px 30px rgba(0,0,0,0.3); 
  animation:celebrationBounce 0.6s ease-out, rainbow 2s ease-in-out infinite;
}
.celebration-text{
  display:block; white-space:nowrap;
}
.confetti-container{
  position:absolute; top:0; left:0; width:100%; height:100%;
}
.confetti{
  position:absolute; width:10px; height:10px; background:#ff6b6b;
  animation:confettiFall 3s linear infinite;
}
.confetti:nth-child(2n){background:#feca57;}
.confetti:nth-child(3n){background:#48dbfb;}
.confetti:nth-child(4n){background:#ff9ff3;}
.confetti:nth-child(5n){background:#1dd1a1;}

@keyframes celebrationBounce{
  0%{transform:translate(-50%, -50%) scale(0) rotate(-180deg); opacity:0;}
  50%{transform:translate(-50%, -50%) scale(1.2) rotate(0deg); opacity:1;}
  100%{transform:translate(-50%, -50%) scale(1) rotate(0deg); opacity:1;}
}
@keyframes rainbow{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
@keyframes confettiFall{
  0%{transform:translateY(-100vh) rotate(0deg); opacity:1;}
  100%{transform:translateY(100vh) rotate(720deg); opacity:0;}
}

/* Purchase Celebration - Dollar Explosion */
.dollar-explosion{
  position:fixed;
  pointer-events:none;
  z-index:10000;
}
.dollar-particle{
  position:absolute;
  font-size:24px;
  font-weight:bold;
  color:#10b981;
  animation:explode 1.5s ease-out forwards;
  transform-origin:center;
}
@keyframes explode{
  0%{
    transform:translate(0, 0) scale(0) rotate(0deg);
    opacity:1;
  }
  50%{
    opacity:1;
  }
  100%{
    transform:translate(var(--dx), var(--dy)) scale(1) rotate(720deg);
    opacity:0;
  }
}

/* Activity */
.activity{max-height:30vh;overflow:auto}
.activity .item{
  display:grid;grid-template-columns:56px 1fr;gap:8px;padding:8px 0;border-bottom:1px dashed var(--line);position:relative
}
.activity .item:last-child{border-bottom:none}
.activity .undo{
  position:absolute;right:0;top:50%;transform:translateY(-50%);
  opacity:0;transition:opacity .12s;background:#e8f0ff;border:1px solid #cbd5e1;color:#0f172a;
  padding:5px 8px;font-size:11px;cursor:pointer;border-radius:10px
}
.activity .item:hover .undo{opacity:1}

/* Micro viz */
.chart{height:100px;display:flex;gap:6px;align-items:flex-end;margin-top:8px}
.bar{flex:1;background:#dbe6ff;border-radius:6px 6px 0 0}
.barlab{font-size:10px;color:#6b7390;text-align:center;margin-top:4px}
.heatmap{display:grid;grid-template-columns:repeat(13,10px);gap:4px}
.cell{width:10px;height:10px;background:#eef2ff;border:1px solid #e5e7eb;border-radius:2px}
.cell.l1{background:#dbeafe}.cell.l2{background:#bfdbfe}.cell.l3{background:#93c5fd}.cell.l4{background:#60a5fa}

/* Lists in sidebar */
.nextlist,.followups{display:grid;gap:8px}
.nextitem,.followitem{
  display:flex;justify-content:space-between;align-items:center;border:1px dashed var(--line);
  padding:6px 8px;background:#fff;border-radius:12px
}

/* Quote */
.quote{font-style:italic;color:#334155;font-size:15px;padding:8px;border-radius:12px;background:color-mix(in oklab, var(--card) 92%, #f0f4ff)}
.quote small{display:block;color:#6b7280;margin-top:4px}

/* Today queue */
.queue-block{margin:10px 0 12px;padding:8px;border:1px dashed var(--line);background:#fff;border-radius:12px}
.queue-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.queue-title{font-weight:800}

/* Icon buttons row (📝 📅 📂 🗑) */
.iconbtn{
  position:relative;border:1px solid var(--line);background:#fff;
  cursor:pointer;font-size:16px;line-height:1;padding:8px 10px;
  display:inline-flex;align-items:center;justify-content:center;min-width:42px;border-radius:12px
}
.iconbtn:focus-visible{outline:none; box-shadow:var(--ring)}

/* Chips */
.tag-chip{
  display:inline-block;border:1px solid #cbd5e1;background:#f8fafc;font-size:11px;
  padding:2px 6px;margin-left:4px;white-space:nowrap;flex-shrink:0;border-radius:999px;
  position:relative;
}
.tag-chip.scheduled{
  padding-right:8px;
}
.tag-chip.purchased-chip{
  background:#e9f5ee;
  color:#0e7a5a;
  border-color:#0e7a5a;
  font-weight:600;
}
.tag-chip.scheduled .unschedule-x{
  display:none;
  position:absolute;
  right:2px;
  top:-2px;
  background:#dc2626;
  color:white;
  border-radius:50%;
  width:14px;
  height:14px;
  line-height:14px;
  text-align:center;
  font-size:10px;
  cursor:pointer;
  font-weight:bold;
}
.tag-chip.scheduled:hover .unschedule-x{
  display:block;
}

/* Density switch */
body[data-density="comfortable"] .row{padding:12px 12px}
body[data-density="comfortable"] .name{font-size:16px}

body[data-density="compact"] .row{padding:5px 8px}
body[data-density="compact"] .name{font-size:14px}
body[data-density="compact"] .notes-preview{font-size:11px}
body[data-density="compact"] .group--quick{gap:6px; margin-right:6px}
body[data-density="compact"] .group--status{gap:6px; margin-right:6px}
body[data-density="compact"] .iconbtn{min-width:34px; padding:4px 6px; font-size:14px}
body[data-density="compact"] .qbtn{min-width:36px; padding:4px 6px; font-size:14px}
body[data-density="compact"] .sbtn{min-width:38px; padding:4px 6px}
body[data-density="compact"] .sbtn .ico{font-size:16px}
body[data-density="compact"] .sbtn .label{font-size:9px; margin-top:2px}

/* Ultra Compact - Smart horizontal layout */
body[data-density="ultra-compact"] .row{
  display:grid; grid-template-columns:1fr auto auto; gap:8px;
  padding:4px 8px; font-size:13px; line-height:1.3; align-items:center;
}
body[data-density="ultra-compact"] .name-section{
  display:flex; align-items:center; gap:6px; min-width:0; overflow:hidden;
}
body[data-density="ultra-compact"] .name{font-size:14px; font-weight:700; flex-shrink:0}
body[data-density="ultra-compact"] .touchCount{font-size:10px; opacity:.6; flex-shrink:0}
body[data-density="ultra-compact"] .notes-preview{
  font-size:11px; opacity:.7; margin-left:8px; 
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; min-width:0;
}
body[data-density="ultra-compact"] .actions-section{
  display:flex; align-items:center; gap:3px; white-space:nowrap;
}
body[data-density="ultra-compact"] .tags-section{
  display:flex; gap:3px; font-size:10px;
}
body[data-density="ultra-compact"] .tag-chip{padding:1px 4px; font-size:9px}

/* Ultra compact button styling */
body[data-density="ultra-compact"] .qbtn{
  min-width:24px; padding:2px 4px; font-size:12px; border-radius:4px;
}
body[data-density="ultra-compact"] .qbtn .badge{
  right:-4px; bottom:-4px; font-size:8px; padding:1px 3px;
}
body[data-density="ultra-compact"] .sbtn{
  min-width:20px; padding:2px 3px; font-size:9px; border-radius:4px; opacity:.8;
}
body[data-density="ultra-compact"] .sbtn .ico{font-size:12px}
body[data-density="ultra-compact"] .sbtn .label{display:none} /* Hide labels in ultra compact */
body[data-density="ultra-compact"] .sbtn.active{opacity:1; outline:1px solid var(--green)}
body[data-density="ultra-compact"] .sbtn.s-hot.active{outline:1px solid #fb923c}
body[data-density="ultra-compact"] .status-tracker .stage-label{display:none} /* Hide status tracker labels */
/* Ultra-compact status tracker - override all compact mode sizing */
body[data-density="ultra-compact"] .status-tracker.compact .stage-icon,
body[data-density="ultra-compact"] .status-tracker.compact .stage.completed .stage-icon,
body[data-density="ultra-compact"] .status-tracker.compact .stage.active .stage-icon,
body[data-density="ultra-compact"] .status-tracker.compact .stage.active.purchased .stage-icon{
  width: 44px !important;
  height: 44px !important;
  font-size: 18px !important;
}
body[data-density="ultra-compact"] .status-tracker.compact .stage-icon:hover{
  transform: scale(1.05) !important; /* Consistent hover scale */
}
body[data-density="ultra-compact"] .iconbtn{
  min-width:20px; padding:2px 3px; font-size:12px; border-radius:4px;
}
body[data-density="ultra-compact"] .status-icons{gap:3px}
body[data-density="ultra-compact"] .age-badge{width:14px; height:14px; font-size:8px}

/* Responsive */
/* Medium screens - better layout for 1400x900 */
@media (min-width:1151px) and (max-width:1450px){
  #sidebar-controls{
    flex:0 0 auto;
  }
}

@media (max-width:1150px){
  .app{grid-template-columns:1fr;grid-template-areas:"main" "side";padding:10px}
  .table-head,.row{grid-template-columns:1fr}
  .actions-wrap{justify-content:flex-start}
  .sidebar{max-height:52vh}
}

</style>
</head>
<body>
<div class="app" id="appRoot">
  <!-- ===== DRAG ZONES ===== -->
  <div class="sidebar-drag-zone left" id="leftDragZone"></div>
  <div class="sidebar-drag-zone right" id="rightDragZone"></div>
  
  <!-- Goal Achievement Celebration -->
  <div id="celebration" class="celebration hidden">
    <div class="celebration-banner">
      <span class="celebration-text">🎉 DAILY GOAL ACHIEVED! 🎉</span>
    </div>
    <div class="confetti-container" id="confettiContainer"></div>
  </div>

  <!-- Purchase Celebration Audio -->
  <audio id="chachingSound" preload="auto">
    <source src="sounds/cash-register-kaching-376867.wav" type="audio/wav">
  </audio>
  
  <!-- ===== LEFT SIDEBAR (for drag and drop dual sidebar only) ===== -->
  <aside class="card sidebar left-sidebar" id="leftSidebar" style="display:none;">
    <!-- Widgets can be dragged here for dual sidebar layout -->
  </aside>
  
  <!-- ===== MAIN LIST ===== -->
  <section class="card">
    <header>
      <div style="display:flex;flex-direction:column;gap:8px">
        <h1 id="hotlistTitle" class="flame-title">Life Hotlist 🔥</h1>
        <div id="errorBanner" class="error-banner"></div>

        <!-- Daily Outreach Progress Bar -->
        <div class="progress-stats">
          <div class="stat-group">
            <strong>Daily Outreach:</strong>
            <span id="dailyOutreachLabel">0 / 10</span>
            <div class="inline-progress" id="dailyOutreachBar">
              <div class="progress-fill" id="dailyOutreachFill"></div>
            </div>
          </div>
          <div class="stat-separator">|</div>
          <div class="stat-group">
            <strong>Calls:</strong>
            <span id="dailyCalls">0</span>
          </div>
          <div class="stat-separator">|</div>
          <div class="stat-group">
            <strong>Messages:</strong>
            <span id="dailyMessages">0</span>
          </div>
          <div class="stat-separator">|</div>
          <div class="stat-group">
            <strong>Goal:</strong>
            <input type="number" class="goal-input" id="dailyOutreachGoal" value="10" min="1" max="100">
            <button class="btn-save" id="saveDailyGoal">Save</button>
          </div>
          <div class="stat-separator">|</div>
          <div class="stat-group" style="background:#e9f5ee; padding:4px 8px; border-radius:6px;">
            <strong style="color:#0e7a5a;">Life Apps This Month:</strong>
            <span id="monthlyPurchases" style="color:#0e7a5a; font-weight:700;">0</span>
          </div>
        </div>

        <!-- All controls in single row below daily outreach -->
        <div class="controls" style="margin:0;padding:0;">
          <div class="stack" style="flex-wrap:nowrap;align-items:center;">
            <input id="globalSearch" type="text" placeholder="Search clients or add new (press Enter)" style="min-width:200px;flex:1;" />
            <label class="small">Sort
              <select id="sortBy">
                <option value="lastTouch">Last touched</option>
                <option value="createdAt">Date added</option>
                <option value="name">Name</option>
              </select>
            </label>
            <label class="small">Density
              <select id="densitySelect">
                <option value="comfortable">Comfortable</option>
                <option value="compact">Compact</option>
                <option value="ultra-compact">Ultra Compact</option>
              </select>
            </label>
            <button id="toggleSidebarBtn" class="btn-min gray" title="Toggle Sidebar" style="padding:4px 8px;">◧</button>
            <div id="sidebar-controls" style="display:flex; gap:2px;"></div>
            <button id="importBtn" class="btn-min gray" title="Import Clients" style="padding:4px 8px;">📥</button>
            <button id="exportBtn" class="btn-min gray" title="Export Clients" style="padding:4px 8px;">📤</button>
            <button id="loadDemoBtn" class="btn-min gray" title="Load Demo Data" style="padding:4px 8px;">📋</button>
          </div>
        </div>
      </div>
    </header>


    <div id="todayBlock" class="section hidden">
      <h2>Today</h2>
      <div class="table-head"><div>Client • Notes</div><div>Actions</div></div>
      <div id="todayList"></div>
    </div>

    <div id="emptyState" style="display:none;"></div>

    <div id="clearDemoSection" style="display:none; text-align:center; margin:20px 0;">
      <button id="clearDemoBtn" class="btn-min orange" onclick="clearDemoData()" style="padding:8px 16px;">
        🗑️ Clear Demo Data
      </button>
      <p style="margin:8px 0 0 0; font-size:0.9em; color:var(--muted);">
        Remove the 3 demo clients to start fresh
      </p>
    </div>

    <div class="table-head" id="mainTableHead">
      <div>Client • Notes</div>
      <div>Actions</div>
    </div>
    <div id="list"></div>

    <div id="scheduledBlock" class="section hidden">
      <h2>Scheduled</h2>
      <div class="table-head"><div>Client • Notes</div><div>Actions</div></div>
      <div id="scheduledList"></div>
    </div>

    <div id="archivedBlock" class="hidden section">
      <h2>Archived</h2>
      <div id="archivedList"></div>
    </div>

    <!-- Shortcuts section at bottom of main content -->
    <div class="shortcuts-section" id="shortcutsSection" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
      <div>
        <strong style="color:#475569">Shortcuts:</strong> ↑/↓ or J/K navigate • 1–5 status • <b>0</b> clear • N notes • A call • L message • <b>Shift+A/L</b> remove • <b>H</b> hot • <b>F</b> today • <b>D</b> tomorrow • <span style="opacity:0.7; font-weight:600">⌘/ for help</span>
      </div>
      <div style="display:flex; align-items:center; gap:16px; font-size:12px; color:#64748b;">
        <a href="#" onclick="showChangelogModal(); return false;" style="color:#3b82f6; text-decoration:none; hover:text-decoration:underline;">v<span id="versionNumber">1.0.0</span></a>
        <span style="color:#cbd5e1;">|</span>
        <a href="#" onclick="openSuggestEmail(); return false;" style="color:#3b82f6; text-decoration:none; hover:text-decoration:underline;">Suggest a change</a>
      </div>
    </div>
  </section>

  <!-- ===== SIDEBAR WIDGETS ===== -->
  <aside class="card sidebar" id="sidebarWidgets">
    <div class="widget" data-key="powerHour" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Power Hour</h2><div class="widget-actions"><button class="btn-min gray" id="hopReset">Reset</button></div></div>
      <div class="widget-body"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div><span id="hopClock" class="small muted">01:00:00</span></div><div class="small muted">Calls this session: <b id="hopCalls">0</b></div></div><div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center"><button class="btn-primary" id="hopStart">Start</button><button class="btn-min gray" id="hopPause">Pause</button></div></div>
    </div>

    <div class="widget" data-key="filters" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Filters</h2><div class="widget-actions"><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div style="display:grid;gap:6px">
        <label>Status
          <select id="statusFilter"><option value="">Any status</option><option>Sent Quote</option><option>Sent Application</option><option>Pending Application Signature</option><option>Pending Medical Questionnaire</option><option>Purchased</option></select>
        </label>
        <label><input id="showArchived" type="checkbox" /> Show archived</label>
        <label class="small"><input id="groupToggle" type="checkbox" /> Group today's activity by client</label>
        <label class="small">Aging threshold (business days)
          <select id="ageDays"><option>2</option><option selected>4</option><option>6</option><option>8</option></select>
        </label>
      </div></div>
    </div>

    <div class="widget" data-key="scheduled" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Scheduled</h2><div class="widget-actions"><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="followList" class="followups"></div></div>
    </div>

    <div class="widget" data-key="summaryReport" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Activity Chart</h2><div class="widget-actions"><select id="chartRangeSel" style="font-size:12px; padding:2px 4px; margin-right:8px;"><option value="7" selected>7d</option><option value="14">14d</option><option value="30">30d</option><option value="60">60d</option><option value="90">90d</option></select><button class="btn-min gray" id="emailSummaryBtn">Email</button><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body">
        <div id="chart" style="display:flex; align-items:flex-end; height:120px; gap:4px; padding:10px 0;"></div>
      </div>
    </div>

    <!-- Activity Chart widget removed but data preserved -->

    <div class="widget" data-key="heatmap" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Heatmap (90d)</h2><div class="widget-actions"><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="heatmap" class="heatmap"></div></div>
    </div>

    <div class="widget" data-key="kpis" draggable="true">
      <div class="widget-head"><h2 class="widget-title">KPIs</h2><div class="widget-actions"><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="kpis" class="kpis-widget"></div></div>
    </div>

    <div class="widget" data-key="pipeline" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Pipeline</h2><div class="widget-actions"><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="pipeline" class="small"></div></div>
    </div>

    <div class="widget" data-key="nextTouch" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Next to Touch</h2><div class="widget-actions"><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="nextList" class="nextlist"></div></div>
    </div>


    <div class="widget" data-key="todayActivity" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Today's Activity</h2><div class="widget-actions"><button class="btn-min gray" id="emailTodayDetailBtn">Email Today</button><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div class="small muted" id="todayDate"></div><div class="activity" id="activity"></div></div>
    </div>

    <div class="widget" data-key="motivation" draggable="true">
      <div class="widget-head"><h2 class="widget-title">Motivation</h2><div class="widget-actions"><button class="btn-min gray" id="quotesEditBtn">Edit quotes</button><button class="btn-min gray" id="quotesNextBtn">Next</button><button class="btn-min gray collapse-btn" data-collapse title="Collapse"></button></div></div>
      <div class="widget-body"><div id="quoteView" class="quote">Add quotes to get started.</div><div class="small muted" id="quoteMeta" style="margin-top:4px"></div><div id="quoteEditor" class="hidden" style="margin-top:8px"><div class="small muted" style="margin-bottom:4px">One quote per line. Blank lines ignored.</div><textarea id="quotesTextarea" style="width:100%;min-height:120px"></textarea><div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px"><div class="small muted">Rotate every <select id="quoteInterval"><option value="5">5</option><option value="10">10</option><option value="15" selected>15</option><option value="30">30</option><option value="60">60</option></select> min • <label><input type="checkbox" id="quoteRandom" checked> Shuffle</label> • <label><input type="checkbox" id="quoteNoRepeat" checked> Avoid repeats</label></div><div><button class="btn-primary" id="quotesSaveBtn">Save</button><button class="btn-min gray" id="quotesCancelBtn">Cancel</button></div></div></div></div>
    </div>
  </aside>
</div>

<!-- Part B goes right below -->
<!-- Part B — JS logic (save as part-b.js or inline under Part A) -->
<script>
(function(){
  /* =========================
   *  Version & Changelog
   * ========================= */
  var VERSION = '1.8.0';
  // Recent commits from git log
  var CHANGELOG = [
    { version: '1.8.0', date: '2025-01-16', changes: 'Implement IndexedDB persistent storage, fix celebration logic, add storage management tools' },
    { version: '1.7.2', date: '2025-01-16', changes: 'Redesign celebrations, fix header layout, and prevent duplicate goal celebrations' },
    { version: '1.7.1', date: '2025-01-16', changes: 'Fix service worker caching strategy and force cache refresh' },
    { version: '1.7.0', date: '2025-01-15', changes: 'Add epic purchase celebration with money rain and cha-ching sound' },
    { version: '1.6.0', date: '2025-01-15', changes: 'Fix purchase tracking with unique purchase dates and cancelable purchase chips' },
    { version: '1.5.0', date: '2025-01-15', changes: 'Fix blank changelog modal and add monthly Life apps purchased counter' },
    { version: '1.4.0', date: '2025-01-15', changes: 'Update PWA icon to flame emoji with reddish-orange theme' },
    { version: '1.3.1', date: '2025-01-15', changes: 'Convert Summary Report to Activity Chart and remove Today\'s Queue widget' }
  ];

  /* =========================
   *  Constants & helpers
   * ========================= */
  var STABLE_KEY='hotlistStable';
  var UI_KEY='hotlistUI';

  var STATUS=['Initial Contact','Sent Quote','Sent Application','Pending Application Signature','Pending Medical Questionnaire','Purchased'];
  var STATUS_ABBR={'Initial Contact':'Contact','Sent Quote':'Quoted','Sent Application':'App','Pending Application Signature':'SigPend','Pending Medical Questionnaire':'MedQ','Purchased':'Purchased'};
  var STATUS_ICON={'Initial Contact':'\uD83E\uDD1D','Sent Quote':'\uD83E\uDD7E','Sent Application':'\uD83D\uDCDD','Pending Application Signature':'\u270D\uFE0F','Pending Medical Questionnaire':'\uD83E\uDDEA','Purchased':'\u2705'};
  var EMOJI_CALL='\uD83D\uDCDE';
  var EMOJI_MSG ='\uD83D\uDCAC';
  var CLAP      ='\uD83D\uDC4F';

  function $(sel,root){ return (root||document).querySelector(sel); }
  function $all(sel,root){ return [].slice.call((root||document).querySelectorAll(sel)); }
  function nowISO(){ return new Date().toISOString(); }
  function startOfDay(d){ var x=new Date(d); x.setHours(0,0,0,0); return x; }
  function addDays(d,n){ var x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function isWithin(ts,start,end){ var t=new Date(ts); return t>=start && t<end; }
  function isToday(ts){ return new Date(ts).toDateString()===new Date().toDateString(); }
  function fmtDay(ts){ var d=new Date(ts); return (d.getMonth()+1)+'/'+d.getDate(); }
  function fmtTime(ts){ return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
  function last(arr){ return arr && arr.length ? arr[arr.length-1] : null; }
  function uid(){ return 'h_'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function escapeHtml(s){ s=String(s==null?'':s); return s.replace(/[&<>"']/g,function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]; }); }
  function businessDaysSince(ts){ var start=startOfDay(new Date(ts)), end=startOfDay(new Date()), days=0, d=new Date(start); for(; d<end; d.setDate(d.getDate()+1)){ var wd=d.getDay(); if(wd!==0 && wd!==6) days++; } return days; }
  function toLocalInputValue(iso){ if(!iso) return ''; var d=new Date(iso); var pad=function(n){return String(n).padStart(2,'0');}; return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes()); }
  function fromLocalInputValue(val){ if(!val) return ''; var d=new Date(val); if(isNaN(+d)) return ''; return d.toISOString(); }

  /* Elements */
  var els={
    appRoot:$('#appRoot'),
    list:$('#list'), archivedList:$('#archivedList'), archivedBlock:$('#archivedBlock'),
    kpis:$('#kpis'),
    globalSearch:$('#globalSearch'), sortBy:$('#sortBy'),
    statusFilter:$('#statusFilter'), showArchived:$('#showArchived'),
    ageDays:$('#ageDays'), groupToggle:$('#groupToggle'),
    emailSummaryBtn:$('#emailSummaryBtn'),
    chart:$('#chart'), chartRangeSel:$('#chartRangeSel'), heatmap:$('#heatmap'),
    todayDate:$('#todayDate'), activity:$('#activity'), emailTodayDetailBtn:$('#emailTodayDetailBtn'),
    hopStart:$('#hopStart'), hopPause:$('#hopPause'), hopReset:$('#hopReset'), hopClock:$('#hopClock'), hopCalls:$('#hopCalls'),
    pipeline:$('#pipeline'), nextList:$('#nextList'), followList:$('#followList'),
    quoteView:$('#quoteView'), quoteMeta:$('#quoteMeta'), quotesEditBtn:$('#quotesEditBtn'),
    quotesNextBtn:$('#quotesNextBtn'), quoteEditor:$('#quoteEditor'), quotesTextarea:$('#quotesTextarea'),
    quoteInterval:$('#quoteInterval'), quoteRandom:$('#quoteRandom'), quoteNoRepeat:$('#quoteNoRepeat'),
    quotesSaveBtn:$('#quotesSaveBtn'), quotesCancelBtn:$('#quotesCancelBtn'),
    sidebar:$('#sidebarWidgets'), leftSidebar:$('#leftSidebar'),
    leftDragZone:$('#leftDragZone'), rightDragZone:$('#rightDragZone'),
    tomorrowList:$('#tomorrowList'),
    ribbonPurchased:$('#ribbonPurchased'), ribbonWeeklyCalls:$('#ribbonWeeklyCalls'), ribbonStreak:$('#ribbonStreak'),
    dailyOutreachGoal:$('#dailyOutreachGoal'), dailyOutreachBar:$('#dailyOutreachBar'), 
    dailyOutreachFill:$('#dailyOutreachFill'), dailyOutreachLabel:$('#dailyOutreachLabel'),
    dailyCalls:$('#dailyCalls'), dailyMessages:$('#dailyMessages'), saveDailyGoal:$('#saveDailyGoal'),
    monthlyPurchases:$('#monthlyPurchases'),
    celebration:$('#celebration'), confettiContainer:$('#confettiContainer'),
    chachingSound:$('#chachingSound'),
    todayBlock:$('#todayBlock'), todayList:$('#todayList'),
    scheduledBlock:$('#scheduledBlock'), scheduledList:$('#scheduledList'),
    densitySelect:$('#densitySelect'),
    toggleSidebarBtn:$('#toggleSidebarBtn'),
    importBtn:$('#importBtn'), exportBtn:$('#exportBtn'), loadDemoBtn:$('#loadDemoBtn'),
    sidebarControls:$('#sidebar-controls'),
    emptyState:$('#emptyState'), mainTableHead:$('#mainTableHead'), clearDemoSection:$('#clearDemoSection')
  };

  /* IndexedDB Storage Module */
  var storageDB = null;
  var DB_NAME = 'HotlistDB';
  var DB_VERSION = 1;
  var STORE_NAME = 'appData';

  async function requestPersistentStorage() {
    if ('storage' in navigator && 'persist' in navigator.storage) {
      try {
        const persistent = await navigator.storage.persist();
        console.log('Persistent storage:', persistent ? 'granted' : 'denied');
        return persistent;
      } catch (e) {
        console.warn('Could not request persistent storage:', e);
        return false;
      }
    }
    return false;
  }

  async function getStorageInfo() {
    const info = {
      persistent: false,
      quota: 0,
      usage: 0
    };

    if ('storage' in navigator) {
      try {
        if ('persisted' in navigator.storage) {
          info.persistent = await navigator.storage.persisted();
        }
        if ('estimate' in navigator.storage) {
          const estimate = await navigator.storage.estimate();
          info.quota = estimate.quota || 0;
          info.usage = estimate.usage || 0;
        }
      } catch (e) {
        console.warn('Could not get storage info:', e);
      }
    }

    return info;
  }

  function initDB() {
    return new Promise(async function(resolve, reject) {
      if (!window.indexedDB) {
        console.log('IndexedDB not supported, falling back to localStorage');
        resolve(null);
        return;
      }

      // Request persistent storage to prevent data loss during cache clearing
      await requestPersistentStorage();

      var request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onerror = function() {
        console.error('Failed to open IndexedDB:', request.error);
        resolve(null);
      };

      request.onsuccess = function() {
        storageDB = request.result;
        console.log('IndexedDB initialized successfully');

        // Handle database closing unexpectedly
        storageDB.onclose = function() {
          console.warn('IndexedDB connection closed unexpectedly');
          storageDB = null;
        };

        storageDB.onerror = function(event) {
          console.error('IndexedDB error:', event);
        };

        storageDB.onabort = function(event) {
          console.error('IndexedDB transaction aborted:', event);
        };

        resolve(storageDB);
      };

      request.onupgradeneeded = function(event) {
        var db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME);
        }
      };
    });
  }

  function saveToIndexedDB(key, data) {
    return new Promise(function(resolve, reject) {
      // Re-open database if needed
      if (!storageDB) {
        initDB().then(function(db) {
          if (!db) {
            reject(new Error('IndexedDB not available'));
            return;
          }
          performSave();
        });
      } else {
        performSave();
      }

      function performSave() {
        try {
          var transaction = storageDB.transaction([STORE_NAME], 'readwrite');
          var store = transaction.objectStore(STORE_NAME);
          var request = store.put(data, key);

          request.onsuccess = function() {
            console.log('Data saved to IndexedDB successfully');
            resolve();
          };

          request.onerror = function() {
            console.error('Failed to save to IndexedDB:', request.error);
            reject(request.error);
          };

          transaction.oncomplete = function() {
            console.log('IndexedDB transaction completed');
          };

          transaction.onerror = function() {
            console.error('IndexedDB transaction error:', transaction.error);
            reject(transaction.error);
          };
        } catch (e) {
          console.error('Error during IndexedDB save:', e);
          reject(e);
        }
      }
    });
  }

  function loadFromIndexedDB(key) {
    return new Promise(function(resolve, reject) {
      // Re-open database if needed
      if (!storageDB) {
        initDB().then(function(db) {
          if (!db) {
            reject(new Error('IndexedDB not available'));
            return;
          }
          performLoad();
        });
      } else {
        performLoad();
      }

      function performLoad() {
        try {
          var transaction = storageDB.transaction([STORE_NAME], 'readonly');
          var store = transaction.objectStore(STORE_NAME);
          var request = store.get(key);

          request.onsuccess = function() {
            console.log('Data loaded from IndexedDB:', key, request.result ? 'found' : 'not found');
            resolve(request.result);
          };

          request.onerror = function() {
            console.error('Failed to load from IndexedDB:', request.error);
            reject(request.error);
          };
        } catch (e) {
          console.error('Error during IndexedDB load:', e);
          reject(e);
        }
      }
    });
  }

  /* UI state with IndexedDB support */
  function loadUI() {
    if (storageDB) {
      return loadFromIndexedDB(UI_KEY).then(function(data) {
        if (data) {
          try {
            return JSON.parse(data);
          } catch(e) {
            console.error('Failed to parse IndexedDB UI data:', e);
          }
        }
        return loadUIFromLocalStorage();
      }).catch(function(e) {
        console.error('IndexedDB UI load failed:', e);
        return loadUIFromLocalStorage();
      });
    }
    return loadUIFromLocalStorage();
  }

  function loadUIFromLocalStorage() {
    try {
      return JSON.parse(localStorage.getItem(UI_KEY) || '{}');
    } catch(e) {
      return {};
    }
  }

  function saveUI(u) {
    var dataStr = JSON.stringify(u);

    // Always save to localStorage first (synchronous, immediate)
    localStorage.setItem(UI_KEY, dataStr);

    // Then attempt to save to IndexedDB (asynchronous)
    saveToIndexedDB(UI_KEY, dataStr).then(function() {
      console.log('Successfully saved UI to IndexedDB');
    }).catch(function(e) {
      console.error('Failed to save UI to IndexedDB, but localStorage save succeeded:', e);
      // Try to reinitialize DB for next save
      storageDB = null;
    });
  }
  var ui = {};
  var uiReady = Promise.resolve().then(function() {
    var result = loadUI();
    if (result && result.then) {
      return result.then(function(loadedUI) {
        ui = loadedUI || {};
        return ui;
      });
    }
    ui = result || {};
    return ui;
  });

  /* Daily queue rotation */
  function rotateDailyQueues(){
    if(!state || !state.clients) return;

    var today = new Date().toDateString();
    var lastRotation = ui.lastQueueRotation || '';

    if(lastRotation !== today){
      // It's a new day, rotate queues
      var rotated = false;
      state.clients.forEach(function(c){
        if(c.queueTomorrow){
          c.queueToday = true;
          c.queueTomorrow = false;
          rotated = true;
        }
      });

      if(rotated){
        save(state);
      }

      // Save today's date as last rotation
      ui.lastQueueRotation = today;
      saveUI(ui);
    }
  }

  function getAgeThreshold(){
    var v = (ui.ageDays!=null) ? Number(ui.ageDays) : Number((els.ageDays && els.ageDays.value) || 4);
    return isFinite(v) ? v : 4;
  }

  /* Migrate existing localStorage data to IndexedDB */
  function migrateData() {
    if (!storageDB) return Promise.resolve();

    return new Promise(function(resolve) {
      var promises = [];

      var mainData = localStorage.getItem(STABLE_KEY);
      if (mainData) {
        promises.push(saveToIndexedDB(STABLE_KEY, mainData).catch(function(e) {
          console.error('Failed to migrate main data:', e);
        }));
      }

      var uiData = localStorage.getItem(UI_KEY);
      if (uiData) {
        promises.push(saveToIndexedDB(UI_KEY, uiData).catch(function(e) {
          console.error('Failed to migrate UI data:', e);
        }));
      }

      Promise.all(promises).then(function() {
        console.log('Data migration completed');
        resolve();
      });
    });
  }

  /* Stable state */
  function coerceState(x){ var out={clients:[], quotes:{raw:'', list:[]}, quotesSettings:{interval:15, random:true, norepeat:true, recent:[]} }; if(!x) return out; if(Array.isArray(x)){ out.clients=x; return normalize(out); } if(typeof x==='object'){ if(Array.isArray(x.clients)) out.clients=x.clients; if(x.quotes) out.quotes=x.quotes; if(x.quotesSettings) out.quotesSettings=x.quotesSettings; return normalize(out);} return out; }
  function normalize(state){ state.clients=(state.clients||[]).map(function(c){ return { id:c.id||uid(), name:c.name||'(Unnamed)', notes:(typeof c.notes==='string'?c.notes:''), status:c.status||'', purchaseDate:(typeof c.purchaseDate==='string'?c.purchaseDate:''), lastTouch:c.lastTouch||nowISO(), createdAt:c.createdAt||c.lastTouch||nowISO(), archived:!!c.archived, followUp:(typeof c.followUp==='string'?c.followUp:''), callCount:(isFinite(c.callCount)?c.callCount:0), msgCount:(isFinite(c.msgCount)?c.msgCount:0), queueToday:!!c.queueToday, queueTomorrow:!!c.queueTomorrow, hot:!!c.hot, history:Array.isArray(c.history)? c.history.filter(Boolean).map(function(h){ return {id:(h.id||uid()), ts:(h.ts||nowISO()), action:(h.action||'status'), to:(h.to!=null?h.to:''), kind:(h.kind!=null?h.kind:'')}; }) : [] }; }); state.quotes = state.quotes || {raw:'', list:[]}; if(!Array.isArray(state.quotes.list)) state.quotes.list=[]; state.quotesSettings = state.quotesSettings || {interval:15, random:true, norepeat:true, recent:[]}; if(!Array.isArray(state.quotesSettings.recent)) state.quotesSettings.recent=[]; return state; }

  /* Enhanced load/save with IndexedDB and localStorage fallback */
  function load() {
    if (storageDB) {
      return loadFromIndexedDB(STABLE_KEY).then(function(data) {
        if (data) {
          try {
            return coerceState(JSON.parse(data));
          } catch(e) {
            console.error('Failed to parse IndexedDB data:', e);
          }
        }
        return loadFromLocalStorage();
      }).catch(function(e) {
        console.error('IndexedDB load failed, using localStorage:', e);
        return loadFromLocalStorage();
      });
    }
    return loadFromLocalStorage();
  }

  function loadFromLocalStorage() {
    try {
      var cur = JSON.parse(localStorage.getItem(STABLE_KEY) || 'null');
      if (cur) return coerceState(cur);
    } catch(e) {
      console.error('Failed to load from localStorage:', e);
    }
    var fresh = {clients:[], quotes:{raw:'', list:[]}, quotesSettings:{interval:15, random:true, norepeat:true, recent:[]}};
    localStorage.setItem(STABLE_KEY, JSON.stringify(fresh));
    return fresh;
  }

  function save(data) {
    var dataStr = JSON.stringify(data);

    // Always save to localStorage first (synchronous, immediate)
    localStorage.setItem(STABLE_KEY, dataStr);

    // Then attempt to save to IndexedDB (asynchronous)
    saveToIndexedDB(STABLE_KEY, dataStr).then(function() {
      console.log('Successfully saved to IndexedDB');
    }).catch(function(e) {
      console.error('Failed to save to IndexedDB, but localStorage save succeeded:', e);
      // Try to reinitialize DB for next save
      storageDB = null;
    });
  }
  /* Initialize storage and load state */
  var state = {clients:[], quotes:{raw:'', list:[]}, quotesSettings:{interval:15, random:true, norepeat:true, recent:[]}}; // Default state to prevent null errors
  var storageReady = initDB().then(function() {
    return migrateData();
  }).then(function() {
    var result = load();
    if (result && result.then) {
      return result.then(function(loadedState) {
        state = loadedState || state;
        return state;
      });
    }
    state = result || state;
    return state;
  }).catch(function(e) {
    console.error('Storage initialization failed:', e);
    state = loadFromLocalStorage() || state;
    return state;
  });

  /* Error banner */
  window.addEventListener('error', function(e){ var b=$('#errorBanner'); if(!b) return; b.style.display='block'; var msg=(e && e.error && e.error.message) ? e.error.message : (e && e.message ? e.message : 'unknown error'); b.textContent='Script error: '+msg; });

  /* Undo (simple) */
  var undoStack=[]; function withUndo(mut){ var snap=JSON.stringify(state); mut(); undoStack.push(snap); if(undoStack.length>50) undoStack.shift(); }

  /* UI-preserving render */
  function preserveUIAndRender(mutator){
    var prevDocY=window.scrollY, prevActY=els.activity?els.activity.scrollTop:0;
    var sel=getSelectedClient(); var selId=sel?sel.id:null;
    if(mutator) withUndo(mutator);
    save(state); render();
    if(selId) setSelectedRowById(selId);
    window.scrollTo(0,prevDocY); if(els.activity) els.activity.scrollTop=prevActY;
  }

  /* CRUD / actions */
  function addClient(name){ preserveUIAndRender(function(){ state.clients.push({id:uid(), name:name, notes:'', status:'', lastTouch:nowISO(), createdAt:nowISO(), archived:false, followUp:'', callCount:0, msgCount:0, queueToday:false, queueTomorrow:false, hot:false, history:[]}); }); }
  function setStatus(c,newStatus,buttonElement){
    var wasPurchased = c.status === 'Purchased';
    var oldStatus = c.status;

    // Only update if status is actually changing
    if(oldStatus === newStatus) {
      // Check if we already have this status recorded today
      var today = new Date().toDateString();
      var alreadyRecordedToday = (c.history || []).some(function(h) {
        if(h.action === 'status' && h.to === newStatus) {
          var histDate = new Date(h.ts).toDateString();
          return histDate === today;
        }
        return false;
      });

      if(alreadyRecordedToday) {
        console.log('Status already recorded today, skipping duplicate entry');
        return;
      }
    }

    preserveUIAndRender(function(){
      var when=nowISO();
      c.status=newStatus;
      c.lastTouch=when;
      c.history.push({id:uid(), ts:when, action:'status', to:newStatus});
      if(c.queueToday) c.queueToday=false;
      // Set purchase date when status becomes Purchased
      if(newStatus === 'Purchased' && !c.purchaseDate){
        c.purchaseDate = when;
      }
    });
    // Trigger epic purchase celebration!
    if(newStatus === 'Purchased' && !wasPurchased){
      setTimeout(function(){
        startPurchaseCelebration(buttonElement);
      }, 100);
    }
  }
  function clearStatus(c){ preserveUIAndRender(function(){ c.status=''; if(c.purchaseDate) delete c.purchaseDate; }); }
  function clearPurchase(c){ preserveUIAndRender(function(){ if(c.status === 'Purchased') c.status=''; if(c.purchaseDate) delete c.purchaseDate; }); }
  function incrementCall(c){
    preserveUIAndRender(function(){
      c.callCount=(c.callCount||0)+1;
      c.lastTouch=nowISO();
      c.history.push({id:uid(), ts:nowISO(), action:'status', to:'Called'});
      if(c.queueToday) c.queueToday=false;
    });
    // Update Power Hour call counter if timer is running
    if(hopRunning){
      hopCallCount++;
      updateHopCalls(hopCallCount);
    }
  }
  function decrementCall(c){
    preserveUIAndRender(function(){
      c.callCount=Math.max(0,(c.callCount||0)-1);
    });
    // Update Power Hour call counter if timer is running
    if(hopRunning && hopCallCount > 0){
      hopCallCount--;
      updateHopCalls(hopCallCount);
    }
  }
  function incrementMsg(c){ preserveUIAndRender(function(){ c.msgCount=(c.msgCount||0)+1; c.lastTouch=nowISO(); c.history.push({id:uid(), ts:nowISO(), action:'status', to:'Emailed'}); if(c.queueToday) c.queueToday=false; }); }
  function decrementMsg(c){ preserveUIAndRender(function(){ c.msgCount=Math.max(0,(c.msgCount||0)-1); }); }
  function updateNotes(c,notes){ c.notes=notes; save(state); }
  function archiveClient(c,flag){ preserveUIAndRender(function(){ c.archived=!!flag; }); }
  function deleteClient(c){ if(!confirm('Delete '+c.name+'?')) return; preserveUIAndRender(function(){ state.clients=state.clients.filter(function(x){return x.id!==c.id;}); }); }
  function toggleQueueToday(c,val){ preserveUIAndRender(function(){ c.queueToday = (typeof val==='boolean') ? val : !c.queueToday; if(c.queueToday) c.queueTomorrow=false; }); }
  function toggleQueueTomorrow(c,val){ preserveUIAndRender(function(){ c.queueTomorrow = (typeof val==='boolean') ? val : !c.queueTomorrow; if(c.queueTomorrow) c.queueToday=false; }); }

  /* Follow-up picker */
  var hiddenFollowPicker=document.createElement('input'); hiddenFollowPicker.type='datetime-local'; hiddenFollowPicker.className='hidden'; document.body.appendChild(hiddenFollowPicker); var followTargetClient=null;
  function setFollowUpViaPicker(c){ followTargetClient=c; var d=c.followUp? new Date(c.followUp) : (function(){ var s=new Date(); s.setDate(s.getDate()+1); s.setHours(8,0,0,0); return s; })(); hiddenFollowPicker.value=toLocalInputValue(d.toISOString()); if(typeof hiddenFollowPicker.showPicker==='function'){ try{ hiddenFollowPicker.showPicker(); return; }catch(e){} } try{ hiddenFollowPicker.focus(); hiddenFollowPicker.click(); return; }catch(e){} var cur=hiddenFollowPicker.value.replace('T',' '); var val=prompt('Follow-up (YYYY-MM-DD HH:MM). Blank to clear:', cur); if(val===null) return; var norm=String(val).trim(); if(!norm){ c.followUp=''; save(state); render(); return; } var iso=new Date(norm.replace(' ','T')); if(isNaN(+iso)){ alert('Invalid date/time'); return; } c.followUp=iso.toISOString(); save(state); render(); }
  hiddenFollowPicker.addEventListener('change', function(){ if(!followTargetClient) return; var iso=fromLocalInputValue(hiddenFollowPicker.value); followTargetClient.followUp=iso; save(state); render(); followTargetClient=null; });

  /* KPIs / ribbons / pipeline / goals */
  function computeKPIs(){ if(!state || !state.clients) return {total:0, touchedToday:0, purchased:0, contacted:0, convRate:0, avgCalls:'—'}; var active=state.clients.filter(function(c){return !c.archived;}); var touchedToday=active.filter(function(c){return isToday(c.lastTouch);}); var purchased=state.clients.filter(function(c){return c.status==='Purchased';}); var contacted=state.clients.filter(function(c){return (c.history||[]).length>0 && c.status!=='Purchased';}); var perClient=state.clients.map(function(c){ var fp=(c.history||[]).find(function(h){return h.action==='status' && h.to==='Purchased';}); var firstPur = fp ? fp.ts : null; if(!firstPur) return null; var calls=(c.history||[]).filter(function(h){ return h.action==='status' && h.to==='Called' && new Date(h.ts)<=new Date(firstPur); }).length; return calls; }).filter(function(v){return v!==null;}); var avgCalls = perClient.length ? (perClient.reduce(function(a,b){return a+b;},0)/perClient.length).toFixed(1) : '—'; return {total:active.length, touchedToday:touchedToday.length, purchased:purchased.length, contacted:contacted.length, convRate:(contacted.length? Math.round((purchased.length/Math.max(contacted.length,1))*100) : 0), avgCalls:avgCalls}; }
  function renderKPIs(){ 
    var k=computeKPIs(); 
    if(!els.kpis) return;
    els.kpis.innerHTML=''; 
    [['Active Leads',k.total],['Touched Today',k.touchedToday],['Purchased',k.purchased],['Contacted (not purchased)',k.contacted],['Conv. Rate',(k.convRate||0)+'%'],['Avg Calls→Purchase',k.avgCalls]].forEach(function(pair){ 
      var row=document.createElement('div'); 
      row.className='kpi-row'; 
      row.innerHTML='<span class="kpi-label">'+pair[0]+'</span><span class="kpi-value">'+pair[1]+'</span>'; 
      els.kpis.appendChild(row); 
    }); 
  }
  function pipelineStats(){ var counts={Calls:0,Emails:0,Quotes:0,Apps:0,Purchased:0}; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action!=='status') return; if(h.to==='Called') counts.Calls++; else if(h.to==='Emailed') counts.Emails++; else if(h.to==='Sent Quote') counts.Quotes++; else if(h.to==='Sent Application') counts.Apps++; else if(h.to==='Purchased') counts.Purchased++; }); }); function conv(a,b){ return a? Math.round((b/a)*100) : 0; } return {counts:counts, convCE:conv(counts.Calls,counts.Emails), convEQ:conv(counts.Emails,counts.Quotes), convQA:conv(counts.Quotes,counts.Apps), convAP:conv(counts.Apps,counts.Purchased)}; }
  function renderPipeline(){ var p=pipelineStats(); els.pipeline.innerHTML = '' +'<div>Calls: <b>'+p.counts.Calls+'</b> → Emails: <b>'+p.counts.Emails+'</b> (<b>'+p.convCE+'%</b>)</div>' +'<div>Emails: <b>'+p.counts.Emails+'</b> → Quotes: <b>'+p.counts.Quotes+'</b> (<b>'+p.convEQ+'%</b>)</div>' +'<div>Quotes: <b>'+p.counts.Quotes+'</b> → Apps: <b>'+p.counts.Apps+'</b> (<b>'+p.convQA+'%</b>)</div>' +'<div>Apps: <b>'+p.counts.Apps+'</b> → Purchased: <b>'+p.counts.Purchased+'</b> (<b>'+p.convAP+'%</b>)</div>'; }
  function weekRange(){ var end=startOfDay(new Date()), start=addDays(end,-6); return {start:start, end:addDays(end,1)}; }
  function weeklyCalls(){ var r=weekRange(), cnt=0; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action==='status' && h.to==='Called' && isWithin(h.ts,r.start,r.end)) cnt++; }); }); return cnt; }
  /* Goals widget removed - functionality now in daily outreach bar */
  function touchesOnDay(day){ var start=startOfDay(day), end=addDays(start,1), cnt=0; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action==='status'){ var t=new Date(h.ts); if(t>=start && t<end) cnt++; }}); }); return cnt; }
  function calcStreak(minPerDay){ var min=(typeof minPerDay==='number'?minPerDay:1), streak=0; for(var i=0;i<365;i++){ var day=addDays(new Date(), -i); if(touchesOnDay(day) >= min) streak++; else break; } return streak; }
  // Keep collecting KPI data for email summaries
  function getKPIData(){
    return {
      purchased: (state && state.clients) ? state.clients.filter(function(c){return c.status==='Purchased';}).length : 0,
      weeklyCalls: weeklyCalls(),
      streak: calcStreak(1)
    };
  }
  function renderTrendRibbons(){
    // Data collection continues but no UI update needed
    getKPIData();
  }
  
  /* Goal Achievement Celebration */
  var celebrationActive = false;
  var lastGoalState = false; // Track if goal was achieved in last render
  
  function createConfetti(){
    if(!els.confettiContainer) return;
    for(var i = 0; i < 50; i++){
      var confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.animationDelay = Math.random() * 3 + 's';
      confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
      els.confettiContainer.appendChild(confetti);
    }
  }
  
  function startCelebration(){
    if(celebrationActive || !els.celebration) return;
    celebrationActive = true;
    
    // Show celebration
    els.celebration.classList.remove('hidden');
    
    // Create confetti
    createConfetti();
    
    // Auto-hide after 4 seconds
    setTimeout(function(){
      stopCelebration();
    }, 4000);
  }
  
  function stopCelebration(){
    if(!celebrationActive || !els.celebration) return;
    celebrationActive = false;

    // Hide celebration
    els.celebration.classList.add('hidden');

    // Clean up confetti
    if(els.confettiContainer) els.confettiContainer.innerHTML = '';
  }

  /* Purchase Celebration - Dollar Explosion */
  function startPurchaseCelebration(buttonElement){
    // Play cash register sound
    if(els.chachingSound) {
      try {
        els.chachingSound.play();
      } catch(e) {
        console.log('Audio playback failed:', e);
      }
    }

    // Create dollar explosion from button
    if(!buttonElement) return;

    var rect = buttonElement.getBoundingClientRect();
    var centerX = rect.left + rect.width / 2;
    var centerY = rect.top + rect.height / 2;

    // Create container for particles
    var container = document.createElement('div');
    container.className = 'dollar-explosion';
    container.style.left = centerX + 'px';
    container.style.top = centerY + 'px';
    document.body.appendChild(container);

    // Create dollar particles
    var dollarSymbols = ['$', '💵', '💰', '💸', '💲'];
    for(var i = 0; i < 12; i++){
      var particle = document.createElement('div');
      particle.className = 'dollar-particle';
      particle.textContent = dollarSymbols[Math.floor(Math.random() * dollarSymbols.length)];

      // Random explosion direction
      var angle = (Math.PI * 2 * i) / 12 + (Math.random() - 0.5) * 0.5;
      var distance = 80 + Math.random() * 120;
      var dx = Math.cos(angle) * distance;
      var dy = Math.sin(angle) * distance - 50; // Bias upward

      particle.style.setProperty('--dx', dx + 'px');
      particle.style.setProperty('--dy', dy + 'px');
      particle.style.animationDelay = Math.random() * 0.2 + 's';

      container.appendChild(particle);
    }

    // Clean up after animation
    setTimeout(function(){
      container.remove();
    }, 2000);
  }
  
  /* Daily Outreach Goal */
  function getDailyOutreachCounts(){
    // Use local date, not UTC
    var todayStart = new Date();
    todayStart.setHours(0,0,0,0);
    var todayEnd = new Date();
    todayEnd.setHours(23,59,59,999);

    var calls = 0, messages = 0;
    if(state && state.clients) state.clients.forEach(function(c){
      if(c.history){
        c.history.forEach(function(h){
          if(!h.ts) return;
          var hTime = new Date(h.ts);
          // Check if the history entry is from today (in local time)
          if(hTime >= todayStart && hTime <= todayEnd){
            if(h.to === 'Called' || h.action === 'call') calls++;
            else if(h.to === 'Emailed' || h.action === 'message') messages++;
          }
        });
      }
    });
    return {calls: calls, messages: messages, total: calls + messages};
  }
  
  function getOutreachCountForDate(date){
    var start = new Date(date);
    start.setHours(0,0,0,0);
    var end = new Date(date);
    end.setHours(23,59,59,999);
    
    var count = 0;
    state.clients.forEach(function(c){
      (c.history||[]).forEach(function(h){
        if(h.action === 'status'){
          var hDate = new Date(h.ts);
          if(hDate >= start && hDate <= end){
            if(h.to === 'Called' || h.to === 'Messaged' || h.to === 'Emailed') count++;
          }
        }
      });
    });
    return count;
  }

  function getMonthlyPurchases(){
    var now = new Date();
    var startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    var endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    var count = 0;

    if(state && state.clients) state.clients.forEach(function(c){
      if(c.status === 'Purchased' && c.purchaseDate){
        var purchaseDate = new Date(c.purchaseDate);
        if(purchaseDate >= startOfMonth && purchaseDate < endOfMonth){
          count++;
        }
      }
    });
    return count;
  }

  function renderDailyOutreach(){
    if(!els.dailyOutreachGoal || !els.dailyOutreachBar) return;
    var goal = Number(ui.dailyOutreachGoal || 10);
    var counts = getDailyOutreachCounts();
    var progress = Math.min(100, (counts.total / goal) * 100);
    var goalAchieved = counts.total >= goal && goal > 0;
    var today = new Date().toDateString();

    if(els.dailyOutreachFill) els.dailyOutreachFill.style.width = progress + '%';
    if(els.dailyOutreachLabel) els.dailyOutreachLabel.textContent = counts.total + ' / ' + goal;
    if(els.dailyCalls) els.dailyCalls.textContent = String(counts.calls);
    if(els.dailyMessages) els.dailyMessages.textContent = String(counts.messages);

    // Update monthly purchases
    if(els.monthlyPurchases){
      els.monthlyPurchases.textContent = String(getMonthlyPurchases());
    }

    // Update goal input if it exists
    if(els.dailyOutreachGoal && document.activeElement !== els.dailyOutreachGoal) {
      els.dailyOutreachGoal.value = String(goal);
    }

    // Check if it's a new day - reset celebration tracking
    var isNewDay = ui.lastCelebrationDate !== today;
    if(isNewDay){
      ui.lastCelebrationGoal = 0; // Reset the celebrated goal level
      ui.lastCelebrationDate = today;
      // For a new day, reset the count to 0 to track fresh
      ui.lastOutreachCount = 0;
      // If there are already activities today (from before page load), update the count
      if(counts.total > 0){
        // If goal is already achieved on first load of the day, mark as celebrated
        if(goalAchieved){
          ui.lastCelebrationGoal = goal;
        }
        // Update count after checking celebration status
        ui.lastOutreachCount = counts.total;
      }
      saveUI(ui);
    }

    // Check if goal has been increased since last celebration
    var lastCelebratedGoal = ui.lastCelebrationGoal || 0;
    var goalIncreased = goal > lastCelebratedGoal;

    // Only trigger celebration when:
    // 1. Goal is achieved
    // 2. Either:
    //    a) Haven't celebrated at this goal level yet (goal was increased), OR
    //    b) Count dropped below goal and came back up (undo scenario)
    // 3. Count has actually changed (not just page refresh)
    // 4. We just crossed the threshold
    var previousCount = ui.lastOutreachCount || 0;
    var countChanged = counts.total !== previousCount;
    var justCrossedThreshold = previousCount < goal && counts.total >= goal;
    var shouldCelebrate = false;

    if(goalAchieved && countChanged){
      // Celebrate if we crossed the threshold (either from below or goal was raised)
      if(justCrossedThreshold){
        shouldCelebrate = true;
      }
      // Also celebrate if goal was increased and we're already past the new goal
      else if(goalIncreased && counts.total >= goal){
        shouldCelebrate = true;
      }
    }

    if(shouldCelebrate){
      startCelebration();
      ui.lastCelebrationGoal = goal; // Remember the goal level we celebrated at
      saveUI(ui);
    }

    // Update stored count
    if(counts.total !== previousCount){
      ui.lastOutreachCount = counts.total;
      saveUI(ui);
    }

    lastGoalState = goalAchieved;
  }
  
  if(els.saveDailyGoal){
    els.saveDailyGoal.addEventListener('click', function(){
      var oldGoal = ui.dailyOutreachGoal || 10;
      var newGoal = Number(els.dailyOutreachGoal.value || 10);
      ui.dailyOutreachGoal = newGoal;

      // If goal was decreased below the celebration level, reset celebration tracker
      if(newGoal < oldGoal && ui.lastCelebrationGoal > newGoal){
        ui.lastCelebrationGoal = Math.min(ui.lastCelebrationGoal, newGoal);
      }

      saveUI(ui);
      renderDailyOutreach();
    });
  }

  function colorClass(st){ return st==='Initial Contact'?'s-contact' : st==='Sent Quote'?'s-quote' : st==='Sent Application'?'s-app' : st==='Pending Application Signature'?'s-sig' : st==='Pending Medical Questionnaire'?'s-medq' : 's-pur'; }

  /* Render Status Progress Tracker */
  function renderStatusTracker(clientOrStatus, clientObj){
    var tracker = document.createElement('div');
    var currentDensity = document.body.getAttribute('data-density');
    var uiDensity = ui.density;
    var isUltraCompact = currentDensity === 'ultra-compact' || uiDensity === 'ultra-compact';

    console.log('renderStatusTracker - body density:', currentDensity, 'ui density:', uiDensity, 'isUltraCompact:', isUltraCompact);

    tracker.className = isUltraCompact ? 'status-tracker' : 'status-tracker compact';

    // Handle both client object and status string, with null checks
    var currentStatus = null;
    var client = null;

    if(typeof clientOrStatus === 'string'){
      currentStatus = clientOrStatus;
      client = clientObj;
    } else if(clientOrStatus){
      currentStatus = clientOrStatus.status;
      client = clientOrStatus;
    } else {
      currentStatus = null;
      client = clientObj;
    }

    // Determine which stage is active/completed
    var currentStatusIndex = STATUS.indexOf(currentStatus);

    // Set progress level for the green line (0-5 based on status index)
    // Line should go TO the active status, not past it
    if(currentStatusIndex >= 0){
      tracker.setAttribute('data-progress', currentStatusIndex);
    } else {
      tracker.setAttribute('data-progress', '-1');
    }

    STATUS.forEach(function(status, index){
      var stage = document.createElement('div');
      stage.className = 'stage';

      // Set completed/active state
      if(currentStatusIndex >= 0){
        if(index < currentStatusIndex){
          stage.classList.add('completed');
        } else if(index === currentStatusIndex){
          stage.classList.add('active');
          // Add purchased class if this is the purchased status
          if(status === 'Purchased'){
            stage.classList.add('purchased');
          }
        }
      }

      var icon = document.createElement('div');
      icon.className = 'stage-icon';
      icon.textContent = STATUS_ICON[status] || '•';
      icon.title = status; // Tooltip

      // Make clickable to set status (only if we have a client object)
      if(client && client.id){
        icon.addEventListener('click', function(e){
          e.stopPropagation();
          setStatus(client, status);
        });
      }

      var label = document.createElement('div');
      label.className = 'stage-label';
      label.textContent = STATUS_ABBR[status] || status;

      stage.appendChild(icon);
      stage.appendChild(label);
      tracker.appendChild(stage);
    });

    return tracker;
  }
  function agingBadge(businessDays, thr){ var span=document.createElement('span'); var clr= businessDays > thr*2 ? 'red' : (businessDays > thr ? 'orange' : ''); span.className='age-badge'+(clr?(' '+clr):''); if(!clr){ span.style.display='none'; } span.textContent=String(businessDays); return span; }
  function contactedToday(c){ var start=startOfDay(new Date()), end=addDays(start,1); return (c.history||[]).some(function(h){ return h.action==='status' && isWithin(h.ts,start,end); }); }

  /* Tooltips */
  function setTip(el, text){ el.classList.add('has-tip'); el.setAttribute('data-tip', text); }

  /* Action icon group */
  function buildIconBar(c, notesWrap, ta){
    var bar=document.createElement('div'); bar.className='group--icons';
    function icon(label,key,tip){ var b=document.createElement('button'); b.className='iconbtn'; b.dataset.act=key; b.textContent=label; setTip(b, tip); return b; }
    var bNotes=icon('📝','notes','Notes'), bSched=icon('📅','schedule','Schedule'), bArch=icon('📂','archive','Archive'), bDel=icon('🗑','delete','Delete');
    bar.appendChild(bNotes); bar.appendChild(bSched); bar.appendChild(bArch); bar.appendChild(bDel);
    bNotes.addEventListener('click', function(){ notesWrap.classList.toggle('hidden'); if(!notesWrap.classList.contains('hidden')) ta.focus(); });
    bArch.addEventListener('click', function(){ archiveClient(c,!c.archived); });
    bDel.addEventListener('click', function(){ deleteClient(c); });
    bSched.addEventListener('click', function(e){ openScheduleMenu(e.currentTarget, c); });
    return bar;
  }

  function openScheduleMenu(anchorBtn, c){
    closeMenus();
    var menu=document.createElement('div'); menu.className='sched-menu';
    var rect=anchorBtn.getBoundingClientRect(); menu.style.top=(rect.bottom+window.scrollY)+'px'; menu.style.left=(rect.left+window.scrollX)+'px';
    menu.innerHTML=['<button data-m="today">Today</button>','<button data-m="tomorrow">Tomorrow</button>','<button data-m="pick">Pick Date/Time…</button>','<div style="border-top:1px solid var(--line);margin:4px 0"></div>','<button data-m="clear-fu">Clear Follow-Up</button>','<button data-m="clear-queues">Clear Today/Tomorrow</button>'].join('');
    document.body.appendChild(menu);
    menu.addEventListener('click', function(e){ var m=e.target.closest('button') && e.target.closest('button').dataset.m; if(m==='today'){ toggleQueueToday(c,true); } if(m==='tomorrow'){ toggleQueueTomorrow(c,true); } if(m==='pick'){ setFollowUpViaPicker(c); } if(m==='clear-fu'){ c.followUp=''; save(state); render(); } if(m==='clear-queues'){ c.queueToday=false; c.queueTomorrow=false; save(state); render(); } closeMenus(); });
    setTimeout(function(){ var kill=function(ev){ if(!menu.contains(ev.target)){ closeMenus(); document.removeEventListener('mousedown',kill,true);} }; document.addEventListener('mousedown',kill,true); },0);
  }
  function closeMenus(){ $all('.sched-menu').forEach(function(n){ n.parentNode.removeChild(n); }); }

  /* Build row */
  function buildRow(c, opts){
    opts=opts||{};
    var thr=getAgeThreshold();

    var row=document.createElement('div'); row.className='row '+(c.status==='Purchased'?'purchased':''); row.dataset.id=c.id;
    /* Untouched class no longer needed - using green dot instead */
    row.addEventListener('click', function(){ setSelectedRowById(c.id); });

    var lastStatusEvt = last((c.history||[]).filter(function(h){return h.action==='status' && STATUS.indexOf(h.to)!==-1;}).sort(function(a,b){return new Date(a.ts)-new Date(b.ts);}));

    /* Build layout - different structure for ultra-compact */
    var isUltraCompact = document.body.getAttribute('data-density') === 'ultra-compact';
    
    if(isUltraCompact) {
      // Ultra-compact: name-section | actions-section | tags-section
      var nameSection=document.createElement('div'); nameSection.className='name-section';
      
      // Status icons + name + count + notes preview all in one line
      var icons=document.createElement('div'); icons.className='status-icons';
      var bd=businessDaysSince(c.lastTouch||nowISO());
      var badge=agingBadge(bd, thr); icons.appendChild(badge);
      /* Status icon removed - replaced by progress tracker */
      
      var name=document.createElement('div'); name.className='name'; 
      name.textContent=c.name;
      var tcount=document.createElement('span'); tcount.className='touchCount'; tcount.textContent='('+( (c.history||[]).length )+')';
      
      var firstLine=(c.notes||'').split('\n')[0] ? (c.notes||'').split('\n')[0].trim() : '';
      var preview=null; 
      if(firstLine){ 
        preview=document.createElement('div'); 
        preview.className='notes-preview'; 
        preview.textContent='"'+firstLine.slice(0,80)+'..."'; 
      }
      
      nameSection.appendChild(icons); nameSection.appendChild(name); nameSection.appendChild(tcount);
      if(contactedToday(c)){ 
        var touchedDot=document.createElement('span'); 
        touchedDot.className='touched-dot'; 
        touchedDot.title='Touched today';
        nameSection.appendChild(touchedDot); 
      }
      if(preview) nameSection.appendChild(preview);
      
      var mid = nameSection; // For ultra-compact, nameSection IS the mid
      
    } else {
      // Standard layout (comfortable/compact)
      var mid=document.createElement('div');
      mid.className='leftcol';
      var head=document.createElement('div'); head.className='name-line';

      var icons=document.createElement('div'); icons.className='status-icons';
      var bd=businessDaysSince(c.lastTouch||nowISO());
      var badge=agingBadge(bd, thr); badge.style.marginRight='4px'; icons.appendChild(badge);
      /* Status icon removed - replaced by progress tracker below */

      var name=document.createElement('div'); name.className='name'; 
      name.textContent=c.name;

      head.appendChild(icons); head.appendChild(name);
      var tcount=document.createElement('span'); tcount.className='touchCount'; tcount.textContent='('+( (c.history||[]).length )+')'; head.appendChild(tcount);
      if(contactedToday(c)){ 
        var touchedDot=document.createElement('span'); 
        touchedDot.className='touched-dot'; 
        touchedDot.title='Touched today';
        head.appendChild(touchedDot); 
      }
      if(opts.whenLabel){
        var whenChip=document.createElement('span');
        whenChip.className='tag-chip scheduled';
        whenChip.innerHTML = opts.whenLabel + '<span class="unschedule-x" data-client-id="' + c.id + '">×</span>';
        head.appendChild(whenChip);
      }
      if(c.purchaseDate){
        var purchaseChip=document.createElement('span');
        purchaseChip.className='tag-chip scheduled purchased-chip';
        var purchaseLabel = 'Purchased: ' + new Date(c.purchaseDate).toLocaleDateString('en-US', {month:'numeric', day:'numeric', year:'2-digit'});
        purchaseChip.innerHTML = purchaseLabel + '<span class="unschedule-x clear-purchase" data-client-id="' + c.id + '">×</span>';
        head.appendChild(purchaseChip);
      }
      if(c.queueToday){ var chip1=document.createElement('span'); chip1.className='tag-chip'; chip1.textContent='Today'; head.appendChild(chip1); }
      if(c.queueTomorrow){ var chip2=document.createElement('span'); chip2.className='tag-chip'; chip2.textContent='Tomorrow'; head.appendChild(chip2); }
      mid.appendChild(head);

      var firstLine=(c.notes||'').split('\n')[0] ? (c.notes||'').split('\n')[0].trim() : '';
      var preview=null; if(firstLine){ preview=document.createElement('div'); preview.className='notes-preview'; preview.textContent=firstLine.slice(0,120); mid.appendChild(preview); }
    }
    
    // Notes textarea (shared by both layouts)
    var notesWrap=document.createElement('div'); notesWrap.className='notes hidden';
    var ta=document.createElement('textarea'); ta.placeholder='Notes…'; ta.value=c.notes||'';
    ta.addEventListener('input', function(){ updateNotes(c,ta.value); });
    ta.addEventListener('keydown', function(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); updateNotes(c, ta.value); var first=(ta.value||'').split('\n')[0] ? (ta.value||'').split('\n')[0].trim() : ''; if(first){ var existingPreview = isUltraCompact ? nameSection.querySelector('.notes-preview') : mid.querySelector('.notes-preview'); if(!existingPreview && !isUltraCompact){ var newPreview=document.createElement('div'); newPreview.className='notes-preview'; newPreview.textContent=first.slice(0,120); mid.insertBefore(newPreview, notesWrap); } else if(existingPreview) { existingPreview.textContent = isUltraCompact ? '"'+first.slice(0,80)+'..."' : first.slice(0,120); } } else { var existingPreview = isUltraCompact ? nameSection.querySelector('.notes-preview') : mid.querySelector('.notes-preview'); if(existingPreview){ existingPreview.parentNode.removeChild(existingPreview); } } notesWrap.classList.add('hidden'); ta.blur(); }});
    notesWrap.appendChild(ta); mid.appendChild(notesWrap);

    if(isUltraCompact) {
      // Ultra-compact: actions-section | tags-section
      var actionsSection=document.createElement('div'); actionsSection.className='actions-section';
      
      // Combine all actions into one compact group
      var callBtn=document.createElement('button'); callBtn.className='qbtn has-tip'; setTip(callBtn,'Call'); callBtn.textContent=EMOJI_CALL;
      var callBadge=document.createElement('span'); callBadge.className='badge'; callBadge.textContent=String(c.callCount||0); callBadge.setAttribute('data-zero', (c.callCount||0)===0 ? '1':'0'); callBtn.appendChild(callBadge); callBtn.addEventListener('click', function(){ incrementCall(c); });
      
      var msgBtn=document.createElement('button'); msgBtn.className='qbtn has-tip'; setTip(msgBtn,'Message'); msgBtn.textContent=EMOJI_MSG;
      var msgBadge=document.createElement('span'); msgBadge.className='badge'; msgBadge.textContent=String(c.msgCount||0); msgBadge.setAttribute('data-zero', (c.msgCount||0)===0 ? '1':'0'); msgBtn.appendChild(msgBadge); msgBtn.addEventListener('click', function(){ incrementMsg(c); });
      
      actionsSection.appendChild(callBtn); actionsSection.appendChild(msgBtn);
      
      // Status buttons (icon only)
      STATUS.forEach(function(st){
        var btn=document.createElement('button'); btn.className='sbtn has-tip '+colorClass(st); setTip(btn, st);
        if(c.status===st) btn.classList.add('active');
        var ico=document.createElement('span'); ico.className='ico status-icon'; ico.textContent=STATUS_ICON[st] || '•';
        btn.appendChild(ico); // No label in ultra-compact
        btn.addEventListener('click', function(){ setStatus(c,st,btn); });
        actionsSection.appendChild(btn);
      });
      
      // Hot button
      var hotBtn=document.createElement('button'); hotBtn.className='sbtn has-tip s-hot'; setTip(hotBtn, 'Hot lead');
      if(c.hot) hotBtn.classList.add('active');
      var hotIco=document.createElement('span'); hotIco.className='ico'; hotIco.textContent='🔥';
      hotBtn.appendChild(hotIco);
      hotBtn.addEventListener('click', function(e){
        var wasHot = c.hot;
        preserveUIAndRender(function(){ c.hot = !c.hot; });
        if(!wasHot && c.hot){
          showFlameAnimation(e);
        }
      });
      actionsSection.appendChild(hotBtn);
      
      // Action icons
      var iconbar = buildIconBar(c, notesWrap, ta);
      iconbar.childNodes.forEach(function(btn){ actionsSection.appendChild(btn); });
      
      // Tags section
      var tagsSection=document.createElement('div'); tagsSection.className='tags-section';
      if(opts.whenLabel){
        var whenChip=document.createElement('span');
        whenChip.className='tag-chip scheduled';
        whenChip.innerHTML = opts.whenLabel + '<span class="unschedule-x" data-client-id="' + c.id + '">×</span>';
        tagsSection.appendChild(whenChip);
      }
      if(c.purchaseDate){
        var purchaseChip=document.createElement('span');
        purchaseChip.className='tag-chip scheduled purchased-chip';
        var purchaseLabel = 'Purchased: ' + new Date(c.purchaseDate).toLocaleDateString('en-US', {month:'numeric', day:'numeric', year:'2-digit'});
        purchaseChip.innerHTML = purchaseLabel + '<span class="unschedule-x clear-purchase" data-client-id="' + c.id + '">×</span>';
        tagsSection.appendChild(purchaseChip);
      }
      if(c.queueToday){ var chip1=document.createElement('span'); chip1.className='tag-chip'; chip1.textContent='Today'; tagsSection.appendChild(chip1); }
      if(c.queueTomorrow){ var chip2=document.createElement('span'); chip2.className='tag-chip'; chip2.textContent='Tomorrow'; tagsSection.appendChild(chip2); }
      
      row.appendChild(mid); row.appendChild(actionsSection); row.appendChild(tagsSection);
      
    } else {
      // Standard layout
      var right=document.createElement('div'); right.className='actions-wrap';

      // Quick counters (more spacing from statuses via group class)
      var quick=document.createElement('div'); quick.className='group--quick';
      var callBtn=document.createElement('button'); callBtn.className='qbtn has-tip'; callBtn.title='Log a Call'; setTip(callBtn,'Call'); callBtn.textContent=EMOJI_CALL;
      var callBadge=document.createElement('span'); callBadge.className='badge'; callBadge.textContent=String(c.callCount||0); callBadge.setAttribute('data-zero', (c.callCount||0)===0 ? '1':'0'); callBtn.appendChild(callBadge); callBtn.addEventListener('click', function(){ incrementCall(c); });
      var msgBtn=document.createElement('button'); msgBtn.className='qbtn has-tip'; msgBtn.title='Log a Message'; setTip(msgBtn,'Message'); msgBtn.textContent=EMOJI_MSG;
      var msgBadge=document.createElement('span'); msgBadge.className='badge'; msgBadge.textContent=String(c.msgCount||0); msgBadge.setAttribute('data-zero', (c.msgCount||0)===0 ? '1':'0'); msgBtn.appendChild(msgBadge); msgBtn.addEventListener('click', function(){ incrementMsg(c); });
      quick.appendChild(callBtn); quick.appendChild(msgBtn);

      // Replace status buttons with progress tracker
      var statusTracker = renderStatusTracker(c ? c.status : null, c);

      // Create a wrapper for status tracker and hot button
      var bar = document.createElement('div');
      bar.className = 'group--status';
      bar.style.display = 'flex';
      bar.style.alignItems = 'center';
      bar.style.gap = '12px';

      if(statusTracker){
        statusTracker.style.margin = '0';
        statusTracker.style.padding = '0';
        bar.appendChild(statusTracker);
      }

      // Hot Lead toggle button
      var hotBtn=document.createElement('button');
      hotBtn.className='sbtn has-tip s-hot';
      hotBtn.style.marginLeft = '8px';
      setTip(hotBtn, 'Hot lead (pin to top)');
      if(c.hot) hotBtn.classList.add('active');
      var hotIco=document.createElement('span'); hotIco.className='ico'; hotIco.textContent='🔥';
      var hotCap=document.createElement('span'); hotCap.className='label'; hotCap.textContent='Hot';
      hotBtn.appendChild(hotIco); hotBtn.appendChild(hotCap);
      hotBtn.addEventListener('click', function(e){
        var wasHot = c.hot;
        preserveUIAndRender(function(){ c.hot = !c.hot; });
        if(!wasHot && c.hot){
          showFlameAnimation(e);
        }
      });
      bar.appendChild(hotBtn);

      // Notes/Schedule/Archive/Delete (icon bar)
      var iconbar = buildIconBar(c, notesWrap, ta);

      right.appendChild(quick); right.appendChild(bar); right.appendChild(iconbar);
      row.appendChild(mid); row.appendChild(right);
    }
    
    // Hot lead row styling
    if(c.hot) {
      row.classList.add('hot-row');
    }
    
    return row;
  }

  /* Selection */
  function allRows(){ return $all('#todayList .row, #list .row'); }
  var selectionIndex=0;
  function setSelectedRowById(id){ var rows=allRows(); var idx=rows.findIndex(function(r){return r.dataset.id===id;}); if(idx>=0){ selectionIndex=idx; restoreSelection(); } }
  function restoreSelection(){ var rows=allRows(); rows.forEach(function(r){ r.classList.remove('selected'); }); if(!rows.length) return; if(selectionIndex<0) selectionIndex=rows.length-1; if(selectionIndex>=rows.length) selectionIndex=0; rows[selectionIndex].classList.add('selected'); rows[selectionIndex].scrollIntoView({block:'nearest'}); }
  function getSelectedClient(){ var rows=allRows(); if(!rows.length) return null; var id=rows[selectionIndex] && rows[selectionIndex].dataset.id; return (state && state.clients) ? state.clients.find(function(c){return c.id===id;}) : null; }

  /* Activity / chart / heatmap */
  function todaysItems(){ var start=startOfDay(new Date()), end=addDays(start,1), items=[]; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action!=='status') return; if(isWithin(h.ts,start,end)) items.push({ts:h.ts,name:c.name,label:(STATUS_ABBR[h.to]||h.to),clientId:c.id,histId:h.id}); }); }); return items.sort(function(a,b){return new Date(b.ts)-new Date(a.ts);}); }
  function todaysGrouped(){ var start=startOfDay(new Date()), end=addDays(start,1), map={}; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action!=='status') return; if(!isWithin(h.ts,start,end)) return; var label=(STATUS_ABBR[h.to]||h.to); var g=map[c.id] || {id:c.id,name:c.name,items:[]}; g.items.push({ts:h.ts,label:label,histId:h.id}); map[c.id]=g; }); }); var groups=Object.keys(map).map(function(k){ var g=map[k]; g.items=g.items.sort(function(a,b){return new Date(a.ts)-new Date(b.ts);}); g.latest=Math.max.apply(null, g.items.map(function(i){return +new Date(i.ts);})); return g; }).sort(function(a,b){return b.latest-a.latest;}); return groups; }
  function renderActivity(){ if(els.todayDate) els.todayDate.textContent=new Date().toLocaleDateString([], {weekday:'long',month:'long',day:'numeric',year:'numeric'}); var grouped= !!ui.groupTodayByClient; els.groupToggle && (els.groupToggle.checked = grouped); if(!els.activity) return; els.activity.innerHTML=''; if(!grouped){ var items=todaysItems(); if(!items.length){ els.activity.innerHTML='<div class="muted small">No activity yet today.</div>'; return; } items.forEach(function(it){ var div=document.createElement('div'); div.className='item'; div.innerHTML='<div class="small muted">'+fmtTime(it.ts)+'</div><div><b>'+escapeHtml(it.name)+'</b> — '+escapeHtml(it.label)+'</div>'+'<button class="undo" data-undo data-client="'+it.clientId+'" data-hist="'+it.histId+'">Undo</button>'; els.activity.appendChild(div); }); } else { var groups=todaysGrouped(); if(!groups.length){ els.activity.innerHTML='<div class="muted small">No activity yet today.</div>'; return; } groups.forEach(function(g){ var who=document.createElement('div'); who.style.fontWeight='700'; who.textContent=g.name; who.style.margin='6px 0 4px'; els.activity.appendChild(who); g.items.forEach(function(it){ var div=document.createElement('div'); div.className='item'; div.innerHTML='<div class="small muted">'+fmtTime(it.ts)+'</div><div>— '+escapeHtml(it.label)+'</div>'+'<button class="undo" data-undo data-client="'+g.id+'" data-hist="'+it.histId+'">Undo</button>'; els.activity.appendChild(div); }); }); } }
  if(els.activity) els.activity.addEventListener('click', function(e){ var btn=e.target.closest('[data-undo]'); if(!btn) return; var cid=btn.getAttribute('data-client'), hid=btn.getAttribute('data-hist'); var c=(state && state.clients) ? state.clients.find(function(x){return String(x.id)===String(cid);}) : null; if(!c) return; var i=c.history.findIndex(function(h){ return String(h.id)===String(hid); }); if(i!==-1){ preserveUIAndRender(function(){ c.history.splice(i,1); var onlyStatus=c.history.filter(function(h){return h.action==='status' && STATUS.indexOf(h.to)!==-1;}).sort(function(a,b){return new Date(a.ts)-new Date(b.ts);}); var lastStatus=last(onlyStatus); c.status = lastStatus ? (lastStatus.to||'') : ''; var anyLast=last(c.history.sort(function(a,b){return new Date(a.ts)-new Date(b.ts);})); if(anyLast) c.lastTouch=anyLast.ts; }); } });

  function lastNDays(n){ var out=[], i, day, next, count; for(i=n-1;i>=0;i--){ day=startOfDay(addDays(new Date(), -i)); next=addDays(day,1); count=0; if(state && state.clients) state.clients.forEach(function(c){ (c.history||[]).forEach(function(h){ if(h.action==='status'){ var t=new Date(h.ts); if(t>=day && t<next) count++; }}); }); out.push({label:(day.getMonth()+1)+'/'+day.getDate(), count:count}); } return out; }
  function renderChart(){ if(!els.chart) return; var days=parseInt((els.chartRangeSel && els.chartRangeSel.value) || '7',10); var data=lastNDays(days), max=1, i; for(i=0;i<data.length;i++){ if(data[i].count>max) max=data[i].count; } els.chart.innerHTML=''; data.forEach(function(d){ var wrap=document.createElement('div'); wrap.style.flex='1'; wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.alignItems='stretch'; var bar=document.createElement('div'); bar.className='bar'; bar.style.height=(Math.max(6, (d.count/max*100)))+'%'; var lab=document.createElement('div'); lab.className='barlab'; lab.textContent=d.label; wrap.appendChild(bar); wrap.appendChild(lab); els.chart.appendChild(wrap); }); }
  function renderHeatmap(){ if(!els.heatmap) return; var days=90, data=lastNDays(days); function lvl(c){ return c===0?'': c<=1?'l1': c<=3?'l2': c<=6?'l3':'l4'; } els.heatmap.innerHTML=''; data.forEach(function(d){ var cell=document.createElement('div'); cell.className='cell '+lvl(d.count); cell.title=d.label+': '+d.count; els.heatmap.appendChild(cell); }); }

  /* Followups & Next to Touch */
  function renderFollowUps(){
    if(!els.followList) return;
    if(!state || !state.clients) return;
    var now = new Date();
    var items = state.clients.filter(function(c){
      // Exclude archived and tomorrow-queued clients
      return !c.archived && c.followUp && !c.queueTomorrow;
    }).map(function(c){
      var when = new Date(c.followUp);
      var daysUntil = Math.ceil((when - now) / (1000 * 60 * 60 * 24));
      return {c:c, when:when, daysUntil:daysUntil};
    }).sort(function(a,b){return +a.when - +b.when;});

    els.followList.innerHTML='';
    if(!items.length){
      els.followList.innerHTML='<div class="small muted">No scheduled follow ups.</div>';
      return;
    }

    items.forEach(function(rec){
      var div=document.createElement('div');
      div.className='followitem';

      var left=document.createElement('div');
      left.textContent=rec.c.name;

      var right=document.createElement('div');
      right.className='small muted';

      // Show countdown and turn red if overdue
      if(rec.daysUntil < 0){
        right.style.color = '#dc2626';
        right.style.fontWeight = '600';
        right.textContent = Math.abs(rec.daysUntil) + ' days overdue';
      } else if(rec.daysUntil === 0){
        right.style.color = '#f59e0b';
        right.style.fontWeight = '600';
        right.textContent = 'Due today';
      } else if(rec.daysUntil === 1){
        right.textContent = 'Tomorrow';
      } else {
        right.textContent = 'In ' + rec.daysUntil + ' days';
      }

      div.appendChild(left);
      div.appendChild(right);
      els.followList.appendChild(div);
    });
  }
  function renderNextToTouch(){ if(!els.nextList) return; var thr=getAgeThreshold(); var list=state.clients.filter(function(c){return !c.archived;}).map(function(c){return {c:c, bd:businessDaysSince(c.lastTouch)};}).filter(function(x){return x.bd>thr;}).sort(function(a,b){return b.bd-a.bd;}).slice(0,25); els.nextList.innerHTML=''; if(!list.length){ els.nextList.innerHTML='<div class="small muted">All caught up '+CLAP+'</div>'; return; } list.forEach(function(it){ var div=document.createElement('div'); div.className='nextitem'; var left=document.createElement('div'); var b=agingBadge(it.bd, thr); b.classList.add('sm'); b.style.marginRight='6px'; b.style.display='inline-flex'; var nameSpan=document.createElement('span'); nameSpan.textContent=it.c.name; left.appendChild(b); left.appendChild(nameSpan); var right=document.createElement('div'); right.className='small muted'; right.textContent='Last: '+fmtDay(it.c.lastTouch)+' ('+it.bd+'bd)'; div.appendChild(left); div.appendChild(right); els.nextList.appendChild(div); }); }

  /* Tomorrow + Scheduled */
  function renderTomorrowList(){ if(!els.tomorrowList) return; var list = state.clients.filter(function(c){ return !c.archived && c.queueTomorrow; }); els.tomorrowList.innerHTML=''; if(!list.length){ els.tomorrowList.innerHTML='<div class="small muted">Nothing queued.</div>'; return; } sortClients(list).forEach(function(c){ var div=document.createElement('div'); div.className='nextitem'; div.innerHTML='<div>'+escapeHtml(c.name)+'</div><div class="small muted">last '+fmtDay(c.lastTouch)+'</div>'; els.tomorrowList.appendChild(div); }); }
  function isFutureFollowUp(c){ if(!c.followUp) return false; var t=new Date(c.followUp); return !isNaN(+t) && t>new Date(); }

  /* Root render */
  function sortClients(arr){ 
    var key=(ui.sortBy||'lastTouch'); 
    return arr.slice().sort(function(a,b){ 
      // Prioritize hot leads first
      if(a.hot !== b.hot) return a.hot ? -1 : 1;
      
      // Then apply the current sort key
      if(key==='name'){ 
        return a.name.localeCompare(b.name); 
      } 
      return new Date(b[key]||0)-new Date(a[key]||0); 
    }); 
  }
  function renderList(container, clients, opts){
    opts=opts||{};
    if(!container) return;
    container.innerHTML='';
    var q=(els.globalSearch && els.globalSearch.value ? els.globalSearch.value : '').toLowerCase().trim();
    var filtered = clients.filter(function(c){
      if(els.showArchived && els.showArchived.checked ? !c.archived : c.archived) return false;
      if(els.statusFilter && els.statusFilter.value && c.status!==els.statusFilter.value) return false;
      if(q && !(c.name.toLowerCase().includes(q) || (c.notes||'').toLowerCase().includes(q) || (c.status||'').toLowerCase().includes(q))) return false;
      return true;
    });

    // Show empty state message if no clients (but not in renderList - handle this at higher level)
    if(filtered.length === 0 && clients.length === 0 && !q){
      // Don't show empty state in list container - this will be handled by main render function
      return;
    }

    sortClients(filtered).forEach(function(c){
      var row=buildRow(c, opts.rowOpts||{});
      container.appendChild(row);
    });
    restoreSelection();
  }
  function render(){
    if(!state || !state.clients) return;

    var activeAll=state.clients.filter(function(c){return !c.archived;});
    var todayClients = activeAll.filter(function(c){ return c.queueToday; });
    var scheduled = activeAll.filter(isFutureFollowUp);
    var mainActive = activeAll.filter(function(c){ return !isFutureFollowUp(c) && !c.queueToday; });
    var archived=state.clients.filter(function(c){return c.archived;});

    renderKPIs(); renderPipeline(); renderTrendRibbons(); renderDailyOutreach(); updateDemoButtons();

    // Handle empty state for main list
    var totalActiveClients = mainActive.length + todayClients.length + scheduled.length;
    if(totalActiveClients === 0){
      showEmptyState();
    } else {
      hideEmptyState();
      renderList(els.list, mainActive);
    }

    // Today section
    if(els.todayBlock && els.todayList){
      if(todayClients.length){
        els.todayBlock.classList.remove('hidden');
        els.todayList.innerHTML='';
        sortClients(todayClients).forEach(function(c){
          var row=buildRow(c, {});
          els.todayList.appendChild(row);
        });
      } else {
        els.todayBlock.classList.add('hidden');
        els.todayList.innerHTML='';
      }
    }

    // Scheduled section
    if(els.scheduledBlock && els.scheduledList){
      if(scheduled.length){
        els.scheduledBlock.classList.remove('hidden');
        els.scheduledList.innerHTML='';
        sortClients(scheduled).forEach(function(c){
          var whenLabel=(new Date(c.followUp)).toLocaleString([], {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'});
          var row=buildRow(c, {whenLabel: whenLabel});
          els.scheduledList.appendChild(row);
        });
      } else {
        els.scheduledBlock.classList.add('hidden');
        els.scheduledList.innerHTML='';
      }
    }

    if(els.showArchived && els.showArchived.checked){
      els.archivedBlock.classList.remove('hidden');
      renderList(els.archivedList, archived);
    } else {
      els.archivedBlock.classList.add('hidden');
      els.archivedList && (els.archivedList.innerHTML='');
    }

    els.todayDate && (els.todayDate.textContent=new Date().toLocaleDateString([], {weekday:'long',month:'long',day:'numeric',year:'numeric'}));
    renderActivity(); renderChart(); renderHeatmap(); renderNextToTouch(); renderFollowUps(); renderQuote(false);
  }

  /* Quotes (light) */
  var quoteTimer=null; function pickQuote(){ var list=(state.quotes && state.quotes.list)||[]; if(!list.length) return ''; var qs=state.quotesSettings||{interval:15, random:true, norepeat:true, recent:[]}; if(!qs.random){ var idx=Number(qs.lastIndex||0); idx=(idx+1)%list.length; qs.lastIndex=idx; return list[idx]; } var recent=Array.isArray(qs.recent)?qs.recent:[]; var tries=0, idx2=0; do{ idx2=Math.floor(Math.random()*list.length); tries++; } while(qs.norepeat && recent.indexOf(idx2)!==-1 && tries<25); recent.push(idx2); while(recent.length>Math.min(20, Math.ceil(list.length/3))) recent.shift(); qs.recent=recent; qs.lastIndex=idx2; state.quotesSettings=qs; save(state); return list[idx2]; }
  function renderQuote(showNew){ if(showNew){ var q=pickQuote(); if(q) state.quotes._current=q; } if(!els.quoteView) return; var cur=(state.quotes && state.quotes._current) ? state.quotes._current : (((state.quotes||{}).list||[])[0]||''); els.quoteView.textContent = cur || 'Add quotes to get started.'; var count=((state.quotes||{}).list||[]).length; els.quoteMeta && (els.quoteMeta.textContent = count ? (count+' quotes • rotates every '+(state.quotesSettings&&state.quotesSettings.interval||15)+' min') : ''); }
  function scheduleQuoteTimer(){ if(quoteTimer) clearInterval(quoteTimer); var mins=(state.quotesSettings && state.quotesSettings.interval) ? Number(state.quotesSettings.interval) : 15; if(mins>0){ quoteTimer=setInterval(function(){ renderQuote(true); }, mins*60*1000); } }

  /* Filters & UI wiring */
  ['change','input'].forEach(function(ev){
    if(els.statusFilter) els.statusFilter.addEventListener(ev, render);
    if(els.showArchived) els.showArchived.addEventListener(ev, render);
    if(els.globalSearch) els.globalSearch.addEventListener(ev, render);
    if(els.sortBy) els.sortBy.addEventListener(ev, function(){ ui.sortBy=els.sortBy.value; saveUI(ui); render(); });
    if(els.chartRangeSel) els.chartRangeSel.addEventListener(ev, function(){ renderChart(); });
  });

  if(els.ageDays){
    if(ui.ageDays!=null) els.ageDays.value = String(ui.ageDays);
    els.ageDays.addEventListener('change', function(){ ui.ageDays = Number(els.ageDays.value||4); saveUI(ui); render(); });
  }
  if(typeof ui.groupTodayByClient==='undefined'){ ui.groupTodayByClient=true; saveUI(ui); }
  if(els.groupToggle) els.groupToggle.addEventListener('change', function(){ ui.groupTodayByClient = !!els.groupToggle.checked; saveUI(ui); renderActivity(); });

  if(els.globalSearch) els.globalSearch.addEventListener('keydown', function(e){
    if(e.key==='Enter'){
      var q=els.globalSearch.value.trim(); if(!q) return;
      var exists=state.clients.some(function(c){ return c.name.toLowerCase()===q.toLowerCase(); });
      if(!exists){ addClient(q); els.globalSearch.select(); }
    }
  });

  /* Density */
  function applyDensity(){ var mode = ui.density || 'comfortable'; document.body.setAttribute('data-density', mode); if(els.densitySelect) els.densitySelect.value = mode; }
  if(typeof ui.density==='undefined'){ ui.density='comfortable'; saveUI(ui); }
  if(els.densitySelect){ els.densitySelect.value=ui.density; els.densitySelect.addEventListener('change', function(){ ui.density=this.value; saveUI(ui); applyDensity(); }); }

  /* Sidebar position + show/hide */
  ;(function(){
    var appRoot=els.appRoot;
    // Removed applySidebarPos - now handled in move button logic
    function applySidebarVisibility(){
      if(ui.sidebarHidden){ appRoot.classList.add('no-side'); if(els.toggleSidebarBtn) els.toggleSidebarBtn.textContent='◨'; }
      else { appRoot.classList.remove('no-side'); if(els.toggleSidebarBtn) els.toggleSidebarBtn.textContent='◧'; }
    }
    if(typeof ui.sidebarLeft==='undefined'){ ui.sidebarLeft=false; }
    if(typeof ui.sidebarHidden==='undefined'){ ui.sidebarHidden=false; }

    // Apply saved sidebar position
    if(ui.sidebarLeft){
      appRoot.classList.add('leftbar');
    }

    applySidebarVisibility();
    // Add the move-left/right helper in the sidebar-controls container
    var controls=els.sidebarControls;
    if(controls){
      var moveBtn=document.createElement('button');
      moveBtn.className='btn-min gray';
      moveBtn.style.padding='4px 8px';
      moveBtn.title = 'Move sidebar to the other side';
      function label(){
        moveBtn.textContent = ui.sidebarLeft ? '→' : '←';
      }
      label();
      moveBtn.addEventListener('click', function(){
        // Toggle sidebar position
        ui.sidebarLeft = !ui.sidebarLeft;

        // Simply toggle the leftbar class - CSS handles the rest
        if(ui.sidebarLeft){
          appRoot.classList.add('leftbar');
        } else {
          appRoot.classList.remove('leftbar');
        }

        // Save state and update button
        saveUI(ui);
        label();
      });
      controls.appendChild(moveBtn);
    }
    if(els.toggleSidebarBtn){
      els.toggleSidebarBtn.addEventListener('click', function(){
        ui.sidebarHidden = !ui.sidebarHidden; saveUI(ui); applySidebarVisibility();
      });
    }
  })();

  /* Import/Export functionality */
  if(els.importBtn){
    els.importBtn.addEventListener('click', function(){
      var textarea = document.createElement('textarea');
      textarea.style.cssText = 'position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:400px; height:300px; padding:10px; z-index:10000; border:2px solid var(--green); border-radius:8px; font-size:14px;';
      textarea.placeholder = 'Paste client names here, one per line.\nExample:\nJohn Smith\nJane Doe\nBob Johnson';
      document.body.appendChild(textarea);

      var importDiv = document.createElement('div');
      importDiv.style.cssText = 'position:fixed; left:50%; top:calc(50% + 170px); transform:translateX(-50%); z-index:10000; display:flex; gap:8px;';
      importDiv.innerHTML = '<button id="confirmImport" class="btn-primary">Import</button><button id="cancelImport" class="btn-min gray">Cancel</button>';
      document.body.appendChild(importDiv);

      var backdrop = document.createElement('div');
      backdrop.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999;';
      document.body.appendChild(backdrop);

      textarea.focus();

      function cleanup(){
        textarea.remove();
        importDiv.remove();
        backdrop.remove();
      }

      document.getElementById('confirmImport').addEventListener('click', function(){
        var lines = textarea.value.split('\n').map(function(line){ return line.trim(); }).filter(Boolean);
        if(lines.length){
          lines.forEach(function(name){
            state.clients.push({
              id:uid(), name:name, notes:'', status:'', lastTouch:nowISO(),
              createdAt:nowISO(), archived:false, followUp:'', callCount:0,
              msgCount:0, queueToday:false, queueTomorrow:false, hot:false, history:[]
            });
          });
          save(state);
          render();
          showNotification('Import Complete', 'Imported ' + lines.length + ' clients successfully');
        }
        cleanup();
      });

      document.getElementById('cancelImport').addEventListener('click', cleanup);
      backdrop.addEventListener('click', cleanup);
    });
  }

  if(els.exportBtn){
    els.exportBtn.addEventListener('click', function(){
      var data = {
        clients: state.clients,
        quotes: state.quotes,
        quotesSettings: state.quotesSettings
      };
      var json = JSON.stringify(data, null, 2);
      var blob = new Blob([json], {type: 'application/json'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'hotlist-export-' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification('Export Complete', 'Your data has been exported successfully');
    });
  }

  /* Load Demo Data Button */
  if(els.loadDemoBtn){
    els.loadDemoBtn.addEventListener('click', function(){
      loadDemoData();
    });
  }


  /* Show/hide demo buttons based on presence of demo data */
  function updateDemoButtons(){
    // Check if there are any demo clients
    var hasDemoClients = state.clients && state.clients.some(function(client){
      return client.id && client.id.startsWith('demo-');
    });

    console.log('=== updateDemoButtons Debug ===');
    console.log('state.clients:', state.clients);
    console.log('hasDemoClients:', hasDemoClients);

    // Show/hide load demo button (show when no demo clients exist)
    if(els.loadDemoBtn){
      els.loadDemoBtn.style.display = hasDemoClients ? 'none' : 'block';
      console.log('Setting load demo button display to:', hasDemoClients ? 'none' : 'block');
    }

    // Show/hide clear demo section (show when demo clients exist)
    if(els.clearDemoSection){
      els.clearDemoSection.style.display = hasDemoClients ? 'block' : 'none';
      console.log('Setting clear demo section display to:', hasDemoClients ? 'block' : 'none');
    }
  }

  /* Empty State Management */
  function showEmptyState(){
    if(!els.emptyState || !els.mainTableHead) return;

    els.emptyState.style.display = 'block';
    els.mainTableHead.style.display = 'none';
    els.list.innerHTML = '';

    els.emptyState.innerHTML = '<div style="padding:40px 20px; text-align:center; color:var(--muted);">' +
      '<div style="font-size:16px; margin-bottom:10px;">No clients yet</div>' +
      '<div style="font-size:14px; margin-bottom:20px;">Use the search bar above to add your first client.<br/>Just type a name and press Enter!<br/><br/>Or use the Import Client button (📥) in the top right to import from a file.</div>' +
      '<button onclick="loadDemoData()" style="background:var(--info); color:white; border:none; padding:12px 24px; border-radius:8px; font-size:14px; cursor:pointer; margin-top:10px; margin-bottom:20px;">📋 Load Demo Data</button>' +
      '<div style="font-size:12px; color:var(--muted); max-width:750px; margin:0 auto; line-height:1.4; background:rgba(0,0,0,0.02); padding:15px; border-radius:8px;">' +
      '<strong>🔒 Privacy Notice:</strong> All data is stored locally in your browser only. Nothing is sent to any server. ' +
      'However, please avoid entering personally identifiable information (PII) like social security numbers, full addresses, or sensitive personal details.' +
      '</div>' +
      '</div>';
  }

  function hideEmptyState(){
    if(!els.emptyState || !els.mainTableHead) return;

    els.emptyState.style.display = 'none';
    els.mainTableHead.style.display = 'flex';
  }

  /* Notification helper */
  function showNotification(title, body){
    if(!('Notification' in window)) return;
    if(Notification.permission === 'granted'){
      new Notification(title, { body: body, icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"%3E%3Crect width="192" height="192" fill="%23ff8c00"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-size="96" fill="white"%3E🔥%3C/text%3E%3C/svg%3E' });
    }
  }

  function requestNotificationPermission(){
    if('Notification' in window && Notification.permission === 'default'){
      Notification.requestPermission();
    }
  }

  /* Check for scheduled follow-ups */
  var notifiedFollowUps = {}; // Track which followups we've notified about
  function checkScheduledNotifications(){
    var now = new Date();
    var scheduled = state.clients.filter(function(c){
      if(c.archived || !c.followUp) return false;
      var followUpTime = new Date(c.followUp);
      if(isNaN(+followUpTime)) return false;

      // Check if this follow-up is due (within 5 minutes)
      var timeDiff = followUpTime - now;
      var isDue = timeDiff <= 5 * 60 * 1000 && timeDiff > -60 * 1000; // 5 min before to 1 min after

      // Only notify once per follow-up
      var notifKey = c.id + ':' + c.followUp;
      if(isDue && !notifiedFollowUps[notifKey]){
        notifiedFollowUps[notifKey] = true;
        return true;
      }
      return false;
    });

    scheduled.forEach(function(c){
      var followUpTime = new Date(c.followUp);
      var timeStr = followUpTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      showNotification('Follow-up Due: ' + c.name, 'Scheduled for ' + timeStr);
    });

    // Clean up old notifications older than 1 hour
    var oneHourAgo = now.getTime() - 60 * 60 * 1000;
    Object.keys(notifiedFollowUps).forEach(function(key){
      var parts = key.split(':');
      if(parts[1]){
        var notifTime = new Date(parts[1]).getTime();
        if(notifTime < oneHourAgo){
          delete notifiedFollowUps[key];
        }
      }
    });
  }

  // Check for scheduled notifications every minute
  setInterval(checkScheduledNotifications, 60 * 1000);

  /* Power Hour */
  var hopTimer=null, hopRemaining=60*60, hopRunning=false, hopCallCount=0, originalTitle = document.title;

  function renderHOP(){
    if(!els.hopClock) return;
    var h=Math.floor(hopRemaining/3600), m=Math.floor((hopRemaining%3600)/60), s=hopRemaining%60;
    var timeStr = [h,m,s].map(function(v){return String(v).padStart(2,'0');}).join(':');
    els.hopClock.textContent=timeStr;

    // Update tab title when timer is running
    if(hopRunning){
      document.title = timeStr + ' | ' + hopCallCount + ' calls | ' + originalTitle;
    }

    // Show notification when timer completes
    if(hopRemaining === 0 && hopRunning){
      showNotification('Power Hour Complete!', 'Great job! You completed ' + hopCallCount + ' calls in this session.');
    }
  }

  function updateHopCalls(count){
    hopCallCount = count;
    if(els.hopCalls) els.hopCalls.textContent = count;
    if(hopRunning) renderHOP(); // Update tab title
  }

  if(els.hopStart) els.hopStart.addEventListener('click', function(){
    if(hopRunning) return;
    hopRunning=true;
    requestNotificationPermission(); // Request permission when starting timer
    hopTimer=setInterval(function(){
      hopRemaining=Math.max(0, hopRemaining-1);
      renderHOP();
      if(hopRemaining===0){
        clearInterval(hopTimer);
        hopRunning=false;
        document.title = originalTitle; // Reset title
      }
    },1000);
  });

  if(els.hopPause) els.hopPause.addEventListener('click', function(){
    hopRunning=false;
    clearInterval(hopTimer);
    document.title = originalTitle; // Reset title
  });

  if(els.hopReset) els.hopReset.addEventListener('click', function(){
    hopRunning=false;
    clearInterval(hopTimer);
    hopRemaining=60*60;
    hopCallCount = 0;
    updateHopCalls(0);
    renderHOP();
    document.title = originalTitle; // Reset title
  });

  /* Modal functions */
  function showShortcutsModal(){
    document.getElementById('shortcutsModal').style.display = 'block';
  }
  function closeShortcutsModal(){
    document.getElementById('shortcutsModal').style.display = 'none';
  }
  function showChangelogModal(){
    // Populate changelog content when modal is shown
    var changelogEl = document.getElementById('changelogContent');
    if(changelogEl) {
      changelogEl.innerHTML = '';
      CHANGELOG.forEach(function(entry) {
        var item = document.createElement('div');
        item.style.cssText = 'border-left:3px solid #3b82f6; padding-left:12px; margin-bottom:12px;';
        item.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:4px;">' +
          '<strong style="color:#1e293b; font-size:14px;">v' + entry.version + '</strong>' +
          '<span style="color:#94a3b8; font-size:12px;">' + entry.date + '</span>' +
          '</div>' +
          '<div style="color:#475569; font-size:13px;">' + entry.changes + '</div>';
        changelogEl.appendChild(item);
      });
    }
    document.getElementById('changelogModal').style.display = 'block';
  }
  function closeChangelogModal(){
    document.getElementById('changelogModal').style.display = 'none';
  }
  function openSuggestEmail(){
    var email = 'leland' + '.' + 'smith' + '@' + 'country' + 'financial' + '.com';
    var subject = encodeURIComponent('Hotlist Suggestion');
    var body = encodeURIComponent('I have a suggestion for the Hotlist app:\n\n');
    window.location.href = 'mailto:' + email + '?subject=' + subject + '&body=' + body;
  }
  window.showShortcutsModal = showShortcutsModal;
  window.closeShortcutsModal = closeShortcutsModal;
  window.showChangelogModal = showChangelogModal;
  window.closeChangelogModal = closeChangelogModal;
  window.openSuggestEmail = openSuggestEmail;

  /* Flame animation when marking hot */
  function showFlameAnimation(event){
    var flame = document.createElement('div');
    flame.className = 'flame-burst';
    flame.innerHTML = '🔥';

    // Find the selected row or use click position
    var selectedRow = document.querySelector('.row.selected');

    if(selectedRow){
      var rect = selectedRow.getBoundingClientRect();
      flame.style.left = (rect.left + rect.width / 2 - 48) + 'px';
      flame.style.top = (rect.top + rect.height / 2 - 48) + 'px';
    } else if(event && event.clientX){
      flame.style.left = (event.clientX - 48) + 'px';
      flame.style.top = (event.clientY - 48) + 'px';
    } else {
      flame.style.left = (window.innerWidth / 2 - 48) + 'px';
      flame.style.top = (window.innerHeight / 2 - 48) + 'px';
    }

    document.body.appendChild(flame);

    // Apply animation
    flame.style.animation = 'flameTravel 0.6s ease-out';

    // Remove after animation completes
    setTimeout(function(){
      flame.remove();
    }, 600);

    // Make the title pulse briefly - only if title exists
    var titleElement = document.getElementById('hotlistTitle');
    if(titleElement){
      titleElement.style.animation = 'pulse 0.3s ease-out';
      setTimeout(function(){
        titleElement.style.animation = '';
      }, 300);
    }
  }

  // Make showFlameAnimation available globally for keyboard shortcuts
  window.showFlameAnimation = showFlameAnimation;

  /* Demo Data Functions */
  function createDemoClients(){

    var now = new Date().toISOString();
    var yesterday = new Date(Date.now() - 24*60*60*1000).toISOString();
    var twoDaysAgo = new Date(Date.now() - 2*24*60*60*1000).toISOString();

    var demoClients = [
      {
        id: 'demo-' + Date.now() + '-1',
        name: 'Sarah Johnson',
        status: 'Sent Quote',
        notes: 'Interested in term life insurance for $500K coverage.\nHas 2 young children, budget around $150/month.\nPrefers to meet on weekends due to work schedule.',
        callCount: 2,
        msgCount: 1,
        lastTouch: yesterday,
        created: twoDaysAgo,
        hot: false,
        archived: false,
        queueToday: false,
        queueTomorrow: false,
        history: [
          { ts: twoDaysAgo, action: 'created' }
        ]
      },
      {
        id: 'demo-' + Date.now() + '-2',
        name: 'Michael Chen',
        notes: 'Self-employed business owner looking for disability insurance.\nRuns a successful consulting firm, needs income protection.\nVery detail-oriented, asks lots of questions.',
        callCount: 0,
        msgCount: 0,
        lastTouch: new Date(Date.now() - 5*24*60*60*1000).toISOString(),
        created: new Date(Date.now() - 5*24*60*60*1000).toISOString(),
        hot: false,
        archived: false,
        queueToday: false,
        queueTomorrow: false,
        history: [
          { ts: new Date(Date.now() - 5*24*60*60*1000).toISOString(), action: 'created' }
        ]
      },
      {
        id: 'demo-' + Date.now() + '-3',
        name: 'Jennifer Martinez',
        status: 'Purchased',
        notes: 'Purchased whole life policy for $250K.\nEasy client, referred by existing customer.\nInterested in additional coverage for spouse.',
        callCount: 1,
        msgCount: 0,
        lastTouch: yesterday,
        created: new Date(Date.now() - 7*24*60*60*1000).toISOString(),
        purchaseDate: yesterday,
        hot: false,
        archived: false,
        queueToday: false,
        queueTomorrow: false,
        history: [
          { ts: new Date(Date.now() - 7*24*60*60*1000).toISOString(), action: 'created' }
        ]
      }
    ];

    return demoClients;
  }

  function loadDemoData(){
    if(!confirm('This will add 3 demo clients to your list. Continue?')) return;

    var demoClients = createDemoClients();

    // Add demo clients to state
    state.clients = state.clients.concat(demoClients);

    // Mark that user has demo data
    localStorage.setItem('hotlist_ever_had_data', 'demo');
    save(state);
    render();

    // Show success message
    setTimeout(function(){
      alert('Demo data loaded! 📋\n\n• Sarah Johnson (Sent Quote)\n• Michael Chen (No status - try setting one!)\n• Jennifer Martinez (Purchased)\n\nExplore the features and use keyboard shortcuts 1-6!');
    }, 100);
  }

  function clearDemoData(){
    if(!confirm('This will remove all demo clients (names starting with demo-). Your real clients will remain. Continue?')) return;

    // Remove all clients with demo IDs
    state.clients = state.clients.filter(function(client){
      return !client.id.startsWith('demo-');
    });

    save(state);
    render();

    // Mark that user has cleared demo data
    localStorage.setItem('hotlist_ever_had_data', 'cleared');

    // Show success message
    setTimeout(function(){
      alert('Demo data cleared! 🗑️\n\nYou can now add your real clients.');
    }, 100);
  }

  function initializeFirstTimeUser(){
    console.log('=== initializeFirstTimeUser Debug ===');
    console.log('state.clients:', state.clients);
    console.log('clients length:', state.clients ? state.clients.length : 'undefined');

    // Check if we should auto-load demo data
    var hasEverHadData = localStorage.getItem('hotlist_ever_had_data');
    console.log('hasEverHadData localStorage value:', hasEverHadData);

    // Check if this is a first-time user (no clients and no previous data)
    if(!state.clients || state.clients.length === 0){
      if(!hasEverHadData){
        console.log('Loading demo data for first-time user...');
        // First-time user - load demo data automatically
        var demoClients = createDemoClients();
        state.clients = demoClients;

        // Mark that user has seen demo data
        localStorage.setItem('hotlist_ever_had_data', 'demo');
        save(state);

        console.log('Demo data loaded! Client count:', state.clients.length);
        console.log('Demo clients:', state.clients.map(function(c){ return c.name; }));
      } else {
        console.log('User has had data before (flag:', hasEverHadData, '), not loading demo data');
      }
    } else {
      console.log('User already has', state.clients.length, 'clients');

      // Check if user has demo data mixed with real data
      var hasDemoClients = state.clients.some(function(client){
        return client.id && client.id.startsWith('demo-');
      });

      if(hasDemoClients && !hasEverHadData){
        console.log('Found demo clients, setting demo flag');
        localStorage.setItem('hotlist_ever_had_data', 'demo');
      }
    }
  }

  /* Debug/Reset Functions */
  function resetForTesting(){
    localStorage.removeItem('hotlist_ever_had_data');
    state.clients = [];
    save(state);
    render();
    console.log('App reset for testing - refresh page to see first-time user experience');
  }

  function forceLoadDemo(){
    var demoClients = createDemoClients();
    state.clients = demoClients;
    localStorage.setItem('hotlist_ever_had_data', 'demo');
    save(state);
    render();
    console.log('Demo data force loaded, client count:', state.clients.length);
  }

  function debugCurrentState(){
    console.log('=== Current App State ===');
    console.log('state.clients:', state.clients);
    console.log('clients count:', state.clients ? state.clients.length : 'undefined');
    console.log('localStorage flag:', localStorage.getItem('hotlist_ever_had_data'));
    console.log('clearDemoBtn element:', els.clearDemoBtn);
    console.log('clearDemoBtn display:', els.clearDemoBtn ? els.clearDemoBtn.style.display : 'element not found');

    if(state.clients && state.clients.length > 0){
      console.log('Client IDs:', state.clients.map(function(c){ return c.id; }));
      console.log('Demo clients:', state.clients.filter(function(c){ return c.id.startsWith('demo-'); }));
    }
  }

  // Make functions available globally for testing
  window.loadDemoData = loadDemoData;
  window.clearDemoData = clearDemoData;
  window.resetForTesting = resetForTesting;
  window.forceLoadDemo = forceLoadDemo;
  window.debugCurrentState = debugCurrentState;

  /* Click handler for unscheduling and clearing purchases */
  document.addEventListener('click', function(e){
    if(e.target.classList.contains('unschedule-x')){
      e.stopPropagation();
      var clientId = e.target.getAttribute('data-client-id');
      var client = state.clients.find(function(c){ return c.id === clientId; });
      if(client){
        if(e.target.classList.contains('clear-purchase')){
          // Clear purchase date and status
          clearPurchase(client);
        } else {
          // Clear follow-up date
          client.followUp = '';
          save(state);
          render();
        }
      }
    }
  });

  /* Schedule Dropdown */
  var activeDropdown = null;
  var dropdownSelectedIndex = 0;

  function showScheduleDropdown(client, event){
    // Close any existing dropdown
    if(activeDropdown){
      activeDropdown.remove();
      activeDropdown = null;
    }

    // Create dropdown menu
    var menu = document.createElement('div');
    menu.className = 'sched-menu';
    menu.style.position = 'fixed';

    // Get the selected row element to position the dropdown
    var rows = allRows();
    var selectedRow = rows[selectionIndex];
    if(!selectedRow) return;

    var rect = selectedRow.getBoundingClientRect();
    menu.style.left = rect.left + 100 + 'px';
    menu.style.top = rect.bottom + 'px';

    // Create menu options
    var options = [
      { label: '🔥 Mark Hot', action: function(){ preserveUIAndRender(function(){ client.hot = !client.hot; }); } },
      { label: '📅 Today', action: function(){ toggleQueueToday(client); } },
      { label: '➡️ Tomorrow', action: function(){ toggleQueueTomorrow(client); } },
      { label: '⏰ Follow-up...', action: function(){ setFollowUpViaPicker(client); } },
      { label: '📝 Archive', action: function(){ archiveClient(client, true); } },
      { label: '❌ Clear Status', action: function(){ clearStatus(client); } }
    ];

    options.forEach(function(opt, index){
      var btn = document.createElement('button');
      btn.textContent = opt.label;
      btn.onclick = function(){
        opt.action();
        closeDropdown();
      };
      if(index === 0) btn.className = 'selected';
      menu.appendChild(btn);
    });

    document.body.appendChild(menu);
    activeDropdown = menu;
    dropdownSelectedIndex = 0;

    // Handle dropdown navigation
    function handleDropdownKey(e){
      if(!activeDropdown) return;

      var buttons = activeDropdown.querySelectorAll('button');

      if(e.key === 'ArrowDown' || e.key === 'j' || e.key === 'J'){
        buttons[dropdownSelectedIndex].classList.remove('selected');
        dropdownSelectedIndex = (dropdownSelectedIndex + 1) % buttons.length;
        buttons[dropdownSelectedIndex].classList.add('selected');
        e.preventDefault();
        e.stopPropagation();
      }
      else if(e.key === 'ArrowUp' || e.key === 'k' || e.key === 'K'){
        buttons[dropdownSelectedIndex].classList.remove('selected');
        dropdownSelectedIndex = (dropdownSelectedIndex - 1 + buttons.length) % buttons.length;
        buttons[dropdownSelectedIndex].classList.add('selected');
        e.preventDefault();
        e.stopPropagation();
      }
      else if(e.key === 'Enter'){
        buttons[dropdownSelectedIndex].click();
        e.preventDefault();
        e.stopPropagation();
      }
      else if(e.key === 'Escape'){
        closeDropdown();
        e.preventDefault();
        e.stopPropagation();
      }
    }

    function closeDropdown(){
      if(activeDropdown){
        activeDropdown.remove();
        activeDropdown = null;
        document.removeEventListener('keydown', handleDropdownKey, true);
        document.removeEventListener('click', outsideClickHandler);
      }
    }

    function outsideClickHandler(e){
      if(activeDropdown && !activeDropdown.contains(e.target)){
        closeDropdown();
      }
    }

    // Add event listeners with capture to intercept before main handler
    document.addEventListener('keydown', handleDropdownKey, true);
    document.addEventListener('click', outsideClickHandler);
  }

  /* Keyboard shortcuts */
  document.addEventListener('keydown', function(e){
    // Skip if dropdown is active (dropdown handler will process)
    if(activeDropdown) return;

    var tag=(document.activeElement && document.activeElement.tagName)||'';

    // Handle Cmd+/ or Ctrl+/ for shortcuts modal
    if((e.metaKey || e.ctrlKey) && e.key === '/'){
      showShortcutsModal();
      e.preventDefault();
      return;
    }

    // Handle Escape to close modals
    if(e.key === 'Escape'){
      if(document.getElementById('shortcutsModal').style.display === 'block'){
        closeShortcutsModal();
        e.preventDefault();
        return;
      }
      if(document.getElementById('changelogModal') && document.getElementById('changelogModal').style.display === 'block'){
        closeChangelogModal();
        e.preventDefault();
        return;
      }
    }

    if(e.ctrlKey || e.metaKey) return;            // <-- Let browser handle other Ctrl/Cmd shortcuts
    if(tag==='INPUT' || tag==='TEXTAREA' || tag==='SELECT') return;

    var key=e.key;
    var rows=allRows(); if(!rows.length && !['F','f','d','D'].includes(key)) return;

    if(key==='ArrowDown' || key==='j' || key==='J'){ selectionIndex++; restoreSelection(); e.preventDefault(); }
    if(key==='ArrowUp' || key==='k' || key==='K'){ selectionIndex--; restoreSelection(); e.preventDefault(); }

    var map={'1':'Initial Contact','2':'Sent Quote','3':'Sent Application','4':'Pending Application Signature','5':'Pending Medical Questionnaire','6':'Purchased'};
    if(map[key]){ var c1=getSelectedClient(); if(c1){ setStatus(c1,map[key]); e.preventDefault(); } }
    
    if(key==='0'){ var c0=getSelectedClient(); if(c0){ clearStatus(c0); e.preventDefault(); } }

    if(key==='a' || key==='A'){ 
      var c2=getSelectedClient(); 
      if(c2){ 
        if(e.shiftKey){ decrementCall(c2); } else { incrementCall(c2); }
        e.preventDefault(); 
      } 
    }
    if(key==='l' || key==='L'){ 
      var c3=getSelectedClient(); 
      if(c3){ 
        if(e.shiftKey){ decrementMsg(c3); } else { incrementMsg(c3); }
        e.preventDefault(); 
      } 
    }
    if(key==='n' || key==='N'){ var rows2=allRows(); var row=rows2[selectionIndex]; if(!row) return; var ta=row.querySelector('textarea'); var wrap=row.querySelector('.notes'); if(wrap){ wrap.classList.toggle('hidden'); if(!wrap.classList.contains('hidden') && ta) ta.focus(); } e.preventDefault(); }
    if(key==='h' || key==='H'){
      var cHot=getSelectedClient();
      if(cHot){
        var wasHot = cHot.hot;
        preserveUIAndRender(function(){ cHot.hot = !cHot.hot; });
        // Show flame animation if marking as hot
        if(!wasHot && cHot.hot){
          showFlameAnimation(e);
        }
        e.preventDefault();
      }
    }

    if(key==='F' || key==='f'){ 
      var c4=getSelectedClient() || state.clients.find(function(c){return !c.archived && !isFutureFollowUp(c) && !c.queueToday && !c.queueTomorrow;}); 
      if(c4){ 
        // Preserve position instead of client ID for F key
        var currentIndex = selectionIndex;
        var prevDocY=window.scrollY, prevActY=els.activity?els.activity.scrollTop:0;
        withUndo(function(){ c4.queueToday = !c4.queueToday; if(c4.queueToday && c4.queueTomorrow) c4.queueTomorrow=false; });
        save(state); render();
        // Restore position, not client
        selectionIndex = currentIndex;
        var rows = allRows();
        if(selectionIndex >= rows.length) selectionIndex = Math.max(0, rows.length - 1);
        restoreSelection();
        window.scrollTo(0,prevDocY); if(els.activity) els.activity.scrollTop=prevActY;
        e.preventDefault(); 
      } 
    }
    if(key==='d' || key==='D'){
      var c5=getSelectedClient() || state.clients.find(function(c){return !c.archived && !isFutureFollowUp(c) && !c.queueToday && !c.queueTomorrow;});
      if(c5){
        toggleQueueTomorrow(c5);
        // Client stays in main list but gets Tomorrow label, so selection stays the same
        e.preventDefault();
      }
    }

    // Schedule dropdown (S)
    if(key==='s' || key==='S'){
      var c6=getSelectedClient();
      if(c6){
        showScheduleDropdown(c6, e);
        e.preventDefault();
      }
    }

    // Undo (U) / placeholder Redo (R)
    if(key==='u' || key==='U'){ var prev=undoStack.pop(); if(prev){ state=coerceState(JSON.parse(prev)); save(state); render(); } }
    if(key==='r' || key==='R'){ /* Hook a redo stack here if needed */ }
  });

  /* Widgets drag & collapse */
  function loadWidgetOrder(){
    if(Array.isArray(ui.widgetOrder) && ui.widgetOrder.length > 0) {
      return ui.widgetOrder;
    }
    // Default order: Today's Activity, Power Hour, Motivation, Heatmap, then others
    var defaultOrder = ['todayActivity', 'powerHour', 'motivation', 'heatmap'];
    var allWidgets = $all('#sidebarWidgets .widget').map(function(w){return w.dataset.key;});
    var otherWidgets = allWidgets.filter(function(key){ return !defaultOrder.includes(key); });
    return defaultOrder.concat(otherWidgets);
  }
  function saveWidgetOrder(keys){ ui.widgetOrder=keys; saveUI(ui); }
  function applyWidgetOrder(){
    var keys=loadWidgetOrder(), map={};
    $all('#sidebarWidgets .widget[draggable="true"]').forEach(function(w){ map[w.dataset.key]=w; });
    keys.forEach(function(k){ if(map[k]) els.sidebar.appendChild(map[k]); });
  }
  
  function loadLeftWidgets(){ return Array.isArray(ui.leftWidgets) ? ui.leftWidgets : []; }
  function saveLeftWidgets(keys){ ui.leftWidgets=keys; saveUI(ui); }
  function saveWidgetLayout(){ 
    var rightKeys = $all('#sidebarWidgets .widget').map(function(w){return w.dataset.key;});
    var leftKeys = $all('#leftSidebar .widget').map(function(w){return w.dataset.key;});
    ui.widgetOrder = rightKeys; ui.leftWidgets = leftKeys; saveUI(ui); 
  }
  
  function applyDualSidebarLayout(){
    var leftWidgets = els.leftSidebar ? els.leftSidebar.querySelectorAll('.widget') : [];
    var hasLeft = leftWidgets.length > 0;
    if(hasLeft){
      els.appRoot.classList.add('dual-sidebar');
      els.leftSidebar.style.display = 'block';
    } else {
      els.appRoot.classList.remove('dual-sidebar');
      els.leftSidebar.style.display = 'none';
    }
  }
  
  function showDragZones(){ 
    if(els.leftDragZone) {
      els.leftDragZone.style.display = 'flex';
      els.leftDragZone.classList.add('active');
    }
    if(els.rightDragZone) {
      els.rightDragZone.style.display = 'flex';
      els.rightDragZone.classList.add('active');
    }
  }
  function hideDragZones(){ 
    if(els.leftDragZone) {
      els.leftDragZone.style.display = 'none';
      els.leftDragZone.classList.remove('active');
    }
    if(els.rightDragZone) {
      els.rightDragZone.style.display = 'none';
      els.rightDragZone.classList.remove('active');
    }
  }
  
  function enableDrag(){ 
    var dragging=null; 
    
    // Universal drag start for any widget
    document.addEventListener('dragstart', function(e){ 
      var w=e.target.closest('.widget'); 
      if(!w) return; 
      dragging=w; 
      e.dataTransfer.effectAllowed='move'; 
      e.dataTransfer.setData('text/plain', w.dataset.key || 'widget'); 
      w.classList.add('dragging'); 
      showDragZones();
    }); 
    
    // Drag over handlers for both sidebars and drag zones
    [els.sidebar, els.leftSidebar, els.leftDragZone, els.rightDragZone].forEach(function(container){
      if(!container) return;
      container.addEventListener('dragover', function(e){ 
        if(!dragging) return; 
        e.preventDefault(); 
        e.dataTransfer.dropEffect = 'move';
        var w=e.target.closest('.widget'); 
        if(w && w!==dragging) { 
          w.classList.add('drag-over'); 
        }
        // Highlight the container itself if dragging over empty space
        if(container === els.leftDragZone || container === els.rightDragZone || (!w && (container === els.sidebar || container === els.leftSidebar))) {
          container.classList.add('drag-target');
        }
      }); 
      container.addEventListener('dragleave', function(e){ 
        var w=e.target.closest('.widget'); 
        if(w) w.classList.remove('drag-over'); 
        container.classList.remove('drag-target');
      }); 
    });
    
    // Drop handlers
    els.sidebar.addEventListener('drop', function(e){ 
      if(!dragging) return; 
      e.preventDefault(); 
      var target=e.target.closest('.widget'); 
      if(target && target!==dragging){ 
        target.classList.remove('drag-over'); 
        var rect=target.getBoundingClientRect(); 
        var before=(e.clientY-rect.top) < rect.height/2; 
        els.sidebar.insertBefore(dragging, before? target : target.nextSibling); 
      } else {
        els.sidebar.appendChild(dragging);
      }
      dragging.classList.remove('dragging'); 
      els.sidebar.classList.remove('drag-target');
      hideDragZones(); 
      applyDualSidebarLayout();
      saveWidgetLayout();
      dragging=null;
    }); 
    
    if(els.leftSidebar){
      els.leftSidebar.addEventListener('drop', function(e){ 
        if(!dragging) return; 
        e.preventDefault(); 
        var target=e.target.closest('.widget'); 
        if(target && target!==dragging){ 
          target.classList.remove('drag-over'); 
          var rect=target.getBoundingClientRect(); 
          var before=(e.clientY-rect.top) < rect.height/2; 
          els.leftSidebar.insertBefore(dragging, before? target : target.nextSibling); 
        } else {
          els.leftSidebar.appendChild(dragging);
        }
        dragging.classList.remove('dragging'); 
        els.leftSidebar.classList.remove('drag-target');
        hideDragZones(); 
        applyDualSidebarLayout();
        saveWidgetLayout();
        dragging=null;
      }); 
    }
    
    if(els.leftDragZone){
      els.leftDragZone.addEventListener('drop', function(e){ 
        if(!dragging) return; 
        e.preventDefault(); 
        els.leftSidebar.appendChild(dragging);
        dragging.classList.remove('dragging'); 
        els.leftDragZone.classList.remove('drag-target');
        hideDragZones(); 
        applyDualSidebarLayout();
        saveWidgetLayout();
        dragging=null;
      }); 
    }
    
    if(els.rightDragZone){
      els.rightDragZone.addEventListener('drop', function(e){ 
        if(!dragging) return; 
        e.preventDefault(); 
        els.sidebar.appendChild(dragging);
        dragging.classList.remove('dragging'); 
        els.rightDragZone.classList.remove('drag-target');
        hideDragZones(); 
        applyDualSidebarLayout();
        saveWidgetLayout();
        dragging=null;
      }); 
    }
    
    // Drag end cleanup
    document.addEventListener('dragend', function(){ 
      var d=document.querySelector('.dragging'); 
      if(d) d.classList.remove('dragging'); 
      hideDragZones();
      dragging=null; 
    }); 
  }
  function enableCollapse(){ 
    // Handle collapse for both sidebars
    function setupCollapse(container){
      if(!container) return;
      container.addEventListener('click', function(e){ 
        var btn=e.target.closest('.collapse-btn'); 
        if(!btn) return; 
        var w=btn.closest('.widget'); 
        if(!w) return; 
        var body=w.querySelector('.widget-body'); 
        if(!body) return; 
        body.classList.toggle('hidden'); 
        ui.widgetCollapsed = ui.widgetCollapsed || {}; 
        ui.widgetCollapsed[w.dataset.key] = body.classList.contains('hidden'); 
        saveUI(ui); 
      }); 
    }
    setupCollapse(els.sidebar);
    setupCollapse(els.leftSidebar);
    
    ui.widgetCollapsed = ui.widgetCollapsed || {}; 
    $all('.widget').forEach(function(w){ 
      var body=w.querySelector('.widget-body'); 
      if(!body) return; 
      if(ui.widgetCollapsed[w.dataset.key]) body.classList.add('hidden'); 
      else body.classList.remove('hidden'); 
    }); 
  }

  /* Boot */
  if(typeof ui.sortBy==='undefined') ui.sortBy='lastTouch';
  if($('#sortBy')) $('#sortBy').value=ui.sortBy||'lastTouch';

  if(els.ageDays){ if(ui.ageDays!=null) els.ageDays.value = String(ui.ageDays); else els.ageDays.value='4'; }
  if(typeof ui.density==='undefined'){ ui.density='comfortable'; }
  applyDensity();

  // ensure widgets are draggable
  $all('#sidebarWidgets .widget').forEach(function(w){ if(!w.getAttribute('draggable')) w.setAttribute('draggable','true'); });

  // Initialize dual sidebar system
  if(typeof ui.leftWidgets === 'undefined') ui.leftWidgets = [];
  if(typeof ui.dailyOutreachGoal === 'undefined') ui.dailyOutreachGoal = 10;
  
  // Apply saved left widget positions
  var leftKeys = loadLeftWidgets();
  var hasLeftWidgets = leftKeys.length > 0;

  leftKeys.forEach(function(key){
    var widget = $('#' + key) || $('[data-key="' + key + '"]');
    if(widget && els.leftSidebar) els.leftSidebar.appendChild(widget);
  });

  // Apply widget order for right sidebar
  applyWidgetOrder();

  // Apply dual sidebar layout if widgets are split between sidebars
  applyDualSidebarLayout();

  enableDrag(); enableCollapse();

  // Check for daily queue rotation on load (will be done after storage is ready)

  // Check for queue rotation every minute (in case app stays open overnight)
  setInterval(function(){
    var today = new Date().toDateString();
    if(ui.lastQueueRotation !== today){
      rotateDailyQueues();
      render();
    }
  }, 60000);

  /* Email functionality with KPI data */
  if(els.emailTodayDetailBtn){
    els.emailTodayDetailBtn.addEventListener('click', function(){
      var kpis = getKPIData();
      var today = new Date().toLocaleDateString();
      var dailyStats = getDailyStats();

      var subject = 'Life Hotlist - Today\'s Activity (' + today + ')';
      var body = 'Today\'s Activity Report\n\n';
      body += '=== KPIs ===\n';
      body += 'Purchased: ' + kpis.purchased + '\n';
      body += 'Weekly Calls: ' + kpis.weeklyCalls + '\n';
      body += 'Streak: ' + kpis.streak + ' day(s)\n\n';
      body += '=== Daily Activity ===\n';
      body += 'Calls: ' + dailyStats.calls + '\n';
      body += 'Messages: ' + dailyStats.messages + '\n\n';

      // Add today's activity details
      var todayActivities = getTodayActivities();
      if(todayActivities.length > 0){
        body += '=== Activity Details ===\n';
        todayActivities.forEach(function(a){
          body += a.time + ' - ' + a.client + ': ' + a.action + '\n';
        });
      }

      window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    });
  }

  if(els.emailSummaryBtn){
    els.emailSummaryBtn.addEventListener('click', function(){
      var kpis = getKPIData();
      var range = els.chartRangeSel ? els.chartRangeSel.value : '7';
      var rangeDays = parseInt(range);

      var subject = 'Life Hotlist - ' + rangeDays + ' Day Summary Report';
      var body = rangeDays + ' Day Summary Report\n\n';
      body += '=== KPIs ===\n';
      body += 'Total Purchased: ' + kpis.purchased + '\n';
      body += 'Weekly Calls: ' + kpis.weeklyCalls + '\n';
      body += 'Current Streak: ' + kpis.streak + ' day(s)\n\n';

      // Add pipeline summary
      var pipeline = getPipelineData();
      body += '=== Pipeline ===\n';
      Object.keys(pipeline).forEach(function(status){
        body += status + ': ' + pipeline[status] + '\n';
      });

      window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    });
  }

  // Helper function to get today's activities
  function getTodayActivities(){
    var activities = [];
    var today = startOfDay(new Date());
    var tomorrow = addDays(today, 1);

    state.clients.forEach(function(c){
      (c.history || []).forEach(function(h){
        var ts = new Date(h.ts);
        if(ts >= today && ts < tomorrow){
          activities.push({
            time: ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            client: c.name,
            action: h.action === 'status' ? 'Status: ' + h.to : h.action
          });
        }
      });
    });

    return activities.sort(function(a, b){ return b.time.localeCompare(a.time); });
  }

  // Helper to get pipeline data
  function getPipelineData(){
    var pipeline = {};
    if(state && state.clients) state.clients.forEach(function(c){
      if(!c.archived && c.status){
        pipeline[c.status] = (pipeline[c.status] || 0) + 1;
      }
    });
    return pipeline;
  }

  // Initialize version
  var versionEl = document.getElementById('versionNumber');
  if(versionEl) versionEl.textContent = VERSION;

  /* Wait for storage initialization then render */
  Promise.all([storageReady, uiReady]).then(function() {
    // Now that storage is ready, perform initial setup
    applyDensity(); // Apply density after UI is loaded
    rotateDailyQueues();
    initializeFirstTimeUser(); // Check for first-time user and load demo data
    renderQuote(false);
    scheduleQuoteTimer();
    renderDailyOutreach();
    render();
  }).catch(function(e) {
    console.error('Failed to initialize storage:', e);
    if (!state) {
      state = {clients:[], quotes:{raw:'', list:[]}, quotesSettings:{interval:15, random:true, norepeat:true, recent:[]}};
    }
    if (!ui) {
      ui = {};
    }
    renderQuote(false);
    scheduleQuoteTimer();
    renderDailyOutreach();
    render();
  });
})();
</script>

<!-- Shortcuts Modal -->
<div id="shortcutsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--card); border-radius:var(--radius); padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:var(--shadow);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0; color:var(--ink);">Keyboard Shortcuts</h2>
      <button onclick="closeShortcutsModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--muted);">×</button>
    </div>
    <div style="display:grid; gap:16px;">
      <div>
        <h3 style="color:var(--green); margin-bottom:8px; font-size:14px;">Navigation</h3>
        <div style="display:grid; gap:4px; font-size:13px;">
          <div><kbd>↑/↓</kbd> or <kbd>J/K</kbd> - Navigate between clients</div>
          <div><kbd>Click</kbd> - Focus on a client row</div>
        </div>
      </div>
      <div>
        <h3 style="color:var(--green); margin-bottom:8px; font-size:14px;">Status Management</h3>
        <div style="display:grid; gap:4px; font-size:13px;">
          <div><kbd>1</kbd> - Initial Contact</div>
          <div><kbd>2</kbd> - Sent Quote</div>
          <div><kbd>3</kbd> - Sent Application</div>
          <div><kbd>4</kbd> - Pending Application Signature</div>
          <div><kbd>5</kbd> - Pending Medical Questionnaire</div>
          <div><kbd>6</kbd> - Purchased</div>
          <div><kbd>0</kbd> - Clear status</div>
        </div>
      </div>
      <div>
        <h3 style="color:var(--green); margin-bottom:8px; font-size:14px;">Actions</h3>
        <div style="display:grid; gap:4px; font-size:13px;">
          <div><kbd>A</kbd> - Log a call</div>
          <div><kbd>L</kbd> - Log a message/email</div>
          <div><kbd>Shift+A</kbd> - Remove a call</div>
          <div><kbd>Shift+L</kbd> - Remove a message</div>
          <div><kbd>N</kbd> - Toggle notes</div>
          <div><kbd>H</kbd> - Mark as hot lead</div>
        </div>
      </div>
      <div>
        <h3 style="color:var(--green); margin-bottom:8px; font-size:14px;">Scheduling</h3>
        <div style="display:grid; gap:4px; font-size:13px;">
          <div><kbd>S</kbd> - Open schedule menu (navigate with arrows)</div>
          <div><kbd>F</kbd> - Queue for today</div>
          <div><kbd>D</kbd> - Queue for tomorrow</div>
          <div><kbd>U</kbd> - Undo last action</div>
        </div>
      </div>
      <div>
        <h3 style="color:var(--green); margin-bottom:8px; font-size:14px;">Help</h3>
        <div style="display:grid; gap:4px; font-size:13px;">
          <div><kbd>⌘/</kbd> or <kbd>Ctrl+/</kbd> - Show this help</div>
          <div><kbd>Esc</kbd> - Close this dialog</div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Changelog Modal -->
<div id="changelogModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--card); border-radius:var(--radius); padding:24px; max-width:500px; width:90%; max-height:70vh; overflow-y:auto; box-shadow:var(--shadow);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0; color:var(--ink);">Changelog</h2>
      <button onclick="closeChangelogModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--muted);">×</button>
    </div>
    <div id="changelogContent" style="display:flex; flex-direction:column; gap:16px;">
      <!-- Changelog items will be inserted here by JavaScript -->
    </div>
  </div>
</div>

<script>
// Register service worker for PWA functionality
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      console.log('ServiceWorker registration successful:', registration.scope);
    }, function(err) {
      console.log('ServiceWorker registration failed:', err);
    });

    // Request notification permission if we have scheduled items
    // Check if state exists (it's defined in the main app IIFE)
    if(typeof state !== 'undefined' && state.clients){
      var hasScheduled = state.clients.some(function(c){
        return !c.archived && c.followUp;
      });
      if(hasScheduled && typeof requestNotificationPermission === 'function'){
        requestNotificationPermission();
      }
    }
  });
}

// PWA install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  // Could show install button here if desired
});
</script>

</body>
</html>
